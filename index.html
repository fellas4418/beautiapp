<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KEESS</title>

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

body { 
  background: #fff7f7; 
  color: #1a1a1a; 
  font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", system-ui, sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}

/* ========== SCREEN CONTAINER ========== */
.screen {
  display: none;
  min-height: 100vh;
  transition: opacity 300ms ease, transform 300ms ease;
}

.screen.visible {
  display: block;
  animation: fadeIn 300ms ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ========== INITIAL SCREEN ========== */
.initial-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 24px;
  background: linear-gradient(135deg, #fff7f7 0%, #ffe8e8 100%);
}

.app-logo {
  font-size: 11px;
  letter-spacing: 3px;
  font-weight: 700;
  color: #d4a5a5;
  margin-bottom: 60px;
  text-transform: uppercase;
}

.primary-scan-btn {
  width: 280px;
  height: 280px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ffffff 0%, #fff2f2 100%);
  border: 3px solid #ffd4d4;
  color: #ff4d4f;
  font-size: 18px;
  font-weight: 700;
  letter-spacing: 0.5px;
  cursor: pointer;
  transition: all 180ms ease;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  box-shadow: 0 8px 32px rgba(255, 77, 79, 0.15);
}

.primary-scan-btn:hover {
  transform: scale(1.05);
  border-color: #ffb8b8;
  box-shadow: 0 12px 48px rgba(255, 77, 79, 0.25);
  background: linear-gradient(135deg, #fff2f2 0%, #ffe8e8 100%);
}

.primary-scan-btn:active {
  transform: scale(0.98);
}

/* ========== SCAN SELECTION SCREEN ========== */
.scan-selection-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 24px;
  background: linear-gradient(135deg, #fff7f7 0%, #ffe8e8 100%);
}

.scan-selection-screen .app-logo {
  margin-bottom: 80px;
}

.scan-buttons {
  display: flex;
  flex-direction: column;
  gap: 24px;
  width: 100%;
  max-width: 320px;
}

.scan-option-btn {
  width: 100%;
  height: 120px;
  border-radius: 16px;
  background: #ffffff;
  border: 3px solid #ffd4d4;
  color: #ff4d4f;
  font-size: 20px;
  font-weight: 700;
  letter-spacing: 0.5px;
  cursor: pointer;
  transition: all 180ms ease;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  box-shadow: 0 4px 16px rgba(255, 77, 79, 0.12);
}

.scan-option-btn:hover {
  transform: translateY(-2px);
  border-color: #ffb8b8;
  box-shadow: 0 8px 24px rgba(255, 77, 79, 0.2);
  background: #fff7f7;
}

.scan-option-btn:active {
  transform: translateY(0);
}

/* ========== FORM SCREEN ========== */
.form-screen {
  max-width: 480px;
  margin: 0 auto;
  padding: 24px;
  min-height: 100vh;
}

.top-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 32px;
  padding-bottom: 16px;
  border-bottom: 2px solid #f0e6e6;
}

.app-logo-small {
  font-size: 10px;
  letter-spacing: 2px;
  font-weight: 700;
  color: #d4a5a5;
  text-transform: uppercase;
}

.nav-toggle {
  background: #ffffff;
  border: 2px solid #f0e6e6;
  color: #6b6b6b;
  padding: 10px 20px;
  border-radius: 24px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 150ms ease;
}

.nav-toggle:hover {
  border-color: #ffd4d4;
  color: #1a1a1a;
  background: #fff7f7;
}

.nav-toggle.active {
  background: #ff4d4f;
  color: #ffffff;
  border-color: #ff4d4f;
}

/* Form sections */
.form-section {
  background: #ffffff;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  border: 2px solid #f0e6e6;
}

.form-section-title {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: #6b6b6b;
  margin-bottom: 16px;
}

.product-name-section {
  margin-bottom: 16px;
}

.expand-toggle {
  background: #ffffff;
  border: 2px solid #f0e6e6;
  color: #6b6b6b;
  padding: 12px 16px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  text-align: left;
  transition: all 150ms ease;
}

.expand-toggle:hover {
  border-color: #ffd4d4;
  color: #1a1a1a;
  background: #fff7f7;
}

.expand-toggle.expanded {
  background: #fff7f7;
  border-color: #ffd4d4;
  color: #1a1a1a;
}

.expandable-content {
  display: none;
  margin-top: 12px;
  animation: slideDown 200ms ease;
}

.expandable-content.visible {
  display: block;
}

@keyframes slideDown {
  from { opacity: 0; max-height: 0; }
  to { opacity: 1; max-height: 200px; }
}

input[type="text"] { 
  width: 100%; 
  padding: 12px; 
  border-radius: 8px; 
  border: 2px solid #f0e6e6; 
  background: #ffffff; 
  color: #1a1a1a; 
  font-size: 14px; 
  transition: border-color 150ms ease;
}

input[type="text"]:focus {
  outline: none;
  border-color: #ffd4d4;
}

input[type="text"]::placeholder {
  color: #b0b0b0;
}

.date-section {
  margin-bottom: 16px;
}

.date-mode-toggle {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 16px;
}

.date-mode-toggle button {
  padding: 10px;
  background: #ffffff;
  color: #6b6b6b;
  border: 2px solid #f0e6e6;
  border-radius: 8px;
  font-weight: 600;
  font-size: 12px;
  cursor: pointer;
  transition: all 150ms ease;
}

.date-mode-toggle button:hover {
  border-color: #ffd4d4;
  color: #1a1a1a;
  background: #fff7f7;
}

.date-mode-toggle button.active {
  background: #ff4d4f;
  border-color: #ff4d4f;
  color: #ffffff;
}

.date-selectors-wrapper {
  position: relative;
  margin-top: 12px;
  padding: 8px 0;
}

.date-selectors {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 8px;
}

.date-selectors.two-col {
  grid-template-columns: 1fr 1fr;
}

.date-selectors select {
  padding: 12px 8px;
  border-radius: 8px;
  border: 2px solid #f0e6e6;
  background: #ffffff;
  color: #1a1a1a;
  font-size: 14px;
  font-weight: 600;
  text-align: center;
  height: 48px;
  appearance: none;
  cursor: pointer;
  transition: all 150ms ease;
}

.date-selectors select:focus {
  outline: none;
  border-color: #ffd4d4;
}

.date-selectors.estimated select {
  border-style: dashed;
  border-color: #ffd4d4;
  background: #fff7f7;
}

.estimated-badge {
  display: inline-block;
  margin-top: 8px;
  padding: 6px 12px;
  background: #fff7f7;
  color: #f59e0b;
  border-radius: 12px;
  font-size: 10px;
  font-weight: 700;
  text-align: center;
  border: 2px dashed #ffd4d4;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.helper-text {
  margin-top: 8px;
  font-size: 11px;
  color: #b0b0b0;
  font-style: italic;
}

.pao { 
  display: grid; 
  grid-template-columns: repeat(4, 1fr); 
  gap: 8px; 
  margin-top: 12px; 
}

.pao button { 
  padding: 12px; 
  border-radius: 8px; 
  border: 2px solid #f0e6e6; 
  background: #ffffff; 
  color: #6b6b6b; 
  font-weight: 700; 
  font-size: 14px; 
  cursor: pointer; 
  transition: all 150ms ease; 
}

.pao button:hover { 
  border-color: #ffd4d4; 
  color: #1a1a1a; 
  background: #fff7f7;
}

.pao button.active { 
  background: #ff4d4f; 
  border-color: #ff4d4f;
  color: #ffffff;
}

.photo-section {
  margin-top: 16px;
}

.file-name { 
  margin-top: 8px; 
  font-size: 11px; 
  color: #b0b0b0; 
  text-align: center; 
}

img { 
  width: 100%; 
  border-radius: 12px; 
  margin-top: 12px; 
  display: block; 
  max-height: 300px; 
  object-fit: contain; 
  border: 2px solid #f0e6e6;
}

.status { 
  margin-top: 12px; 
  padding: 10px; 
  border-radius: 8px; 
  text-align: center; 
  font-weight: 600; 
  font-size: 12px; 
}

.save-btn {
  width: 100%;
  padding: 16px;
  background: #ff4d4f;
  color: #ffffff;
  border: none;
  border-radius: 12px;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  margin-top: 20px;
  transition: all 150ms ease;
  text-transform: uppercase;
  letter-spacing: 1px;
  box-shadow: 0 4px 12px rgba(255, 77, 79, 0.2);
}

.save-btn:hover {
  background: #ff3333;
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(255, 77, 79, 0.3);
}

.save-btn:active {
  transform: translateY(0);
}

.info-section {
  background: #ffffff;
  border-radius: 16px;
  padding: 20px;
  margin-top: 24px;
  border: 2px solid #f0e6e6;
}

.info-title {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: #6b6b6b;
  margin-bottom: 12px;
}

.info-content {
  font-size: 13px;
  line-height: 1.6;
  color: #6b6b6b;
}

.info-content strong {
  color: #1a1a1a;
}

/* ========== RESULT SCREEN ========== */
.result-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 24px;
  background: linear-gradient(135deg, #fff7f7 0%, #ffe8e8 100%);
}

.result-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%;
  max-width: 400px;
}

.status-text {
  font-size: 72px;
  font-weight: 900;
  letter-spacing: -2px;
  text-align: center;
  margin-bottom: 16px;
  line-height: 1;
}

.status-text.safe {
  color: #22c55e;
}

.status-text.use-soon {
  color: #f59e0b;
}

.status-text.toss {
  color: #ef4444;
}

.status-subtext {
  font-size: 14px;
  color: #6b6b6b;
  text-align: center;
  font-weight: 500;
}

.details-toggle {
  margin-top: 24px;
  background: none;
  border: none;
  color: #6b6b6b;
  font-size: 12px;
  cursor: pointer;
  text-decoration: underline;
  transition: color 150ms ease;
}

.details-toggle:hover {
  color: #1a1a1a;
}

.result-details {
  display: none;
  margin-top: 16px;
  padding: 16px;
  background: #ffffff;
  border: 2px solid #f0e6e6;
  border-radius: 12px;
  font-size: 13px;
  color: #6b6b6b;
  max-width: 300px;
  line-height: 1.6;
}

.result-details.visible {
  display: block;
  animation: fadeIn 200ms ease;
}

.result-actions {
  width: 100%;
  max-width: 320px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  padding-bottom: 40px;
}

.scan-again-btn {
  width: 100%;
  height: 64px;
  border-radius: 16px;
  background: #ff4d4f;
  border: none;
  color: #ffffff;
  font-size: 18px;
  font-weight: 700;
  letter-spacing: 0.5px;
  cursor: pointer;
  transition: all 180ms ease;
  text-transform: uppercase;
  box-shadow: 0 4px 16px rgba(255, 77, 79, 0.25);
}

.scan-again-btn:hover {
  background: #ff3333;
  transform: translateY(-2px);
  box-shadow: 0 6px 24px rgba(255, 77, 79, 0.35);
}

.scan-again-btn:active {
  transform: translateY(0);
}

.done-btn {
  background: none;
  border: none;
  color: #6b6b6b;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  padding: 12px;
  transition: color 150ms ease;
  text-decoration: underline;
}

.done-btn:hover {
  color: #1a1a1a;
}

/* ========== MY SHELF ========== */
.shelf-view {
  max-width: 480px;
  margin: 0 auto;
  padding: 24px;
  min-height: 100vh;
}

.shelf-header {
  font-size: 24px;
  font-weight: 900;
  margin-bottom: 20px;
  letter-spacing: -0.5px;
  color: #1a1a1a;
}

.shelf-summary {
  background: #ffffff;
  padding: 12px 16px;
  border-radius: 12px;
  font-size: 13px;
  color: #6b6b6b;
  margin-bottom: 16px;
  text-align: center;
  font-weight: 600;
  border: 2px solid #f0e6e6;
}

.shelf-item { 
  background: #ffffff; 
  border-radius: 12px; 
  padding: 16px; 
  margin-bottom: 12px; 
  position: relative; 
  display: flex;
  align-items: center;
  gap: 12px;
  border: 2px solid #f0e6e6;
  transition: all 150ms ease;
}

.shelf-item:hover {
  border-color: #ffd4d4;
  box-shadow: 0 2px 8px rgba(255, 77, 79, 0.1);
}

.shelf-item-content {
  flex: 1;
  min-width: 0;
}

.shelf-item-name {
  font-size: 15px;
  font-weight: 700;
  color: #1a1a1a;
  margin-bottom: 6px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.shelf-item-meta {
  font-size: 11px;
  color: #6b6b6b;
  margin-bottom: 3px;
}

.shelf-item-dates {
  font-size: 10px;
  color: #b0b0b0;
}

.shelf-item-estimated-badge {
  display: inline-block;
  padding: 2px 6px;
  background: #fff7f7;
  color: #f59e0b;
  border-radius: 4px;
  font-size: 9px;
  font-weight: 700;
  margin-left: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border: 1px solid #ffd4d4;
}

.shelf-item-status { 
  padding: 8px 14px; 
  border-radius: 8px; 
  font-size: 11px; 
  font-weight: 700;
  white-space: nowrap;
  flex-shrink: 0;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: #ffffff;
}

.delete-btn { 
  position: absolute; 
  top: 10px; 
  right: 10px; 
  background: #ffffff; 
  color: #d4a5a5; 
  width: 24px; 
  height: 24px; 
  border-radius: 50%; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  font-size: 14px; 
  cursor: pointer; 
  transition: all 150ms ease; 
  padding: 0; 
  z-index: 10;
  border: 2px solid #f0e6e6;
}

.delete-btn:hover { 
  background: #ffd4d4; 
  color: #ef4444;
  border-color: #ffd4d4;
}

/* Responsive adjustments */
@media (max-width: 400px) {
  .status-text {
    font-size: 56px;
  }
  
  .primary-scan-btn {
    width: 240px;
    height: 240px;
    font-size: 16px;
  }
}
</style>
</head>

<body>

<!-- INITIAL SCREEN -->
<div class="screen visible initial-screen" id="initialScreen">
  <div class="app-logo">KEESS</div>
  <button class="primary-scan-btn" onclick="showScanSelection()">
    Scan cosmetic label
  </button>
</div>

<!-- SCAN SELECTION SCREEN -->
<div class="screen scan-selection-screen" id="scanSelectionScreen">
  <div class="app-logo">KEESS</div>
  <div class="scan-buttons">
    <button class="scan-option-btn" onclick="document.getElementById('cameraInput').click()">
      Take photo
    </button>
    <button class="scan-option-btn" onclick="document.getElementById('galleryInput').click()">
      Select image
    </button>
  </div>
  <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">
  <input type="file" id="galleryInput" accept="image/*" style="display:none;">
</div>

<!-- FORM SCREEN -->
<div class="screen form-screen" id="formScreen">
  
  <div class="top-nav">
    <div class="app-logo-small">KEESS</div>
    <button class="nav-toggle" id="shelfToggle" onclick="showShelf()">My Shelf</button>
  </div>

  <!-- Product Name (collapsed) -->
  <div class="product-name-section">
    <button class="expand-toggle" id="nameToggle" onclick="toggleProductName()">
      + Product name (optional)
    </button>
    <div class="expandable-content" id="nameContent">
      <input type="text" id="productName" placeholder="e.g. Est√©e Lauder Night Repair">
    </div>
  </div>

  <!-- Opening Date -->
  <div class="form-section date-section">
    <div class="form-section-title">Opening Date</div>
    
    <div class="date-mode-toggle">
      <button id="exactBtn" class="active" onclick="setDateMode('exact')">Exact date</button>
      <button id="estimatedBtn" onclick="setDateMode('estimated')">Estimate</button>
    </div>

    <div class="date-selectors-wrapper">
      <div id="exactDateSelectors" class="date-selectors">
        <select id="yearSelect"></select>
        <select id="monthSelect"></select>
        <select id="daySelect"></select>
      </div>

      <div id="estimatedDateSelectors" class="date-selectors two-col estimated" style="display:none;">
        <select id="yearSelectEst"></select>
        <select id="monthSelectEst"></select>
      </div>
    </div>

    <div id="estimatedBadge" class="estimated-badge" style="display:none;">
      Estimated
    </div>

    <div id="helperText" class="helper-text" style="display:none;">
      Opening date is estimated
    </div>
  </div>

  <!-- PAO -->
  <div class="form-section">
    <div class="form-section-title">Period After Opening (PAO)</div>
    <div class="pao" id="paoBtns"></div>
  </div>

  <!-- Photo Preview -->
  <div class="form-section photo-section" id="photoPreviewSection" style="display:none;">
    <div class="form-section-title">Product Photo</div>
    <img id="preview" style="display:none">
    <div class="file-name" id="fileName"></div>
    <div id="status" class="status" style="display:none"></div>
  </div>

  <button class="save-btn" id="saveBtn">Save to My Shelf</button>

  <!-- Info Section -->
  <div class="info-section">
    <div class="info-title">What is PAO?</div>
    <div class="info-content">
      <strong>Period After Opening (PAO)</strong> indicates the time a cosmetic product can be safely used after opening. Check the jar icon on your product for the number (e.g., 12M = 12 months).
    </div>
  </div>

</div>

<!-- RESULT SCREEN -->
<div class="screen result-screen" id="resultScreen">
  <div class="result-content">
    <div class="status-text" id="statusText"></div>
    <div class="status-subtext" id="statusSubtext"></div>
    <button class="details-toggle" id="detailsToggle" onclick="toggleDetails()">More details</button>
    <div class="result-details" id="resultDetails"></div>
  </div>
  
  <div class="result-actions">
    <button class="scan-again-btn" onclick="showScanSelection()">Scan again</button>
    <button class="done-btn" onclick="showShelf()">Done for now</button>
  </div>
</div>

<!-- MY SHELF -->
<div class="screen shelf-view" id="shelfView">
  <div class="top-nav">
    <div class="app-logo-small">KEESS</div>
    <button class="nav-toggle active" onclick="backFromShelf()">Back</button>
  </div>
  
  <div class="shelf-header">My Shelf</div>
  <div id="shelfSummary"></div>
  <div id="shelfItems"></div>
</div>

<script>
// ========== SCREEN NAVIGATION ==========

function hideAllScreens() {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('visible'));
}

function showScreen(screenId) {
  hideAllScreens();
  document.getElementById(screenId).classList.add('visible');
}

function showScanSelection() {
  showScreen('scanSelectionScreen');
  resetForm();
}

function showFormScreen() {
  showScreen('formScreen');
}

function showResultScreen() {
  showScreen('resultScreen');
}

function showShelf() {
  showScreen('shelfView');
  renderShelf();
}

let lastScreen = 'initialScreen';

function backFromShelf() {
  if (lastScreen === 'resultScreen') {
    showScreen('resultScreen');
  } else if (lastScreen === 'formScreen') {
    showScreen('formScreen');
  } else {
    showScreen('initialScreen');
  }
}

function resetForm() {
  productName.value = "";
  selectedPAO = null;
  currentImageDataURL = null;
  lastStatus = null;
  ocrProcessed = false;
  
  [...paoBox.children].forEach(b => b.classList.remove("active"));
  
  preview.style.display = "none";
  preview.src = "";
  fileName.textContent = "";
  status.style.display = "none";
  photoPreviewSection.style.display = "none";
  
  if (productNameExpanded) {
    toggleProductName();
  }
  
  if (detailsExpanded) {
    toggleDetails();
  }
}

// ========== UI TOGGLES ==========

let productNameExpanded = false;
function toggleProductName() {
  productNameExpanded = !productNameExpanded;
  const content = document.getElementById('nameContent');
  const toggle = document.getElementById('nameToggle');
  
  if (productNameExpanded) {
    content.classList.add('visible');
    toggle.classList.add('expanded');
    toggle.textContent = '‚àí Product name (optional)';
  } else {
    content.classList.remove('visible');
    toggle.classList.remove('expanded');
    toggle.textContent = '+ Product name (optional)';
  }
}

let detailsExpanded = false;
function toggleDetails() {
  detailsExpanded = !detailsExpanded;
  const details = document.getElementById('resultDetails');
  const toggle = document.getElementById('detailsToggle');
  
  if (detailsExpanded) {
    details.classList.add('visible');
    toggle.textContent = 'Hide details';
  } else {
    details.classList.remove('visible');
    toggle.textContent = 'More details';
  }
}

// ========== ORIGINAL LOGIC (UNCHANGED) ==========

const SUPPORTED_PAOS = [3, 6, 12, 24];
const PAOS = [3, 6, 9, 12, 18, 24, 36];
const SHELF_STORAGE_KEY = "myShelf";
const PACIFIC_TZ = "America/Los_Angeles";

let selectedPAO = null;
let currentImageDataURL = null;
let lastStatus = null;
let ocrProcessed = false;
let dateMode = 'exact';

const productName = document.getElementById("productName");
const paoBox = document.getElementById("paoBtns");
const preview = document.getElementById("preview");
const status = document.getElementById("status");
const fileName = document.getElementById("fileName");
const saveBtn = document.getElementById("saveBtn");
const shelfSummary = document.getElementById("shelfSummary");
const shelfItems = document.getElementById("shelfItems");
const photoPreviewSection = document.getElementById("photoPreviewSection");

const exactBtn = document.getElementById("exactBtn");
const estimatedBtn = document.getElementById("estimatedBtn");
const exactDateSelectors = document.getElementById("exactDateSelectors");
const estimatedDateSelectors = document.getElementById("estimatedDateSelectors");
const helperText = document.getElementById("helperText");
const estimatedBadge = document.getElementById("estimatedBadge");

const yearSelect = document.getElementById("yearSelect");
const monthSelect = document.getElementById("monthSelect");
const daySelect = document.getElementById("daySelect");
const yearSelectEst = document.getElementById("yearSelectEst");
const monthSelectEst = document.getElementById("monthSelectEst");

const statusText = document.getElementById("statusText");
const statusSubtext = document.getElementById("statusSubtext");
const resultDetails = document.getElementById("resultDetails");

function getPacificMidnight(dateStr) {
  const dateObj = new Date(dateStr + "T00:00:00");
  const pacificDateStr = dateObj.toLocaleString("en-US", { timeZone: PACIFIC_TZ });
  const pacificDate = new Date(pacificDateStr);
  pacificDate.setHours(0, 0, 0, 0);
  return pacificDate;
}

function getTodayPacific() {
  const now = new Date();
  const pacificNowStr = now.toLocaleString("en-US", { timeZone: PACIFIC_TZ });
  const pacificNow = new Date(pacificNowStr);
  pacificNow.setHours(0, 0, 0, 0);
  return pacificNow;
}

function initDateSelectors() {
  const todayPacific = getTodayPacific();
  const currentYear = todayPacific.getFullYear();
  const currentMonth = todayPacific.getMonth() + 1;
  const currentDay = todayPacific.getDate();
  
  for (let y = currentYear; y >= currentYear - 5; y--) {
    yearSelect.add(new Option(y, y));
    yearSelectEst.add(new Option(y, y));
  }
  
  for (let m = 1; m <= 12; m++) {
    const monthName = new Date(2000, m - 1, 1).toLocaleString('en', { month: 'long' });
    monthSelect.add(new Option(monthName, m));
    monthSelectEst.add(new Option(monthName, m));
  }
  
  yearSelect.value = currentYear;
  monthSelect.value = currentMonth;
  yearSelectEst.value = currentYear;
  monthSelectEst.value = currentMonth;
  
  updateDayOptions();
  daySelect.value = currentDay;
}

function getDaysInMonth(year, month) {
  return new Date(year, month, 0).getDate();
}

function updateDayOptions() {
  const year = parseInt(yearSelect.value);
  const month = parseInt(monthSelect.value);
  const daysInMonth = getDaysInMonth(year, month);
  const currentDay = daySelect.value || 1;
  
  daySelect.innerHTML = '';
  for (let d = 1; d <= daysInMonth; d++) {
    daySelect.add(new Option(d, d));
  }
  
  if (currentDay <= daysInMonth) {
    daySelect.value = currentDay;
  } else {
    daySelect.value = daysInMonth;
  }
}

yearSelect.onchange = updateDayOptions;
monthSelect.onchange = updateDayOptions;
daySelect.onchange = () => {};
yearSelectEst.onchange = () => {};
monthSelectEst.onchange = () => {};

function setDateMode(mode) {
  dateMode = mode;
  
  if (mode === 'exact') {
    exactBtn.classList.add('active');
    estimatedBtn.classList.remove('active');
    exactDateSelectors.style.display = 'grid';
    estimatedDateSelectors.style.display = 'none';
    helperText.style.display = 'none';
    estimatedBadge.style.display = 'none';
  } else {
    exactBtn.classList.remove('active');
    estimatedBtn.classList.add('active');
    exactDateSelectors.style.display = 'none';
    estimatedDateSelectors.style.display = 'grid';
    helperText.style.display = 'block';
    estimatedBadge.style.display = 'inline-block';
  }
}

function getOpeningDate() {
  if (dateMode === 'exact') {
    const year = yearSelect.value;
    const month = String(monthSelect.value).padStart(2, '0');
    const day = String(daySelect.value).padStart(2, '0');
    return `${year}-${month}-${day}`;
  } else {
    const year = yearSelectEst.value;
    const month = String(monthSelectEst.value).padStart(2, '0');
    return `${year}-${month}-01`;
  }
}

SUPPORTED_PAOS.forEach(m => {
  const b = document.createElement("button");
  b.textContent = m + "M";
  b.onclick = () => { selectPAO(m); calculateAndShowResult(); };
  paoBox.appendChild(b);
});

function selectPAO(m) {
  selectedPAO = m;
  [...paoBox.children].forEach(b => {
    b.classList.toggle("active", b.textContent === m + "M");
  });
}

function addMonths(d, m) {
  const [y, mo, da] = d.split("-").map(Number);
  const dt = new Date(y, mo - 1, da);
  dt.setMonth(dt.getMonth() + m);
  dt.setHours(0, 0, 0, 0);
  
  const year = dt.getFullYear();
  const month = String(dt.getMonth() + 1).padStart(2, '0');
  const day = String(dt.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function calculateDaysLeft(expiryDateStr) {
  const todayPacific = getTodayPacific();
  const expiryPacific = getPacificMidnight(expiryDateStr);
  
  const daysLeft = Math.ceil((expiryPacific - todayPacific) / (1000 * 60 * 60 * 24));
  
  return daysLeft;
}

function calculateAndShowResult() {
  if (!selectedPAO) { 
    return; 
  }
  
  const openingDate = getOpeningDate();
  const expiryDateStr = addMonths(openingDate, selectedPAO);
  
  const daysLeft = calculateDaysLeft(expiryDateStr);
  
  let statusTextContent = "";
  let statusClass = "";
  let subtextContent = "";
  let detailsContent = "";
  
  if (daysLeft < 0) {
    statusTextContent = "TOSS IT";
    statusClass = "toss";
    subtextContent = "";
    detailsContent = `Expired ${Math.abs(daysLeft)} days ago<br>Expiry date: ${expiryDateStr}<br>Opening date: ${openingDate}`;
  } else if (daysLeft <= 60) {
    statusTextContent = "USE SOON";
    statusClass = "use-soon";
    subtextContent = `${daysLeft} days left`;
    detailsContent = `Expires in ${daysLeft} days<br>Expiry date: ${expiryDateStr}<br>Opening date: ${openingDate}`;
  } else {
    statusTextContent = "SAFE";
    statusClass = "safe";
    subtextContent = "";
    detailsContent = `${daysLeft} days left<br>Expiry date: ${expiryDateStr}<br>Opening date: ${openingDate}`;
  }
  
  if (dateMode === 'estimated') {
    detailsContent += '<br><br><span style="color:#f59e0b;">Opening date is estimated</span>';
  }
  
  statusText.textContent = statusTextContent;
  statusText.className = 'status-text ' + statusClass;
  statusSubtext.textContent = subtextContent;
  resultDetails.innerHTML = detailsContent;
  
  lastScreen = 'formScreen';
  showResultScreen();
}

function extractPAO(text) {
  console.log("Detected text:", text);
  
  const versions = [
    text,
    text.toUpperCase(),
    text.replace(/\s+/g, ''),
    text.replace(/[^a-zA-Z0-9]/g, ' '),
  ];
  
  const patterns = [
    /(\d{1,2})\s*M\b/gi,
    /(\d{1,2})M/gi,
    /M\s*(\d{1,2})/gi,
  ];
  
  for (let ver of versions) {
    for (let pattern of patterns) {
      pattern.lastIndex = 0;
      let match;
      while ((match = pattern.exec(ver)) !== null) {
        const num = parseInt(match[1]);
        if (PAOS.includes(num)) {
          console.log("‚úì Found PAO:", num);
          return num;
        }
      }
    }
  }
  
  const numbers = text.match(/\d+/g);
  if (numbers) {
    for (let numStr of numbers) {
      const num = parseInt(numStr);
      if (PAOS.includes(num)) {
        const idx = text.indexOf(numStr);
        const context = text.substring(Math.max(0, idx - 2), Math.min(text.length, idx + numStr.length + 2));
        if (/m/i.test(context)) {
          console.log("‚úì Found PAO by context:", num);
          return num;
        }
      }
    }
  }
  
  return null;
}

async function detectWithGoogle(base64Image) {
  const apiKey = document.getElementById("apiKey");
  const key = apiKey.value.trim();
  
  if (!key) {
    throw new Error("API key not found");
  }
  
  const base64Content = base64Image.split(',')[1];
  
  const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${key}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      requests: [
        {
          image: {
            content: base64Content
          },
          features: [
            {
              type: 'TEXT_DETECTION',
              maxResults: 10
            }
          ]
        }
      ]
    })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error?.message || `API error: ${response.status}`);
  }
  
  const data = await response.json();
  
  console.log("Google Vision response:", data);
  
  const textAnnotations = data.responses[0]?.textAnnotations;
  
  if (!textAnnotations || textAnnotations.length === 0) {
    return null;
  }
  
  const fullText = textAnnotations[0].description;
  
  return extractPAO(fullText);
}

async function handleFileSelect(e) {
  const file = e.target.files[0];
  if (!file) return;

  ocrProcessed = false;

  fileName.textContent = file.name;
  
  const reader = new FileReader();
  
  reader.onload = async (event) => {
    const base64 = event.target.result;
    currentImageDataURL = base64;
    
    preview.src = base64;
    preview.style.display = "block";
    photoPreviewSection.style.display = "block";
    
    showFormScreen();

    if (ocrProcessed) {
      console.log("This image was already OCR processed. Skipping...");
      return;
    }

    ocrProcessed = true;

    status.style.display = "block";
    status.style.background = "#fff7f7";
    status.style.color = "#f59e0b";
    status.style.border = "2px solid #ffd4d4";
    status.textContent = "Analyzing...";

    try {
      const pao = await detectWithGoogle(base64);
      
      if (pao && SUPPORTED_PAOS.includes(pao)) {
        selectPAO(pao);
        status.style.background = "#f0fdf4";
        status.style.color = "#22c55e";
        status.style.border = "2px solid #bbf7d0";
        status.textContent = `Detected: ${pao}M`;
      } else if (pao) {
        status.style.background = "#fff7f7";
        status.style.color = "#f59e0b";
        status.style.border = "2px solid #ffd4d4";
        status.textContent = `Detected ${pao}M but not supported. Select manually.`;
      } else {
        status.style.background = "#fef2f2";
        status.style.color = "#ef4444";
        status.style.border = "2px solid #fecaca";
        status.textContent = "Could not detect PAO. Select manually.";
      }
      
    } catch (err) {
      console.error(err);
      status.style.background = "#fef2f2";
      status.style.color = "#ef4444";
      status.style.border = "2px solid #fecaca";
      status.textContent = "Error: " + err.message;
    }
  };
  
  reader.readAsDataURL(file);
}

document.getElementById("cameraInput").onchange = handleFileSelect;
document.getElementById("galleryInput").onchange = handleFileSelect;

function loadShelfFromStorage() {
  try {
    const stored = localStorage.getItem(SHELF_STORAGE_KEY);
    if (!stored) {
      console.log("No shelf data");
      return [];
    }
    const parsed = JSON.parse(stored);
    console.log("Loaded shelf data:", parsed.length, "items");
    return Array.isArray(parsed) ? parsed : [];
  } catch (err) {
    console.error("Shelf load error:", err);
    return [];
  }
}

function saveShelfToStorage(shelf) {
  try {
    localStorage.setItem(SHELF_STORAGE_KEY, JSON.stringify(shelf));
    console.log("Saved shelf data:", shelf.length, "items");
    return true;
  } catch (err) {
    console.error("Shelf save error:", err);
    alert("Save failed: " + err.message);
    return false;
  }
}

function computeStatusFromExpiry(expiryDate) {
  const daysLeft = calculateDaysLeft(expiryDate);
  
  if (daysLeft < 0) {
    return "TOSS";
  } else if (daysLeft <= 60) {
    return "USE SOON";
  } else {
    return "KEEP";
  }
}

function refreshAllStatuses() {
  const shelf = loadShelfFromStorage();
  let updated = false;
  
  shelf.forEach(item => {
    const newStatus = computeStatusFromExpiry(item.expiryDate);
    if (item.status !== newStatus) {
      item.status = newStatus;
      updated = true;
    }
  });
  
  if (updated) {
    saveShelfToStorage(shelf);
    console.log("‚úì Statuses refreshed and saved");
  }
  
  return shelf;
}

saveBtn.onclick = () => {
  if (!selectedPAO) {
    alert("First select a PAO period");
    return;
  }

  const openingDate = getOpeningDate();
  const expiryDate = addMonths(openingDate, selectedPAO);
  const itemStatus = computeStatusFromExpiry(expiryDate);

  const name = productName.value.trim() || "noname";

  const item = {
    name: name,
    pao: selectedPAO + "M",
    openingDate: openingDate,
    expiryDate: expiryDate,
    status: itemStatus,
    isEstimated: dateMode === 'estimated',
    createdAt: Date.now()
  };

  const shelf = loadShelfFromStorage();
  shelf.push(item);
  
  const saveSuccess = saveShelfToStorage(shelf);
  
  if (saveSuccess) {
    alert("Saved to My Shelf");
    lastScreen = 'formScreen';
    calculateAndShowResult();
  }
};

function getStatusPriority(status) {
  const priorities = {
    "TOSS": 1,
    "USE SOON": 2,
    "KEEP": 3
  };
  return priorities[status] || 999;
}

function deleteItem(createdAt) {
  if (!confirm("Delete this item?")) return;
  
  const shelf = loadShelfFromStorage();
  const updatedShelf = shelf.filter(item => item.createdAt !== createdAt);
  saveShelfToStorage(updatedShelf);
  renderShelf();
}

function formatOpeningDate(dateStr, isEstimated) {
  if (isEstimated) {
    const [year, month] = dateStr.split('-');
    const monthName = new Date(year, parseInt(month) - 1, 1).toLocaleString('en', { month: 'short' });
    return `${monthName} ${year}`;
  } else {
    return dateStr;
  }
}

function renderShelf() {
  const shelf = refreshAllStatuses();
  
  if (shelf.length === 0) {
    shelfSummary.innerHTML = '';
    shelfItems.innerHTML = '<div style="text-align:center;color:#b0b0b0;padding:40px;">No items yet</div>';
    return;
  }
  
  const tossCount = shelf.filter(item => item.status === "TOSS").length;
  const useSoonCount = shelf.filter(item => item.status === "USE SOON").length;
  const keepCount = shelf.filter(item => item.status === "KEEP").length;
  
  let summaryText = "";
  
  if (tossCount > 0) {
    summaryText = `üóëÔ∏è You have expired products. Time to toss them.`;
  } else if (useSoonCount > 0) {
    summaryText = `‚ö†Ô∏è Some products are expiring soon.`;
  } else if (keepCount > 0) {
    summaryText = "‚ú® Safe vibes only";
  }
  
  if (summaryText) {
    shelfSummary.innerHTML = `<div class="shelf-summary">${summaryText}</div>`;
  } else {
    shelfSummary.innerHTML = '';
  }
  
  const itemsWithStatus = shelf.map(item => {
    if (!item.createdAt) {
      item.createdAt = Date.now() + Math.random();
    }
    
    if (!item.name) {
      item.name = "noname";
    }
    
    let displayStatus = item.status;
    if (item.status === "TOSS") {
      displayStatus = "TOSS IT";
    } else if (item.status === "KEEP") {
      displayStatus = "SAFE";
    }
    
    return {
      ...item,
      displayStatus: displayStatus
    };
  });
  
  itemsWithStatus.sort((a, b) => {
    return getStatusPriority(a.status) - getStatusPriority(b.status);
  });
  
  shelfItems.innerHTML = itemsWithStatus.map(item => {
    const itemStatus = item.displayStatus;
    
    let statusColor = "";
    if (item.status === "TOSS") {
      statusColor = "#ef4444";
    } else if (item.status === "USE SOON") {
      statusColor = "#f59e0b";
    } else {
      statusColor = "#22c55e";
    }
    
    const openingDateDisplay = formatOpeningDate(item.openingDate, item.isEstimated || false);
    const estimatedBadge = (item.isEstimated || false) ? '<span class="shelf-item-estimated-badge">Est.</span>' : '';
    
    return `
      <div class="shelf-item">
        <button class="delete-btn" onclick="deleteItem(${item.createdAt})">√ó</button>
        <div class="shelf-item-content">
          <div class="shelf-item-name">${item.name}</div>
          <div class="shelf-item-meta">${item.pao} ¬∑ Expires ${item.expiryDate}</div>
          <div class="shelf-item-dates">Opened: ${openingDateDisplay}${estimatedBadge}</div>
        </div>
        <div class="shelf-item-status" style="background: ${statusColor};">
          ${itemStatus}
        </div>
      </div>
    `;
  }).join('');
}

(function cleanupOldData() {
  try {
    const stored = localStorage.getItem(SHELF_STORAGE_KEY);
    if (stored) {
      const shelf = JSON.parse(stored);
      if (shelf.length > 0 && shelf[0].image) {
        console.warn("Old format data detected. Cleaning up...");
        localStorage.removeItem(SHELF_STORAGE_KEY);
        console.log("Shelf data reset.");
      }
    }
  } catch (err) {
    console.error("Data cleanup error:", err);
  }
})();

(async function initNotifications() {
  if (!("Notification" in window)) {
    console.log("Browser does not support notifications");
    return;
  }

  if (Notification.permission === "default") {
    try {
      await Notification.requestPermission();
    } catch (err) {
      console.error("Notification permission error:", err);
    }
  }

  if (Notification.permission !== "granted") {
    console.log("Notification permission not granted");
    return;
  }

  const shelf = refreshAllStatuses();
  
  if (shelf.length === 0) {
    return;
  }

  const tossCount = shelf.filter(item => item.status === "TOSS").length;
  const useSoonCount = shelf.filter(item => item.status === "USE SOON").length;

  if (tossCount > 0) {
    new Notification("KEESS ¬∑ Keep or Toss", {
      body: "üóëÔ∏è You have expired products. Time to toss them.",
      icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>üóëÔ∏è</text></svg>",
      silent: true
    });
    console.log("‚úì Notification sent: TOSS");
  } else if (useSoonCount > 0) {
    new Notification("KEESS ¬∑ Keep or Toss", {
      body: "‚ö†Ô∏è Some products are expiring soon.",
      icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>‚ö†Ô∏è</text></svg>",
      silent: true
    });
    console.log("‚úì Notification sent: USE SOON");
  }
})();

initDateSelectors();
renderShelf();
</script>

<input type="text" id="apiKey" value="AIzaSyAtwhPrHK5d_yLVkBfOc8tDjfk-2_cHDrw" style="display:none;" />

</body>
</html>