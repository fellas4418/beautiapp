<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Check Cosmetic Freshness</title>
  <style>
    :root{
      --bg:#0b0c10;
      --card:#111318;
      --text:#e8e8ea;
      --muted:#a8abb4;
      --border:rgba(255,255,255,.10);
      --btn2:#1f2430;
      --danger:#ff4d4f;
      --ok:#20c997;
      --warn:#ffcc00;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    .wrap{
      max-width: 760px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 40px;
    }
    .header{ padding: 12px 4px 6px; }
    .title{ margin:0; font-size: 26px; line-height: 1.2; letter-spacing: -0.2px; }
    .sub{ margin: 8px 0 0; color: var(--muted); font-size: 14px; line-height: 1.5; }
    .card{
      margin-top: 14px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    .row{
      display:flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    button{
      border: 0;
      border-radius: 12px;
      padding: 14px 14px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      min-height: 48px;
    }
    .btn-secondary{
      background: var(--btn2);
      color: var(--text);
      border: 1px solid var(--border);
      flex: 1 1 160px;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .fieldBtn{
      margin-top: 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      user-select: none;
    }
    .fieldBtn .left{
      display:flex;
      flex-direction: column;
      gap: 2px;
    }
    .fieldBtn .label{
      font-size: 12px;
      color: var(--muted);
    }
    .fieldBtn .value{
      font-size: 15px;
      color: var(--text);
      font-weight: 900;
      letter-spacing: -0.2px;
    }
    .fieldBtn .chev{
      color: rgba(255,255,255,.35);
      font-size: 18px;
      padding: 0 6px;
    }

    .panel{
      margin-top: 12px;
      padding: 12px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      border-radius: 12px;
    }
    .photoBox{
      position: relative;
      min-height: 240px;
      border-radius: 12px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.06);
      overflow: hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #imgPreview{
      width: 100%;
      height: 100%;
      object-fit: contain;
      display:none;
    }
    #imgPlaceholder{
      color: rgba(255,255,255,.25);
      font-size: 13px;
      padding: 12px;
      text-align:center;
      line-height: 1.4;
    }
    .footer{
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
      text-align:center;
    }

    .photoLoader{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction: column;
      gap: 10px;
      z-index: 10;
    }
    .photoLoader.show{ display:flex; }
    .spin{
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 3px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.85);
      animation: sp 0.9s linear infinite;
    }
    @keyframes sp { to { transform: rotate(360deg); } }
    .photoLoader .t{
      font-size: 13px;
      color: rgba(255,255,255,.8);
      font-weight: 700;
    }

    .decision{
      display:none;
      margin-top: 12px;
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      text-align:center;
      font-weight: 950;
      letter-spacing: -0.6px;
      line-height: 1.05;
      font-size: 36px;
    }
    .decision.show{ display:block; }
    .decision.ok{
      border-color: rgba(32,201,151,.55);
      background: rgba(32,201,151,.10);
      color: var(--ok);
    }
    .decision.err{
      border-color: rgba(255,77,79,.55);
      background: rgba(255,77,79,.10);
      color: var(--danger);
    }

    .triplet{
      display:none;
      margin-top: 12px;
      gap: 10px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
    }
    .bigCard{
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      min-height: 92px;
    }
    .bigCard .k{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .bigCard .v{
      font-size: 40px;
      font-weight: 950;
      letter-spacing: -0.8px;
      line-height: 1.05;
      word-break: break-word;
    }

    .paoArea{
      margin-top: 12px;
    }
    .paoHint{
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 8px 2px;
    }
    .paoGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .paoBtn{
      background: rgba(255,255,255,.02);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 0;
      font-size: 15px;
      font-weight: 900;
      min-height: 48px;
    }
    .paoBtn.active{
      border-color: rgba(32,201,151,.65);
      background: rgba(32,201,151,.10);
      color: var(--ok);
    }

    .status{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(17,19,24,.95);
      border: 1px solid var(--border);
      font-size: 14px;
      display:none;
      line-height: 1.45;
      word-break: break-word;
    }
    .status.show{ display:block; }
    .status.ok{ color: var(--ok); border-color: rgba(32,201,151,.55); background: rgba(32,201,151,.10); }
    .status.err{ color: var(--danger); border-color: rgba(255,77,79,.55); background: rgba(255,77,79,.10); }
    .status.warn{ color: var(--warn); border-color: rgba(255,204,0,.55); background: rgba(255,204,0,.10); }

    .shelf{
      margin-top: 14px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.02);
    }
    .shelfTop{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .shelfTitle{
      font-weight: 950;
      letter-spacing: -0.3px;
      font-size: 16px;
    }
    .tinyBtn{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.9);
      padding: 10px 10px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 850;
      min-height: 40px;
      cursor: pointer;
    }
    .shelfAdd{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .input{
      flex: 1 1 220px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      border-radius: 12px;
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
      min-height: 46px;
    }
    .shelfList{
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .item{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      padding: 12px;
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    .itemLeft{
      display:flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }
    .itemName{
      font-weight: 950;
      letter-spacing: -0.3px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 520px;
    }
    .itemMeta{
      color: rgba(255,255,255,.65);
      font-size: 13px;
      line-height: 1.35;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.15);
      font-size: 12px;
      font-weight: 900;
      width: fit-content;
    }
    .badge.ok{ color: var(--ok); border-color: rgba(32,201,151,.35); background: rgba(32,201,151,.10); }
    .badge.warn{ color: var(--warn); border-color: rgba(255,204,0,.35); background: rgba(255,204,0,.10); }
    .badge.err{ color: var(--danger); border-color: rgba(255,77,79,.35); background: rgba(255,77,79,.10); }

    .toast{
      position: fixed;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 99999;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(15,17,22,.92);
      color: rgba(255,255,255,.92);
      font-weight: 950;
      letter-spacing: -0.4px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      min-width: min(520px, calc(100% - 24px));
      text-align:center;
      user-select:none;
      cursor:pointer;
    }
    .toast.show{ display:flex; }
    .toast.ok{ border-color: rgba(32,201,151,.55); background: rgba(32,201,151,.16); color: var(--ok); }
    .toast.err{ border-color: rgba(255,77,79,.55); background: rgba(255,77,79,.16); color: var(--danger); }

    @media (max-width: 520px){
      .triplet{ grid-template-columns: 1fr; }
      .bigCard .v{ font-size: 38px; }
      .decision{ font-size: 32px; }
    }
    @media (max-width: 420px){
      .title{ font-size: 22px; }
      .btn-secondary{ flex: 1 1 100%; }
      .decision{ font-size: 30px; }
    }

    /* Date picker modal */
    .modalBack{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.65);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 14px;
      z-index: 9999;
    }
    .modalBack.show{ display:flex; }
    .modal{
      width: min(420px, 100%);
      background: #0f1116;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
    }
    .modalTop{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .topLeft{
      display:flex;
      align-items: baseline;
      gap: 10px;
    }
    .yearBtn{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 950;
      cursor: pointer;
      font-size: 14px;
    }
    .monthLabel{
      font-size: 14px;
      color: rgba(255,255,255,.75);
      font-weight: 900;
      letter-spacing: -0.2px;
    }
    .navBtns{
      display:flex;
      gap: 8px;
    }
    .iconBtn{
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .modalBody{ padding: 12px 12px 6px; }
    .dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      padding: 0 2px 8px;
      color: rgba(255,255,255,.45);
      font-size: 12px;
      text-align: center;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      padding: 0 2px 10px;
    }
    .dayCell{
      height: 42px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.85);
      font-weight: 900;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .dayCell.mute{ opacity: .25; cursor: default; }
    .dayCell.sel{
      border-color: rgba(32,201,151,.65);
      background: rgba(32,201,151,.12);
      color: var(--ok);
    }
    .yearGrid{
      display:none;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      padding: 12px 12px 14px;
    }
    .yearGrid.show{ display:grid; }
    .yearCell{
      height: 46px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.85);
      font-weight: 950;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .yearCell.sel{
      border-color: rgba(32,201,151,.65);
      background: rgba(32,201,151,.12);
      color: var(--ok);
    }
    .modalBottom{
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex;
      gap: 10px;
      justify-content: space-between;
    }
    .smallBtn{
      flex: 1;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 900;
      padding: 12px 12px;
      cursor:pointer;
      min-height: 46px;
      font-size: 14px;
    }
    .smallBtn.primary{
      border-color: rgba(32,201,151,.55);
      background: rgba(32,201,151,.10);
      color: var(--ok);
    }
  </style>
</head>
<body>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <div class="wrap">
    <div class="header">
      <h1 class="title">Check Your Cosmetic Freshness</h1>
      <p class="sub">Photo is optional. You can tap a PAO button below to calculate instantly.</p>
    </div>

    <div class="card">
      <input id="imageCamera" type="file" accept="image/*" capture="environment" style="display:none" />
      <input id="imageGallery" type="file" accept="image/*" style="display:none" />

      <div class="row">
        <button id="btnCamera" class="btn-secondary" type="button">Take Photo</button>
        <button id="btnGallery" class="btn-secondary" type="button">Upload Photo</button>
        <button id="btnOcr" class="btn-secondary" type="button" disabled>Detect PAO (Retry)</button>
      </div>

      <div id="openedBtn" class="fieldBtn" role="button" aria-label="Opened date">
        <div class="left">
          <div class="label">Opened date</div>
          <div id="openedValue" class="value">-</div>
        </div>
        <div class="chev">›</div>
      </div>

      <div class="panel">
        <div class="photoBox">
          <div id="photoLoader" class="photoLoader">
            <div class="spin"></div>
            <div class="t">Analyzing photo...</div>
          </div>
          <img id="imgPreview" alt="preview" />
          <div id="imgPlaceholder">No photo selected (optional)</div>
        </div>
        <div class="footer">Photo (optional)</div>
      </div>

      <div id="decision" class="decision"></div>

      <div id="triplet" class="triplet">
        <div class="bigCard">
          <div class="k">PAO</div>
          <div id="vPao" class="v">-</div>
        </div>
        <div class="bigCard">
          <div class="k">Days left</div>
          <div id="vDays" class="v">-</div>
        </div>
        <div class="bigCard">
          <div class="k">Toss at</div>
          <div id="vToss" class="v">-</div>
        </div>
      </div>

      <div class="paoArea">
        <p class="paoHint">Choose PAO (months after opening)</p>
        <div id="paoGrid" class="paoGrid"></div>
      </div>

      <div id="status" class="status"></div>

      <div class="shelf">
        <div class="shelfTop">
          <div class="shelfTitle">My Shelf</div>
          <button id="btnClearShelf" class="tinyBtn" type="button">Clear</button>
        </div>

        <div class="shelfAdd">
          <input id="productName" class="input" placeholder="Product name (optional)" />
          <button id="btnAddShelf" class="tinyBtn" type="button" disabled>Add to My Shelf</button>
        </div>

        <div id="shelfList" class="shelfList"></div>
      </div>
    </div>
  </div>

  <div id="dpBack" class="modalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Date picker">
      <div class="modalTop">
        <div class="topLeft">
          <button id="dpYearBtn" class="yearBtn" type="button">2026</button>
          <div id="dpMonthLabel" class="monthLabel">January</div>
        </div>
        <div class="navBtns">
          <button id="dpPrev" class="iconBtn" type="button" aria-label="Previous">‹</button>
          <button id="dpNext" class="iconBtn" type="button" aria-label="Next">›</button>
        </div>
      </div>

      <div class="modalBody">
        <div id="dpDow" class="dow"></div>
        <div id="dpGrid" class="grid"></div>
        <div id="dpYearGrid" class="yearGrid"></div>
      </div>

      <div class="modalBottom">
        <button id="dpToday" class="smallBtn" type="button">Today</button>
        <button id="dpCancel" class="smallBtn" type="button">Cancel</button>
        <button id="dpSet" class="smallBtn primary" type="button">Set</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://skinguard.ohryee.workers.dev";
    const OCR_ENDPOINT = API_BASE + "/ocr-pao";
    const FRESHNESS_ENDPOINT = API_BASE + "/freshness";

    const PAO_CHOICES = [3, 6, 9, 12, 18, 24, 36];

    const $toast = document.getElementById("toast");

    const $imageCamera = document.getElementById("imageCamera");
    const $imageGallery = document.getElementById("imageGallery");
    const $btnCamera = document.getElementById("btnCamera");
    const $btnGallery = document.getElementById("btnGallery");
    const $btnOcr = document.getElementById("btnOcr");

    const $openedBtn = document.getElementById("openedBtn");
    const $openedValue = document.getElementById("openedValue");

    const $imgPreview = document.getElementById("imgPreview");
    const $imgPlaceholder = document.getElementById("imgPlaceholder");
    const $photoLoader = document.getElementById("photoLoader");

    const $decision = document.getElementById("decision");
    const $triplet = document.getElementById("triplet");
    const $vPao = document.getElementById("vPao");
    const $vDays = document.getElementById("vDays");
    const $vToss = document.getElementById("vToss");

    const $status = document.getElementById("status");
    const $paoGrid = document.getElementById("paoGrid");

    const $productName = document.getElementById("productName");
    const $btnAddShelf = document.getElementById("btnAddShelf");
    const $btnClearShelf = document.getElementById("btnClearShelf");
    const $shelfList = document.getElementById("shelfList");

    // date picker elements
    const $dpBack = document.getElementById("dpBack");
    const $dpYearBtn = document.getElementById("dpYearBtn");
    const $dpMonthLabel = document.getElementById("dpMonthLabel");
    const $dpPrev = document.getElementById("dpPrev");
    const $dpNext = document.getElementById("dpNext");
    const $dpDow = document.getElementById("dpDow");
    const $dpGrid = document.getElementById("dpGrid");
    const $dpYearGrid = document.getElementById("dpYearGrid");
    const $dpToday = document.getElementById("dpToday");
    const $dpCancel = document.getElementById("dpCancel");
    const $dpSet = document.getElementById("dpSet");

    const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const DOW = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

    let selectedFile = null;
    let previewUrl = null;
    let ocrBusy = false;

    let selectedPao = null;
    let openedDate = "";

    let currentResult = null;

    let dpMode = "day"; // "day" | "year"
    let dpViewYear = 0;
    let dpViewMonth = 0; // 0-11
    let dpSelected = ""; // YYYY-MM-DD
    let dpYearPageStart = 0;

    const SHELF_KEY = "skinguard_shelf_v1";

    function pad2(n){ return String(n).padStart(2,"0"); }

    function todayLocalYYYYMMDD(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }

    function setStatus(msg, type){
      $status.className = "status show" + (type ? (" " + type) : "");
      $status.textContent = msg;
    }
    function hideStatus(){
      $status.className = "status";
      $status.textContent = "";
    }

    function showLoader(show){
      $photoLoader.classList.toggle("show", !!show);
    }

    function hideDecision(){
      $decision.className = "decision";
      $decision.textContent = "";
    }
    function setDecisionSafe(){
      $decision.className = "decision show ok";
      $decision.textContent = "SAFE TO USE";
    }
    function setDecisionToss(){
      $decision.className = "decision show err";
      $decision.textContent = "TOSS IT";
    }

    function toast(text, type){
      $toast.className = "toast show" + (type ? (" " + type) : "");
      $toast.textContent = text;
      let killed = false;

      const kill = () => {
        if (killed) return;
        killed = true;
        $toast.className = "toast";
        $toast.textContent = "";
        $toast.onclick = null;
      };

      $toast.onclick = kill;
      setTimeout(kill, 1500);
    }

    function showTriplet(){
      $triplet.style.display = "grid";
    }

    function showSelected(months){
      selectedPao = months;
      showTriplet();
      $vPao.textContent = months + "M";
      $vDays.textContent = "-";
      $vToss.textContent = "-";

      document.querySelectorAll(".paoBtn").forEach(btn => {
        const m = Number(btn.dataset.m);
        btn.classList.toggle("active", m === months);
      });
    }

    function setFreshnessValues(daysLeft, tossAt){
      showTriplet();
      $vDays.textContent = Number.isFinite(daysLeft) ? String(daysLeft) : "-";
      $vToss.textContent = tossAt ? String(tossAt) : "-";
    }

    async function fetchWithTimeout(url, options, timeoutMs = 20000){
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeoutMs);
      try{
        return await fetch(url, { ...options, signal: controller.signal, cache: "no-store" });
      } finally {
        clearTimeout(id);
      }
    }

    function fileToPayload(file, maxW = 1400, quality = 0.85) {
      return new Promise((resolve, reject) => {
        if (!file) return reject(new Error("no file"));
        const fr = new FileReader();
        fr.onerror = () => reject(new Error("FileReader error"));
        fr.onload = () => {
          const dataUrl = String(fr.result || "");
          const img = new Image();
          img.onerror = () => reject(new Error("image decode error"));
          img.onload = () => {
            const w = img.naturalWidth || img.width || 1;
            const h = img.naturalHeight || img.height || 1;
            const scale = Math.min(1, maxW / w);
            const tw = Math.max(1, Math.round(w * scale));
            const th = Math.max(1, Math.round(h * scale));

            const canvas = document.createElement("canvas");
            canvas.width = tw;
            canvas.height = th;
            const ctx = canvas.getContext("2d");
            if (!ctx) return reject(new Error("canvas ctx error"));
            ctx.drawImage(img, 0, 0, tw, th);

            const outMime = "image/jpeg";
            const outDataUrl = canvas.toDataURL(outMime, quality);
            const base64 = outDataUrl.split(",")[1] || "";
            resolve({ imageBase64: base64, mimeType: outMime, width: tw, height: th });
          };
          img.src = dataUrl;
        };
        fr.readAsDataURL(file);
      });
    }

    function humanScanErrorMessage(status){
      if (status === 429) return "Too many requests right now. Please try again.";
      if (status >= 500) return "Service is temporarily unavailable. Please try again.";
      if (status === 413) return "Photo is too large. Please retake closer.";
      if (status === 400) return "Couldn’t read this photo. Please retake (closer, brighter).";
      return "Couldn’t analyze this photo. Please try again.";
    }

    function buildPaoButtons(){
      $paoGrid.innerHTML = "";
      PAO_CHOICES.forEach(m => {
        const btn = document.createElement("button");
        btn.className = "paoBtn";
        btn.textContent = `${m}M`;
        btn.dataset.m = String(m);
        btn.addEventListener("click", async () => {
          hideStatus();
          hideDecision();
          currentResult = null;
          $btnAddShelf.disabled = true;

          showSelected(m);
          setStatus("Calculating freshness...", "");
          await runFreshness(m);
        });
        $paoGrid.appendChild(btn);
      });
    }

    function setPhotoPreview(file){
      if (previewUrl) URL.revokeObjectURL(previewUrl);
      previewUrl = URL.createObjectURL(file);
      $imgPreview.src = previewUrl;
      $imgPreview.style.display = "block";
      $imgPlaceholder.style.display = "none";
    }

    async function runFreshness(paoMonths){
      const od = (openedDate || "").trim() || todayLocalYYYYMMDD();

      try{
        showLoader(false);
        const res = await fetchWithTimeout(FRESHNESS_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paoMonths, openedDate: od }),
        }, 15000);

        if (!res.ok){
          hideDecision();
          setStatus("Couldn’t check freshness right now. Please try again.", "warn");
          currentResult = null;
          $btnAddShelf.disabled = true;
          return;
        }

        const data = await res.json().catch(() => ({}));
        const daysLeft = Number.isFinite(Number(data?.daysLeft)) ? Number(data.daysLeft) : null;
        const tossAt = typeof data?.tossAt === "string" ? data.tossAt : "";

        setFreshnessValues(daysLeft, tossAt);

        const status = data?.status;
        if (status === "TOSS"){
          setDecisionToss();
          hideStatus();
          toast("TOSS IT", "err");
        } else {
          setDecisionSafe();
          hideStatus();
          toast("SAFE TO USE", "ok");
        }

        currentResult = {
          status: String(status || "OK"),
          paoMonths,
          openedDate: od,
          tossAt: tossAt || "",
          daysLeft: Number.isFinite(daysLeft) ? daysLeft : null,
          updatedAt: Date.now(),
        };
        $btnAddShelf.disabled = false;

      } catch(e){
        hideDecision();
        setStatus("Freshness check failed. Please try again.", "warn");
        currentResult = null;
        $btnAddShelf.disabled = true;
      }
    }

    async function runOcr(){
      if (ocrBusy) return;
      if (!selectedFile){
        setStatus("No photo selected. Tap a PAO button below.", "warn");
        return;
      }

      ocrBusy = true;
      $btnOcr.disabled = true;
      hideDecision();
      currentResult = null;
      $btnAddShelf.disabled = true;

      showLoader(true);
      setStatus("Reading PAO mark from photo...", "");

      try{
        const payload = await fileToPayload(selectedFile, 1100, 0.75);

        const res = await fetchWithTimeout(OCR_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        }, 25000);

        showLoader(false);

        if (!res.ok){
          let detail = {};
          try { detail = await res.json(); } catch(e) {}
          const extra =
            (detail?.usingModel ? ` (model ${detail.usingModel})` : "") +
            (detail?.upstreamStatus ? ` (upstream ${detail.upstreamStatus})` : "");
          setStatus(humanScanErrorMessage(res.status) + extra + " Tap a PAO button below.", "warn");
          return;
        }

        const data = await res.json().catch(() => ({}));
        const pao = Array.isArray(data?.paoCandidates) ? data.paoCandidates : [];

        if (pao.length === 1){
          const m = Number(pao[0]);
          showSelected(m);
          hideStatus();
          await runFreshness(m);
          return;
        }

        if (pao.length > 1){
          setStatus(`Multiple candidates detected (${pao.join(", ")}). Tap the correct one below.`, "warn");
          return;
        }

        setStatus("Couldn’t find a PAO mark. Tap a PAO button below.", "warn");
      } catch(e){
        showLoader(false);
        setStatus("Couldn’t analyze this photo. Tap a PAO button below.", "warn");
      } finally{
        ocrBusy = false;
        $btnOcr.disabled = !selectedFile;
      }
    }

    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    $btnCamera.addEventListener("click", () => {
      if (isMobile) {
        $imageCamera.value = "";
        $imageCamera.click();
      } else {
        $imageGallery.value = "";
        $imageGallery.click();
      }
    });

    $btnGallery.addEventListener("click", () => {
      $imageGallery.value = "";
      $imageGallery.click();
    });

    function onPickedFile(f){
      if (!f) return;
      selectedFile = f;
      setPhotoPreview(f);
      $btnOcr.disabled = false;

      hideDecision();
      hideStatus();
      runOcr();
    }

    $imageCamera.addEventListener("change", (e) => onPickedFile(e.target.files?.[0]));
    $imageGallery.addEventListener("change", (e) => onPickedFile(e.target.files?.[0]));

    $btnOcr.addEventListener("click", runOcr);

    /* Shelf (localStorage) */

    function uid(){
      if (crypto && crypto.randomUUID) return crypto.randomUUID();
      return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now();
    }

    function readShelf(){
      try{
        const raw = localStorage.getItem(SHELF_KEY);
        const arr = JSON.parse(raw || "[]");
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function writeShelf(items){
      localStorage.setItem(SHELF_KEY, JSON.stringify(items || []));
    }

    function statusBadgeClass(s){
      if (s === "TOSS") return "err";
      if (s === "WARN") return "warn";
      return "ok";
    }

    function statusLabel(s){
      if (s === "TOSS") return "TOSS";
      if (s === "WARN") return "SOON";
      return "SAFE";
    }

    function renderShelf(){
      const items = readShelf().sort((a,b) => (b?.updatedAt||0) - (a?.updatedAt||0));
      $shelfList.innerHTML = "";

      if (items.length === 0){
        const empty = document.createElement("div");
        empty.style.color = "rgba(255,255,255,.45)";
        empty.style.fontSize = "13px";
        empty.style.padding = "8px 2px 2px";
        empty.textContent = "No saved items yet.";
        $shelfList.appendChild(empty);
        return;
      }

      items.forEach(it => {
        const row = document.createElement("div");
        row.className = "item";

        const left = document.createElement("div");
        left.className = "itemLeft";

        const name = document.createElement("div");
        name.className = "itemName";
        name.textContent = it?.name || "Unnamed product";

        const badge = document.createElement("div");
        badge.className = "badge " + statusBadgeClass(it?.status);
        badge.textContent = statusLabel(it?.status);

        const meta = document.createElement("div");
        meta.className = "itemMeta";
        meta.textContent =
          `Opened: ${it?.openedDate || "-"} · PAO: ${(it?.paoMonths||"-")}M · Toss: ${it?.tossAt || "-"} · Days left: ${Number.isFinite(it?.daysLeft) ? it.daysLeft : "-"}`;

        left.appendChild(name);
        left.appendChild(badge);
        left.appendChild(meta);

        const del = document.createElement("button");
        del.className = "tinyBtn";
        del.textContent = "Delete";
        del.onclick = () => {
          const next = readShelf().filter(x => x?.id !== it?.id);
          writeShelf(next);
          renderShelf();
        };

        row.appendChild(left);
        row.appendChild(del);
        $shelfList.appendChild(row);
      });
    }

    $btnAddShelf.addEventListener("click", () => {
      if (!currentResult){
        setStatus("No result to save yet.", "warn");
        return;
      }
      const name = String($productName.value || "").trim();
      const items = readShelf();

      items.unshift({
        id: uid(),
        name: name || "",
        status: currentResult.status,
        paoMonths: currentResult.paoMonths,
        openedDate: currentResult.openedDate,
        tossAt: currentResult.tossAt,
        daysLeft: currentResult.daysLeft,
        updatedAt: Date.now(),
      });

      writeShelf(items.slice(0, 200)); // cap
      $productName.value = "";
      renderShelf();
      toast("Saved to My Shelf", "ok");
    });

    $btnClearShelf.addEventListener("click", () => {
      writeShelf([]);
      renderShelf();
      toast("Shelf cleared", "");
    });

    /* Custom date picker */

    function parseYYYYMMDD(s){
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(s||"").trim());
      if (!m) return null;
      const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
      if (y < 1900 || y > 2100) return null;
      if (mo < 1 || mo > 12) return null;
      if (d < 1 || d > 31) return null;
      const dt = new Date(y, mo-1, d);
      if (dt.getFullYear() !== y || dt.getMonth() !== mo-1 || dt.getDate() !== d) return null;
      return { y, mo, d };
    }

    function daysInMonth(y, m0){
      return new Date(y, m0+1, 0).getDate();
    }

    function openDatePicker(){
      const base = parseYYYYMMDD(openedDate) || parseYYYYMMDD(todayLocalYYYYMMDD());
      dpSelected = openedDate || todayLocalYYYYMMDD();
      dpViewYear = base.y;
      dpViewMonth = base.mo - 1;
      dpMode = "day";
      dpYearPageStart = Math.floor(dpViewYear / 12) * 12;

      renderDatePicker();
      $dpBack.classList.add("show");
      $dpBack.setAttribute("aria-hidden","false");
    }

    function closeDatePicker(){
      $dpBack.classList.remove("show");
      $dpBack.setAttribute("aria-hidden","true");
    }

    function renderDatePicker(){
      $dpYearBtn.textContent = String(dpViewYear);
      $dpMonthLabel.textContent = MONTHS[dpViewMonth];

      $dpDow.innerHTML = "";
      DOW.forEach(w => {
        const div = document.createElement("div");
        div.textContent = w;
        $dpDow.appendChild(div);
      });

      if (dpMode === "year"){
        $dpDow.style.display = "none";
        $dpGrid.style.display = "none";
        $dpYearGrid.classList.add("show");
        renderYearGrid();
        return;
      }

      $dpDow.style.display = "grid";
      $dpGrid.style.display = "grid";
      $dpYearGrid.classList.remove("show");
      renderDayGrid();
    }

    function renderDayGrid(){
      $dpGrid.innerHTML = "";

      const first = new Date(dpViewYear, dpViewMonth, 1);
      const startDow = first.getDay();
      const dim = daysInMonth(dpViewYear, dpViewMonth);

      const sel = parseYYYYMMDD(dpSelected);
      const selKey = sel ? `${sel.y}-${pad2(sel.mo)}-${pad2(sel.d)}` : "";

      for (let i=0; i<startDow; i++){
        const cell = document.createElement("div");
        cell.className = "dayCell mute";
        cell.textContent = "";
        $dpGrid.appendChild(cell);
      }

      for (let d=1; d<=dim; d++){
        const key = `${dpViewYear}-${pad2(dpViewMonth+1)}-${pad2(d)}`;
        const cell = document.createElement("div");
        cell.className = "dayCell" + (key === selKey ? " sel" : "");
        cell.textContent = String(d);
        cell.addEventListener("click", () => {
          dpSelected = key;
          renderDatePicker();
        });
        $dpGrid.appendChild(cell);
      }

      const totalCells = startDow + dim;
      const pad = (7 - (totalCells % 7)) % 7;
      for (let i=0; i<pad; i++){
        const cell = document.createElement("div");
        cell.className = "dayCell mute";
        cell.textContent = "";
        $dpGrid.appendChild(cell);
      }
    }

    function renderYearGrid(){
      $dpYearGrid.innerHTML = "";
      const start = dpYearPageStart;
      const count = 12;

      for (let i=0; i<count; i++){
        const y = start + i;
        const cell = document.createElement("div");
        cell.className = "yearCell" + (y === dpViewYear ? " sel" : "");
        cell.textContent = String(y);
        cell.addEventListener("click", () => {
          dpViewYear = y;
          dpMode = "day";
          renderDatePicker();
        });
        $dpYearGrid.appendChild(cell);
      }
    }

    $dpYearBtn.addEventListener("click", () => {
      dpMode = (dpMode === "year") ? "day" : "year";
      renderDatePicker();
    });

    $dpPrev.addEventListener("click", () => {
      if (dpMode === "year"){
        dpYearPageStart -= 12;
        renderDatePicker();
        return;
      }
      dpViewMonth -= 1;
      if (dpViewMonth < 0){
        dpViewMonth = 11;
        dpViewYear -= 1;
      }
      renderDatePicker();
    });

    $dpNext.addEventListener("click", () => {
      if (dpMode === "year"){
        dpYearPageStart += 12;
        renderDatePicker();
        return;
      }
      dpViewMonth += 1;
      if (dpViewMonth > 11){
        dpViewMonth = 0;
        dpViewYear += 1;
      }
      renderDatePicker();
    });

    $dpCancel.addEventListener("click", closeDatePicker);

    function applyOpenedDateAndRecalc(){
      openedDate = dpSelected || todayLocalYYYYMMDD();
      $openedValue.textContent = openedDate;
      closeDatePicker();

      if (selectedPao){
        hideStatus();
        setStatus("Updating freshness...", "");
        runFreshness(selectedPao);
      }
    }

    $dpToday.addEventListener("click", () => {
      dpSelected = todayLocalYYYYMMDD();
      const p = parseYYYYMMDD(dpSelected);
      dpViewYear = p.y;
      dpViewMonth = p.mo - 1;
      dpMode = "day";
      renderDatePicker();
      applyOpenedDateAndRecalc();
    });

    $dpSet.addEventListener("click", () => {
      if (!parseYYYYMMDD(dpSelected)){
        dpSelected = todayLocalYYYYMMDD();
      }
      applyOpenedDateAndRecalc();
    });

    $dpBack.addEventListener("click", (e) => {
      if (e.target === $dpBack) closeDatePicker();
    });

    $openedBtn.addEventListener("click", openDatePicker);

    // init
    openedDate = todayLocalYYYYMMDD();
    $openedValue.textContent = openedDate;
    buildPaoButtons();
    renderShelf();
  </script>
</body>
</html>
