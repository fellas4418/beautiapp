<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Keep or Toss</title>
  <meta name="theme-color" content="#0b0c10" />
  <style>
    :root{
      --bg:#0b0c10;
      --card:#111318;
      --card2:#0f1116;
      --text:#e8e8ea;
      --muted:#a8abb4;
      --border:rgba(255,255,255,.10);
      --btn:#2b6cff;
      --btn2:#1f2430;
      --danger:#ff4d4f;
      --warn:#ffcc00;
      --ok:#20c997;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 70% -10%, rgba(43,108,255,.18), transparent 60%),
                  radial-gradient(900px 600px at 0% 20%, rgba(32,201,151,.12), transparent 55%),
                  var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    .wrap{ max-width: 460px; margin: 0 auto; padding: 14px 14px 40px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin: 4px 0 10px; }
    .title{ font-size: 22px; font-weight: 800; letter-spacing: .2px; margin:0; }
    .sub{ margin: 2px 0 0; color: var(--muted); font-size: 12px; }
    .btn{
      appearance:none;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 700;
      cursor:pointer;
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ border: none; background: linear-gradient(180deg, rgba(43,108,255,1), rgba(43,108,255,.85)); }
    .btn.ghost{ background: transparent; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .fileRow{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,.15);
    }
    .fileName{
      color: var(--muted);
      font-size: 12px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 230px;
    }
    input[type="file"]{ display:none; }
    .previewWrap{ padding: 12px; }
    .preview{
      width:100%;
      border-radius: 14px;
      display:block;
      background: #0a0b0f;
      border: 1px solid rgba(255,255,255,.08);
      max-height: 520px;
      object-fit: contain;
    }
    .form{ padding: 0 12px 12px; display:grid; gap: 10px; }
    .fieldLabel{ font-size: 12px; color: var(--muted); margin: 0 0 6px; }
    .input{
      width:100%;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 10px;
      outline:none;
      font-size: 14px;
    }
    .input:focus{ border-color: rgba(43,108,255,.65); box-shadow: 0 0 0 3px rgba(43,108,255,.18); }
    .paoGrid{ display:grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .paoBtn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 0;
      font-weight: 800;
      cursor:pointer;
      user-select:none;
    }
    .paoBtn.active{
      outline: 2px solid rgba(32,201,151,.9);
      background: rgba(32,201,151,.12);
      border-color: rgba(32,201,151,.35);
    }
    .statusLine{
      font-size: 13px;
      font-weight: 800;
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height: 42px;
    }
    .statusLine .left{ display:flex; gap:10px; align-items:center; min-width: 0; }
    .pill{
      font-size: 11px;
      font-weight: 900;
      padding: 5px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      white-space: nowrap;
    }
    .pill.ok{ color: var(--ok); border-color: rgba(32,201,151,.35); background: rgba(32,201,151,.10); }
    .pill.warn{ color: var(--warn); border-color: rgba(255,204,0,.35); background: rgba(255,204,0,.10); }
    .pill.err{ color: var(--danger); border-color: rgba(255,77,79,.35); background: rgba(255,77,79,.10); }
    .muted{ color: var(--muted); font-weight: 600; font-size: 12px; }
    .actions{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .help{ font-size: 12px; color: var(--muted); line-height: 1.35; margin-top: 2px; }
    .shelfCard{
      margin-top: 12px;
      background: rgba(0,0,0,.14);
      border-top: 1px solid var(--border);
      padding: 12px;
    }
    .shelfHeader{ display:flex; align-items:center; justify-content:space-between; margin-bottom: 10px; }
    .shelfTitle{ font-weight: 900; margin:0; }
    .count{ color: var(--muted); font-size: 12px; font-weight: 700; }
    .group{ margin-top: 12px; }
    .groupTop{ display:flex; align-items:center; gap:10px; margin-bottom: 8px; }
    .groupName{ font-weight: 900; margin:0; font-size: 13px; }
    .divider{ height:1px; background: rgba(255,255,255,.08); flex:1; }
    .item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      border-radius: 14px;
      padding: 10px;
      display:grid;
      gap: 8px;
      margin-bottom: 8px;
    }
    .itemTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .itemName{ font-weight: 900; font-size: 14px; overflow:hidden; text-overflow:ellipsis; white-space: nowrap; }
    .itemMeta{ color: var(--muted); font-size: 12px; line-height: 1.35; }
    .thumb{
      width:100%;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08);
      background: #0a0b0f;
      max-height: 220px;
      object-fit: cover;
    }
    .miniActions{ display:flex; gap:8px; }
    .miniBtn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      border-radius: 10px;
      padding: 6px 8px;
      font-weight: 800;
      font-size: 12px;
      cursor:pointer;
    }
    @media (max-width: 380px){
      .fileName{ max-width: 180px; }
      .paoGrid{ grid-template-columns: repeat(3, 1fr); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 class="title">Keep or Toss</h1>
        <div class="sub">Photo → local PAO OCR → Toss date → My Shelf</div>
      </div>
      <button class="btn ghost" id="resetAllBtn" type="button">Reset</button>
    </div>

    <div class="card">
      <div class="fileRow">
        <button class="btn primary" id="chooseBtn" type="button">Choose image</button>
        <div class="fileName" id="fileName">No file</div>
        <div style="flex:1"></div>
        <button class="btn" id="clearBtn" type="button">Clear</button>
        <input type="file" id="fileInput" accept="image/*" />
      </div>

      <div class="previewWrap">
        <img id="preview" class="preview" alt="preview" style="display:none" />
      </div>

      <div class="form">
        <div>
          <div class="fieldLabel">Opened</div>
          <input class="input" type="date" id="opened" />
        </div>

        <div>
          <div class="fieldLabel">Name</div>
          <input class="input" type="text" id="name" placeholder="Product name (optional)" />
        </div>

        <div>
          <div class="fieldLabel">PAO</div>
          <div class="paoGrid" id="paoBtns"></div>
        </div>

        <div class="statusLine" id="statusLine">
          <div class="left">
            <span class="pill warn" id="statusPill">WAIT</span>
            <span id="statusText" class="muted">Choose image to auto-detect PAO.</span>
          </div>
          <span id="statusRight" class="muted"></span>
        </div>

        <div class="actions">
          <button class="btn primary" id="addBtn" type="button">Add to Shelf</button>
          <button class="btn" id="clearShelfBtn" type="button">Clear Shelf</button>
        </div>

        <div class="help">
          Tip: “TOSS” items stack on top. Add photos one by one and you’ll immediately see what to throw away first.
        </div>
      </div>

      <div class="shelfCard">
        <div class="shelfHeader">
          <div class="shelfTitle">My Shelf</div>
          <div class="count" id="countText">0 items</div>
        </div>
        <div id="shelf"></div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>

  <script>
    const PAOS = [3,6,9,12,18,24,36];
    const $ = (id) => document.getElementById(id);

    const fileInput = $("fileInput");
    const chooseBtn = $("chooseBtn");
    const clearBtn = $("clearBtn");
    const fileNameEl = $("fileName");
    const preview = $("preview");
    const opened = $("opened");
    const nameInput = $("name");
    const paoBtns = $("paoBtns");
    const statusPill = $("statusPill");
    const statusText = $("statusText");
    const statusRight = $("statusRight");
    const addBtn = $("addBtn");
    const clearShelfBtn = $("clearShelfBtn");
    const resetAllBtn = $("resetAllBtn");
    const shelfEl = $("shelf");
    const countText = $("countText");

    let selectedPAO = null;
    let lastImageDataUrl = "";
    let ocrBusy = false;

    const LS_KEY = "keepOrTossShelf_v1";
    let shelf = loadShelf();

    function pad2(n){ return String(n).padStart(2,"0"); }
    function isoDate(d){ return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); }
    function todayISO(){ return isoDate(new Date()); }
    opened.value = todayISO();

    function addMonths(dateStr, months){
      const [y,m,d] = dateStr.split("-").map(Number);
      const dt = new Date(y, m-1, d);
      const targetMonth = dt.getMonth() + months;
      dt.setMonth(targetMonth);
      while (dt.getMonth() !== (targetMonth % 12 + 12) % 12) dt.setDate(dt.getDate() - 1);
      return dt;
    }
    function diffDays(a, b){ return Math.floor((a.getTime() - b.getTime()) / 86400000); }

    function getStatus(openedISO, paoMonths){
      const tossDate = addMonths(openedISO, paoMonths);
      const today = new Date();
      const daysLeft = diffDays(tossDate, today);
      if (daysLeft < 0) return { key:"toss", label:"TOSS", cls:"err", tossDate, daysLeft };
      if (daysLeft <= 30) return { key:"soon", label:"USE SOON", cls:"warn", tossDate, daysLeft };
      return { key:"safe", label:"SAFE", cls:"ok", tossDate, daysLeft };
    }

    function setStatus(pillText, pillCls, text, right=""){
      statusPill.className = "pill " + pillCls;
      statusPill.textContent = pillText;
      statusText.textContent = text;
      statusRight.textContent = right;
    }

    function renderPAOButtons(){
      paoBtns.innerHTML = "";
      PAOS.forEach((m)=>{
        const b = document.createElement("button");
        b.type = "button";
        b.className = "paoBtn";
        b.textContent = m + "M";
        b.addEventListener("click", ()=>{
          selectPAO(m);
          updateResultLine();
        });
        paoBtns.appendChild(b);
      });
    }

    function selectPAO(m){
      selectedPAO = m;
      [...paoBtns.children].forEach((b)=>{
        b.classList.toggle("active", b.textContent === (m+"M"));
      });
    }

    function updateResultLine(){
      if (!opened.value || !selectedPAO){
        setStatus("WAIT","warn","Pick PAO and date.","");
        return;
      }
      const st = getStatus(opened.value, selectedPAO);
      const tossISO = isoDate(st.tossDate);
      const right = "Toss at " + tossISO;

      if (st.key === "toss") setStatus("TOSS","err","Expired. Throw it away.", right);
      else if (st.key === "soon") setStatus("SOON","warn","Use it soon.", right);
      else setStatus("SAFE","ok","Safe to use.", right);
    }

    opened.addEventListener("change", updateResultLine);

    chooseBtn.addEventListener("click", ()=> fileInput.click());

    clearBtn.addEventListener("click", ()=>{
      fileInput.value = "";
      fileNameEl.textContent = "No file";
      preview.style.display = "none";
      preview.src = "";
      lastImageDataUrl = "";
      selectedPAO = null;
      [...paoBtns.children].forEach(b=> b.classList.remove("active"));
      setStatus("WAIT","warn","Choose image to auto-detect PAO.","");
      statusRight.textContent = "";
    });

    resetAllBtn.addEventListener("click", ()=>{
      clearBtn.click();
      nameInput.value = "";
      opened.value = todayISO();
      updateResultLine();
    });

    clearShelfBtn.addEventListener("click", ()=>{
      shelf = [];
      saveShelf();
      renderShelf();
    });

    addBtn.addEventListener("click", ()=>{
      if (!lastImageDataUrl){
        setStatus("WAIT","warn","Choose an image first.","");
        return;
      }
      if (!opened.value || !selectedPAO){
        setStatus("WAIT","warn","Pick PAO and date first.","");
        return;
      }

      const st = getStatus(opened.value, selectedPAO);
      const item = {
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2),
        name: (nameInput.value || "").trim() || "Untitled",
        openedAt: opened.value,
        pao: selectedPAO,
        tossAt: isoDate(st.tossDate),
        status: st.key,
        createdAt: Date.now(),
        img: lastImageDataUrl
      };

      shelf.unshift(item);
      saveShelf();
      renderShelf();
    });

    function loadShelf(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }
    function saveShelf(){ localStorage.setItem(LS_KEY, JSON.stringify(shelf)); }

    function sortShelfForUX(items){
      const rank = { toss:0, soon:1, safe:2 };
      return [...items].sort((a,b)=>{
        const ra = rank[a.status] ?? 9;
        const rb = rank[b.status] ?? 9;
        if (ra !== rb) return ra - rb;
        if (a.tossAt !== b.tossAt) return a.tossAt.localeCompare(b.tossAt);
        return (b.createdAt||0) - (a.createdAt||0);
      });
    }
    function groupByStatus(items){
      const g = { toss: [], soon: [], safe: [] };
      items.forEach(it=>{
        if (it.status === "toss") g.toss.push(it);
        else if (it.status === "soon") g.soon.push(it);
        else g.safe.push(it);
      });
      return g;
    }

    function renderShelf(){
      const items = sortShelfForUX(shelf);
      countText.textContent = items.length + " items";
      const g = groupByStatus(items);
      shelfEl.innerHTML = "";

      const groups = [
        { key:"toss", label:"Throw away first", pill:"TOSS", cls:"err" },
        { key:"soon", label:"Use soon", pill:"SOON", cls:"warn" },
        { key:"safe", label:"Safe to use", pill:"SAFE", cls:"ok" },
      ];

      groups.forEach(gr=>{
        const arr = g[gr.key];
        const wrap = document.createElement("div");
        wrap.className = "group";

        const top = document.createElement("div");
        top.className = "groupTop";

        const pill = document.createElement("span");
        pill.className = "pill " + gr.cls;
        pill.textContent = gr.pill;

        const name = document.createElement("div");
        name.className = "groupName";
        name.textContent = gr.label + " (" + arr.length + ")";

        const div = document.createElement("div");
        div.className = "divider";

        top.appendChild(pill);
        top.appendChild(name);
        top.appendChild(div);
        wrap.appendChild(top);

        if (arr.length === 0){
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.style.padding = "6px 2px 2px";
          empty.textContent = "No items.";
          wrap.appendChild(empty);
        } else {
          arr.forEach(it=>{
            const card = document.createElement("div");
            card.className = "item";

            const top2 = document.createElement("div");
            top2.className = "itemTop";

            const nm = document.createElement("div");
            nm.className = "itemName";
            nm.textContent = it.name;

            const right = document.createElement("div");
            right.className = "miniActions";

            const useBtn = document.createElement("button");
            useBtn.type = "button";
            useBtn.className = "miniBtn";
            useBtn.textContent = "Use";
            useBtn.addEventListener("click", ()=>{
              lastImageDataUrl = it.img || "";
              if (lastImageDataUrl){
                preview.src = lastImageDataUrl;
                preview.style.display = "block";
              }
              fileNameEl.textContent = "Loaded from shelf";
              opened.value = it.openedAt || todayISO();
              nameInput.value = it.name === "Untitled" ? "" : it.name;
              selectPAO(it.pao || null);
              updateResultLine();
              window.scrollTo({ top: 0, behavior: "smooth" });
            });

            const delBtn = document.createElement("button");
            delBtn.type = "button";
            delBtn.className = "miniBtn";
            delBtn.textContent = "Delete";
            delBtn.addEventListener("click", ()=>{
              shelf = shelf.filter(x=> x.id !== it.id);
              saveShelf();
              renderShelf();
            });

            right.appendChild(useBtn);
            right.appendChild(delBtn);

            top2.appendChild(nm);
            top2.appendChild(right);

            const meta = document.createElement("div");
            meta.className = "itemMeta";
            meta.textContent = it.pao + "M · Opened " + (it.openedAt || "-") + " · Toss at " + (it.tossAt || "-");

            const img = document.createElement("img");
            img.className = "thumb";
            img.alt = "item photo";
            img.src = it.img || "";

            card.appendChild(top2);
            card.appendChild(meta);
            if (it.img) card.appendChild(img);

            wrap.appendChild(card);
          });
        }

        shelfEl.appendChild(wrap);
      });
    }

    renderPAOButtons();
    renderShelf();
    updateResultLine();

    // ---------------------------
    // Local PAO OCR (Tesseract.js)
    // ---------------------------

    function dataURLToImage(dataUrl){
      return new Promise((resolve, reject)=>{
        const img = new Image();
        img.onload = ()=> resolve(img);
        img.onerror = reject;
        img.src = dataUrl;
      });
    }

    function preprocessToCanvas(img, invert=false){
      // 핵심 수정:
      // 상단 중앙만 강하게 크롭 (오검출 방지)
      // - x: 20% ~ 80% (중앙 60%)
      // - y: 0%  ~ 55% (상단 55%)
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d", { willReadFrequently: true });

      const iw = img.naturalWidth || img.width;
      const ih = img.naturalHeight || img.height;

      const sx = Math.floor(iw * 0.20);
      const sy = Math.floor(ih * 0.00);
      const cropW = Math.floor(iw * 0.60);
      const cropH = Math.floor(ih * 0.55);

      const scale = 2.8;
      canvas.width = Math.floor(cropW * scale);
      canvas.height = Math.floor(cropH * scale);

      ctx.drawImage(img, sx, sy, cropW, cropH, 0, 0, canvas.width, canvas.height);

      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const d = imageData.data;

      let sum = 0;
      for (let i=0;i<d.length;i+=4){
        const v = (d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114);
        sum += v;
      }
      const mean = sum / (d.length/4);
      const thr = Math.max(105, Math.min(175, mean * 0.92));

      for (let i=0;i<d.length;i+=4){
        const v = (d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114);
        let out = v < thr ? 0 : 255;
        if (invert) out = 255 - out;
        d[i]=d[i+1]=d[i+2]=out;
        d[i+3]=255;
      }
      ctx.putImageData(imageData, 0, 0);
      return canvas;
    }

    function extractPAOFromText(raw){
      let t = String(raw || "").toUpperCase();
      t = t.replace(/O/g, "0");
      t = t.replace(/G/g, "6");  // 6 자주 G로 나옴
      t = t.replace(/\s+/g, " ").trim();

      // "3M" 같은 정확 토큰 우선
      const exact = t.match(/\b(3|6|9|12|18|24|36)\s*M\b/);
      if (exact) return Number(exact[1]);

      // 백업: 사이에 잡음이 껴도 허용
      const m = t.match(/\b(3|6|9|12|18|24|36)\b[^A-Z0-9]{0,3}M\b/);
      if (m) return Number(m[1]);

      return null;
    }

    async function recognizeCanvas(worker, canvas){
      const { data } = await worker.recognize(canvas);
      return (data && data.text) ? data.text : "";
    }

    async function runLocalPAOOCR(dataUrl){
      if (ocrBusy) return;
      ocrBusy = true;

      try{
        setStatus("OCR","warn","Detecting PAO…","");
        const img = await dataURLToImage(dataUrl);

        const worker = await Tesseract.createWorker("eng", 1, {
          logger: (m)=>{
            if (m && m.status === "recognizing text" && typeof m.progress === "number"){
              statusRight.textContent = Math.round(m.progress * 100) + "%";
            }
          }
        });

        await worker.setParameters({
          tessedit_char_whitelist: "0123456789Mm",
          preserve_interword_spaces: "1",
          tessedit_pageseg_mode: "8" // single word (중요)
        });

        // 1) 일반 이진화
        const canvasA = preprocessToCanvas(img, false);
        const rawA = await recognizeCanvas(worker, canvasA);
        const paoA = extractPAOFromText(rawA);

        // 2) 반전 이진화 (배경/조명에 따라 더 잘 잡힘)
        let rawB = "";
        let paoB = null;
        if (!paoA){
          const canvasB = preprocessToCanvas(img, true);
          rawB = await recognizeCanvas(worker, canvasB);
          paoB = extractPAOFromText(rawB);
        }

        await worker.terminate();

        const pao = paoA || paoB;

        if (pao && PAOS.includes(pao)){
          selectPAO(pao);
          updateResultLine();

          const st = getStatus(opened.value || todayISO(), pao);
          const tossISO = isoDate(st.tossDate);
          if (st.key === "toss") setStatus("TOSS","err","Expired. Throw it away.","Toss at " + tossISO);
          else if (st.key === "soon") setStatus("SOON","warn","Use it soon.","Toss at " + tossISO);
          else setStatus("SAFE","ok","Safe to use.","Toss at " + tossISO);

          // console.log("OCR RAW A:", rawA);
          // console.log("OCR RAW B:", rawB);
        } else {
          setStatus("FAIL","err","PAO not detected. Tap a PAO button manually.","");
          // console.log("OCR RAW A:", rawA);
          // console.log("OCR RAW B:", rawB);
        }
      } catch (e){
        console.error(e);
        setStatus("ERR","err","OCR error. Try another photo or pick PAO manually.","");
      } finally {
        ocrBusy = false;
        statusRight.textContent = "";
      }
    }

    fileInput.addEventListener("change", async (e)=>{
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      fileNameEl.textContent = file.name || "Selected";

      const reader = new FileReader();
      reader.onload = async ()=>{
        lastImageDataUrl = String(reader.result || "");
        preview.src = lastImageDataUrl;
        preview.style.display = "block";

        selectedPAO = null;
        [...paoBtns.children].forEach(b=> b.classList.remove("active"));

        await runLocalPAOOCR(lastImageDataUrl);

        if (!selectedPAO) updateResultLine();
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
