<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PAO Scanner</title>

<style>
body{
  background:#0b0b0b; color:#eee; font-family:-apple-system,sans-serif;
  margin:0; padding:20px; text-align:center;
}
.container{ max-width:420px; margin:auto; }
button{
  padding:14px; border-radius:12px;
  background:#222; color:#fff; border:1px solid #333;
  font-weight:600; width:100%; margin-bottom:10px;
}
.viewer{
  width:100%; aspect-ratio:1; background:#151515;
  border-radius:20px; border:1px solid #222;
  display:flex; align-items:center; justify-content:center;
  margin-bottom:15px;
}
#preview{ width:100%; height:100%; object-fit:contain; display:none; }
#result{ font-size:3rem; font-weight:800; color:#ffcc00; margin-top:10px; }
.manual{ display:none; margin-top:10px; }
.manual button{
  width:23%; margin:1%; font-size:.9rem;
}
</style>
</head>

<body>
<div class="container">
  <h2>Scan PAO</h2>

  <input id="file" type="file" accept="image/*" capture="environment" hidden>
  <button onclick="file.click()">Take / Upload Photo</button>

  <div class="viewer">
    <span id="placeholder">Point at 6M / 12M</span>
    <img id="preview">
  </div>

  <div id="result"></div>

  <div class="manual" id="manual">
    <div style="font-size:.8rem;color:#777;">Select manually</div>
    <button onclick="setManual(3)">3M</button>
    <button onclick="setManual(6)">6M</button>
    <button onclick="setManual(12)">12M</button>
    <button onclick="setManual(24)">24M</button>
  </div>
</div>

<canvas id="canvas" hidden></canvas>

<script>
const worker = new Worker("pao-worker.js");
const file = document.getElementById("file");
const preview = document.getElementById("preview");
const placeholder = document.getElementById("placeholder");
const result = document.getElementById("result");
const manual = document.getElementById("manual");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

file.onchange = () => {
  const f = file.files[0];
  if (!f) return;

  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      const scale = 3;
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;

      ctx.setTransform(scale,0,0,scale,0,0);
      ctx.drawImage(img,0,0);

      // threshold
      const d = ctx.getImageData(0,0,canvas.width,canvas.height);
      for(let i=0;i<d.data.length;i+=4){
        const y = 0.2
