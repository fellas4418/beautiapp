<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KEESS</title>

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

body { 
  background: #fff7f7; 
  color: #1a1a1a; 
  font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", system-ui, sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}

/* ========== SCREEN CONTAINER ========== */
.screen {
  display: none;
  min-height: 100vh;
  transition: opacity 300ms ease, transform 300ms ease;
}

.screen.visible {
  display: block;
  animation: fadeIn 300ms ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ========== HOME SCREEN ========== */
.home-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 24px;
  background: linear-gradient(135deg, #fff7f7 0%, #ffe8e8 100%);
}

.app-logo {
  font-size: 11px;
  letter-spacing: 3px;
  font-weight: 700;
  color: #d4a5a5;
  margin-bottom: 60px;
  text-transform: uppercase;
}

.primary-scan-btn {
  width: 280px;
  height: 280px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ffffff 0%, #fff2f2 100%);
  border: 3px solid #ffd4d4;
  color: #ff4d4f;
  font-size: 18px;
  font-weight: 700;
  letter-spacing: 0.5px;
  cursor: pointer;
  transition: all 180ms ease;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  box-shadow: 0 8px 32px rgba(255, 77, 79, 0.15);
  z-index: 100;
  position: relative;
  pointer-events: auto;
}

.primary-scan-btn:hover {
  transform: scale(1.05);
  border-color: #ffb8b8;
  box-shadow: 0 12px 48px rgba(255, 77, 79, 0.25);
  background: linear-gradient(135deg, #fff2f2 0%, #ffe8e8 100%);
}

.primary-scan-btn:active {
  transform: scale(0.98);
}

/* ========== SCAN SCREEN ========== */
.scan-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 24px;
  background: linear-gradient(135deg, #fff7f7 0%, #ffe8e8 100%);
}

.scan-screen .app-logo {
  margin-bottom: 80px;
}

.scan-buttons {
  display: flex;
  flex-direction: column;
  gap: 24px;
  width: 100%;
  max-width: 320px;
  z-index: 100;
  position: relative;
}

.scan-option-btn {
  width: 100%;
  height: 120px;
  border-radius: 16px;
  background: #ffffff;
  border: 3px solid #ffd4d4;
  color: #ff4d4f;
  font-size: 20px;
  font-weight: 700;
  letter-spacing: 0.5px;
  cursor: pointer;
  transition: all 180ms ease;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  box-shadow: 0 4px 16px rgba(255, 77, 79, 0.12);
  z-index: 100;
  position: relative;
  pointer-events: auto;
}

.scan-option-btn:hover {
  transform: translateY(-2px);
  border-color: #ffb8b8;
  box-shadow: 0 8px 24px rgba(255, 77, 79, 0.2);
  background: #fff7f7;
}

.scan-option-btn:active {
  transform: translateY(0);
}

/* ========== RESULT SCREEN ========== */
.result-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 24px;
  background: linear-gradient(135deg, #fff7f7 0%, #ffe8e8 100%);
}

.result-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%;
  max-width: 400px;
}

.status-text {
  font-size: 72px;
  font-weight: 900;
  letter-spacing: -2px;
  text-align: center;
  margin-bottom: 16px;
  line-height: 1;
}

.status-text.safe {
  color: #22c55e;
}

.status-text.use-soon {
  color: #f59e0b;
}

.status-text.toss {
  color: #ef4444;
}

.status-subtext {
  font-size: 14px;
  color: #6b6b6b;
  text-align: center;
  font-weight: 500;
}

.details-toggle {
  margin-top: 24px;
  background: none;
  border: none;
  color: #6b6b6b;
  font-size: 12px;
  cursor: pointer;
  text-decoration: underline;
  transition: color 150ms ease;
  z-index: 100;
  position: relative;
  pointer-events: auto;
}

.details-toggle:hover {
  color: #1a1a1a;
}

.result-details {
  display: none;
  margin-top: 16px;
  padding: 16px;
  background: #ffffff;
  border: 2px solid #f0e6e6;
  border-radius: 12px;
  font-size: 13px;
  color: #6b6b6b;
  max-width: 300px;
  line-height: 1.6;
}

.result-details.visible {
  display: block;
  animation: fadeIn 200ms ease;
}

.result-actions {
  width: 100%;
  max-width: 320px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  padding-bottom: 40px;
}

.scan-again-btn {
  width: 100%;
  height: 64px;
  border-radius: 16px;
  background: #ff4d4f;
  border: none;
  color: #ffffff;
  font-size: 18px;
  font-weight: 700;
  letter-spacing: 0.5px;
  cursor: pointer;
  transition: all 180ms ease;
  text-transform: uppercase;
  box-shadow: 0 4px 16px rgba(255, 77, 79, 0.25);
  z-index: 100;
  position: relative;
  pointer-events: auto;
}

.scan-again-btn:hover {
  background: #ff3333;
  transform: translateY(-2px);
  box-shadow: 0 6px 24px rgba(255, 77, 79, 0.35);
}

.scan-again-btn:active {
  transform: translateY(0);
}

.done-btn {
  background: none;
  border: none;
  color: #6b6b6b;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  padding: 12px;
  transition: color 150ms ease;
  text-decoration: underline;
  z-index: 100;
  position: relative;
  pointer-events: auto;
}

.done-btn:hover {
  color: #1a1a1a;
}

/* ========== MY SHELF ========== */
.shelf-view {
  max-width: 480px;
  margin: 0 auto;
  padding: 24px;
  min-height: 100vh;
}

.top-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 32px;
  padding-bottom: 16px;
  border-bottom: 2px solid #f0e6e6;
}

.app-logo-small {
  font-size: 10px;
  letter-spacing: 2px;
  font-weight: 700;
  color: #d4a5a5;
  text-transform: uppercase;
}

.nav-toggle {
  background: #ffffff;
  border: 2px solid #f0e6e6;
  color: #6b6b6b;
  padding: 10px 20px;
  border-radius: 24px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 150ms ease;
}

.nav-toggle:hover {
  border-color: #ffd4d4;
  color: #1a1a1a;
  background: #fff7f7;
}

.nav-toggle.active {
  background: #ff4d4f;
  color: #ffffff;
  border-color: #ff4d4f;
}

.shelf-header {
  font-size: 24px;
  font-weight: 900;
  margin-bottom: 20px;
  letter-spacing: -0.5px;
  color: #1a1a1a;
}

.shelf-summary {
  background: #ffffff;
  padding: 12px 16px;
  border-radius: 12px;
  font-size: 13px;
  color: #6b6b6b;
  margin-bottom: 16px;
  text-align: center;
  font-weight: 600;
  border: 2px solid #f0e6e6;
}

.shelf-item { 
  background: #ffffff; 
  border-radius: 12px; 
  padding: 16px; 
  margin-bottom: 12px; 
  position: relative; 
  display: flex;
  align-items: center;
  gap: 12px;
  border: 2px solid #f0e6e6;
  transition: all 150ms ease;
}

.shelf-item:hover {
  border-color: #ffd4d4;
  box-shadow: 0 2px 8px rgba(255, 77, 79, 0.1);
}

.shelf-item-content {
  flex: 1;
  min-width: 0;
}

.shelf-item-name {
  font-size: 15px;
  font-weight: 700;
  color: #1a1a1a;
  margin-bottom: 6px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.shelf-item-meta {
  font-size: 11px;
  color: #6b6b6b;
  margin-bottom: 3px;
}

.shelf-item-dates {
  font-size: 10px;
  color: #b0b0b0;
}

.shelf-item-estimated-badge {
  display: inline-block;
  padding: 2px 6px;
  background: #fff7f7;
  color: #f59e0b;
  border-radius: 4px;
  font-size: 9px;
  font-weight: 700;
  margin-left: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border: 1px solid #ffd4d4;
}

.shelf-item-status { 
  padding: 8px 14px; 
  border-radius: 8px; 
  font-size: 11px; 
  font-weight: 700;
  white-space: nowrap;
  flex-shrink: 0;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: #ffffff;
}

.delete-btn { 
  position: absolute; 
  top: 10px; 
  right: 10px; 
  background: #ffffff; 
  color: #d4a5a5; 
  width: 24px; 
  height: 24px; 
  border-radius: 50%; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  font-size: 14px; 
  cursor: pointer; 
  transition: all 150ms ease; 
  padding: 0; 
  z-index: 10;
  border: 2px solid #f0e6e6;
}

.delete-btn:hover { 
  background: #ffd4d4; 
  color: #ef4444;
  border-color: #ffd4d4;
}

/* Hidden processing elements */
.hidden-processing {
  display: none !important;
}

/* Responsive adjustments */
@media (max-width: 400px) {
  .status-text {
    font-size: 56px;
  }
  
  .primary-scan-btn {
    width: 240px;
    height: 240px;
    font-size: 16px;
  }
}
</style>
</head>

<body>

<!-- HOME SCREEN -->
<div class="screen home-screen" id="homeScreen">
  <div class="app-logo">KEESS</div>
  <button class="primary-scan-btn" id="mainScanBtn">
    Scan cosmetic label
  </button>
</div>

<!-- SCAN SCREEN -->
<div class="screen scan-screen" id="scanScreen">
  <div class="app-logo">KEESS</div>
  <div class="scan-buttons">
    <button class="scan-option-btn" id="takePhotoBtn">
      Take photo
    </button>
    <button class="scan-option-btn" id="selectImageBtn">
      Select image
    </button>
  </div>
</div>

<!-- RESULT SCREEN -->
<div class="screen result-screen" id="resultScreen">
  <div class="result-content">
    <div class="status-text" id="statusText"></div>
    <div class="status-subtext" id="statusSubtext"></div>
    <button class="details-toggle" id="detailsToggle">More details</button>
    <div class="result-details" id="resultDetails"></div>
  </div>
  
  <div class="result-actions">
    <button class="scan-again-btn" id="scanAgainBtn">Scan again</button>
    <button class="done-btn" id="doneBtn">Done for now</button>
  </div>
</div>

<!-- MY SHELF -->
<div class="screen shelf-view" id="shelfView">
  <div class="top-nav">
    <div class="app-logo-small">KEESS</div>
    <button class="nav-toggle active" id="backFromShelfBtn">Back</button>
  </div>
  
  <div class="shelf-header">My Shelf</div>
  <div id="shelfSummary"></div>
  <div id="shelfItems"></div>
</div>

<!-- Hidden file inputs -->
<input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden-processing">
<input type="file" id="galleryInput" accept="image/*" class="hidden-processing">

<!-- Hidden processing elements -->
<div class="hidden-processing">
  <img id="preview">
  <div id="status"></div>
  <div id="fileName"></div>
</div>

<script>
// ========== STATE SYSTEM ==========

let appState = "home";
let lastStateBeforeShelf = "home";

const SUPPORTED_PAOS = [3, 6, 12, 24];
const PAOS = [3, 6, 9, 12, 18, 24, 36];
const SHELF_STORAGE_KEY = "myShelf";
const PACIFIC_TZ = "America/Los_Angeles";

let selectedPAO = null;
let currentImageDataURL = null;
let ocrProcessed = false;
let detailsExpanded = false;

// Current result data
let currentOpeningDate = null;
let currentExpiryDate = null;
let currentDaysLeft = null;
let currentStatusText = null;
let currentStatusClass = null;

function setState(newState) {
  console.log(`State transition: ${appState} â†’ ${newState}`);
  appState = newState;
  renderCurrentState();
}

function renderCurrentState() {
  // Hide all screens
  document.getElementById('homeScreen').classList.remove('visible');
  document.getElementById('scanScreen').classList.remove('visible');
  document.getElementById('resultScreen').classList.remove('visible');
  document.getElementById('shelfView').classList.remove('visible');
  
  // Show current screen
  if (appState === "home") {
    document.getElementById('homeScreen').classList.add('visible');
  } else if (appState === "scan") {
    document.getElementById('scanScreen').classList.add('visible');
  } else if (appState === "result") {
    document.getElementById('resultScreen').classList.add('visible');
    renderResultScreen();
  } else if (appState === "shelf") {
    document.getElementById('shelfView').classList.add('visible');
    renderShelf();
  }
}

// ========== BUTTON WIRING ==========

document.getElementById('mainScanBtn').addEventListener('click', function() {
  console.log('Main scan button clicked: home â†’ scan');
  setState('scan');
});

document.getElementById('takePhotoBtn').addEventListener('click', function() {
  console.log('Take photo button clicked');
  document.getElementById('cameraInput').click();
});

document.getElementById('selectImageBtn').addEventListener('click', function() {
  console.log('Select image button clicked');
  document.getElementById('galleryInput').click();
});

document.getElementById('scanAgainBtn').addEventListener('click', function() {
  console.log('Scan again button clicked: result â†’ scan');
  resetForNewScan();
  setState('scan');
});

document.getElementById('doneBtn').addEventListener('click', function() {
  console.log('Done button clicked: result â†’ shelf');
  saveCurrentResultToShelf();
  lastStateBeforeShelf = 'result';
  setState('shelf');
});

document.getElementById('detailsToggle').addEventListener('click', function() {
  detailsExpanded = !detailsExpanded;
  const details = document.getElementById('resultDetails');
  const toggle = document.getElementById('detailsToggle');
  
  if (detailsExpanded) {
    details.classList.add('visible');
    toggle.textContent = 'Hide details';
  } else {
    details.classList.remove('visible');
    toggle.textContent = 'More details';
  }
});

document.getElementById('backFromShelfBtn').addEventListener('click', function() {
  console.log('Back from shelf clicked');
  if (lastStateBeforeShelf === 'result') {
    setState('result');
  } else {
    setState('home');
  }
});

function resetForNewScan() {
  selectedPAO = null;
  currentImageDataURL = null;
  ocrProcessed = false;
  detailsExpanded = false;
  
  currentOpeningDate = null;
  currentExpiryDate = null;
  currentDaysLeft = null;
  currentStatusText = null;
  currentStatusClass = null;
  
  document.getElementById('preview').src = "";
  document.getElementById('fileName').textContent = "";
  document.getElementById('status').textContent = "";
}

// ========== FILE HANDLING ==========

document.getElementById('cameraInput').addEventListener('change', handleFileSelect);
document.getElementById('galleryInput').addEventListener('change', handleFileSelect);

async function handleFileSelect(e) {
  const file = e.target.files[0];
  if (!file) return;

  console.log('File selected:', file.name);
  ocrProcessed = false;

  document.getElementById('fileName').textContent = file.name;
  
  const reader = new FileReader();
  
  reader.onload = async (event) => {
    const base64 = event.target.result;
    currentImageDataURL = base64;
    
    document.getElementById('preview').src = base64;

    if (ocrProcessed) {
      console.log("This image was already OCR processed. Skipping...");
      return;
    }

    ocrProcessed = true;

    document.getElementById('status').textContent = "Analyzing...";

    try {
      const pao = await detectWithGoogle(base64);
      
      if (pao && SUPPORTED_PAOS.includes(pao)) {
        selectedPAO = pao;
        document.getElementById('status').textContent = `Detected: ${pao}M`;
        console.log('PAO detected:', pao);
        
        // Automatically calculate and show result
        calculateAndShowResult();
      } else if (pao) {
        document.getElementById('status').textContent = `Detected ${pao}M but not supported. Manual input needed.`;
        console.log('Unsupported PAO detected:', pao);
        // For now, we'll use a default PAO
        selectedPAO = 12;
        calculateAndShowResult();
      } else {
        document.getElementById('status').textContent = "Could not detect PAO. Using default.";
        console.log('No PAO detected, using default');
        // Use default PAO
        selectedPAO = 12;
        calculateAndShowResult();
      }
      
    } catch (err) {
      console.error('OCR Error:', err);
      document.getElementById('status').textContent = "Error: " + err.message;
      // Use default PAO on error
      selectedPAO = 12;
      calculateAndShowResult();
    }
  };
  
  reader.readAsDataURL(file);
}

// ========== CALCULATION LOGIC (UNCHANGED) ==========

function getPacificMidnight(dateStr) {
  const dateObj = new Date(dateStr + "T00:00:00");
  const pacificDateStr = dateObj.toLocaleString("en-US", { timeZone: PACIFIC_TZ });
  const pacificDate = new Date(pacificDateStr);
  pacificDate.setHours(0, 0, 0, 0);
  return pacificDate;
}

function getTodayPacific() {
  const now = new Date();
  const pacificNowStr = now.toLocaleString("en-US", { timeZone: PACIFIC_TZ });
  const pacificNow = new Date(pacificNowStr);
  pacificNow.setHours(0, 0, 0, 0);
  return pacificNow;
}

function addMonths(d, m) {
  const [y, mo, da] = d.split("-").map(Number);
  const dt = new Date(y, mo - 1, da);
  dt.setMonth(dt.getMonth() + m);
  dt.setHours(0, 0, 0, 0);
  
  const year = dt.getFullYear();
  const month = String(dt.getMonth() + 1).padStart(2, '0');
  const day = String(dt.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function calculateDaysLeft(expiryDateStr) {
  const todayPacific = getTodayPacific();
  const expiryPacific = getPacificMidnight(expiryDateStr);
  
  const daysLeft = Math.ceil((expiryPacific - todayPacific) / (1000 * 60 * 60 * 24));
  
  return daysLeft;
}

function calculateAndShowResult() {
  if (!selectedPAO) { 
    console.log('No PAO selected, cannot calculate');
    return; 
  }
  
  const todayPacific = getTodayPacific();
  const year = todayPacific.getFullYear();
  const month = String(todayPacific.getMonth() + 1).padStart(2, '0');
  const day = String(todayPacific.getDate()).padStart(2, '0');
  const openingDate = `${year}-${month}-${day}`;
  
  const expiryDateStr = addMonths(openingDate, selectedPAO);
  
  const daysLeft = calculateDaysLeft(expiryDateStr);
  
  currentOpeningDate = openingDate;
  currentExpiryDate = expiryDateStr;
  currentDaysLeft = daysLeft;
  
  if (daysLeft < 0) {
    currentStatusText = "TOSS IT";
    currentStatusClass = "toss";
  } else if (daysLeft <= 60) {
    currentStatusText = "USE SOON";
    currentStatusClass = "use-soon";
  } else {
    currentStatusText = "SAFE";
    currentStatusClass = "safe";
  }
  
  console.log('Calculation complete, moving to result screen');
  console.log('scan â†’ result');
  setState('result');
}

function renderResultScreen() {
  const statusText = document.getElementById('statusText');
  const statusSubtext = document.getElementById('statusSubtext');
  const resultDetails = document.getElementById('resultDetails');
  
  statusText.textContent = currentStatusText;
  statusText.className = 'status-text ' + currentStatusClass;
  
  if (currentStatusClass === 'use-soon') {
    statusSubtext.textContent = `${currentDaysLeft} days left`;
  } else {
    statusSubtext.textContent = '';
  }
  
  let detailsContent = '';
  if (currentDaysLeft < 0) {
    detailsContent = `Expired ${Math.abs(currentDaysLeft)} days ago<br>Expiry date: ${currentExpiryDate}<br>Opening date: ${currentOpeningDate}`;
  } else {
    detailsContent = `${currentDaysLeft} days left<br>Expiry date: ${currentExpiryDate}<br>Opening date: ${currentOpeningDate}`;
  }
  
  resultDetails.innerHTML = detailsContent;
  
  // Reset details toggle
  if (detailsExpanded) {
    resultDetails.classList.add('visible');
    document.getElementById('detailsToggle').textContent = 'Hide details';
  } else {
    resultDetails.classList.remove('visible');
    document.getElementById('detailsToggle').textContent = 'More details';
  }
}

// ========== OCR LOGIC (UNCHANGED) ==========

function extractPAO(text) {
  console.log("Detected text:", text);
  
  const versions = [
    text,
    text.toUpperCase(),
    text.replace(/\s+/g, ''),
    text.replace(/[^a-zA-Z0-9]/g, ' '),
  ];
  
  const patterns = [
    /(\d{1,2})\s*M\b/gi,
    /(\d{1,2})M/gi,
    /M\s*(\d{1,2})/gi,
  ];
  
  for (let ver of versions) {
    for (let pattern of patterns) {
      pattern.lastIndex = 0;
      let match;
      while ((match = pattern.exec(ver)) !== null) {
        const num = parseInt(match[1]);
        if (PAOS.includes(num)) {
          console.log("âœ“ Found PAO:", num);
          return num;
        }
      }
    }
  }
  
  const numbers = text.match(/\d+/g);
  if (numbers) {
    for (let numStr of numbers) {
      const num = parseInt(numStr);
      if (PAOS.includes(num)) {
        const idx = text.indexOf(numStr);
        const context = text.substring(Math.max(0, idx - 2), Math.min(text.length, idx + numStr.length + 2));
        if (/m/i.test(context)) {
          console.log("âœ“ Found PAO by context:", num);
          return num;
        }
      }
    }
  }
  
  return null;
}

async function detectWithGoogle(base64Image) {
  const apiKey = "AIzaSyAtwhPrHK5d_yLVkBfOc8tDjfk-2_cHDrw";
  
  if (!apiKey || apiKey === "AIzaSyAtwhPrHK5d_yLVkBfOc8tDjfk-2_cHDrw") {
    console.warn("API key not configured, skipping OCR");
    return null;
  }
  
  const base64Content = base64Image.split(',')[1];
  
  const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      requests: [
        {
          image: {
            content: base64Content
          },
          features: [
            {
              type: 'TEXT_DETECTION',
              maxResults: 10
            }
          ]
        }
      ]
    })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error?.message || `API error: ${response.status}`);
  }
  
  const data = await response.json();
  
  console.log("Google Vision response:", data);
  
  const textAnnotations = data.responses[0]?.textAnnotations;
  
  if (!textAnnotations || textAnnotations.length === 0) {
    return null;
  }
  
  const fullText = textAnnotations[0].description;
  
  return extractPAO(fullText);
}

// ========== SHELF LOGIC (UNCHANGED) ==========

function loadShelfFromStorage() {
  try {
    const stored = localStorage.getItem(SHELF_STORAGE_KEY);
    if (!stored) {
      console.log("No shelf data");
      return [];
    }
    const parsed = JSON.parse(stored);
    console.log("Loaded shelf data:", parsed.length, "items");
    return Array.isArray(parsed) ? parsed : [];
  } catch (err) {
    console.error("Shelf load error:", err);
    return [];
  }
}

function saveShelfToStorage(shelf) {
  try {
    localStorage.setItem(SHELF_STORAGE_KEY, JSON.stringify(shelf));
    console.log("Saved shelf data:", shelf.length, "items");
    return true;
  } catch (err) {
    console.error("Shelf save error:", err);
    return false;
  }
}

function computeStatusFromExpiry(expiryDate) {
  const daysLeft = calculateDaysLeft(expiryDate);
  
  if (daysLeft < 0) {
    return "TOSS";
  } else if (daysLeft <= 60) {
    return "USE SOON";
  } else {
    return "KEEP";
  }
}

function refreshAllStatuses() {
  const shelf = loadShelfFromStorage();
  let updated = false;
  
  shelf.forEach(item => {
    const newStatus = computeStatusFromExpiry(item.expiryDate);
    if (item.status !== newStatus) {
      item.status = newStatus;
      updated = true;
    }
  });
  
  if (updated) {
    saveShelfToStorage(shelf);
    console.log("âœ“ Statuses refreshed and saved");
  }
  
  return shelf;
}

function saveCurrentResultToShelf() {
  if (!currentOpeningDate || !currentExpiryDate || !selectedPAO) {
    console.log('No result to save');
    return;
  }

  const itemStatus = computeStatusFromExpiry(currentExpiryDate);
  const name = "Product";

  const item = {
    name: name,
    pao: selectedPAO + "M",
    openingDate: currentOpeningDate,
    expiryDate: currentExpiryDate,
    status: itemStatus,
    isEstimated: false,
    createdAt: Date.now()
  };

  const shelf = loadShelfFromStorage();
  shelf.push(item);
  
  saveShelfToStorage(shelf);
  console.log('Item saved to shelf');
}

function getStatusPriority(status) {
  const priorities = {
    "TOSS": 1,
    "USE SOON": 2,
    "KEEP": 3
  };
  return priorities[status] || 999;
}

function deleteItem(createdAt) {
  if (!confirm("Delete this item?")) return;
  
  const shelf = loadShelfFromStorage();
  const updatedShelf = shelf.filter(item => item.createdAt !== createdAt);
  saveShelfToStorage(updatedShelf);
  renderShelf();
}

function renderShelf() {
  const shelf = refreshAllStatuses();
  
  const shelfSummary = document.getElementById('shelfSummary');
  const shelfItems = document.getElementById('shelfItems');
  
  if (shelf.length === 0) {
    shelfSummary.innerHTML = '';
    shelfItems.innerHTML = '<div style="text-align:center;color:#b0b0b0;padding:40px;">No items yet</div>';
    return;
  }
  
  const tossCount = shelf.filter(item => item.status === "TOSS").length;
  const useSoonCount = shelf.filter(item => item.status === "USE SOON").length;
  const keepCount = shelf.filter(item => item.status === "KEEP").length;
  
  let summaryText = "";
  
  if (tossCount > 0) {
    summaryText = `ðŸ—‘ï¸ You have expired products. Time to toss them.`;
  } else if (useSoonCount > 0) {
    summaryText = `âš ï¸ Some products are expiring soon.`;
  } else if (keepCount > 0) {
    summaryText = "âœ¨ Safe vibes only";
  }
  
  if (summaryText) {
    shelfSummary.innerHTML = `<div class="shelf-summary">${summaryText}</div>`;
  } else {
    shelfSummary.innerHTML = '';
  }
  
  const itemsWithStatus = shelf.map(item => {
    if (!item.createdAt) {
      item.createdAt = Date.now() + Math.random();
    }
    
    if (!item.name) {
      item.name = "Product";
    }
    
    let displayStatus = item.status;
    if (item.status === "TOSS") {
      displayStatus = "TOSS IT";
    } else if (item.status === "KEEP") {
      displayStatus = "SAFE";
    }
    
    return {
      ...item,
      displayStatus: displayStatus
    };
  });
  
  itemsWithStatus.sort((a, b) => {
    return getStatusPriority(a.status) - getStatusPriority(b.status);
  });
  
  shelfItems.innerHTML = itemsWithStatus.map(item => {
    const itemStatus = item.displayStatus;
    
    let statusColor = "";
    if (item.status === "TOSS") {
      statusColor = "#ef4444";
    } else if (item.status === "USE SOON") {
      statusColor = "#f59e0b";
    } else {
      statusColor = "#22c55e";
    }
    
    return `
      <div class="shelf-item">
        <button class="delete-btn" onclick="deleteItem(${item.createdAt})">Ã—</button>
        <div class="shelf-item-content">
          <div class="shelf-item-name">${item.name}</div>
          <div class="shelf-item-meta">${item.pao} Â· Expires ${item.expiryDate}</div>
          <div class="shelf-item-dates">Opened: ${item.openingDate}</div>
        </div>
        <div class="shelf-item-status" style="background: ${statusColor};">
          ${itemStatus}
        </div>
      </div>
    `;
  }).join('');
}

// ========== INITIALIZATION ==========

// Initialize app
setState('home');

console.log('KEESS initialized - state:', appState);
</script>

</body>
</html>