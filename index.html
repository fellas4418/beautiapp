<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cosmetic Expiry Calculator</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
* { box-sizing: border-box; }
body { margin: 0; background: #0b0c10; color: #e8e8ea; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
.wrap { max-width: 420px; margin: 0 auto; padding: 16px; }
.card { background: #111318; border-radius: 16px; padding: 16px; margin-bottom: 16px; }
h2 { margin: 0 0 20px 0; font-size: 28px; }
img { width: 100%; border-radius: 12px; margin-top: 10px; display: block; max-height: 400px; object-fit: contain; background: #000; }
.pao { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 12px; }
button { padding: 12px; border-radius: 10px; border: none; background: #1f2430; color: #fff; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.2s; }
button:hover { background: #2a3142; transform: translateY(-2px); }
button.active { background: linear-gradient(135deg, #667eea, #764ba2); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5); }
.result { margin-top: 14px; font-weight: 800; font-size: 17px; text-align: center; padding: 14px; background: #1a1d2e; border-radius: 10px; }
input[type="date"] { width: 100%; margin-top: 10px; padding: 10px; border-radius: 8px; border: none; font-size: 14px; }

.file-upload-wrapper { position: relative; margin-top: 10px; }
.file-upload-wrapper input[type="file"] { 
  position: absolute; 
  opacity: 0; 
  width: 100%; 
  height: 100%; 
  cursor: pointer; 
  z-index: 2;
}
.file-upload-label {
  display: block;
  width: 100%;
  padding: 12px;
  background: #667eea;
  color: white;
  text-align: center;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.file-upload-label:hover {
  background: #5568d3;
}
.file-name {
  margin-top: 8px;
  font-size: 13px;
  color: #aaa;
  text-align: center;
}

.status { margin-top: 10px; padding: 12px; border-radius: 8px; text-align: center; font-weight: 600; font-size: 14px; }
label { display: block; margin-top: 12px; margin-bottom: 4px; font-size: 14px; color: #aaa; }
.debug { margin-top: 10px; padding: 10px; background: #1a1d2e; border-radius: 8px; font-size: 11px; color: #888; max-height: 250px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; font-family: monospace; border: 1px solid #333; }
.info-box { background: #1a1d2e; padding: 14px; border-radius: 10px; margin-top: 16px; font-size: 14px; line-height: 1.6; color: #aaa; }
.info-box strong { color: #667eea; }
.test-btn { background: #dc3545; margin-top: 10px; width: 100%; }
canvas { display: none; }
.processed-images { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
.processed-images img { max-height: 150px; }
</style>
</head>

<body>
<div class="wrap">
<h2>üíÑ PAO Calculator</h2>

<div class="card">
<label>Opening Date</label>
<input type="date" id="opened">

<label>Period After Opening (PAO)</label>
<div class="pao" id="paoBtns"></div>

<label>Upload Product Photo (Optional)</label>
<div class="file-upload-wrapper">
  <input type="file" id="fileInput" accept="image/*">
  <div class="file-upload-label">üì∑ Choose Photo</div>
</div>
<div class="file-name" id="fileName"></div>

<canvas id="canvas"></canvas>
<img id="preview" style="display:none">

<div class="processed-images" id="processedImages" style="display:none"></div>

<button class="test-btn" onclick="testOCR()">üß™ Test OCR System</button>

<div id="result" class="result">Select a PAO period</div>
<div id="status" class="status" style="display:none"></div>
<div id="debug" class="debug" style="display:none"></div>
</div>

<div class="card">
<h3 style="margin:0 0 12px 0">‚ÑπÔ∏è About PAO</h3>
<div class="info-box">
<strong>Period After Opening (PAO)</strong> indicates how long a cosmetic product is safe to use after opening.<br><br>
Look for the open jar symbol on your product with a number (e.g., 12M = 12 months).<br><br>
Upload a clear photo of the PAO symbol for automatic detection.
</div>
</div>
</div>

<script>
const PAOS = [3, 6, 9, 12, 18, 24, 36];
let selectedPAO = null;

const opened = document.getElementById("opened");
const paoBox = document.getElementById("paoBtns");
const result = document.getElementById("result");
const preview = document.getElementById("preview");
const status = document.getElementById("status");
const debug = document.getElementById("debug");
const fileName = document.getElementById("fileName");
const canvas = document.getElementById("canvas");
const processedImages = document.getElementById("processedImages");

opened.value = new Date().toISOString().slice(0, 10);

PAOS.forEach(m => {
  const b = document.createElement("button");
  b.textContent = m + "M";
  b.onclick = () => { selectPAO(m); updateResult(); };
  paoBox.appendChild(b);
});

function selectPAO(m) {
  selectedPAO = m;
  [...paoBox.children].forEach(b => {
    b.classList.toggle("active", b.textContent === m + "M");
  });
}

function addMonths(d, m) {
  const [y, mo, da] = d.split("-").map(Number);
  const dt = new Date(y, mo - 1, da);
  dt.setMonth(dt.getMonth() + m);
  return dt;
}

function updateResult() {
  if (!selectedPAO) { 
    result.textContent = "Select a PAO period"; 
    return; 
  }
  const toss = addMonths(opened.value, selectedPAO);
  const daysLeft = Math.ceil((toss - new Date()) / (1000 * 60 * 60 * 24));
  
  let emoji = "‚úÖ";
  if (daysLeft < 0) emoji = "‚ùå";
  else if (daysLeft <= 30) emoji = "‚ö†Ô∏è";
  
  result.textContent = `${emoji} ${selectedPAO}M ¬∑ Expires on ${toss.toISOString().slice(0, 10)}`;
  
  if (daysLeft < 0) {
    result.textContent += ` (Expired ${Math.abs(daysLeft)} days ago)`;
  } else {
    result.textContent += ` (${daysLeft} days left)`;
  }
}

function logDebug(msg) {
  debug.style.display = "block";
  debug.textContent += msg + "\n";
  console.log(msg);
}

// üîç Ï¥àÍ∞ïÎ†• PAO Ï∂îÏ∂ú - Î™®Îì† Í∞ÄÎä•Ìïú Ìå®ÌÑ¥
function extractPAO(text) {
  logDebug("=== Extracting PAO ===");
  logDebug("Original text:\n" + text);
  
  // Ïó¨Îü¨ Î≤ÑÏ†ÑÏùò ÌÖçÏä§Ìä∏ ÏÉùÏÑ±
  const versions = [
    text,
    text.toUpperCase(),
    text.toLowerCase(),
    text.replace(/\s+/g, ''),
    text.replace(/[^a-zA-Z0-9]/g, ''),
    text.replace(/[^a-zA-Z0-9]/g, ' '),
  ];
  
  logDebug("Text versions: " + versions.length);
  
  // Î™®Îì† Í∞ÄÎä•Ìïú Ìå®ÌÑ¥
  const patterns = [
    /(\d{1,2})\s*M\b/gi,
    /(\d{1,2})\s*m\b/gi,
    /(\d{1,2})M/gi,
    /(\d{1,2})m/gi,
    /(\d{1,2})\s*MO/gi,
    /(\d{1,2})\s*MONTH/gi,
    /\bM\s*(\d{1,2})/gi,
    /PAO\D*(\d{1,2})/gi,
  ];
  
  // Î™®Îì† Î≤ÑÏ†ÑÏóêÏÑú Î™®Îì† Ìå®ÌÑ¥ ÏãúÎèÑ
  for (let ver of versions) {
    for (let pattern of patterns) {
      pattern.lastIndex = 0; // Ï†ïÍ∑úÏãù Î¶¨ÏÖã
      let match;
      while ((match = pattern.exec(ver)) !== null) {
        const num = parseInt(match[1]);
        logDebug(`Pattern ${pattern.source} matched: "${match[0]}" -> ${num}`);
        if (PAOS.includes(num)) {
          logDebug(`‚úì VALID PAO FOUND: ${num}M`);
          return num;
        }
      }
    }
  }
  
  // Ïà´Ïûê + M Ï°∞Ìï© ÏßÅÏ†ë Ï∞æÍ∏∞
  const allMatches = text.match(/\d+/g);
  logDebug("All numbers: " + (allMatches ? allMatches.join(", ") : "none"));
  
  if (allMatches) {
    for (let numStr of allMatches) {
      const num = parseInt(numStr);
      if (PAOS.includes(num)) {
        // Ïù¥ Ïà´Ïûê Ï£ºÎ≥Ä 3Í∏ÄÏûê ÌôïÏù∏
        const idx = text.indexOf(numStr);
        const before = text.substring(Math.max(0, idx - 2), idx);
        const after = text.substring(idx + numStr.length, Math.min(text.length, idx + numStr.length + 2));
        const context = before + numStr + after;
        
        logDebug(`Number ${num} context: "${context}"`);
        
        if (/m/i.test(after) || /m/i.test(before)) {
          logDebug(`‚úì FOUND BY CONTEXT: ${num}M`);
          return num;
        }
      }
    }
  }
  
  logDebug("‚úó No PAO found");
  return null;
}

// Îã§Ï§ë Ïù¥ÎØ∏ÏßÄ Ï†ÑÏ≤òÎ¶¨ (3Í∞ÄÏßÄ Î≤ÑÏ†Ñ)
function preprocessImages(img) {
  const results = [];
  
  // Í∏∞Î≥∏ ÌÅ¨Í∏∞ Ï°∞Ï†ï
  let width = img.width;
  let height = img.height;
  const maxSize = 2000;
  
  if (width > maxSize || height > maxSize) {
    if (width > height) {
      height = (height / width) * maxSize;
      width = maxSize;
    } else {
      width = (width / height) * maxSize;
      height = maxSize;
    }
  }
  
  // Î≤ÑÏ†Ñ 1: Í≥†ÎåÄÎπÑ (High Contrast)
  canvas.width = width;
  canvas.height = height;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, width, height);
  
  let imageData = ctx.getImageData(0, 0, width, height);
  let data = imageData.data;
  
  // ÎåÄÎπÑ Ï¶ùÍ∞Ä
  const contrast = 100;
  const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
  
  for (let i = 0; i < data.length; i += 4) {
    data[i] = Math.min(255, Math.max(0, factor * (data[i] - 128) + 128));
    data[i + 1] = Math.min(255, Math.max(0, factor * (data[i + 1] - 128) + 128));
    data[i + 2] = Math.min(255, Math.max(0, factor * (data[i + 2] - 128) + 128));
  }
  
  ctx.putImageData(imageData, 0, 0);
  results.push({ name: "High Contrast", data: canvas.toDataURL() });
  
  // Î≤ÑÏ†Ñ 2: ÌùëÎ∞± + ÏÉ§ÌîÑÎãù
  ctx.drawImage(img, 0, 0, width, height);
  imageData = ctx.getImageData(0, 0, width, height);
  data = imageData.data;
  
  // Í∑∏Î†àÏù¥Ïä§ÏºÄÏùº
  for (let i = 0; i < data.length; i += 4) {
    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
    data[i] = data[i + 1] = data[i + 2] = avg;
  }
  
  // ÏûÑÍ≥ÑÍ∞í Ï†ÅÏö©
  for (let i = 0; i < data.length; i += 4) {
    const brightness = data[i];
    const threshold = brightness > 128 ? 255 : 0;
    data[i] = data[i + 1] = data[i + 2] = threshold;
  }
  
  ctx.putImageData(imageData, 0, 0);
  results.push({ name: "B&W Threshold", data: canvas.toDataURL() });
  
  // Î≤ÑÏ†Ñ 3: Î∞òÏ†Ñ (Inverted)
  ctx.drawImage(img, 0, 0, width, height);
  imageData = ctx.getImageData(0, 0, width, height);
  data = imageData.data;
  
  for (let i = 0; i < data.length; i += 4) {
    data[i] = 255 - data[i];
    data[i + 1] = 255 - data[i + 1];
    data[i + 2] = 255 - data[i + 2];
  }
  
  ctx.putImageData(imageData, 0, 0);
  results.push({ name: "Inverted", data: canvas.toDataURL() });
  
  return results;
}

async function testOCR() {
  status.style.display = "block";
  status.style.background = "#4d4d1b";
  status.style.color = "#f0ad4e";
  status.textContent = "üß™ Testing OCR...";
  
  debug.style.display = "block";
  debug.textContent = "=== OCR Test ===\n";
  
  try {
    if (typeof Tesseract === 'undefined') {
      throw new Error("Tesseract.js not loaded!");
    }
    
    logDebug("‚úì Tesseract.js loaded");
    
    const testCanvas = document.createElement('canvas');
    testCanvas.width = 300;
    testCanvas.height = 150;
    const ctx = testCanvas.getContext('2d');
    
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, 300, 150);
    ctx.fillStyle = 'black';
    ctx.font = 'bold 60px Arial';
    ctx.fillText('12M', 80, 90);
    
    const blob = await new Promise(resolve => testCanvas.toBlob(resolve));
    
    const { data: { text } } = await Tesseract.recognize(blob, 'eng', {
      logger: m => {
        if (m.status === 'recognizing text') {
          status.textContent = `üß™ Testing... ${Math.round(m.progress * 100)}%`;
        }
      }
    });
    
    logDebug("Test text: " + text);
    const pao = extractPAO(text);
    
    if (pao === 12) {
      status.style.background = "#1b4d3e";
      status.style.color = "#20c997";
      status.textContent = "‚úì OCR working!";
    } else {
      status.style.background = "#4d4d1b";
      status.style.color = "#f0ad4e";
      status.textContent = "‚ö† OCR loaded but uncertain";
    }
    
  } catch (err) {
    logDebug("ERROR: " + err.message);
    status.style.background = "#4d1b1b";
    status.style.color = "#ff6b6b";
    status.textContent = "‚ùå Failed: " + err.message;
  }
}

document.getElementById("fileInput").onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  fileName.textContent = file.name;

  status.style.display = "block";
  status.style.background = "#4d4d1b";
  status.style.color = "#f0ad4e";
  status.textContent = "üì∑ Loading...";

  debug.style.display = "block";
  debug.textContent = "=== OCR Analysis ===\n";

  const img = new Image();
  img.onload = async () => {
    preview.src = img.src;
    preview.style.display = "block";
    
    logDebug(`Image: ${file.name} (${(file.size/1024).toFixed(1)}KB)`);
    logDebug(`Size: ${img.width}x${img.height}`);
    
    try {
      status.textContent = "üîç Preprocessing (3 versions)...";
      
      const processed = preprocessImages(img);
      
      // Ï†ÑÏ≤òÎ¶¨Îêú Ïù¥ÎØ∏ÏßÄ ÌëúÏãú
      processedImages.innerHTML = '';
      processedImages.style.display = 'grid';
      processed.forEach(p => {
        const imgEl = document.createElement('img');
        imgEl.src = p.data;
        imgEl.title = p.name;
        processedImages.appendChild(imgEl);
      });
      
      logDebug(`Created ${processed.length} processed versions`);
      
      let foundPAO = null;
      
      // Í∞Å Î≤ÑÏ†ÑÏóêÏÑú OCR ÏãúÎèÑ
      for (let i = 0; i < processed.length; i++) {
        if (foundPAO) break;
        
        const version = processed[i];
        logDebug(`\n--- Trying ${version.name} ---`);
        status.textContent = `üîç Analyzing ${version.name}...`;
        
        const { data: { text, confidence } } = await Tesseract.recognize(version.data, 'eng', {
          logger: m => {
            if (m.status === 'recognizing text') {
              const pct = Math.round(m.progress * 100);
              status.textContent = `üîç ${version.name} ${pct}%`;
            }
          },
          tessedit_char_whitelist: '0123456789MmOoNnTtHh ',
        });

        logDebug(`Confidence: ${confidence.toFixed(1)}%`);
        logDebug(`Text:\n${text}`);
        
        const pao = extractPAO(text);
        if (pao) {
          foundPAO = pao;
          logDebug(`‚úì‚úì‚úì SUCCESS with ${version.name}!`);
          break;
        }
      }
      
      if (foundPAO) {
        selectPAO(foundPAO);
        updateResult();
        status.style.background = "#1b4d3e";
        status.style.color = "#20c997";
        status.textContent = `‚úì Detected: ${foundPAO}M`;
      } else {
        status.style.background = "#4d1b1b";
        status.style.color = "#ff6b6b";
        status.textContent = "‚ùå No PAO detected. Select manually ‚Üì";
      }
      
    } catch (err) {
      logDebug("ERROR: " + err.message);
      status.style.background = "#4d1b1b";
      status.style.color = "#ff6b6b";
      status.textContent = "‚ö† Error: " + err.message;
    }
  };
  
  img.src = URL.createObjectURL(file);
};

opened.onchange = updateResult;
</script>
</body>
</html>