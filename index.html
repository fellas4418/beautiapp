<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cosmetic Freshness</title>
  <style>
    :root{
      --bg:#0b0c10;
      --card:#111318;
      --text:#e8e8ea;
      --muted:#a8abb4;
      --border:rgba(255,255,255,.10);
      --btn:#2b6cff;
      --btn2:#1f2430;
      --danger:#ff4d4f;
      --warn:#ffcc00;
      --ok:#20c997;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .grow{flex:1 1 auto;}
    .muted{color:var(--muted);font-size:13px;line-height:1.5}
    .sep{height:1px;background:var(--border);margin:14px 0}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:940px){.grid{grid-template-columns:1.1fr .9fr}}

    .btn{
      background:var(--btn);
      color:#fff;
      border:none;
      padding:12px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
    }
    .btn.secondary{background:var(--btn2);color:var(--text);border:1px solid var(--border);}
    .btn:disabled{opacity:.55;cursor:not-allowed;}
    .link{color:var(--danger);cursor:pointer;text-decoration:underline;font-weight:800}

    .videoBox{
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      background:#05060a;
    }
    video{width:100%;height:auto;display:block;}
    canvas{display:none;}

    .thumb{
      width:100%;
      max-height:360px;
      object-fit:contain;
      border-radius:16px;
      border:1px solid var(--border);
      background:#0a0b0f;
      display:none;
    }

    .kv{display:grid;grid-template-columns:170px 1fr;gap:10px;font-size:14px;line-height:1.6}
    .paoBig{
      font-size:26px;
      font-weight:1000;
      letter-spacing:0.5px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      font-size:13px;
      font-weight:900;
    }
    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    .bad{color:var(--danger)}

    .chips{display:flex;gap:10px;flex-wrap:wrap}
    .chip{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
    }
    .chip.active{border-color:rgba(43,108,255,.8);box-shadow:0 0 0 2px rgba(43,108,255,.25) inset}

    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
    }
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .itemTitle{font-weight:1000}
    .small{font-size:12px;color:var(--muted);line-height:1.45}

    input[type="file"]{display:none;}
    input[type="text"]{
      padding:12px;border-radius:12px;border:1px solid var(--border);
      background:#0a0b0f;color:var(--text);
      width:100%;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="font-size:18px;font-weight:1100;margin-bottom:6px;">Cosmetic Freshness</div>
      <div class="muted">촬영 또는 사진 선택 → 바로 PAO(3M/6M/12M)를 인식해 보여주고, 개봉일을 한 번만 선택하면 남은 날짜/만료일을 계산해 My Shelf에 저장합니다.</div>
    </div>

    <div class="grid">
      <div class="card">
        <div style="font-size:16px;font-weight:1100;margin-bottom:6px;">촬영 / 사진 가져오기</div>
        <div class="muted" id="msg">카메라를 켜고 촬영하거나, 사진을 선택하면 자동으로 인식합니다.</div>

        <div class="sep"></div>

        <div class="row">
          <button id="btnCamera" class="btn">카메라 켜기</button>
          <button id="btnCapture" class="btn secondary" disabled>촬영하기</button>
          <label for="photoInput" class="btn secondary" style="display:inline-flex;align-items:center;justify-content:center;cursor:pointer;">사진 가져오기</label>
          <input id="photoInput" type="file" accept="image/*" />
          <button id="btnStop" class="btn secondary" style="display:none;">카메라 끄기</button>
        </div>

        <div style="height:10px"></div>

        <div id="cameraBox" class="videoBox" style="display:none;">
          <video id="video" playsinline></video>
        </div>

        <canvas id="canvas"></canvas>
        <img id="preview" class="thumb" alt="preview" />

        <div id="resultBox" style="display:none;margin-top:14px;">
          <div class="sep"></div>

          <div class="kv">
            <div class="muted">PAO</div>
            <div id="detectedPao" class="paoBig">-</div>

            <div class="muted">상태</div>
            <div id="verdict">-</div>

            <div class="muted">만료일</div>
            <div id="expiryDate">-</div>

            <div class="muted">남은 날짜</div>
            <div id="daysLeft">-</div>
          </div>

          <div id="openDateBox" style="margin-top:14px;display:none;">
            <div class="muted" style="margin-bottom:10px;">개봉일을 선택하세요 (한 번만).</div>
            <div class="chips">
              <button class="chip" data-open="today">오늘</button>
              <button class="chip" data-open="yesterday">어제</button>
              <button class="chip" data-open="week">일주일 전쯤</button>
              <button class="chip" data-open="month">한 달 전쯤</button>
              <button class="chip" data-open="unknown">기억 안남</button>
            </div>
            <div class="muted" style="margin-top:10px;">기억 안남은 보수적으로 추정합니다.</div>
          </div>

          <div id="saveBox" style="display:none;margin-top:14px;">
            <div class="row">
              <div class="grow">
                <input id="nickname" type="text" placeholder="(선택) 별명 예: 파란 크림, 선크림" />
              </div>
              <button id="btnSave" class="btn">My Shelf 저장</button>
            </div>
          </div>

          <div style="height:8px"></div>
          <button id="btnRetry" class="btn secondary">다시 하기</button>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div style="font-size:16px;font-weight:1100;">My Shelf</div>
            <div class="muted">저장된 제품 목록 (이 기기 브라우저에 저장)</div>
          </div>
          <div class="link" id="clearShelf">전체 삭제</div>
        </div>

        <div class="sep"></div>

        <div id="shelfList" class="list"></div>
        <div id="emptyShelf" class="muted">아직 저장된 제품이 없습니다.</div>
      </div>
    </div>
  </div>

  <script>
    const WORKER_BASE = "https://skinguard.ohryee.workers.dev";

    const msg = document.getElementById("msg");

    const btnCamera = document.getElementById("btnCamera");
    const btnCapture = document.getElementById("btnCapture");
    const btnStop = document.getElementById("btnStop");
    const btnRetry = document.getElementById("btnRetry");

    const cameraBox = document.getElementById("cameraBox");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");

    const photoInput = document.getElementById("photoInput");
    const preview = document.getElementById("preview");

    const resultBox = document.getElementById("resultBox");
    const detectedPao = document.getElementById("detectedPao");
    const verdictEl = document.getElementById("verdict");
    const expiryDateEl = document.getElementById("expiryDate");
    const daysLeftEl = document.getElementById("daysLeft");

    const openDateBox = document.getElementById("openDateBox");
    const saveBox = document.getElementById("saveBox");
    const nickname = document.getElementById("nickname");
    const btnSave = document.getElementById("btnSave");

    const shelfList = document.getElementById("shelfList");
    const emptyShelf = document.getElementById("emptyShelf");
    const clearShelf = document.getElementById("clearShelf");

    let stream = null;

    let current = {
      paoMonths: null,
      paoRaw: "",
      openDateISO: null,
      expiryISO: null,
      daysLeft: null,
      verdict: "NEEDS_OPEN_DATE",
      imageDataUrl: ""
    };

    function setMsg(t){ msg.textContent = t || ""; }

    function isoDate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function addMonths(dateObj, months){
      const d = new Date(dateObj);
      const targetMonth = d.getMonth() + months;
      d.setMonth(targetMonth);
      while (d.getMonth() !== ((targetMonth % 12) + 12) % 12) d.setDate(d.getDate() - 1);
      return d;
    }

    function computeVerdict(daysLeft){
      if (daysLeft <= 0) return "TOSS";
      if (daysLeft <= 30) return "NEAR";
      return "SAFE";
    }

    function verdictPill(v){
      if (v === "SAFE") return `<span class="pill"><span class="ok">Safe</span><span class="muted">사용 가능</span></span>`;
      if (v === "NEAR") return `<span class="pill"><span class="warn">Near expiry</span><span class="muted">곧 만료</span></span>`;
      if (v === "TOSS") return `<span class="pill"><span class="bad">Toss it</span><span class="muted">폐기 권장</span></span>`;
      return `<span class="pill"><span class="muted">개봉일 선택 필요</span></span>`;
    }

    function resetAll(){
      current = {
        paoMonths: null,
        paoRaw: "",
        openDateISO: null,
        expiryISO: null,
        daysLeft: null,
        verdict: "NEEDS_OPEN_DATE",
        imageDataUrl: ""
      };
      preview.style.display = "none";
      preview.src = "";
      resultBox.style.display = "none";
      openDateBox.style.display = "none";
      saveBox.style.display = "none";
      nickname.value = "";
      document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
      setMsg("카메라를 켜고 촬영하거나, 사진을 선택하면 자동으로 인식합니다.");
    }

    function renderResult(){
      resultBox.style.display = "block";
      detectedPao.textContent = current.paoRaw || (current.paoMonths ? `${current.paoMonths}M` : "-");
      verdictEl.innerHTML = verdictPill(current.verdict);
      expiryDateEl.textContent = current.expiryISO || "-";
      daysLeftEl.textContent = (current.daysLeft == null) ? "-" : `${current.daysLeft} days`;
      openDateBox.style.display = current.paoMonths ? "block" : "none";
      saveBox.style.display = current.openDateISO ? "block" : "none";
    }

    function normalizeTextFromPayload(payload){
      if (!payload || typeof payload !== "object") return "";
      if (typeof payload.text === "string") return payload.text;
      if (typeof payload.ocrText === "string") return payload.ocrText;
      if (payload.result && typeof payload.result.text === "string") return payload.result.text;
      if (payload.data && typeof payload.data.text === "string") return payload.data.text;
      return "";
    }

    function extractPAOFromText(text){
      const t = (text || "").toString()
        .replace(/\s+/g, " ")
        .replace(/Ｍ/g,"M").replace(/ｍ/g,"m");

      const patterns = [
        /\b([1-9]\d?)\s*(M|m)\b/g,
        /\bPAO\s*[:\-]?\s*([1-9]\d?)\s*(M|m)\b/gi,
        /\b([1-9]\d?)\s*(mo|mos|month|months)\b/gi
      ];

      let best = null;
      for (const re of patterns) {
        let m;
        while ((m = re.exec(t)) !== null) {
          const n = parseInt(m[1], 10);
          if (!Number.isFinite(n) || n < 1 || n > 48) continue;
          best = n;
          break;
        }
        if (best) break;
      }
      return best;
    }

    function toNumberMaybe(v){
      if (typeof v === "number" && Number.isFinite(v)) return v;
      if (typeof v === "string") {
        const n = parseInt(v, 10);
        if (Number.isFinite(n)) return n;
      }
      return null;
    }

    function monthsFromRaw(raw){
      const s = String(raw || "").replace(/Ｍ/g,"M").replace(/ｍ/g,"m");
      const m = /\b([1-9]\d?)\s*M\b/i.exec(s);
      if (!m) return null;
      const n = parseInt(m[1], 10);
      if (!Number.isFinite(n) || n < 1 || n > 48) return null;
      return n;
    }

    async function postWithFallback(dataUrlOrBase64){
      const paths = ["/pao", "/ocr", "/analyze", "/detect"];
      let lastStatus = null;

      // dataUrl이면 워커로 그대로 보내도 워커가 처리(=안전)
      const payload = { imageBase64: dataUrlOrBase64 };

      for (const p of paths){
        const url = WORKER_BASE.replace(/\/+$/,"") + p;
        try{
          const res = await fetch(url, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(payload)
          });

          lastStatus = res.status;

          const isJson = (res.headers.get("content-type") || "").includes("application/json");
          const out = isJson ? await res.json().catch(()=> ({})) : {};

          if (!res.ok) {
            if (res.status === 404) continue;
            return { ok:false, status: res.status, path: p, payload: out };
          }

          return { ok:true, status: res.status, path: p, payload: out };
        }catch(e){
          return { ok:false, status: 0, path: p, payload: { error: "network" } };
        }
      }

      return { ok:false, status: lastStatus ?? 404, path: "(all)", payload: { error: "not_found" } };
    }

    async function downscaleToJpegDataUrl(dataUrl, maxSide = 1280, quality = 0.85) {
      const img = new Image();
      img.src = dataUrl;
      await new Promise((res, rej) => { img.onload = res; img.onerror = rej; });

      let w = img.naturalWidth || img.width;
      let h = img.naturalHeight || img.height;

      const scale = Math.min(1, maxSide / Math.max(w, h));
      w = Math.max(1, Math.round(w * scale));
      h = Math.max(1, Math.round(h * scale));

      const c = document.createElement("canvas");
      c.width = w;
      c.height = h;
      const ctx = c.getContext("2d");
      ctx.drawImage(img, 0, 0, w, h);

      return c.toDataURL("image/jpeg", quality);
    }

    async function recognizeFromDataUrl(dataUrl){
      resetAll();

      // 핵심: 크기 줄여서 인식 성공률 올림
      const smallUrl = await downscaleToJpegDataUrl(dataUrl, 1280, 0.85);

      current.imageDataUrl = smallUrl;
      preview.src = smallUrl;
      preview.style.display = "block";

      setMsg("인식 중…");

      // 워커가 dataURL도 처리하도록 만들었으니, dataURL을 그대로 보냄(안전 + 단순)
      const r = await postWithFallback(smallUrl);

      if (!r.ok) {
        setMsg("인식에 실패했어요. 사진을 더 선명하게 찍고 다시 시도해 주세요.");
        renderResult();
        return;
      }

      const payload = r.payload || {};
      let paoMonths = toNumberMaybe(payload.paoMonths);

      if (!paoMonths) paoMonths = monthsFromRaw(payload.paoRaw);

      if (!paoMonths) {
        const text = normalizeTextFromPayload(payload);
        paoMonths = extractPAOFromText(text);
      }

      if (!paoMonths) {
        current.paoMonths = null;
        current.paoRaw = "";
        setMsg("PAO(3M/6M/12M 등)를 찾지 못했어요. PAO 마크가 크게 보이게 다시 찍어 주세요.");
        renderResult();
        return;
      }

      current.paoMonths = paoMonths;
      current.paoRaw = (typeof payload.paoRaw === "string" && payload.paoRaw.trim()) ? payload.paoRaw.trim() : `${paoMonths}M`;
      current.verdict = "NEEDS_OPEN_DATE";
      setMsg(`PAO를 인식했어요: ${current.paoRaw}. 이제 개봉일만 선택하면 됩니다.`);
      renderResult();
    }

    function pickOpenDate(option){
      if (!current.paoMonths) return;

      const now = new Date();
      const open = new Date(now);

      if (option === "today") {}
      if (option === "yesterday") open.setDate(open.getDate()-1);
      if (option === "week") open.setDate(open.getDate()-7);
      if (option === "month") open.setDate(open.getDate()-30);
      if (option === "unknown") open.setDate(open.getDate()-60);

      current.openDateISO = isoDate(open);

      const openDate = new Date(current.openDateISO + "T00:00:00");
      const exp = addMonths(openDate, current.paoMonths);
      current.expiryISO = isoDate(exp);

      const today0 = new Date(isoDate(new Date()) + "T00:00:00");
      const diffMs = exp.getTime() - today0.getTime();
      const diffDays = Math.floor(diffMs / (1000*60*60*24));

      current.daysLeft = diffDays;
      current.verdict = computeVerdict(diffDays);

      renderResult();
    }

    function getShelf(){
      try{
        const raw = localStorage.getItem("shelf_v1");
        return raw ? JSON.parse(raw) : [];
      }catch(e){
        return [];
      }
    }
    function setShelf(list){
      localStorage.setItem("shelf_v1", JSON.stringify(list));
    }
    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderShelf(){
      const list = getShelf();
      shelfList.innerHTML = "";
      emptyShelf.style.display = list.length ? "none" : "block";

      list.slice().sort((a,b)=> (a.createdAt < b.createdAt ? 1 : -1))
        .forEach(item=>{
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <div class="itemTop">
              <div>
                <div class="itemTitle">${escapeHtml(item.nickname || "Unnamed product")}</div>
                <div class="small">PAO: ${escapeHtml(item.paoRaw || (item.paoMonths ? item.paoMonths+"M" : "-"))} · Opened: ${escapeHtml(item.openDateISO || "-")}</div>
                <div class="small">Expiry: ${escapeHtml(item.expiryISO || "-")} · Days left: ${item.daysLeft == null ? "-" : item.daysLeft}</div>
              </div>
              <div style="text-align:right">
                <div>${verdictPill(item.verdict)}</div>
                <div class="small" style="margin-top:8px;"><span class="link" data-del="${item.id}">삭제</span></div>
              </div>
            </div>
          `;
          shelfList.appendChild(div);
        });

      shelfList.querySelectorAll("[data-del]").forEach(el=>{
        el.addEventListener("click", ()=>{
          const id = el.getAttribute("data-del");
          const list = getShelf().filter(x => x.id !== id);
          setShelf(list);
          renderShelf();
        });
      });
    }

    async function startCamera(){
      try{
        setMsg("카메라 여는 중…");
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
        video.srcObject = stream;
        await video.play();
        cameraBox.style.display = "block";
        btnStop.style.display = "inline-flex";
        btnCapture.disabled = false;
        setMsg("촬영하기를 누르면 바로 인식합니다.");
      }catch(e){
        setMsg("카메라를 열 수 없어요. 브라우저 권한을 확인하거나 사진 가져오기를 사용해 주세요.");
      }
    }

    function stopCamera(){
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.srcObject = null;
      cameraBox.style.display = "none";
      btnStop.style.display = "none";
      btnCapture.disabled = true;
    }

    function captureAndRecognize(){
      if (!video.videoWidth || !video.videoHeight) {
        setMsg("카메라 영상이 아직 준비되지 않았어요. 잠깐 후 다시 시도해 주세요.");
        return;
      }
      const w = video.videoWidth;
      const h = video.videoHeight;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d", { willReadFrequently: true });
      ctx.drawImage(video, 0, 0, w, h);

      const dataUrl = canvas.toDataURL("image/jpeg", 0.92);
      stopCamera();
      recognizeFromDataUrl(dataUrl);
    }

    function saveToShelf(){
      if (!current.paoMonths || !current.openDateISO || !current.expiryISO) {
        setMsg("저장하려면 PAO 인식 + 개봉일 선택이 필요해요.");
        return;
      }
      const item = {
        id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2)),
        nickname: (nickname.value || "").trim(),
        paoMonths: current.paoMonths,
        paoRaw: current.paoRaw,
        openDateISO: current.openDateISO,
        expiryISO: current.expiryISO,
        daysLeft: current.daysLeft,
        verdict: current.verdict,
        createdAt: new Date().toISOString()
      };
      const list = getShelf();
      list.push(item);
      setShelf(list);
      renderShelf();
      setMsg("My Shelf에 저장했어요.");
    }

    btnCamera.addEventListener("click", startCamera);
    btnStop.addEventListener("click", ()=>{
      stopCamera();
      setMsg("카메라를 껐어요.");
    });
    btnCapture.addEventListener("click", captureAndRecognize);

    photoInput.addEventListener("change", async ()=>{
      const file = photoInput.files && photoInput.files[0];
      if (!file) return;
      stopCamera();
      const dataUrl = await new Promise((resolve, reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(String(r.result || ""));
        r.onerror = reject;
        r.readAsDataURL(file);
      });
      photoInput.value = "";
      recognizeFromDataUrl(dataUrl);
    });

    btnRetry.addEventListener("click", resetAll);

    document.querySelectorAll(".chip").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
        btn.classList.add("active");
        pickOpenDate(btn.getAttribute("data-open"));
      });
    });

    btnSave.addEventListener("click", saveToShelf);

    clearShelf.addEventListener("click", ()=>{
      localStorage.removeItem("shelf_v1");
      renderShelf();
      setMsg("My Shelf를 전체 삭제했어요.");
    });

    renderShelf();
    resetAll();
  </script>
</body>
</html>
