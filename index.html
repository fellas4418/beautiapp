<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Keep or Toss</title>

  <style>
    body{margin:0;background:#0b0c10;color:#e8e8ea;font-family:system-ui}
    .wrap{max-width:420px;margin:0 auto;padding:16px}
    .card{background:#111318;border-radius:16px;padding:14px}
    img{width:100%;border-radius:12px;margin-top:10px}
    .pao{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
    button{padding:10px;border-radius:10px;border:none;background:#1f2430;color:#fff;font-weight:700}
    button.active{outline:2px solid #20c997}
    .result{margin-top:12px;font-weight:800}
    .ok{color:#20c997}.warn{color:#ffcc00}.err{color:#ff4d4f}
    input[type="date"]{width:100%;margin-top:10px;padding:8px;border-radius:8px;border:none}
  </style>
</head>

<body>
  <div class="wrap">
    <h2>Keep or Toss</h2>

    <div class="card">
      <input type="file" id="fileInput" accept="image/*">
      <img id="preview" style="display:none">

      <input type="date" id="opened">

      <div class="pao" id="paoBtns"></div>

      <div id="result" class="result"></div>
    </div>
  </div>

  <script>
    const PAOS=[3,6,9,12,18,24,36];
    let selectedPAO=null;

    const openedInput=document.getElementById("opened");
    const paoBox=document.getElementById("paoBtns");
    const result=document.getElementById("result");

    // 기본 날짜 값은 오늘
    openedInput.value = new Date().toISOString().slice(0,10);

    // PAO 버튼 생성
    PAOS.forEach(m=>{
      const b=document.createElement("button");
      b.textContent=m+"M";
      b.onclick=()=>{
        selectPAO(m);
        updateResult();
      };
      paoBox.appendChild(b);
    });

    function selectPAO(m){
      selectedPAO=m;
      [...paoBox.children].forEach(b=>{
        b.classList.toggle("active",b.textContent===m+"M");
      });
    }

    function addMonths(dateStr,months){
      const [y,m,d]=dateStr.split("-").map(Number);
      const dt=new Date(y,m-1,d);
      dt.setMonth(dt.getMonth()+months);
      return dt;
    }

    function updateResult(){
      if(!openedInput.value||!selectedPAO){
        result.className="result warn";
        result.textContent="PAO를 선택하세요";
        return;
      }

      const tossDate=addMonths(openedInput.value,selectedPAO);
      const today=new Date();
      const daysLeft=Math.floor((tossDate-today)/86400000);

      let cls="ok",txt="SAFE TO USE";
      if(daysLeft<0){cls="err";txt="TOSS IT";}
      else if(daysLeft<=30){cls="warn";txt="USE SOON";}

      result.className="result "+cls;
      result.textContent=
        `${txt} · ${selectedPAO}M · Toss at ${tossDate.toISOString().slice(0,10)}`;
    }

    openedInput.onchange=updateResult;

    // 이미지 업로드 시 OCR 호출
    document.getElementById("fileInput").onchange=async e=>{
      const file=e.target.files[0];
      if(!file)return;

      const reader=new FileReader();
      reader.onload=async()=>{
        document.getElementById("preview").src=reader.result;
        document.getElementById("preview").style.display="block";

        // base64로 변환 후 워커에 보내기
        const base64=reader.result.split(",")[1];
        const res=await fetch("https://pao-ocr-worker.ohryee.workers.dev",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({imageBase64:base64})
        });
        const json=await res.json();

        if(json.pao){
          selectPAO(json.pao);  // OCR에서 받은 PAO 값을 자동으로 선택
          updateResult();  // 결과 업데이트
        }
      };
      reader.readAsDataURL(file);
    };
  </script>
  <script>
    // 이전 코드 그대로 이어서 추가
    // OCR에서 PAO 값 받은 후 자동 선택하는 부분
  
    async function runPaoOCR(file) {
      try {
        const base64 = await imageToBase64(file);
  
        const res = await fetch(PAO_OCR_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ imageBase64: base64 }),
        });
  
        const data = await res.json();
  
        // OCR 결과로 PAO 값을 받음
        if (!data || !data.pao) return;
  
        selectPAO(data.pao);  // OCR 결과로 자동 PAO 선택
        updateResult();  // PAO 선택 후 결과 업데이트
      } catch (e) {
        console.error("PAO OCR failed", e);
      }
    }
  
    // 기존 파일 업로드 이벤트에서 호출됨
    document.getElementById("fileInput").addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
  
      runPaoOCR(file); // 사진을 선택하면 OCR 호출
    });
  
    function selectPAO(m) {
      selectedPAO = m;
      [...paoBox.children].forEach(b => {
        b.classList.toggle("active", b.textContent === m + "M");
      });
    }
  </script>
  
</body>
</html>
