<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KEESS</title>

<style>
* { box-sizing: border-box; }
body { margin: 0; background: #0b0c10; color: #e8e8ea; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
.wrap { max-width: 420px; margin: 0 auto; padding: 16px; }
.card { background: #111318; border-radius: 16px; padding: 16px; margin-bottom: 16px; }
h2 { margin: 0 0 20px 0; font-size: 28px; }
img { width: 100%; border-radius: 12px; margin-top: 10px; display: block; max-height: 400px; object-fit: contain; }
.pao { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 12px; }
button { padding: 12px; border-radius: 10px; border: none; background: #1f2430; color: #fff; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.2s; }
button:hover { background: #2a3142; transform: translateY(-2px); }
button.active { background: linear-gradient(135deg, #667eea, #764ba2); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5); }
.result { margin-top: 14px; font-weight: 800; font-size: 17px; text-align: center; padding: 14px; background: #1a1d2e; border-radius: 10px; }
.status-label { margin-top: 8px; font-weight: 800; font-size: 15px; text-align: center; padding: 10px; border-radius: 8px; }
input[type="text"] { width: 100%; margin-top: 10px; padding: 10px; border-radius: 8px; border: 1px solid #333; background: #1a1d2e; color: #fff; font-size: 14px; }

.file-upload-wrapper { position: relative; margin-top: 10px; }
.file-upload-wrapper input[type="file"] { 
  position: absolute; 
  opacity: 0; 
  width: 100%; 
  height: 100%; 
  cursor: pointer; 
  z-index: 2;
}
.file-upload-label {
  display: block;
  width: 100%;
  padding: 12px;
  background: #667eea;
  color: white;
  text-align: center;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.file-upload-label:hover { background: #5568d3; }
.file-name { margin-top: 8px; font-size: 13px; color: #aaa; text-align: center; }
.status { margin-top: 10px; padding: 12px; border-radius: 8px; text-align: center; font-weight: 600; font-size: 14px; }
label { display: block; margin-top: 12px; margin-bottom: 4px; font-size: 14px; color: #aaa; }

.photo-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 10px;
}

.photo-buttons button {
  padding: 12px;
  background: #667eea;
  color: white;
  border-radius: 8px;
  font-weight: 600;
  font-size: 14px;
}

.photo-buttons button:hover {
  background: #5568d3;
}

@keyframes statusFadeUp {
  from {
    opacity: 0;
    transform: translateY(8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.status-label.animate {
  animation: statusFadeUp 250ms ease-out;
}

.shelf-section { margin-top: 24px; }

.shelf-item { 
  background: #111318; 
  border-radius: 12px; 
  padding: 12px; 
  margin-bottom: 10px; 
  position: relative; 
  display: flex;
  align-items: center;
  gap: 12px;
}

.shelf-item-content {
  flex: 1;
  min-width: 0;
}

.shelf-item-name {
  font-size: 16px;
  font-weight: 700;
  color: #e8e8ea;
  margin-bottom: 4px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.shelf-item-meta {
  font-size: 12px;
  color: #888;
  margin-bottom: 2px;
}

.shelf-item-dates {
  font-size: 11px;
  color: #666;
}

.shelf-item-status { 
  padding: 6px 12px; 
  border-radius: 6px; 
  font-size: 12px; 
  font-weight: 700;
  white-space: nowrap;
  flex-shrink: 0;
}

.delete-btn { 
  position: absolute; 
  top: 8px; 
  right: 8px; 
  background: #4d1b1b; 
  color: #ff6b6b; 
  width: 28px; 
  height: 28px; 
  border-radius: 50%; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  font-size: 16px; 
  cursor: pointer; 
  transition: all 0.2s; 
  padding: 0; 
  z-index: 10; 
}
.delete-btn:hover { background: #6b2020; transform: scale(1.1); }

.shelf-summary {
  background: #1a1d2e;
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 14px;
  color: #e8e8ea;
  margin-bottom: 12px;
  text-align: center;
  font-weight: 600;
}

.date-mode-toggle {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 10px;
}

.date-mode-toggle button {
  padding: 10px;
  background: #1f2430;
  color: #fff;
  border-radius: 8px;
  font-weight: 600;
  font-size: 13px;
}

.date-mode-toggle button.active {
  background: #667eea;
}

.date-selectors {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
  margin-top: 10px;
}

.date-selectors.two-col {
  grid-template-columns: 1fr 1fr;
}

.date-selectors select {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #333;
  background: #1a1d2e;
  color: #fff;
  font-size: 14px;
  font-weight: 600;
}

.helper-text {
  margin-top: 8px;
  font-size: 12px;
  color: #888;
  font-style: italic;
}
</style>
</head>

<body>
<div class="wrap">
<h2>KEESS</h2>
<div style="margin-top:-8px; font-size:14px; color:#888; margin-bottom:20px;">
  Keep or Toss
</div>

<div class="card">
<label>Product Name (optional)</label>
<input type="text" id="productName" placeholder="e.g. Est√©e Lauder Night Repair">

<label>Opening Date</label>
<div class="date-mode-toggle">
  <button id="exactBtn" class="active" onclick="setDateMode('exact')">I remember the exact date</button>
  <button id="estimatedBtn" onclick="setDateMode('estimated')">I'm not sure</button>
</div>

<div id="exactDateSelectors" class="date-selectors">
  <select id="yearSelect"></select>
  <select id="monthSelect"></select>
  <select id="daySelect"></select>
</div>

<div id="estimatedDateSelectors" class="date-selectors two-col" style="display:none;">
  <select id="yearSelectEst"></select>
  <select id="monthSelectEst"></select>
</div>

<div id="helperText" class="helper-text" style="display:none;">
  It's okay if you don't remember the exact date. Just pick the closest month.
</div>

<label>Period After Opening (PAO)</label>
<div class="pao" id="paoBtns"></div>

<label>Upload Product Photo</label>
<div class="photo-buttons">
  <button onclick="document.getElementById('cameraInput').click()">üì∏ Take a photo</button>
  <button onclick="document.getElementById('galleryInput').click()">üñº Select from gallery</button>
</div>
<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">
<input type="file" id="galleryInput" accept="image/*" style="display:none;">
<div class="file-name" id="fileName"></div>

<img id="preview" style="display:none">

<div id="result" class="result">Select a PAO period</div>
<div id="statusLabel" class="status-label" style="display:none"></div>
<div id="status" class="status" style="display:none"></div>

<button id="saveBtn" style="width:100%; margin-top:14px; background:#20c997;">Save to My Shelf</button>
</div>

<div class="card">
<div style="background: #1a1d2e; padding: 14px; border-radius: 10px; font-size: 14px; line-height: 1.6; color: #aaa; margin-bottom: 14px;">
Most people use expired cosmetics without knowing it.
</div>
<h3 style="margin:0 0 12px 0">‚ÑπÔ∏è What is PAO?</h3>
<div style="background: #1a1d2e; padding: 14px; border-radius: 10px; font-size: 14px; line-height: 1.6; color: #aaa;">
<strong style="color:#667eea">Period After Opening (PAO)</strong> indicates the time a cosmetic product can be safely used after opening.<br><br>
Check the jar icon on your product for the number (e.g., 12M = 12 months).
</div>
</div>

<div id="shelfSection" class="shelf-section">
<h2>üì¶ My Shelf</h2>
<div id="shelfSummary"></div>
<div id="shelfItems"></div>
</div>

</div>

<script>
const SUPPORTED_PAOS = [3, 6, 12, 24];
const PAOS = [3, 6, 9, 12, 18, 24, 36];
const SHELF_STORAGE_KEY = "myShelf";

let selectedPAO = null;
let currentImageDataURL = null;
let lastStatus = null;
let ocrProcessed = false;
let dateMode = 'exact';

const productName = document.getElementById("productName");
const paoBox = document.getElementById("paoBtns");
const result = document.getElementById("result");
const statusLabel = document.getElementById("statusLabel");
const preview = document.getElementById("preview");
const status = document.getElementById("status");
const fileName = document.getElementById("fileName");
const saveBtn = document.getElementById("saveBtn");
const shelfSummary = document.getElementById("shelfSummary");
const shelfItems = document.getElementById("shelfItems");

const exactBtn = document.getElementById("exactBtn");
const estimatedBtn = document.getElementById("estimatedBtn");
const exactDateSelectors = document.getElementById("exactDateSelectors");
const estimatedDateSelectors = document.getElementById("estimatedDateSelectors");
const helperText = document.getElementById("helperText");

const yearSelect = document.getElementById("yearSelect");
const monthSelect = document.getElementById("monthSelect");
const daySelect = document.getElementById("daySelect");
const yearSelectEst = document.getElementById("yearSelectEst");
const monthSelectEst = document.getElementById("monthSelectEst");

function initDateSelectors() {
  const currentDate = new Date();
  const currentYear = currentDate.getFullYear();
  const currentMonth = currentDate.getMonth() + 1;
  const currentDay = currentDate.getDate();
  
  for (let y = currentYear; y >= currentYear - 5; y--) {
    yearSelect.add(new Option(y, y));
    yearSelectEst.add(new Option(y, y));
  }
  
  for (let m = 1; m <= 12; m++) {
    const monthName = new Date(2000, m - 1, 1).toLocaleString('en', { month: 'long' });
    monthSelect.add(new Option(monthName, m));
    monthSelectEst.add(new Option(monthName, m));
  }
  
  yearSelect.value = currentYear;
  monthSelect.value = currentMonth;
  yearSelectEst.value = currentYear;
  monthSelectEst.value = currentMonth;
  
  updateDayOptions();
  daySelect.value = currentDay;
}

function getDaysInMonth(year, month) {
  return new Date(year, month, 0).getDate();
}

function updateDayOptions() {
  const year = parseInt(yearSelect.value);
  const month = parseInt(monthSelect.value);
  const daysInMonth = getDaysInMonth(year, month);
  const currentDay = daySelect.value || 1;
  
  daySelect.innerHTML = '';
  for (let d = 1; d <= daysInMonth; d++) {
    daySelect.add(new Option(d, d));
  }
  
  if (currentDay <= daysInMonth) {
    daySelect.value = currentDay;
  } else {
    daySelect.value = daysInMonth;
  }
}

yearSelect.onchange = updateDayOptions;
monthSelect.onchange = updateDayOptions;

yearSelect.onchange = () => { updateDayOptions(); updateResult(); };
monthSelect.onchange = () => { updateDayOptions(); updateResult(); };
daySelect.onchange = updateResult;
yearSelectEst.onchange = updateResult;
monthSelectEst.onchange = updateResult;

function setDateMode(mode) {
  dateMode = mode;
  
  if (mode === 'exact') {
    exactBtn.classList.add('active');
    estimatedBtn.classList.remove('active');
    exactDateSelectors.style.display = 'grid';
    estimatedDateSelectors.style.display = 'none';
    helperText.style.display = 'none';
  } else {
    exactBtn.classList.remove('active');
    estimatedBtn.classList.add('active');
    exactDateSelectors.style.display = 'none';
    estimatedDateSelectors.style.display = 'grid';
    helperText.style.display = 'block';
  }
  
  updateResult();
}

function getOpeningDate() {
  if (dateMode === 'exact') {
    const year = yearSelect.value;
    const month = String(monthSelect.value).padStart(2, '0');
    const day = String(daySelect.value).padStart(2, '0');
    return `${year}-${month}-${day}`;
  } else {
    const year = yearSelectEst.value;
    const month = String(monthSelectEst.value).padStart(2, '0');
    return `${year}-${month}-01`;
  }
}

SUPPORTED_PAOS.forEach(m => {
  const b = document.createElement("button");
  b.textContent = m + "M";
  b.onclick = () => { selectPAO(m); updateResult(); };
  paoBox.appendChild(b);
});

function selectPAO(m) {
  selectedPAO = m;
  [...paoBox.children].forEach(b => {
    b.classList.toggle("active", b.textContent === m + "M");
  });
}

function addMonths(d, m) {
  const [y, mo, da] = d.split("-").map(Number);
  const dt = new Date(y, mo - 1, da);
  dt.setMonth(dt.getMonth() + m);
  return dt;
}

function updateResult() {
  if (!selectedPAO) { 
    result.textContent = "Select a PAO period";
    statusLabel.style.display = "none";
    lastStatus = null;
    return; 
  }
  
  const openingDate = getOpeningDate();
  const toss = addMonths(openingDate, selectedPAO);
  const daysLeft = Math.ceil((toss - new Date()) / (1000 * 60 * 60 * 24));
  
  let statusText = "";
  let statusColor = "";
  let resultMessage = "";
  
  if (daysLeft < 0) {
    statusText = "TOSS";
    statusColor = "#4d1b1b";
    resultMessage = "üóëÔ∏è This product should be thrown away";
  } else if (daysLeft <= 60) {
    statusText = "USE SOON";
    statusColor = "#4d4d1b";
    resultMessage = "‚ö† Expiring soon ‚Äî " + daysLeft + " days left";
  } else {
    statusText = "KEEP";
    statusColor = "#1b4d3e";
    resultMessage = "‚úÖ Safe (for now)";
  }
  
  result.textContent = resultMessage;
  
  if (statusText !== lastStatus) {
    statusLabel.classList.remove("animate");
    void statusLabel.offsetWidth;
    statusLabel.classList.add("animate");
    lastStatus = statusText;
  }
  
  statusLabel.textContent = statusText;
  statusLabel.style.background = statusColor;
  statusLabel.style.display = "block";

  saveBtn.style.display = "block";
}

function extractPAO(text) {
  console.log("Detected text:", text);
  
  const versions = [
    text,
    text.toUpperCase(),
    text.replace(/\s+/g, ''),
    text.replace(/[^a-zA-Z0-9]/g, ' '),
  ];
  
  const patterns = [
    /(\d{1,2})\s*M\b/gi,
    /(\d{1,2})M/gi,
    /M\s*(\d{1,2})/gi,
  ];
  
  for (let ver of versions) {
    for (let pattern of patterns) {
      pattern.lastIndex = 0;
      let match;
      while ((match = pattern.exec(ver)) !== null) {
        const num = parseInt(match[1]);
        if (PAOS.includes(num)) {
          console.log("‚úì Found PAO:", num);
          return num;
        }
      }
    }
  }
  
  const numbers = text.match(/\d+/g);
  if (numbers) {
    for (let numStr of numbers) {
      const num = parseInt(numStr);
      if (PAOS.includes(num)) {
        const idx = text.indexOf(numStr);
        const context = text.substring(Math.max(0, idx - 2), Math.min(text.length, idx + numStr.length + 2));
        if (/m/i.test(context)) {
          console.log("‚úì Found PAO by context:", num);
          return num;
        }
      }
    }
  }
  
  return null;
}

async function detectWithGoogle(base64Image) {
  const apiKey = document.getElementById("apiKey");
  const key = apiKey.value.trim();
  
  if (!key) {
    throw new Error("API key not found");
  }
  
  const base64Content = base64Image.split(',')[1];
  
  const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${key}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      requests: [
        {
          image: {
            content: base64Content
          },
          features: [
            {
              type: 'TEXT_DETECTION',
              maxResults: 10
            }
          ]
        }
      ]
    })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error?.message || `API error: ${response.status}`);
  }
  
  const data = await response.json();
  
  console.log("Google Vision response:", data);
  
  const textAnnotations = data.responses[0]?.textAnnotations;
  
  if (!textAnnotations || textAnnotations.length === 0) {
    return null;
  }
  
  const fullText = textAnnotations[0].description;
  
  return extractPAO(fullText);
}

async function handleFileSelect(e) {
  const file = e.target.files[0];
  if (!file) return;

  ocrProcessed = false;

  fileName.textContent = file.name;
  
  const reader = new FileReader();
  
  reader.onload = async (event) => {
    const base64 = event.target.result;
    currentImageDataURL = base64;
    
    preview.src = base64;
    preview.style.display = "block";

    if (ocrProcessed) {
      console.log("This image was already OCR processed. Skipping...");
      return;
    }

    ocrProcessed = true;

    status.style.display = "block";
    status.style.background = "#4d4d1b";
    status.style.color = "#f0ad4e";
    status.textContent = "üîç Analyzing with Google Vision...";

    try {
      const pao = await detectWithGoogle(base64);
      
      if (pao && SUPPORTED_PAOS.includes(pao)) {
        selectPAO(pao);
        updateResult();
        status.style.background = "#1b4d3e";
        status.style.color = "#20c997";
        status.textContent = `‚úì Detected: ${pao}M`;
      } else if (pao) {
        status.style.background = "#4d4d1b";
        status.style.color = "#f0ad4e";
        status.textContent = `‚ö† Detected ${pao}M but not supported. Select manually ‚Üì`;
      } else {
        status.style.background = "#4d1b1b";
        status.style.color = "#ff6b6b";
        status.textContent = "‚ùå Could not detect PAO. Select manually ‚Üì";
      }
      
    } catch (err) {
      console.error(err);
      status.style.background = "#4d1b1b";
      status.style.color = "#ff6b6b";
      status.textContent = "‚ö† Error: " + err.message;
    }
  };
  
  reader.readAsDataURL(file);
}

document.getElementById("cameraInput").onchange = handleFileSelect;
document.getElementById("galleryInput").onchange = handleFileSelect;

function loadShelfFromStorage() {
  try {
    const stored = localStorage.getItem(SHELF_STORAGE_KEY);
    if (!stored) {
      console.log("No shelf data");
      return [];
    }
    const parsed = JSON.parse(stored);
    console.log("Loaded shelf data:", parsed.length, "items");
    return Array.isArray(parsed) ? parsed : [];
  } catch (err) {
    console.error("Shelf load error:", err);
    return [];
  }
}

function saveShelfToStorage(shelf) {
  try {
    localStorage.setItem(SHELF_STORAGE_KEY, JSON.stringify(shelf));
    console.log("Saved shelf data:", shelf.length, "items");
    return true;
  } catch (err) {
    console.error("Shelf save error:", err);
    alert("‚ö† Save failed: " + err.message);
    return false;
  }
}

function computeStatusFromExpiry(expiryDate) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const expiry = new Date(expiryDate);
  expiry.setHours(0, 0, 0, 0);
  
  const daysLeft = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
  
  if (daysLeft < 0) {
    return "TOSS";
  } else if (daysLeft <= 60) {
    return "USE SOON";
  } else {
    return "KEEP";
  }
}

function refreshAllStatuses() {
  const shelf = loadShelfFromStorage();
  let updated = false;
  
  shelf.forEach(item => {
    const newStatus = computeStatusFromExpiry(item.expiryDate);
    if (item.status !== newStatus) {
      item.status = newStatus;
      updated = true;
    }
  });
  
  if (updated) {
    saveShelfToStorage(shelf);
    console.log("‚úì Statuses refreshed and saved");
  }
  
  return shelf;
}

saveBtn.onclick = () => {
  if (!selectedPAO) {
    alert("‚ö† First select a PAO period");
    return;
  }

  const openingDate = getOpeningDate();
  const expiryDate = addMonths(openingDate, selectedPAO).toISOString().slice(0, 10);
  const itemStatus = computeStatusFromExpiry(expiryDate);

  const name = productName.value.trim() || "noname";

  const item = {
    name: name,
    pao: selectedPAO + "M",
    openingDate: openingDate,
    expiryDate: expiryDate,
    status: itemStatus,
    isEstimated: dateMode === 'estimated',
    createdAt: Date.now()
  };

  const shelf = loadShelfFromStorage();
  shelf.push(item);
  
  const saveSuccess = saveShelfToStorage(shelf);
  
  if (saveSuccess) {
    alert("‚úì Saved to My Shelf!");
    productName.value = "";
    renderShelf();
  }
};

function getStatusPriority(status) {
  const priorities = {
    "TOSS": 1,
    "USE SOON": 2,
    "KEEP": 3
  };
  return priorities[status] || 999;
}

function deleteItem(createdAt) {
  if (!confirm("Really delete?")) return;
  
  const shelf = loadShelfFromStorage();
  const updatedShelf = shelf.filter(item => item.createdAt !== createdAt);
  saveShelfToStorage(updatedShelf);
  renderShelf();
}

function formatOpeningDate(dateStr, isEstimated) {
  if (isEstimated) {
    const [year, month] = dateStr.split('-');
    const monthName = new Date(year, parseInt(month) - 1, 1).toLocaleString('en', { month: 'short' });
    return `${monthName} ${year} (estimated)`;
  } else {
    return dateStr;
  }
}

function renderShelf() {
  const shelf = refreshAllStatuses();
  
  if (shelf.length === 0) {
    shelfSummary.innerHTML = '';
    shelfItems.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">No items in your shelf yet. Add your first product!</div>';
    return;
  }
  
  const tossCount = shelf.filter(item => item.status === "TOSS").length;
  const useSoonCount = shelf.filter(item => item.status === "USE SOON").length;
  
  let summaryText = "";
  if (tossCount > 0 && useSoonCount > 0) {
    summaryText = `üóëÔ∏è ${tossCount} expired ¬∑ ‚ö† ${useSoonCount} expiring soon`;
  } else if (tossCount > 0) {
    summaryText = `üóëÔ∏è ${tossCount} expired`;
  } else if (useSoonCount > 0) {
    summaryText = `‚ö† ${useSoonCount} expiring soon`;
  }
  
  if (summaryText) {
    shelfSummary.innerHTML = `<div class="shelf-summary">${summaryText}</div>`;
  } else {
    shelfSummary.innerHTML = '';
  }
  
  const itemsWithStatus = shelf.map(item => {
    if (!item.createdAt) {
      item.createdAt = Date.now() + Math.random();
    }
    
    if (!item.name) {
      item.name = "noname";
    }
    
    return {
      ...item,
      displayStatus: item.status
    };
  });
  
  itemsWithStatus.sort((a, b) => {
    return getStatusPriority(a.displayStatus) - getStatusPriority(b.displayStatus);
  });
  
  shelfItems.innerHTML = itemsWithStatus.map(item => {
    const itemStatus = item.displayStatus;
    
    let statusColor = "";
    if (itemStatus === "TOSS") {
      statusColor = "#4d1b1b";
    } else if (itemStatus === "USE SOON") {
      statusColor = "#4d4d1b";
    } else {
      statusColor = "#1b4d3e";
    }
    
    const openingDateDisplay = formatOpeningDate(item.openingDate, item.isEstimated || false);
    
    return `
      <div class="shelf-item">
        <button class="delete-btn" onclick="deleteItem(${item.createdAt})">√ó</button>
        <div class="shelf-item-content">
          <div class="shelf-item-name">${item.name}</div>
          <div class="shelf-item-meta">${item.pao} ¬∑ Expires ${item.expiryDate}</div>
          <div class="shelf-item-dates">Opened: ${openingDateDisplay}</div>
        </div>
        <div class="shelf-item-status" style="background: ${statusColor};">
          ${itemStatus}
        </div>
      </div>
    `;
  }).join('');
}

(function cleanupOldData() {
  try {
    const stored = localStorage.getItem(SHELF_STORAGE_KEY);
    if (stored) {
      const shelf = JSON.parse(stored);
      if (shelf.length > 0 && shelf[0].image) {
        console.warn("‚ö† Old format data detected. Cleaning up...");
        localStorage.removeItem(SHELF_STORAGE_KEY);
        console.log("‚úì Shelf data reset. Ready to use without storage issues.");
      }
    }
  } catch (err) {
    console.error("Data cleanup error:", err);
  }
})();

(async function initNotifications() {
  if (!("Notification" in window)) {
    console.log("Browser does not support notifications");
    return;
  }

  if (Notification.permission === "default") {
    try {
      await Notification.requestPermission();
    } catch (err) {
      console.error("Notification permission error:", err);
    }
  }

  if (Notification.permission !== "granted") {
    console.log("Notification permission not granted");
    return;
  }

  const shelf = refreshAllStatuses();
  
  if (shelf.length === 0) {
    return;
  }

  const hasToss = shelf.some(item => item.status === "TOSS");
  const hasUseSoon = shelf.some(item => item.status === "USE SOON");

  if (hasToss) {
    new Notification("PAO Calculator", {
      body: "Some products are expired. Toss them.",
      icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>üóëÔ∏è</text></svg>",
      silent: true
    });
    console.log("‚úì Notification sent: TOSS");
  } else if (hasUseSoon) {
    new Notification("PAO Calculator", {
      body: "Some products are expiring soon.",
      icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>‚ö†Ô∏è</text></svg>",
      silent: true
    });
    console.log("‚úì Notification sent: USE SOON");
  }
})();

initDateSelectors();
renderShelf();
</script>

<input type="text" id="apiKey" value="AIzaSyAtwhPrHK5d_yLVkBfOc8tDjfk-2_cHDrw" style="display:none;" />

</body>
</html>