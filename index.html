<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>í™”ì¥í’ˆ ì‚¬ìš©ê¸°í•œ ê´€ë¦¬</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
* { box-sizing: border-box; }
body { margin: 0; background: #0b0c10; color: #e8e8ea; font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", "ë§‘ì€ ê³ ë”•", sans-serif; }
.wrap { max-width: 420px; margin: 0 auto; padding: 16px; }
.card { background: #111318; border-radius: 16px; padding: 16px; margin-bottom: 16px; }
h2 { margin: 0 0 20px 0; font-size: 28px; }
img { width: 100%; border-radius: 12px; margin-top: 10px; display: block; }
.pao { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 12px; }
button { padding: 12px; border-radius: 10px; border: none; background: #1f2430; color: #fff; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.2s; }
button:hover { background: #2a3142; transform: translateY(-2px); }
button.active { background: linear-gradient(135deg, #667eea, #764ba2); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5); }
.result { margin-top: 14px; font-weight: 800; font-size: 17px; text-align: center; padding: 14px; background: #1a1d2e; border-radius: 10px; }
input[type="date"], input[type="text"] { width: 100%; margin-top: 10px; padding: 10px; border-radius: 8px; border: none; font-size: 14px; }
input[type="file"] { width: 100%; padding: 10px; background: #1a1d2e; border: 2px dashed #333; border-radius: 8px; color: #e8e8ea; cursor: pointer; margin-top: 10px; }
input[type="file"]::-webkit-file-upload-button { background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; }
.status { margin-top: 10px; padding: 12px; border-radius: 8px; text-align: center; font-weight: 600; font-size: 14px; }
.add-btn { background: linear-gradient(135deg, #20c997, #17a2b8); width: 100%; margin-top: 12px; padding: 14px; font-size: 16px; }
.add-btn:hover { background: linear-gradient(135deg, #17a2b8, #20c997); }
.add-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.vanity-list { margin-top: 16px; }
.vanity-item { background: #1a1d2e; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
.vanity-item .info { flex: 1; }
.vanity-item .name { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
.vanity-item .date { font-size: 12px; color: #888; }
.vanity-item .delete { background: #dc3545; padding: 8px 12px; border-radius: 6px; font-size: 12px; }
.vanity-item.expired { border-left: 4px solid #dc3545; }
.vanity-item.warning { border-left: 4px solid #ffc107; }
.vanity-item.safe { border-left: 4px solid #20c997; }
.vanity-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-right: 12px; }
label { display: block; margin-top: 12px; margin-bottom: 4px; font-size: 14px; color: #aaa; }
</style>
</head>

<body>
<div class="wrap">
<h2>ğŸ’„ í™”ì¥í’ˆ ì‚¬ìš©ê¸°í•œ ê´€ë¦¬</h2>

<div class="card">
<label>ì œí’ˆëª…</label>
<input type="text" id="productName" placeholder="ì œí’ˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">

<label>ê°œë´‰ì¼ì</label>
<input type="date" id="opened">

<label>ì‚¬ìš©ê¸°í•œ (PAO) ì„ íƒ</label>
<div class="pao" id="paoBtns"></div>

<label>ì œí’ˆ ì‚¬ì§„ (ì„ íƒì‚¬í•­)</label>
<input type="file" id="fileInput" accept="image/*">
<img id="preview" style="display:none">

<div id="result" class="result">ì‚¬ìš©ê¸°í•œì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
<div id="status" class="status" style="display:none"></div>
<button class="add-btn" onclick="addToVanity()">â• ë‚´ í™”ì¥ëŒ€ì— ì¶”ê°€</button>
</div>

<div class="card">
<h3 style="margin:0 0 12px 0">ğŸ’„ ë‚´ í™”ì¥ëŒ€</h3>
<div id="vanityList" class="vanity-list"></div>
</div>
</div>

<script>
const PAOS = [3, 6, 9, 12, 18, 24, 36];
let selectedPAO = null;

const opened = document.getElementById("opened");
const productName = document.getElementById("productName");
const paoBox = document.getElementById("paoBtns");
const result = document.getElementById("result");
const preview = document.getElementById("preview");
const status = document.getElementById("status");
const vanityList = document.getElementById("vanityList");

opened.value = new Date().toISOString().slice(0, 10);

let vanityItems = JSON.parse(localStorage.getItem('vanityItems') || '[]');

PAOS.forEach(m => {
  const b = document.createElement("button");
  b.textContent = m + "ê°œì›”";
  b.onclick = () => { selectPAO(m); updateResult(); };
  paoBox.appendChild(b);
});

function selectPAO(m) {
  selectedPAO = m;
  [...paoBox.children].forEach(b => {
    b.classList.toggle("active", b.textContent === m + "ê°œì›”");
  });
}

function addMonths(d, m) {
  const [y, mo, da] = d.split("-").map(Number);
  const dt = new Date(y, mo - 1, da);
  dt.setMonth(dt.getMonth() + m);
  return dt;
}

function updateResult() {
  if (!selectedPAO) { result.textContent = "ì‚¬ìš©ê¸°í•œì„ ì„ íƒí•´ì£¼ì„¸ìš”"; return; }
  const toss = addMonths(opened.value, selectedPAO);
  result.textContent = `${selectedPAO}ê°œì›” Â· íê¸°ì¼ ${toss.toISOString().slice(0, 10)}`;
}

function addToVanity() {
  if (!selectedPAO) {
    alert('ì‚¬ìš©ê¸°í•œì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!');
    return;
  }

  const name = productName.value.trim() || 'ì´ë¦„ ì—†ëŠ” ì œí’ˆ';
  const openDate = opened.value;
  const tossDate = addMonths(openDate, selectedPAO).toISOString().slice(0, 10);
  
  const item = {
    id: Date.now(),
    name: name,
    pao: selectedPAO,
    opened: openDate,
    toss: tossDate,
    image: preview.style.display === 'block' ? preview.src : null
  };

  vanityItems.unshift(item);
  localStorage.setItem('vanityItems', JSON.stringify(vanityItems));
  
  renderVanity();
  
  productName.value = '';
  preview.style.display = 'none';
  status.style.display = 'none';
  document.getElementById('fileInput').value = '';
  
  alert('âœ… í™”ì¥ëŒ€ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

function deleteItem(id) {
  if (!confirm('ì´ ì œí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  vanityItems = vanityItems.filter(item => item.id !== id);
  localStorage.setItem('vanityItems', JSON.stringify(vanityItems));
  renderVanity();
}

function renderVanity() {
  if (vanityItems.length === 0) {
    vanityList.innerHTML = '<div style="text-align:center;color:#666;padding:20px">ì•„ì§ ë“±ë¡ëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }

  const today = new Date().toISOString().slice(0, 10);
  
  vanityList.innerHTML = vanityItems.map(item => {
    const daysLeft = Math.ceil((new Date(item.toss) - new Date(today)) / (1000 * 60 * 60 * 24));
    
    let statusClass = 'safe';
    let statusText = `${daysLeft}ì¼ ë‚¨ìŒ`;
    
    if (daysLeft < 0) {
      statusClass = 'expired';
      statusText = `ë§Œë£Œ ${Math.abs(daysLeft)}ì¼ ì§€ë‚¨`;
    } else if (daysLeft <= 30) {
      statusClass = 'warning';
      statusText = `âš  ${daysLeft}ì¼ ë‚¨ìŒ`;
    }

    return `
      <div class="vanity-item ${statusClass}">
        ${item.image ? `<img src="${item.image}">` : ''}
        <div class="info">
          <div class="name">${item.name}</div>
          <div class="date">${item.pao}ê°œì›” Â· ê°œë´‰ì¼ ${item.opened}</div>
          <div class="date">${statusText}</div>
        </div>
        <button class="delete" onclick="deleteItem(${item.id})">ğŸ—‘</button>
      </div>
    `;
  }).join('');
}

// ğŸ” ê°œì„ ëœ PAO ì¶”ì¶œ í•¨ìˆ˜
function extractPAO(text) {
  const clean = text.replace(/\s+/g, '').toUpperCase();
  
  const patterns = [
    /(\d+)M/,
    /(\d+)\s*M/,
  ];
  
  for (let pattern of patterns) {
    const match = clean.match(pattern);
    if (match) {
      const num = parseInt(match[1]);
      if (PAOS.includes(num)) {
        return num;
      }
    }
  }
  
  return null;
}

document.getElementById("fileInput").onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  preview.src = URL.createObjectURL(file);
  preview.style.display = "block";

  status.style.display = "block";
  status.style.background = "#4d4d1b";
  status.style.color = "#f0ad4e";
  status.textContent = "ğŸ” ì‚¬ìš©ê¸°í•œ ì¸ì‹ ì¤‘...";

  try {
    const { data: { text } } = await Tesseract.recognize(file, 'eng', {
      logger: m => {
        if (m.status === 'recognizing text') {
          const pct = Math.round(m.progress * 100);
          status.textContent = `ğŸ” ë¶„ì„ ì¤‘... ${pct}%`;
        }
      }
    });

    console.log("OCR ê²°ê³¼:", text);
    
    const pao = extractPAO(text);
    
    if (pao) {
      selectPAO(pao);
      updateResult();
      status.style.background = "#1b4d3e";
      status.style.color = "#20c997";
      status.textContent = `âœ“ ${pao}ê°œì›” ì¸ì‹ë¨`;
    } else {
      status.style.background = "#4d1b1b";
      status.style.color = "#ff6b6b";
      status.textContent = "âŒ ì¸ì‹ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ì„ íƒí•´ì£¼ì„¸ìš” â†“";
    }
  } catch (err) {
    console.error(err);
    status.style.background = "#4d1b1b";
    status.style.color = "#ff6b6b";
    status.textContent = "âš  ì˜¤ë¥˜ ë°œìƒ. ìˆ˜ë™ìœ¼ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”";
  }
};

opened.onchange = updateResult;

renderVanity();
</script>
</body>
</html>