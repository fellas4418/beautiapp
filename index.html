<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Keep or Toss</title>
  <meta name="theme-color" content="#0b0c10" />
  <style>
    :root{
      --bg:#0b0c10;
      --card:#111318;
      --card2:#141720;
      --text:#e8e8ea;
      --muted:#a8abb4;
      --border:rgba(255,255,255,.10);

      --btn:#2b6cff;
      --btnText:#ffffff;
      --btn2:#1f2430;

      --ok:#20c997;
      --warn:#ffcc00;
      --bad:#ff4d4f;

      --shadow: 0 10px 28px rgba(0,0,0,.45);
      --r:18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background: radial-gradient(1200px 800px at 10% 5%, rgba(43,108,255,.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 10%, rgba(32,201,151,.14), transparent 50%),
                  var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    a{ color:inherit; }
    .wrap{
      max-width: 760px;
      margin: 0 auto;
      padding: 18px 14px 28px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .logo{
      width:34px;height:34px;border-radius:10px;
      background: linear-gradient(135deg, rgba(43,108,255,.9), rgba(32,201,151,.9));
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      flex: 0 0 auto;
    }
    .brandText{
      min-width:0;
      display:flex;
      flex-direction:column;
      line-height:1.15;
    }
    .brandTitle{
      font-weight: 750;
      letter-spacing: .2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandSub{
      color:var(--muted);
      font-size: 12.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill{
      padding: 7px 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      border-radius: 999px;
      font-size: 12.5px;
      flex:0 0 auto;
    }

    .card{
      background: rgba(17,19,24,.82);
      border: 1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 16px;
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .card + .card{ margin-top: 14px; }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .col{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .title{
      font-size: 20px;
      font-weight: 780;
      letter-spacing: .2px;
    }
    .sub{
      color: var(--muted);
      font-size: 13.5px;
      line-height: 1.4;
    }

    .btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 650;
      letter-spacing: .2px;
      cursor: pointer;
      width: 100%;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(43,108,255,.95), rgba(43,108,255,.75));
      border-color: rgba(43,108,255,.55);
      color: var(--btnText);
    }
    .btn.ghost{
      background: rgba(31,36,48,.55);
    }
    .btn.danger{
      background: rgba(255,77,79,.10);
      border-color: rgba(255,77,79,.30);
      color: #ffd7d7;
    }
    .btn.small{
      padding: 10px 12px;
      border-radius: 12px;
      width: auto;
      white-space:nowrap;
    }
    .btnrow{
      display:flex;
      gap:10px;
      margin-top: 12px;
    }
    .btnrow .btn{ width: 100%; }

    .hero{
      padding: 18px 16px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(43,108,255,.16), rgba(32,201,151,.10));
    }
    .heroBig{
      font-size: 44px;
      font-weight: 820;
      letter-spacing: .3px;
      margin: 4px 0 6px;
    }
    .heroText{
      color: var(--muted);
      line-height: 1.45;
      font-size: 14px;
      margin: 0 0 14px;
    }

    .preview{
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      overflow:hidden;
      position:relative;
      margin-top: 12px;
    }
    .preview .empty{
      padding: 18px;
      color: var(--muted);
      text-align:center;
    }
    .preview img, .preview video{
      display:block;
      width:100%;
      height:auto;
    }
    .preview video{
      background: #000;
      aspect-ratio: 3/4;
      object-fit: cover;
    }
    .badgeTag{
      position:absolute;
      top:10px;
      left:10px;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      backdrop-filter: blur(8px);
    }

    .field{
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px 12px;
      background: rgba(255,255,255,.03);
    }
    .label{
      font-size: 12.5px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input[type="text"], input[type="date"]{
      width:100%;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: var(--text);
      border-radius: 12px;
      padding: 12px 12px;
      font-size: 15px;
      outline: none;
    }

    .split{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .split > *{ flex: 1 1 240px; }

    .center{
      text-align:center;
      padding: 12px 0 2px;
    }
    .spinner{
      width: 34px;
      height: 34px;
      border-radius: 50%;
      margin: 14px auto 0;
      border: 3px solid rgba(255,255,255,.18);
      border-top-color: rgba(43,108,255,.95);
      animation: spin 1s linear infinite;
    }
    @keyframes spin{
      to{ transform: rotate(360deg); }
    }

    .resultBig{
      font-size: 66px;
      font-weight: 860;
      letter-spacing: .6px;
      margin: 4px 0 0;
    }
    .resultMini{
      color: var(--muted);
      font-size: 14px;
      margin: 6px 0 0;
      line-height: 1.45;
    }

    .shelfTop{
      display:flex;
      align-items:stretch;
      gap:12px;
      flex-wrap:wrap;
    }
    .shelfCount{
      flex: 1 1 220px;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
    }
    .shelfCount .num{
      font-size: 56px;
      font-weight: 850;
      line-height:1;
      margin-top: 2px;
    }
    .shelfCount .txt{
      color: var(--muted);
      margin-top: 6px;
    }
    .shelfActions{
      display:flex;
      gap:10px;
      flex: 1 1 220px;
      justify-content:flex-end;
      align-items:flex-start;
    }
    .shelfActions .btn{ width:auto; }

    .gauge{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .ring{
      width: 150px;
      height: 150px;
      border-radius: 999px;
      background: conic-gradient(var(--ok) 0deg, var(--ok) 0deg, rgba(255,255,255,.10) 0deg);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      flex: 0 0 auto;
    }
    .ring::after{
      content:"";
      width: 116px;
      height: 116px;
      border-radius: 999px;
      background: rgba(17,19,24,.92);
      border: 1px solid rgba(255,255,255,.10);
      position:absolute;
      inset: 0;
      margin:auto;
    }
    .ringInner{
      position:relative;
      z-index:2;
      text-align:center;
      line-height:1.05;
    }
    .ringPct{
      font-size: 38px;
      font-weight: 850;
    }
    .ringLbl{
      color: var(--muted);
      font-size: 12px;
      margin-top: 2px;
    }
    .gaugeText{
      flex: 1 1 220px;
      min-width: 220px;
    }
    .gaugeTitle{
      font-size: 18px;
      font-weight: 780;
      margin-bottom: 4px;
    }
    .gaugeDesc{
      color: var(--muted);
      line-height: 1.45;
      font-size: 13.5px;
      margin-bottom: 10px;
    }
    .gaugeMini{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12.5px;
      color: var(--muted);
    }

    .list{
      margin-top: 12px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .item{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .itemLeft{ min-width:0; }
    .itemName{
      font-weight: 780;
      font-size: 16px;
      margin-bottom: 6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 48vw;
    }
    .itemMeta{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }
    .itemRight{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
      flex:0 0 auto;
    }
    .tag{
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12.5px;
      font-weight: 750;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--muted);
    }
    .tag.safe{
      border-color: rgba(32,201,151,.30);
      background: rgba(32,201,151,.12);
      color: rgba(200,255,240,.95);
    }
    .tag.toss{
      border-color: rgba(255,77,79,.35);
      background: rgba(255,77,79,.12);
      color: rgba(255,220,220,.96);
    }

    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 20px 14px;
      z-index: 9999;
      backdrop-filter: blur(6px);
    }
    .modal{
      width: min(520px, 100%);
      background: rgba(17,19,24,.92);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      padding: 16px;
    }
    .modalTitle{
      font-size: 18px;
      font-weight: 820;
      margin-bottom: 6px;
    }
    .modalSub{
      color: var(--muted);
      font-size: 13.5px;
      line-height: 1.45;
    }
    .modalActions{
      display:flex;
      gap:10px;
      margin-top: 14px;
    }
    .modalActions .btn{ width: 100%; }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      z-index: 9998;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(17,19,24,.90);
      box-shadow: 0 18px 40px rgba(0,0,0,.55);
      padding: 10px 12px;
      border-radius: 14px;
      color: rgba(255,255,255,.92);
      font-size: 13px;
      max-width: min(560px, calc(100% - 24px));
      backdrop-filter: blur(8px);
      opacity: 0;
      transition: opacity .18s ease, transform .18s ease;
      pointer-events:none;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    @media (max-width: 420px){
      .heroBig{ font-size: 38px; }
      .ring{ width: 140px; height: 140px; }
      .ring::after{ width: 110px; height: 110px; }
      .itemName{ max-width: 56vw; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="brandText">
          <div class="brandTitle">Keep or Toss</div>
          <div class="brandSub">Check your makeup before you use it.</div>
        </div>
      </div>
      <div id="savedPill" class="pill">Not saved</div>
    </div>

    <div id="app"></div>
  </div>

  <div id="modal-root"></div>
  <div id="toast" class="toast"></div>

  <script>
    // Configure your Worker endpoint here (optional).
    // Expected to return JSON like: { detected: "6M" } or { text: "Detected 6M" }
    // If empty, a local mock will be used.
    const WORKER_OCR_ENDPOINT = ""; // example: "https://skinguard.ohryee.workers.dev/ocr"

    const Screen = {
      ENTRY: "ENTRY",
      SCAN: "SCAN",
      ANALYZE: "ANALYZE",
      SAVE: "SAVE",
      SHELF: "SHELF",
    };

    const state = {
      screen: Screen.ENTRY,

      // media
      stream: null,
      imageDataUrl: "",

      // analysis
      detectedPao: "",   // "3M" "6M" "12M"
      status: "",        // "SAFE" "TOSS"
      analyzeError: "",

      // save
      openedDate: "",
      productName: "",

      // reminders
      notiOnOpenEnabled: false,
      noti7days: false,
      notiOnDay: true,

      // shelf
      items: [],

      // modal
      modal: null,

      // transient
      autoAnalyze: false
    };

    const $app = document.getElementById("app");
    const $modal = document.getElementById("modal-root");
    const $toast = document.getElementById("toast");
    const $savedPill = document.getElementById("savedPill");

    function setScreen(next) {
      cleanupScreenSideEffects();
      state.screen = next;
      render();
    }

    function openModal(obj) {
      state.modal = obj;
      renderModal();
    }

    function closeModal() {
      state.modal = null;
      renderModal();
    }

    function toast(msg, ms=1700) {
      $toast.textContent = msg;
      $toast.classList.add("show");
      setTimeout(() => $toast.classList.remove("show"), ms);
    }

    function render() {
      updateSavedPill();

      switch (state.screen) {
        case Screen.ENTRY:
          $app.innerHTML = viewEntry();
          bindEntry();
          break;

        case Screen.SCAN:
          $app.innerHTML = viewScan();
          bindScan();
          break;

        case Screen.ANALYZE:
          $app.innerHTML = viewAnalyze();
          bindAnalyze();
          break;

        case Screen.SAVE:
          $app.innerHTML = viewSave();
          bindSave();
          break;

        case Screen.SHELF:
          $app.innerHTML = viewShelf();
          bindShelf();
          break;
      }
      renderModal();
    }

    function renderModal() {
      if (!state.modal) { $modal.innerHTML = ""; return; }

      if (state.modal.type === "CLEAR_ALL_CONFIRM") {
        $modal.innerHTML = modalClearAll();
        bindModalClearAll();
        return;
      }

      if (state.modal.type === "RESULT_POPUP") {
        $modal.innerHTML = modalResult(state.modal);
        bindModalResult();
        return;
      }
    }

    function updateSavedPill() {
      const n = state.items.length;
      $savedPill.textContent = n ? (n === 1 ? "1 saved" : (n + " saved")) : "Not saved";
    }

    function viewEntry() {
      return `
        <div class="card">
          <div class="hero">
            <div class="heroBig">keep or toss?</div>
            <p class="heroText">Take a photo of the PAO icon (like 6M, 12M) to check freshness.</p>

            <div class="btnrow">
              <button id="btnTakePhoto" class="btn primary">Take a photo</button>
            </div>
            <div class="btnrow">
              <button id="btnUpload" class="btn ghost">Upload a photo</button>
            </div>

            <div class="sub" style="margin-top:12px;">Your shelf starts the moment you save your first item.</div>
          </div>
        </div>

        <div class="card">
          <div class="row">
            <div class="col">
              <div class="title">My Shelf</div>
              <div class="sub">See your overall freshness at a glance.</div>
            </div>
            <button id="btnGoShelf" class="btn small">Open</button>
          </div>
        </div>
      `;
    }

    function bindEntry() {
      document.getElementById("btnTakePhoto").onclick = () => {
        state.autoAnalyze = false;
        setScreen(Screen.SCAN);
        startCameraIfPossible();
      };

      document.getElementById("btnUpload").onclick = () => {
        state.autoAnalyze = true;
        setScreen(Screen.SCAN);
        // In SCAN, file chooser will open
        setTimeout(() => {
          const input = document.getElementById("fileInput");
          if (input) input.click();
        }, 50);
      };

      document.getElementById("btnGoShelf").onclick = () => setScreen(Screen.SHELF);
    }

    function viewScan() {
      const hasImage = !!state.imageDataUrl;
      return `
        <div class="card">
          <div class="row">
            <div class="col">
              <div class="title">Scan</div>
              <div class="sub">Focus on the PAO icon (6M / 12M).</div>
            </div>
            <button id="btnBack" class="btn small">Back</button>
          </div>

          <div class="preview" style="margin-top:12px;">
            <div class="badgeTag">Camera</div>
            <video id="video" playsinline autoplay muted></video>
          </div>

          <div class="btnrow">
            <button id="btnCapture" class="btn primary">Capture</button>
            <button id="btnSwitchToUpload" class="btn ghost">Choose image</button>
          </div>

          <div class="preview" style="margin-top:12px;">
            <div class="badgeTag">Preview</div>
            ${hasImage ? `<img id="previewImg" src="${state.imageDataUrl}" alt="preview" />` : `<div class="empty">No image yet</div>`}
          </div>

          <input id="fileInput" type="file" accept="image/*" style="display:none" />

          <div class="btnrow">
            <button id="btnAnalyze" class="btn" ${hasImage ? "" : "disabled"}>Analyze</button>
          </div>
        </div>
      `;
    }

    function bindScan() {
      document.getElementById("btnBack").onclick = () => {
        stopCamera();
        setScreen(Screen.ENTRY);
      };

      document.getElementById("btnSwitchToUpload").onclick = () => {
        const input = document.getElementById("fileInput");
        if (input) input.click();
      };

      const input = document.getElementById("fileInput");
      input.onchange = async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        state.imageDataUrl = await fileToDataUrl(file);
        stopCamera();
        if (state.autoAnalyze) {
          setScreen(Screen.ANALYZE);
        } else {
          render();
        }
      };

      document.getElementById("btnCapture").onclick = async () => {
        const video = document.getElementById("video");
        const dataUrl = captureFromVideo(video);
        if (!dataUrl) {
          toast("Capture failed. Try again.");
          return;
        }
        state.imageDataUrl = dataUrl;
        stopCamera();
        setScreen(Screen.ANALYZE);
      };

      document.getElementById("btnAnalyze").onclick = () => setScreen(Screen.ANALYZE);

      // Ensure camera starts on this screen if possible
      startCameraIfPossible();
    }

    function viewAnalyze() {
      return `
        <div class="card">
          <div class="center">
            <div class="title">Checking freshness…</div>
            <div class="sub">Hold on a sec.</div>
            <div class="spinner"></div>
          </div>
        </div>
      `;
    }

    function bindAnalyze() {
      runAnalyze();
    }

    async function runAnalyze() {
      state.analyzeError = "";
      state.detectedPao = "";
      state.status = "";

      try {
        const detected = await detectPAO(state.imageDataUrl);
        state.detectedPao = normalizePao(detected);

        if (!state.detectedPao) {
          throw new Error("No PAO detected");
        }

        // Pre-compute status using openedDate default = today (user can edit later)
        const today = isoToday();
        if (!state.openedDate) state.openedDate = today;

        const exp = addMonthsISO(state.openedDate, monthsFromPao(state.detectedPao));
        state.status = compareISO(today, exp) <= 0 ? "SAFE" : "TOSS";

        openModal({
          type: "RESULT_POPUP",
          pao: state.detectedPao,
          status: state.status,
          tip: state.status === "SAFE"
            ? pickTipSafe()
            : pickTipToss()
        });

        setTimeout(() => {
          closeModal();
          setScreen(Screen.SAVE);
        }, 2300);

      } catch (err) {
        state.analyzeError = "Scan failed. Try a clearer PAO photo.";
        toast(state.analyzeError, 2300);
        setScreen(Screen.SCAN);
      }
    }

    function viewSave() {
      const today = isoToday();
      if (!state.openedDate) state.openedDate = today;

      return `
        <div class="card">
          <div class="row">
            <div class="col">
              <div class="title">Save</div>
              <div class="sub">Detected: ${escapeHtml(state.detectedPao || "-")}</div>
            </div>
            <button id="btnBackToScan" class="btn small">Back</button>
          </div>

          <div class="field">
            <div class="label">Opened date</div>
            <input id="openedDate" type="date" value="${state.openedDate}" />
          </div>

          <div class="field">
            <div class="label">Product name (optional)</div>
            <input id="productName" type="text" value="${escapeAttr(state.productName || "")}" placeholder="e.g., Cushion foundation" />
          </div>

          <div class="field">
            <div class="label">Reminders</div>
            <div class="sub" style="margin-top:2px;">
              This MVP shows reminders when you open the app. True scheduled push needs server subscriptions.
            </div>
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
              <button id="btnEnableNoti" class="btn small">${state.notiOnOpenEnabled ? "Enabled" : "Enable"}</button>
              <span class="chip">On the day: ${state.notiOnDay ? "On" : "Off"}</span>
              <span class="chip">7 days before: ${state.noti7days ? "On" : "Off"}</span>
            </div>
            <div class="btnrow" style="margin-top:10px;">
              <button id="toggle7" class="btn">${state.noti7days ? "Turn off 7 days before" : "Turn on 7 days before"}</button>
              <button id="toggleDay" class="btn">${state.notiOnDay ? "Turn off on the day" : "Turn on on the day"}</button>
            </div>
          </div>

          <div class="btnrow">
            <button id="btnSave" class="btn primary">Save to My Shelf</button>
          </div>
        </div>
      `;
    }

    function bindSave() {
      document.getElementById("btnBackToScan").onclick = () => setScreen(Screen.SCAN);

      document.getElementById("openedDate").onchange = (e) => {
        state.openedDate = e.target.value;
      };

      document.getElementById("productName").oninput = (e) => {
        state.productName = e.target.value;
      };

      document.getElementById("toggle7").onclick = () => {
        state.noti7days = !state.noti7days;
        saveSettings();
        render();
      };
      document.getElementById("toggleDay").onclick = () => {
        state.notiOnDay = !state.notiOnDay;
        saveSettings();
        render();
      };

      document.getElementById("btnEnableNoti").onclick = async () => {
        const ok = await enableOnOpenNotifications();
        if (ok) {
          state.notiOnOpenEnabled = true;
          saveSettings();
          toast("Notifications enabled (on-open reminders).");
          render();
        }
      };

      document.getElementById("btnSave").onclick = () => {
        addItemToShelf();
        saveItems();
        saveSettings();
        setScreen(Screen.SHELF);
        setTimeout(() => maybeRunOnOpenReminders(true), 250);
      };
    }

    function viewShelf() {
      const stats = computeShelfStats(state.items);
      const pct = stats.total ? Math.round((stats.safe / stats.total) * 100) : 100;

      const gauge = gaugeLabel(pct);
      const ringDeg = Math.round((pct / 100) * 360);

      return `
        <div class="card">
          <div class="row">
            <div class="col">
              <div class="title">My Shelf</div>
              <div class="sub">Your items, your freshness.</div>
            </div>
            <button id="btnHome" class="btn small">Home</button>
          </div>

          <div class="shelfTop" style="margin-top:12px;">
            <div class="shelfCount">
              <div class="sub">Items</div>
              <div class="num">${stats.total}</div>
              <div class="txt sub">items inside</div>
            </div>

            <div class="shelfActions">
              <button id="btnAdd" class="btn small primary">Add</button>
              <button id="btnClearAll" class="btn small danger" ${stats.total ? "" : "disabled"}>Clear all</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="gauge">
            <div class="ring" id="ring" style="background: conic-gradient(var(--ok) ${ringDeg}deg, rgba(255,255,255,.10) 0deg);">
              <div class="ringInner">
                <div class="ringPct">${pct}%</div>
                <div class="ringLbl">safe ratio</div>
              </div>
            </div>

            <div class="gaugeText">
              <div class="gaugeTitle">${escapeHtml(gauge.title)}</div>
              <div class="gaugeDesc">${escapeHtml(gauge.desc)}</div>
              <div class="gaugeMini">
                <span class="chip">Safe ${stats.safe} / ${stats.total}</span>
                <span class="chip">Toss ${stats.toss} / ${stats.total}</span>
                <span class="chip">${gauge.mz}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row">
            <div class="title">Items</div>
            <div class="pill">Delete for one item · Clear all for everything</div>
          </div>

          <div class="list">
            ${state.items.length ? state.items.map(renderItem).join("") : `<div class="sub" style="padding:8px 2px;">No items yet.</div>`}
          </div>
        </div>
      `;
    }

    function bindShelf() {
      document.getElementById("btnHome").onclick = () => setScreen(Screen.ENTRY);
      document.getElementById("btnAdd").onclick = () => {
        state.autoAnalyze = false;
        setScreen(Screen.SCAN);
        startCameraIfPossible();
      };
      const clearBtn = document.getElementById("btnClearAll");
      if (clearBtn) {
        clearBtn.onclick = () => openModal({ type: "CLEAR_ALL_CONFIRM" });
      }

      document.querySelectorAll("[data-del]").forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute("data-del");
          state.items = state.items.filter(x => x.id !== id);
          saveItems();
          render();
        };
      });
    }

    function renderItem(it) {
      const tagClass = it.status === "TOSS" ? "toss" : "safe";
      const exp = it.expires || computeExpires(it.openedDate, it.pao);
      return `
        <div class="item">
          <div class="itemLeft">
            <div class="itemName">${escapeHtml(it.name || "Untitled item")}</div>
            <div class="itemMeta">
              Opened: ${escapeHtml(it.openedDate)}<br/>
              PAO: ${escapeHtml(it.pao)}<br/>
              Expires: ${escapeHtml(exp)}
            </div>
          </div>
          <div class="itemRight">
            <span class="tag ${tagClass}">${it.status === "TOSS" ? "Toss" : "Safe"}</span>
            <button class="btn small danger" data-del="${escapeAttr(it.id)}">Delete</button>
          </div>
        </div>
      `;
    }

    function modalClearAll() {
      return `
        <div class="modal-backdrop" role="dialog" aria-modal="true">
          <div class="modal">
            <div class="modalTitle">Clear all items?</div>
            <div class="modalSub">This will permanently remove all products from your shelf.</div>
            <div class="modalActions">
              <button id="mCancel" class="btn">Cancel</button>
              <button id="mClear" class="btn danger">Clear all</button>
            </div>
          </div>
        </div>
      `;
    }

    function bindModalClearAll() {
      document.getElementById("mCancel").onclick = closeModal;
      document.getElementById("mClear").onclick = () => {
        state.items = [];
        saveItems();
        closeModal();
        toast("Cleared.");
        render();
      };
      // click outside to close
      $modal.firstElementChild.onclick = (e) => {
        if (e.target === $modal.firstElementChild) closeModal();
      };
    }

    function modalResult({ pao, status, tip }) {
      const isToss = status === "TOSS";
      const ttl = isToss ? "TOSS IT" : "SAFE TO USE";
      const sub = isToss
        ? "Better to avoid irritation and breakouts."
        : "Looks good. Keep it clean and steady.";
      return `
        <div class="modal-backdrop" role="dialog" aria-modal="true">
          <div class="modal">
            <div class="modalTitle">${ttl}</div>
            <div class="modalSub">${sub}</div>
            <div style="margin-top:10px; padding:12px; border-radius:16px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.03);">
              <div class="resultBig">${escapeHtml(pao)}</div>
              <div class="resultMini">${escapeHtml(tip)}</div>
            </div>
            <div class="modalActions">
              <button id="mOk" class="btn ${isToss ? "danger" : "primary"}">OK</button>
            </div>
          </div>
        </div>
      `;
    }

    function bindModalResult() {
      document.getElementById("mOk").onclick = closeModal;
      $modal.firstElementChild.onclick = (e) => {
        if (e.target === $modal.firstElementChild) closeModal();
      };
    }

    function addItemToShelf() {
      const today = isoToday();
      const opened = state.openedDate || today;
      const pao = state.detectedPao || "6M";
      const expires = computeExpires(opened, pao);
      const status = compareISO(today, expires) <= 0 ? "SAFE" : "TOSS";

      const item = {
        id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
        name: (state.productName || "").trim() || "Untitled item",
        openedDate: opened,
        pao,
        expires,
        status,
        createdAt: Date.now()
      };

      state.items.unshift(item);

      // reset transient fields
      state.productName = "";
      state.imageDataUrl = "";
      state.detectedPao = "";
      state.status = "";
      state.autoAnalyze = false;
    }

    function computeExpires(openedISO, pao) {
      const m = monthsFromPao(pao);
      return addMonthsISO(openedISO, m);
    }

    function computeShelfStats(items) {
      let safe = 0;
      let toss = 0;
      for (const it of items) {
        if (it.status === "TOSS") toss++;
        else safe++;
      }
      return { total: items.length, safe, toss };
    }

    function gaugeLabel(pct) {
      // User's suggested buckets: 100-80 good, 80-60 ok, 60-40 bad, below 60 very bad
      if (pct >= 80) {
        return {
          title: "Good",
          desc: "Mostly clean. You’re managing well.",
          mz: "You’re in the clean zone."
        };
      }
      if (pct >= 60) {
        return {
          title: "Okay",
          desc: "A few risky ones. Time for a quick cleanup.",
          mz: "Not bad, but check the back row."
        };
      }
      if (pct >= 40) {
        return {
          title: "Bad",
          desc: "You’ve got too many expired items in rotation.",
          mz: "Your shelf is side-eyeing you."
        };
      }
      return {
        title: "Very bad",
        desc: "High risk. Toss the expired ones today.",
        mz: "This shelf needs an intervention."
      };
    }

    function pickTipSafe() {
      const tips = [
        "Wipe the opening clean and keep the cap tight.",
        "Store away from heat and direct sunlight.",
        "If smell or texture changes, stop using it.",
        "Keep applicators clean to avoid bacteria buildup."
      ];
      return tips[Math.floor(Math.random() * tips.length)];
    }

    function pickTipToss() {
      const tips = [
        "If it stings, smells off, or separates, toss it immediately.",
        "Mascara and liquid liners are the fastest to go bad.",
        "Don’t ‘revive’ old products with water or alcohol.",
        "When in doubt, toss. Skin repairs cost more."
      ];
      return tips[Math.floor(Math.random() * tips.length)];
    }

    async function detectPAO(imageDataUrl) {
      if (!WORKER_OCR_ENDPOINT) {
        // Local mock: tries to read obvious handwritten "6M"/"12M" is not possible; fallback
        // We'll randomly pick 6M/12M to keep flow running for MVP.
        return Math.random() < 0.55 ? "6M" : "12M";
      }

      // Send base64 without prefix if needed
      const base64 = imageDataUrl.includes(",") ? imageDataUrl.split(",")[1] : imageDataUrl;

      const res = await fetch(WORKER_OCR_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ imageBase64: base64 })
      });

      if (!res.ok) throw new Error("Worker error");

      const data = await res.json().catch(() => ({}));

      // Accept several shapes
      if (data.detected) return String(data.detected);
      if (data.pao) return String(data.pao);
      if (data.text) {
        const t = String(data.text);
        const m = t.match(/(\b\d{1,2})\s*M\b/i);
        if (m) return (m[1] + "M").toUpperCase();
        return t;
      }
      return "";
    }

    function normalizePao(raw) {
      const s = String(raw || "").toUpperCase().replace(/\s+/g, "");
      const m = s.match(/(\d{1,2})M/);
      if (!m) return "";
      const n = Number(m[1]);
      if (!Number.isFinite(n)) return "";
      if (n < 1 || n > 36) return "";
      return n + "M";
    }

    function monthsFromPao(pao) {
      const m = String(pao || "").toUpperCase().match(/(\d{1,2})M/);
      const n = m ? Number(m[1]) : 0;
      return Number.isFinite(n) ? n : 0;
    }

    function isoToday() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function compareISO(a, b) {
      // a,b are YYYY-MM-DD
      if (a === b) return 0;
      return a < b ? -1 : 1;
    }

    function addMonthsISO(iso, months) {
      const [y, m, d] = iso.split("-").map(Number);
      const dt = new Date(y, (m - 1), d);
      const targetMonth = dt.getMonth() + months;

      // Move to first day of target month then clamp day to month length
      const temp = new Date(dt.getFullYear(), targetMonth, 1);
      const lastDay = new Date(temp.getFullYear(), temp.getMonth() + 1, 0).getDate();
      const day = Math.min(d, lastDay);
      const out = new Date(temp.getFullYear(), temp.getMonth(), day);

      const yyyy = out.getFullYear();
      const mm = String(out.getMonth() + 1).padStart(2, "0");
      const dd = String(out.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    async function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    function captureFromVideo(video) {
      if (!video || !video.videoWidth || !video.videoHeight) return "";
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      if (!ctx) return "";
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL("image/jpeg", 0.92);
    }

    async function startCameraIfPossible() {
      // Only start if we're on SCAN screen
      if (state.screen !== Screen.SCAN) return;

      const video = document.getElementById("video");
      if (!video) return;

      // If already running, attach stream
      if (state.stream) {
        try { video.srcObject = state.stream; } catch {}
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });
        state.stream = stream;
        try { video.srcObject = stream; } catch {}
        video.play().catch(() => {});
      } catch (e) {
        // If camera fails, user can still upload
        const prev = document.querySelector(".preview .badgeTag");
        toast("Camera blocked. Use Upload instead.", 2200);
      }
    }

    function stopCamera() {
      if (state.stream) {
        try {
          state.stream.getTracks().forEach(t => t.stop());
        } catch {}
      }
      state.stream = null;
      const video = document.getElementById("video");
      if (video) {
        try { video.srcObject = null; } catch {}
      }
    }

    function cleanupScreenSideEffects() {
      // Prevent hidden overlays from capturing clicks by removing camera stream when leaving SCAN
      if (state.screen === Screen.SCAN) {
        stopCamera();
      }
      closeModal();
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }
    function escapeAttr(s) {
      return escapeHtml(s).replace(/"/g, "&quot;");
    }

    function saveItems() {
      localStorage.setItem("kot_shelf_items", JSON.stringify(state.items));
      updateSavedPill();
    }

    function loadItems() {
      try {
        state.items = JSON.parse(localStorage.getItem("kot_shelf_items") || "[]");
        if (!Array.isArray(state.items)) state.items = [];
      } catch {
        state.items = [];
      }
      // backfill expires/status if missing
      const today = isoToday();
      state.items = state.items.map(it => {
        const opened = it.openedDate || today;
        const pao = it.pao || "6M";
        const exp = it.expires || computeExpires(opened, pao);
        const st = it.status || (compareISO(today, exp) <= 0 ? "SAFE" : "TOSS");
        return { ...it, openedDate: opened, pao, expires: exp, status: st };
      });
    }

    function saveSettings() {
      localStorage.setItem("kot_settings", JSON.stringify({
        notiOnOpenEnabled: state.notiOnOpenEnabled,
        noti7days: state.noti7days,
        notiOnDay: state.notiOnDay
      }));
    }

    function loadSettings() {
      try {
        const s = JSON.parse(localStorage.getItem("kot_settings") || "{}");
        state.notiOnOpenEnabled = !!s.notiOnOpenEnabled;
        state.noti7days = !!s.noti7days;
        state.notiOnDay = (s.notiOnDay === undefined) ? true : !!s.notiOnDay;
      } catch {}
    }

    async function enableOnOpenNotifications() {
      // Register service worker if not already
      if (!("serviceWorker" in navigator)) {
        toast("This browser does not support notifications.");
        return false;
      }
      try {
        const reg = await navigator.serviceWorker.register("./sw.js");
        await navigator.serviceWorker.ready;

        const perm = await Notification.requestPermission();
        if (perm !== "granted") {
          toast("Notification permission not granted.", 2200);
          return false;
        }
        return true;
      } catch (e) {
        toast("Failed to enable notifications.", 2200);
        return false;
      }
    }

    async function notify(title, body) {
      if (!("serviceWorker" in navigator)) return;
      if (!("Notification" in window)) return;
      if (Notification.permission !== "granted") return;

      try {
        const reg = await navigator.serviceWorker.ready;
        reg.showNotification(title, { body });
      } catch {}
    }

    async function maybeRunOnOpenReminders(force=false) {
      if (!state.notiOnOpenEnabled) return;
      if (!force && !state.items.length) return;

      const today = isoToday();
      let expToday = 0;
      let expSoon = 0;

      for (const it of state.items) {
        const exp = it.expires || computeExpires(it.openedDate, it.pao);
        if (exp === today) expToday++;

        if (state.noti7days) {
          const d7 = addDaysISO(today, 7);
          if (compareISO(exp, today) >= 0 && compareISO(exp, d7) <= 0) {
            expSoon++;
          }
        }
      }

      if (state.notiOnDay && expToday > 0) {
        await notify("Keep or Toss", expToday === 1 ? "1 item expires today." : (expToday + " items expire today."));
      } else if (state.noti7days && expSoon > 0) {
        await notify("Keep or Toss", expSoon === 1 ? "1 item expires within 7 days." : (expSoon + " items expire within 7 days."));
      }
    }

    function addDaysISO(iso, days) {
      const [y, m, d] = iso.split("-").map(Number);
      const dt = new Date(y, m - 1, d);
      dt.setDate(dt.getDate() + days);
      const yyyy = dt.getFullYear();
      const mm = String(dt.getMonth() + 1).padStart(2, "0");
      const dd = String(dt.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    // init
    loadItems();
    loadSettings();

    // Decide initial screen: if shelf has items, stay on ENTRY but shelf is one tap away
    setScreen(Screen.ENTRY);

    // On-open reminders
    setTimeout(() => maybeRunOnOpenReminders(false), 600);
  </script>
</body>
</html>
