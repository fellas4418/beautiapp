<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Check Cosmetic Freshness</title>
  <style>
    :root{
      --bg:#0b0c10;
      --card:#111318;
      --text:#e8e8ea;
      --muted:#a8abb4;
      --border:rgba(255,255,255,.10);
      --btn:#2b6cff;
      --btn2:#1f2430;
      --danger:#ff4d4f;
      --warn:#ffcc00;
      --ok:#20c997;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:820px;margin:0 auto;padding:20px;}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      margin-bottom:14px;
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    .grow{flex:1 1 auto;}
    .btn{
      background:var(--btn);
      color:#fff;
      border:none;
      padding:12px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
    }
    .btn.secondary{background:var(--btn2);color:var(--text);border:1px solid var(--border);}
    .btn:disabled{opacity:.55;cursor:not-allowed;}
    input[type="file"]{display:none;}
    .labelbtn{
      display:inline-flex;align-items:center;justify-content:center;
      background:var(--btn2);border:1px solid var(--border);
      padding:12px 14px;border-radius:12px;cursor:pointer;
      font-weight:600;color:var(--text);
    }
    .muted{color:var(--muted);font-size:13px;line-height:1.45}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:10px;font-size:14px;line-height:1.55}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);font-size:13px}
    .status-ok{color:var(--ok)}
    .status-warn{color:var(--warn)}
    .status-bad{color:var(--danger)}
    .sep{height:1px;background:var(--border);margin:14px 0}
    .thumb{width:100%;max-height:320px;object-fit:contain;border-radius:12px;border:1px solid var(--border);background:#0a0b0f}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:860px){.grid{grid-template-columns:1.1fr .9fr}}
    .chips{display:flex;gap:10px;flex-wrap:wrap}
    .chip{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:600;
    }
    .chip.active{border-color:rgba(43,108,255,.8);box-shadow:0 0 0 2px rgba(43,108,255,.25) inset}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
    }
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .itemTitle{font-weight:700}
    .small{font-size:12px;color:var(--muted)}
    .dangerLink{color:var(--danger);cursor:pointer;text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="font-size:18px;font-weight:800;margin-bottom:6px;">Cosmetic Freshness Check</div>
      <div class="muted">PAO(3M/6M/12M 등)를 감지한 뒤, 개봉일을 한 번만 선택하면 남은 기간과 권장 폐기 시점을 계산해 저장합니다.</div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row">
          <label class="labelbtn" for="fileInput">사진 선택</label>
          <input id="fileInput" type="file" accept="image/*" />
          <button id="scanBtn" class="btn">스캔하기</button>
          <button id="resetBtn" class="btn secondary">초기화</button>
        </div>

        <div class="sep"></div>

        <img id="preview" class="thumb" alt="preview" style="display:none;" />

        <div id="msg" class="muted" style="margin-top:12px;"></div>

        <div id="scanResult" style="display:none;margin-top:12px;">
          <div class="kv">
            <div class="muted">Detected PAO</div>
            <div id="detectedPao" style="font-weight:800;"></div>

            <div class="muted">Confidence</div>
            <div id="confidence"></div>

            <div class="muted">Status</div>
            <div id="statusLine"></div>

            <div class="muted">Expiry date</div>
            <div id="expiryDate"></div>

            <div class="muted">Days left</div>
            <div id="daysLeft"></div>
          </div>

          <div id="openDateBox" style="margin-top:14px;">
            <div class="muted" style="margin-bottom:10px;">개봉일을 선택하세요 (한 번만).</div>
            <div class="chips">
              <button class="chip" data-open="today">오늘</button>
              <button class="chip" data-open="yesterday">어제</button>
              <button class="chip" data-open="week">일주일 전쯤</button>
              <button class="chip" data-open="month">한 달 전쯤</button>
              <button class="chip" data-open="unknown">기억 안남</button>
            </div>
            <div class="muted" style="margin-top:10px;">
              “기억 안남”을 선택하면 안전 쪽으로 보수적으로 추정해서 계산합니다.
            </div>
          </div>

          <div id="saveBox" style="display:none;margin-top:14px;">
            <div class="row">
              <input id="nickname" class="grow" placeholder="(선택) 제품 별명 예: 파란 크림, 선크림" style="padding:12px;border-radius:12px;border:1px solid var(--border);background:#0a0b0f;color:var(--text);" />
              <button id="saveBtn" class="btn">My Shelf에 저장</button>
            </div>
            <div class="muted" style="margin-top:8px;">저장은 이 기기(브라우저)에 저장됩니다. 로그인 없이도 테스트 가능.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div style="font-size:16px;font-weight:800;">My Shelf</div>
            <div class="muted">스캔한 제품이 여기에 쌓입니다.</div>
          </div>
          <div class="dangerLink" id="clearShelf">전체 삭제</div>
        </div>

        <div class="sep"></div>
        <div id="shelfList" class="list"></div>
        <div id="emptyShelf" class="muted">아직 저장된 제품이 없습니다.</div>
      </div>
    </div>
  </div>

  <script>
    // 1) 너의 Worker 엔드포인트로 바꿔야 함
    // 예: https://xxxxx.yourname.workers.dev/pao
    const WORKER_ENDPOINT = "https://skinguard.ohryee.workers.dev/pao";

    const fileInput = document.getElementById("fileInput");
    const scanBtn = document.getElementById("scanBtn");
    const resetBtn = document.getElementById("resetBtn");
    const preview = document.getElementById("preview");
    const msg = document.getElementById("msg");

    const scanResult = document.getElementById("scanResult");
    const detectedPao = document.getElementById("detectedPao");
    const confidenceEl = document.getElementById("confidence");
    const statusLine = document.getElementById("statusLine");
    const expiryDateEl = document.getElementById("expiryDate");
    const daysLeftEl = document.getElementById("daysLeft");

    const openDateBox = document.getElementById("openDateBox");
    const saveBox = document.getElementById("saveBox");
    const saveBtn = document.getElementById("saveBtn");
    const nickname = document.getElementById("nickname");

    const shelfList = document.getElementById("shelfList");
    const emptyShelf = document.getElementById("emptyShelf");
    const clearShelf = document.getElementById("clearShelf");

    let current = {
      imageDataUrl: "",
      paoMonths: null,
      paoRaw: "",
      confidence: null,
      openDateISO: null,
      expiryISO: null,
      daysLeft: null,
      verdict: "NEEDS_OPEN_DATE", // SAFE / NEAR / TOSS / NEEDS_OPEN_DATE
      debugText: ""
    };

    function setMsg(text){ msg.textContent = text || ""; }

    function isoDate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function addMonths(dateObj, months){
      const d = new Date(dateObj);
      const targetMonth = d.getMonth() + months;
      d.setMonth(targetMonth);

      // JS Date가 월 넘김 처리하면서 일자가 밀릴 수 있어서
      // 원래 일이 사라지는 케이스(예: 1/31 +1M → 3/3 같은) 방지 로직
      // 방법: 목표 월로 갔는데 월이 예상보다 더 밀렸으면 하루씩 당겨서 맞춤
      while (d.getMonth() !== ((targetMonth % 12) + 12) % 12) {
        d.setDate(d.getDate() - 1);
      }
      return d;
    }

    function computeVerdict(daysLeft){
      // 기준은 너가 나중에 바꾸기 쉬운 형태로 둠
      // Toss: 0 이하
      // Near: 30일 이내
      if (daysLeft <= 0) return "TOSS";
      if (daysLeft <= 30) return "NEAR";
      return "SAFE";
    }

    function verdictLabel(v){
      if (v === "SAFE") return `<span class="pill"><span class="status-ok">Safe</span><span class="muted">사용 가능</span></span>`;
      if (v === "NEAR") return `<span class="pill"><span class="status-warn">Near expiry</span><span class="muted">곧 만료</span></span>`;
      if (v === "TOSS") return `<span class="pill"><span class="status-bad">Toss it</span><span class="muted">폐기 권장</span></span>`;
      return `<span class="pill"><span class="muted">Needs open date</span></span>`;
    }

    function renderResult(){
      scanResult.style.display = "block";
      detectedPao.textContent = current.paoRaw || (current.paoMonths ? `${current.paoMonths}M` : "Not found");
      confidenceEl.textContent = (current.confidence == null) ? "-" : `${Math.round(current.confidence * 100)}%`;

      statusLine.innerHTML = verdictLabel(current.verdict);

      expiryDateEl.textContent = current.expiryISO ? current.expiryISO : "-";
      daysLeftEl.textContent = (current.daysLeft == null) ? "-" : `${current.daysLeft} days`;

      if (!current.openDateISO) {
        openDateBox.style.display = "block";
        saveBox.style.display = "none";
      } else {
        openDateBox.style.display = "none";
        saveBox.style.display = "block";
      }
    }

    function resetAll(){
      current = {
        imageDataUrl: "",
        paoMonths: null,
        paoRaw: "",
        confidence: null,
        openDateISO: null,
        expiryISO: null,
        daysLeft: null,
        verdict: "NEEDS_OPEN_DATE",
        debugText: ""
      };
      preview.style.display = "none";
      preview.src = "";
      scanResult.style.display = "none";
      nickname.value = "";
      setMsg("");
      document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
    }

    function getShelf(){
      try{
        const raw = localStorage.getItem("shelf_v1");
        return raw ? JSON.parse(raw) : [];
      }catch(e){
        return [];
      }
    }

    function setShelf(list){
      localStorage.setItem("shelf_v1", JSON.stringify(list));
    }

    function renderShelf(){
      const list = getShelf();
      shelfList.innerHTML = "";
      emptyShelf.style.display = list.length ? "none" : "block";

      list
        .slice()
        .sort((a,b)=> (a.createdAt < b.createdAt ? 1 : -1))
        .forEach(item=>{
          const div = document.createElement("div");
          div.className = "item";
          const vHtml = verdictLabel(item.verdict);
          div.innerHTML = `
            <div class="itemTop">
              <div>
                <div class="itemTitle">${escapeHtml(item.nickname || "Unnamed product")}</div>
                <div class="small">PAO: ${escapeHtml(item.paoRaw || (item.paoMonths ? item.paoMonths+"M" : "-"))} · Opened: ${escapeHtml(item.openDateISO || "-")}</div>
                <div class="small">Expiry: ${escapeHtml(item.expiryISO || "-")} · Days left: ${item.daysLeft == null ? "-" : item.daysLeft}</div>
              </div>
              <div style="text-align:right">
                <div>${vHtml}</div>
                <div class="small" style="margin-top:8px;"><span class="dangerLink" data-del="${item.id}">삭제</span></div>
              </div>
            </div>
          `;
          shelfList.appendChild(div);
        });

      shelfList.querySelectorAll("[data-del]").forEach(el=>{
        el.addEventListener("click", ()=>{
          const id = el.getAttribute("data-del");
          const list = getShelf().filter(x => x.id !== id);
          setShelf(list);
          renderShelf();
        });
      });
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function fileToBase64(file){
      return new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload = ()=> resolve(String(reader.result || ""));
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function pickOpenDate(option){
      const now = new Date();
      let open = new Date(now);

      if (option === "today") open = now;
      if (option === "yesterday") { open.setDate(open.getDate()-1); }
      if (option === "week") { open.setDate(open.getDate()-7); }
      if (option === "month") { open.setDate(open.getDate()-30); }
      if (option === "unknown") {
        // 보수적 추정: “이미 꽤 썼을 가능성”을 반영해 60일 전으로 잡음
        // 여기 숫자는 네가 원하는 성향(더 보수/더 관대)에 맞춰 바꾸면 됨
        open.setDate(open.getDate()-60);
      }
      current.openDateISO = isoDate(open);

      if (!current.paoMonths) {
        // PAO가 없으면 날짜 계산을 못하니, 저장은 가능하게 하되 verdict는 NEEDS_OPEN_DATE 대신 NEEDS_PAO로 둘 수도 있는데
        // 지금은 단순하게 "TOSS/Safe" 계산을 안 하고 저장만 허용하지 않음
        // UX상 이 경우는 스캔 재시도 유도
        current.openDateISO = null;
        setMsg("PAO를 찾지 못했어요. 사진을 더 가까이, 더 선명하게 찍어서 다시 스캔해 주세요.");
        renderResult();
        return;
      }

      const openDate = new Date(current.openDateISO + "T00:00:00");
      const exp = addMonths(openDate, current.paoMonths);
      const expISO = isoDate(exp);

      const today = new Date();
      const today0 = new Date(isoDate(today) + "T00:00:00");
      const diffMs = exp.getTime() - today0.getTime();
      const diffDays = Math.floor(diffMs / (1000*60*60*24));

      current.expiryISO = expISO;
      current.daysLeft = diffDays;
      current.verdict = computeVerdict(diffDays);

      renderResult();
    }

    async function scan(){
      const file = fileInput.files && fileInput.files[0];
      if (!file) {
        setMsg("사진을 먼저 선택해 주세요.");
        return;
      }

      scanBtn.disabled = true;
      setMsg("스캔 중…");
      resetScanComputedOnly();

      try{
        const dataUrl = await fileToBase64(file);
        current.imageDataUrl = dataUrl;
        preview.src = dataUrl;
        preview.style.display = "block";

        const base64 = dataUrl.split(",")[1] || "";
        const res = await fetch(WORKER_ENDPOINT, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ imageBase64: base64 })
        });

        const isJson = (res.headers.get("content-type") || "").includes("application/json");
        const payload = isJson ? await res.json().catch(()=> ({})) : {};

        if (!res.ok) {
          // “Server error (500)” 같은 내부 문구 그대로 노출하지 않기
          const msgText = payload?.error || "스캔에 실패했어요. 사진을 더 선명하게 찍고 다시 시도해 주세요.";
          setMsg(msgText);
          scanBtn.disabled = false;
          return;
        }

        // 기대 응답: { paoMonths: number|null, paoRaw: "6M", confidence: 0~1, debugText?:string }
        current.paoMonths = payload?.paoMonths ?? null;
        current.paoRaw = payload?.paoRaw ?? (current.paoMonths ? `${current.paoMonths}M` : "");
        current.confidence = (typeof payload?.confidence === "number") ? payload.confidence : null;
        current.debugText = payload?.debugText || "";

        if (!current.paoMonths) {
          current.verdict = "NEEDS_OPEN_DATE";
          setMsg("PAO(3M/6M/12M 등)를 찾지 못했어요. PAO 마크가 더 크게 나오게 다시 찍어 주세요.");
          renderResult();
          scanBtn.disabled = false;
          return;
        }

        setMsg("PAO를 찾았어요. 이제 개봉일만 선택하면 남은 기간이 계산돼요.");
        renderResult();
      }catch(e){
        setMsg("네트워크 문제로 스캔이 실패했어요. 인터넷 연결을 확인하고 다시 시도해 주세요.");
      }finally{
        scanBtn.disabled = false;
      }
    }

    function resetScanComputedOnly(){
      current.paoMonths = null;
      current.paoRaw = "";
      current.confidence = null;
      current.openDateISO = null;
      current.expiryISO = null;
      current.daysLeft = null;
      current.verdict = "NEEDS_OPEN_DATE";
      current.debugText = "";
      scanResult.style.display = "none";
      document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
    }

    function saveToShelf(){
      if (!current.paoMonths || !current.openDateISO || !current.expiryISO) {
        setMsg("저장하려면 PAO 감지와 개봉일 선택이 필요해요.");
        return;
      }

      const item = {
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2),
        nickname: (nickname.value || "").trim(),
        paoMonths: current.paoMonths,
        paoRaw: current.paoRaw,
        confidence: current.confidence,
        openDateISO: current.openDateISO,
        expiryISO: current.expiryISO,
        daysLeft: current.daysLeft,
        verdict: current.verdict,
        createdAt: new Date().toISOString()
      };

      const list = getShelf();
      list.push(item);
      setShelf(list);
      renderShelf();

      setMsg("My Shelf에 저장했어요. 다음 제품도 바로 스캔할 수 있어요.");
      // 다음 스캔을 유도하려면 초기화는 일부만:
      nickname.value = "";
    }

    // events
    fileInput.addEventListener("change", async ()=>{
      const file = fileInput.files && fileInput.files[0];
      if (!file) return;
      const dataUrl = await fileToBase64(file);
      preview.src = dataUrl;
      preview.style.display = "block";
      setMsg("스캔하기를 눌러 주세요.");
      resetScanComputedOnly();
    });

    scanBtn.addEventListener("click", scan);
    resetBtn.addEventListener("click", resetAll);
    saveBtn.addEventListener("click", saveToShelf);

    document.querySelectorAll(".chip").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
        btn.classList.add("active");
        const opt = btn.getAttribute("data-open");
        pickOpenDate(opt);
      });
    });

    clearShelf.addEventListener("click", ()=>{
      localStorage.removeItem("shelf_v1");
      renderShelf();
      setMsg("My Shelf를 전체 삭제했어요.");
    });

    // init
    renderShelf();
    setMsg("사진을 선택한 뒤 스캔하세요.");
  </script>
</body>
</html>
