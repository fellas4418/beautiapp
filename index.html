<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Keep or Toss</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
* { box-sizing: border-box; }
body { margin: 0; background: #0b0c10; color: #e8e8ea; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif; }
.wrap { max-width: 420px; margin: 0 auto; padding: 16px; }
.card { background: #111318; border-radius: 16px; padding: 16px; margin-bottom: 16px; }
h2 { margin: 0 0 20px 0; font-size: 28px; }
img { width: 100%; border-radius: 12px; margin-top: 10px; display: block; }
.pao { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 12px; }
button { padding: 12px; border-radius: 10px; border: none; background: #1f2430; color: #fff; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.2s; }
button:hover { background: #2a3142; transform: translateY(-2px); }
button.active { background: linear-gradient(135deg, #667eea, #764ba2); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5); }
.result { margin-top: 14px; font-weight: 800; font-size: 17px; text-align: center; padding: 14px; background: #1a1d2e; border-radius: 10px; }
input[type="date"], input[type="text"] { width: 100%; margin-top: 10px; padding: 10px; border-radius: 8px; border: none; font-size: 14px; }
input[type="file"] { width: 100%; padding: 10px; background: #1a1d2e; border: 2px dashed #333; border-radius: 8px; color: #e8e8ea; cursor: pointer; }
input[type="file"]::-webkit-file-upload-button { background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; }
.status { margin-top: 10px; padding: 12px; border-radius: 8px; text-align: center; font-weight: 600; font-size: 14px; }
.add-btn { background: linear-gradient(135deg, #20c997, #17a2b8); width: 100%; margin-top: 12px; padding: 14px; font-size: 16px; }
.add-btn:hover { background: linear-gradient(135deg, #17a2b8, #20c997); }
.vanity-list { margin-top: 16px; }
.vanity-item { background: #1a1d2e; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
.vanity-item .info { flex: 1; }
.vanity-item .name { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
.vanity-item .date { font-size: 12px; color: #888; }
.vanity-item .delete { background: #dc3545; padding: 8px 12px; border-radius: 6px; font-size: 12px; }
.vanity-item.expired { border-left: 4px solid #dc3545; }
.vanity-item.warning { border-left: 4px solid #ffc107; }
.vanity-item.safe { border-left: 4px solid #20c997; }
</style>
</head>

<body>
<div class="wrap">
<h2>Keep or Toss</h2>

<div class="card">
<input type="file" id="fileInput" accept="image/*">
<img id="preview" style="display:none">
<div id="debugImg" style="display:none"></div>

<input type="text" id="productName" placeholder="Product name (optional)">
<input type="date" id="opened">
<div class="pao" id="paoBtns"></div>
<div id="result" class="result">Upload image or select PAO</div>
<div id="status" class="status" style="display:none"></div>
<button class="add-btn" onclick="addToVanity()">‚ûï Add to Vanity</button>
</div>

<div class="card">
<h3 style="margin:0 0 12px 0">üíÑ My Vanity</h3>
<div id="vanityList" class="vanity-list"></div>
</div>
</div>

<script>
const PAOS = [3, 6, 9, 12, 18, 24, 36];
let selectedPAO = null;

const opened = document.getElementById("opened");
const productName = document.getElementById("productName");
const paoBox = document.getElementById("paoBtns");
const result = document.getElementById("result");
const preview = document.getElementById("preview");
const status = document.getElementById("status");
const debugImg = document.getElementById("debugImg");
const vanityList = document.getElementById("vanityList");

opened.value = new Date().toISOString().slice(0, 10);

// localStorageÏóêÏÑú ÌôîÏû•ÎåÄ Î™©Î°ù Î°úÎìú
let vanityItems = JSON.parse(localStorage.getItem('vanityItems') || '[]');

PAOS.forEach(m => {
  const b = document.createElement("button");
  b.textContent = m + "M";
  b.onclick = () => { selectPAO(m); updateResult(); };
  paoBox.appendChild(b);
});

function selectPAO(m) {
  selectedPAO = m;
  [...paoBox.children].forEach(b => {
    b.classList.toggle("active", b.textContent === m + "M");
  });
}

function addMonths(d, m) {
  const [y, mo, da] = d.split("-").map(Number);
  const dt = new Date(y, mo - 1, da);
  dt.setMonth(dt.getMonth() + m);
  return dt;
}

function updateResult() {
  if (!selectedPAO) { result.textContent = "Select PAO period"; return; }
  const toss = addMonths(opened.value, selectedPAO);
  result.textContent = `${selectedPAO}M ¬∑ Toss ${toss.toISOString().slice(0, 10)}`;
}

function addToVanity() {
  if (!selectedPAO) {
    alert('Please select PAO period first!');
    return;
  }

  const name = productName.value.trim() || 'Unnamed Product';
  const openDate = opened.value;
  const tossDate = addMonths(openDate, selectedPAO).toISOString().slice(0, 10);
  
  const item = {
    id: Date.now(),
    name: name,
    pao: selectedPAO,
    opened: openDate,
    toss: tossDate,
    image: preview.style.display === 'block' ? preview.src : null
  };

  vanityItems.unshift(item);
  localStorage.setItem('vanityItems', JSON.stringify(vanityItems));
  
  renderVanity();
  
  // Ï¥àÍ∏∞Ìôî
  productName.value = '';
  preview.style.display = 'none';
  debugImg.style.display = 'none';
  status.style.display = 'none';
  
  alert('‚úÖ Added to vanity!');
}

function deleteItem(id) {
  if (!confirm('Delete this item?')) return;
  vanityItems = vanityItems.filter(item => item.id !== id);
  localStorage.setItem('vanityItems', JSON.stringify(vanityItems));
  renderVanity();
}

function renderVanity() {
  if (vanityItems.length === 0) {
    vanityList.innerHTML = '<div style="text-align:center;color:#666;padding:20px">No items yet</div>';
    return;
  }

  const today = new Date().toISOString().slice(0, 10);
  
  vanityList.innerHTML = vanityItems.map(item => {
    const daysLeft = Math.ceil((new Date(item.toss) - new Date(today)) / (1000 * 60 * 60 * 24));
    
    let statusClass = 'safe';
    let statusText = `${daysLeft} days left`;
    
    if (daysLeft < 0) {
      statusClass = 'expired';
      statusText = `Expired ${Math.abs(daysLeft)} days ago`;
    } else if (daysLeft <= 30) {
      statusClass = 'warning';
      statusText = `‚ö† ${daysLeft} days left`;
    }

    return `
      <div class="vanity-item ${statusClass}">
        ${item.image ? `<img src="${item.image}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;margin-right:12px">` : ''}
        <div class="info">
          <div class="name">${item.name}</div>
          <div class="date">${item.pao}M ¬∑ Opened ${item.opened}</div>
          <div class="date">${statusText}</div>
        </div>
        <button class="delete" onclick="deleteItem(${item.id})">üóë</button>
      </div>
    `;
  }).join('');
}

document.getElementById("fileInput").onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  preview.src = URL.createObjectURL(file);
  preview.style.display = "block";

  status.style.display = "block";
  status.style.background = "#4d4d1b";
  status.style.color = "#f0ad4e";
  status.textContent = "üîç Detecting PAO symbol...";

  console.clear();
  console.log("=".repeat(50));
  console.log("üì∏ Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏôÑÎ£å:", file.name);

  const img = new Image();
  img.onload = async () => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    canvas.width = img.width * 3;
    canvas.height = img.height * 3;

    console.log(`üìê ÌÅ¨Í∏∞: ${img.width}x${img.height} ‚Üí ${canvas.width}x${canvas.height}`);

    ctx.fillStyle = 'black';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    ctx.filter = 'invert(1) contrast(3) brightness(0.8) grayscale(100%)';
    const temp = document.createElement('canvas');
    temp.width = canvas.width;
    temp.height = canvas.height;
    temp.getContext('2d').drawImage(canvas, 0, 0);
    
    ctx.filter = 'none';
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(temp, 0, 0);

    let data = ctx.getImageData(0, 0, canvas.width, canvas.height);
    for (let i = 0; i < data.data.length; i += 4) {
      const avg = (data.data[i] + data.data[i + 1] + data.data[i + 2]) / 3;
      const val = avg > 180 ? 255 : 0;
      data.data[i] = data.data[i + 1] = data.data[i + 2] = val;
    }
    ctx.putImageData(data, 0, 0);

    console.log("‚úì Ï†ÑÏ≤òÎ¶¨ ÏôÑÎ£å");

    const dbg = document.createElement('img');
    dbg.src = canvas.toDataURL();
    dbg.style.cssText = 'width:100%;margin-top:10px;border:3px solid lime';
    debugImg.innerHTML = '';
    debugImg.appendChild(dbg);
    debugImg.style.display = 'block';

    console.log("ü§ñ Tesseract OCR ÏãúÏûë...");

    try {
      const { data: { text } } = await Tesseract.recognize(canvas, 'eng', {
        logger: m => {
          if (m.status === 'recognizing text') {
            const pct = Math.round(m.progress * 100);
            status.textContent = `üîç Analyzing... ${pct}%`;
          }
        }
      });

      console.log("=".repeat(50));
      console.log("üìÑ OCR ÏõêÎ¨∏:");
      console.log(text);
      console.log("=".repeat(50));

      const lines = text.split(/[\n\r]/);
      const matches = [];
      
      for (const line of lines) {
        if (/may/i.test(line)) {
          console.log(`‚äò Ïä§ÌÇµ: "${line.trim()}" (may Ìè¨Ìï®)`);
          continue;
        }
        
        const match = line.match(/\b(3|6|9|12|18|24|36)\s*M\b/i);
        if (match) {
          matches.push(match[0]);
          console.log(`‚úì Î∞úÍ≤¨: "${line.trim()}" ‚Üí ${match[0]}`);
        }
      }

      if (matches.length > 0) {
        const shortest = matches.sort((a, b) => a.length - b.length)[0];
        const num = parseInt(shortest.match(/\d+/)[0]);

        console.log("‚úÖ ÏµúÏ¢Ö ÌõÑÎ≥¥:", matches);
        console.log("üéØ ÏµúÏ¢Ö ÏÑ†ÌÉù:", num + "M");

        selectPAO(num);
        updateResult();
        status.style.background = "#1b4d3e";
        status.style.color = "#20c997";
        status.textContent = `‚úì Detected ${num}M`;
      } else {
        console.log("‚ùå PAO Ìå®ÌÑ¥ Î™ª Ï∞æÏùå");
        status.style.background = "#4d1b1b";
        status.style.color = "#ff6b6b";
        status.textContent = "‚ùå Not detected. Select manually ‚Üì";
      }
    } catch (err) {
      console.error("‚ùå OCR ÏóêÎü¨:", err);
      status.style.background = "#4d1b1b";
      status.style.color = "#ff6b6b";
      status.textContent = "‚ö† Error. Select manually";
    }
  };

  img.src = URL.createObjectURL(file);
};

opened.onchange = updateResult;

// Ï¥àÍ∏∞ Î†åÎçîÎßÅ
renderVanity();
</script>
</body>
</html>