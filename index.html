<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Keep or Toss</title>
  <meta name="theme-color" content="#0b0c10" />

  <!--
    핵심 정책
    - 워커스 호출 안 함 (네트워크/코르스/지연 제거)
    - Analyze 버튼 없음 (파일 선택 즉시 OCR 자동 실행)
    - 화장대 정렬: TOSS(맨 위) → USE SOON → SAFE (아이템 추가할 때마다 자동 재정렬)
    - 로컬 저장: localStorage
  -->

  <style>
    :root{
      --bg:#0b0c10;
      --card:#111318;
      --card2:#0f1116;
      --text:#e8e8ea;
      --muted:#a8abb4;
      --border:rgba(255,255,255,.10);
      --btn:#2b6cff;
      --btn2:#1f2430;
      --danger:#ff4d4f;
      --warn:#ffcc00;
      --ok:#20c997;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background: radial-gradient(1200px 700px at 10% 0%, rgba(43,108,255,.12), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(32,201,151,.10), transparent 60%),
                  var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    .wrap{
      max-width: 860px;
      margin: 0 auto;
      padding: 18px 14px 40px;
      display:flex;
      gap: 16px;
      align-items:flex-start;
      justify-content:center;
      flex-wrap:wrap;
    }

    .titlebar{
      width:100%;
      max-width: 860px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 6px 4px 2px;
    }

    .titlebar .title{
      font-size: 22px;
      letter-spacing: .2px;
      font-weight: 800;
      margin:0;
    }

    .titlebar .subtitle{
      margin: 2px 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .panel{
      width: 420px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .panel .inner{
      padding: 14px;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .spacer{ height: 10px; }

    .hint{
      font-size: 12px;
      color: var(--muted);
      margin: 8px 2px 0;
      line-height: 1.35;
    }

    .btn{
      appearance:none;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 800;
      letter-spacing: .2px;
      cursor:pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,.30);
      user-select:none;
    }
    .btn:hover{ filter: brightness(1.03); }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      border-color: rgba(43,108,255,.35);
      background: linear-gradient(180deg, rgba(43,108,255,.35), rgba(43,108,255,.15));
    }

    .btn.ghost{
      box-shadow:none;
      background: transparent;
    }

    .btn.small{
      padding: 8px 10px;
      border-radius: 11px;
      font-weight: 800;
      font-size: 12px;
    }

    .filebar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 14px;
      background: rgba(0,0,0,.18);
      border-bottom: 1px solid var(--border);
    }

    .filebar .filename{
      font-size: 12px;
      color: var(--muted);
      max-width: 220px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .hiddenInput{
      position:absolute;
      left:-9999px;
      width:1px;
      height:1px;
      opacity:0;
      pointer-events:none;
    }

    .previewBox{
      background: rgba(0,0,0,.18);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      overflow:hidden;
      width:100%;
      aspect-ratio: 3 / 4;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }

    .previewBox img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:none;
    }

    .previewBox .empty{
      padding: 16px;
      text-align:center;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }

    .badge{
      position:absolute;
      left:10px;
      bottom:10px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.10);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,.90);
      display:none;
      gap: 8px;
      align-items:center;
    }

    .dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background: var(--muted);
      display:inline-block;
    }
    .dot.ok{ background: var(--ok); }
    .dot.warn{ background: var(--warn); }
    .dot.err{ background: var(--danger); }

    .inputs{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 12px;
    }

    .field{
      background: rgba(0,0,0,.18);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 10px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
    }

    .field label{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }

    .field input[type="date"]{
      width: 180px;
      background: transparent;
      color: var(--text);
      border: none;
      outline:none;
      font-size: 13px;
      font-weight: 700;
    }

    .field input[type="text"]{
      width: 100%;
      background: transparent;
      color: var(--text);
      border: none;
      outline:none;
      font-size: 13px;
      font-weight: 700;
    }

    .paoGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 12px;
    }

    .paoBtn{
      padding: 11px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(31,36,48,.55);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      letter-spacing: .2px;
    }

    .paoBtn.active{
      outline: 2px solid rgba(32,201,151,.85);
      background: rgba(32,201,151,.10);
    }

    .resultLine{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.18);
      font-weight: 900;
      font-size: 13px;
      line-height: 1.35;
      min-height: 44px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }

    .resultLine .left{
      display:flex;
      align-items:center;
      gap: 8px;
      min-width: 180px;
    }

    .statusText.ok{ color: var(--ok); }
    .statusText.warn{ color: var(--warn); }
    .statusText.err{ color: var(--danger); }

    .meta{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,.75);
      opacity: .9;
    }

    .actions{
      display:flex;
      gap: 10px;
      margin-top: 12px;
    }

    .shelfPanel{
      width: 420px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .shelfHeader{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,.18);
    }

    .shelfHeader .h1{
      margin:0;
      font-size: 14px;
      font-weight: 900;
      letter-spacing:.2px;
    }

    .shelfHeader .count{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }

    .group{
      padding: 12px 14px 6px;
    }

    .groupTitle{
      display:flex;
      align-items:center;
      gap: 8px;
      font-weight: 900;
      font-size: 12px;
      letter-spacing: .2px;
      margin: 0 0 10px;
    }

    .groupTitle .tag{
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: rgba(255,255,255,.85);
      background: rgba(0,0,0,.18);
    }

    .groupTitle .tag.err{ border-color: rgba(255,77,79,.35); color: rgba(255,77,79,.95); }
    .groupTitle .tag.warn{ border-color: rgba(255,204,0,.35); color: rgba(255,204,0,.95); }
    .groupTitle .tag.ok{ border-color: rgba(32,201,151,.35); color: rgba(32,201,151,.95); }

    .items{
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding-bottom: 10px;
    }

    .item{
      border: 1px solid var(--border);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 10px;
      display:flex;
      gap: 10px;
      align-items:flex-start;
    }

    .thumb{
      width: 54px;
      height: 72px;
      border-radius: 10px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      flex: 0 0 auto;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .thumb img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }

    .itemMain{
      flex: 1 1 auto;
      min-width: 0;
    }

    .itemTitle{
      font-weight: 1000;
      font-size: 13px;
      margin: 0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .itemSub{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .itemSub .mono{ font-family: var(--mono); }

    .itemRight{
      display:flex;
      flex-direction:column;
      gap: 8px;
      align-items:flex-end;
      flex: 0 0 auto;
    }

    .pill{
      font-weight: 1000;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.18);
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .pill.ok{ color: var(--ok); border-color: rgba(32,201,151,.35); }
    .pill.warn{ color: var(--warn); border-color: rgba(255,204,0,.35); }
    .pill.err{ color: var(--danger); border-color: rgba(255,77,79,.35); }

    .delBtn{
      appearance:none;
      border: 1px solid rgba(255,77,79,.35);
      background: rgba(255,77,79,.10);
      color: rgba(255,255,255,.92);
      padding: 6px 8px;
      border-radius: 10px;
      font-weight: 1000;
      font-size: 11px;
      cursor:pointer;
    }

    .delBtn:hover{ filter: brightness(1.05); }
    .delBtn:active{ transform: translateY(1px); }

    .footerNote{
      padding: 10px 14px 14px;
      color: var(--muted);
      font-size: 11px;
      line-height: 1.35;
      border-top: 1px solid var(--border);
      background: rgba(0,0,0,.10);
    }

    @media (max-width: 920px){
      .wrap{ max-width: 860px; }
      .panel,.shelfPanel{ width: 100%; max-width: 520px; }
      .titlebar{ max-width: 520px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="titlebar">
      <div>
        <p class="titlebar-title title">Keep or Toss</p>
        <p class="subtitle">Photo → local PAO OCR → Toss date → My Shelf</p>
      </div>
      <button class="btn ghost small" id="btnResetAll" type="button">Reset</button>
    </div>

    <!-- LEFT: scanner -->
    <section class="panel" aria-label="scanner">
      <div class="filebar">
        <div class="row" style="gap:8px;">
          <input class="hiddenInput" id="fileInput" type="file" accept="image/*" />
          <button class="btn primary small" id="btnPick" type="button">Choose image</button>
          <div class="filename" id="fileName">No file selected</div>
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn small" id="btnClearCurrent" type="button">Clear</button>
        </div>
      </div>

      <div class="inner">
        <div class="previewBox" id="previewBox">
          <img id="previewImg" alt="preview" />
          <div class="empty" id="previewEmpty">
            사진을 선택하면 자동으로 PAO(3M/6M/…)를 읽고<br/>
            Toss date를 계산해서 화장대에 넣을 수 있어.
          </div>
          <div class="badge" id="scanBadge">
            <span class="dot" id="scanDot"></span>
            <span id="scanText">대기</span>
          </div>
        </div>

        <div class="inputs">
          <div class="field">
            <label for="opened">Opened</label>
            <input id="opened" type="date" />
          </div>

          <div class="field">
            <label for="productName">Name</label>
            <input id="productName" type="text" placeholder="Product name (optional)" maxlength="60" />
          </div>
        </div>

        <div class="paoGrid" id="paoGrid"></div>

        <div class="resultLine" id="resultLine">
          <div class="left">
            <span class="dot" id="statusDot"></span>
            <span class="statusText warn" id="statusText">PAO와 날짜를 선택하세요</span>
          </div>
          <div class="meta" id="metaText"></div>
        </div>

        <div class="actions">
          <button class="btn primary" id="btnAdd" type="button" style="flex:1;">Add to Shelf</button>
          <button class="btn" id="btnClearShelf" type="button" style="flex:1;">Clear Shelf</button>
        </div>

        <div class="hint" id="hintLine">
          팁: “버릴 것”이 맨 위로 올라오게 정렬됨. 사진 추가할수록 위에서부터 바로 정리됨.
        </div>
      </div>
    </section>

    <!-- RIGHT: shelf -->
    <section class="shelfPanel" aria-label="shelf">
      <div class="shelfHeader">
        <p class="h1">My Shelf</p>
        <div class="count" id="shelfCount">0 items</div>
      </div>

      <div class="group" id="groupToss">
        <div class="groupTitle">
          <span class="tag err">TOSS</span>
          <span>버릴 것 (기한 지남)</span>
        </div>
        <div class="items" id="listToss"></div>
      </div>

      <div class="group" id="groupSoon">
        <div class="groupTitle">
          <span class="tag warn">USE SOON</span>
          <span>곧 버릴 것 (30일 이내)</span>
        </div>
        <div class="items" id="listSoon"></div>
      </div>

      <div class="group" id="groupSafe">
        <div class="groupTitle">
          <span class="tag ok">SAFE</span>
          <span>사용해도 되는 것</span>
        </div>
        <div class="items" id="listSafe"></div>
      </div>

      <div class="footerNote">
        로컬 저장(localStorage). 브라우저/기기 바꾸면 데이터는 안 따라감.<br/>
        지금 단계는 “PAO + 날짜 + 정렬 UX”만 고정. 워커스/서버는 안 씀.
      </div>
    </section>
  </div>

    <!-- Tesseract.js (로컬 OCR) -->
  <!--
    - 첫 실행 때 워커 로딩/캐시 때문에 약간의 딜레이가 있을 수 있음
    - 그 다음부터는 훨씬 빨라짐
    - 인식 대상이 "3M, 6M..." 같은 짧은 패턴이라 whitelist로 강하게 제한함
  -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script>
    /* =========================
       Constants
    ========================= */
    const PAO_OPTIONS = [3,6,9,12,18,24,36];
    const SOON_DAYS = 30;

    const LS_KEY = "keep_or_toss_shelf_v3";

    /* =========================
       Elements
    ========================= */
    const fileInput = document.getElementById("fileInput");
    const btnPick = document.getElementById("btnPick");
    const btnClearCurrent = document.getElementById("btnClearCurrent");
    const fileNameEl = document.getElementById("fileName");

    const previewImg = document.getElementById("previewImg");
    const previewEmpty = document.getElementById("previewEmpty");

    const openedEl = document.getElementById("opened");
    const productNameEl = document.getElementById("productName");

    const paoGrid = document.getElementById("paoGrid");

    const resultLine = document.getElementById("resultLine");
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const metaText = document.getElementById("metaText");

    const btnAdd = document.getElementById("btnAdd");
    const btnClearShelf = document.getElementById("btnClearShelf");
    const btnResetAll = document.getElementById("btnResetAll");

    const shelfCount = document.getElementById("shelfCount");
    const listToss = document.getElementById("listToss");
    const listSoon = document.getElementById("listSoon");
    const listSafe = document.getElementById("listSafe");

    const scanBadge = document.getElementById("scanBadge");
    const scanDot = document.getElementById("scanDot");
    const scanText = document.getElementById("scanText");

    /* =========================
       State
    ========================= */
    let selectedPAO = null;
    let currentImageDataUrl = "";
    let currentImageThumb = "";
    let shelf = [];

    let ocrWorker = null;
    let ocrReady = false;
    let ocrBusy = false;

    /* =========================
       Helpers: date
    ========================= */
    function todayISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    }

    function parseISO(iso){
      const [y,m,d] = String(iso).split("-").map(Number);
      return new Date(y, (m||1)-1, d||1);
    }

    function toISO(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    }

    function addMonths(iso, months){
      const dt = parseISO(iso);
      const day = dt.getDate();
      dt.setMonth(dt.getMonth() + months);

      // JS month overflow로 날짜가 밀리는 문제 완화
      // ex) 1/31 + 1 month => 3/02 같은 케이스를 최대한 원래 월의 마지막날로 맞춤
      if (dt.getDate() !== day) {
        dt.setDate(0); // 전월 말일
      }
      return dt;
    }

    function diffDays(a, b){
      // a-b (a가 미래면 +)
      const ms = a.getTime() - b.getTime();
      return Math.floor(ms / 86400000);
    }

    /* =========================
       Status logic
    ========================= */
    function getStatus(tossDate){
      const today = new Date();
      const left = diffDays(tossDate, today);

      if (left < 0) return { key:"err", label:"TOSS IT", daysLeft:left };
      if (left <= SOON_DAYS) return { key:"warn", label:"USE SOON", daysLeft:left };
      return { key:"ok", label:"SAFE TO USE", daysLeft:left };
    }

    function setResultUI(statusKey, text, meta){
      statusDot.className = "dot " + (statusKey || "");
      statusText.className = "statusText " + (statusKey || "warn");
      statusText.textContent = text || "";
      metaText.textContent = meta || "";
    }

    function setScanUI(mode, text){
      // mode: "idle" | "busy" | "ok" | "fail"
      scanBadge.style.display = "flex";
      scanText.textContent = text || "";

      scanDot.className = "dot";
      if (mode === "ok") scanDot.classList.add("ok");
      else if (mode === "fail") scanDot.classList.add("err");
      else if (mode === "busy") scanDot.classList.add("warn");
    }

    function hideScanUI(){
      scanBadge.style.display = "none";
    }

    /* =========================
       PAO buttons
    ========================= */
    function renderPaoButtons(){
      paoGrid.innerHTML = "";
      PAO_OPTIONS.forEach(m=>{
        const b = document.createElement("button");
        b.type = "button";
        b.className = "paoBtn";
        b.textContent = `${m}M`;
        b.addEventListener("click", ()=>{
          selectPAO(m);
          updateResult();
        });
        paoGrid.appendChild(b);
      });
    }

    function selectPAO(m){
      selectedPAO = m;
      [...paoGrid.children].forEach(btn=>{
        btn.classList.toggle("active", btn.textContent === `${m}M`);
      });
    }

    function clearPAO(){
      selectedPAO = null;
      [...paoGrid.children].forEach(btn=> btn.classList.remove("active"));
    }

    /* =========================
       Result calculation
    ========================= */
    function updateResult(){
      const opened = openedEl.value;
      if (!opened || !selectedPAO){
        setResultUI("warn", "PAO와 날짜를 선택하세요", "");
        return;
      }

      const tossDate = addMonths(opened, selectedPAO);
      const st = getStatus(tossDate);

      const meta = `${selectedPAO}M · Toss at ${toISO(tossDate)} · D${st.daysLeft>=0?"+":""}${st.daysLeft}`;
      setResultUI(st.key, st.label, meta);
    }

    /* =========================
       localStorage
    ========================= */
    function loadShelf(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return arr;
      }catch{
        return [];
      }
    }

    function saveShelf(){
      localStorage.setItem(LS_KEY, JSON.stringify(shelf));
    }

    /* =========================
       Shelf sort/render
       - TOSS first, then SOON, then SAFE
       - within each group: tossDate ascending (더 급한게 위)
       - tie-breaker: createdAt desc (최근 추가가 위)
    ========================= */
    function statusRank(key){
      if (key === "err") return 0;
      if (key === "warn") return 1;
      return 2;
    }

    function normalizeItem(it){
      // 기존 데이터 호환
      const openedAt = it.openedAt || it.opened || todayISO();
      const paoMonths = Number(it.paoMonths || it.pao || 0) || null;
      const name = it.name || it.productName || "";
      const image = it.image || it.imageDataUrl || "";
      const thumb = it.thumb || it.thumbnail || "";
      const createdAt = it.createdAt || Date.now();

      let tossAt = it.tossAt;
      if (!tossAt && openedAt && paoMonths){
        tossAt = toISO(addMonths(openedAt, paoMonths));
      }

      return {
        id: it.id || ("it_" + Math.random().toString(36).slice(2) + "_" + Date.now()),
        name,
        openedAt,
        paoMonths,
        tossAt,
        image,
        thumb,
        createdAt
      };
    }

    function computeStatusForItem(it){
      const tossDate = parseISO(it.tossAt);
      const st = getStatus(tossDate);
      return st;
    }

    function sortShelf(){
      shelf = shelf.map(normalizeItem);

      shelf.sort((a,b)=>{
        const sa = computeStatusForItem(a);
        const sb = computeStatusForItem(b);

        const ra = statusRank(sa.key);
        const rb = statusRank(sb.key);
        if (ra !== rb) return ra - rb;

        // tossAt 빠른 순
        const ta = parseISO(a.tossAt).getTime();
        const tb = parseISO(b.tossAt).getTime();
        if (ta !== tb) return ta - tb;

        // 최근 추가 위
        return (b.createdAt||0) - (a.createdAt||0);
      });
    }

    function renderShelf(){
      listToss.innerHTML = "";
      listSoon.innerHTML = "";
      listSafe.innerHTML = "";

      sortShelf();

      const total = shelf.length;
      shelfCount.textContent = `${total} item${total===1?"":"s"}`;

      shelf.forEach(it=>{
        const st = computeStatusForItem(it);
        const el = renderItem(it, st);

        if (st.key === "err") listToss.appendChild(el);
        else if (st.key === "warn") listSoon.appendChild(el);
        else listSafe.appendChild(el);
      });
    }

    function renderItem(it, st){
      const wrap = document.createElement("div");
      wrap.className = "item";

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      const img = document.createElement("img");
      img.alt = "thumb";
      img.src = it.thumb || it.image || "";
      thumb.appendChild(img);

      const main = document.createElement("div");
      main.className = "itemMain";

      const title = document.createElement("p");
      title.className = "itemTitle";
      title.textContent = it.name?.trim() ? it.name.trim() : "Untitled";

      const sub = document.createElement("div");
      sub.className = "itemSub";
      sub.innerHTML =
        `<span class="mono">${it.paoMonths||"?"}M</span> · Opened <span class="mono">${it.openedAt}</span><br/>` +
        `Toss <span class="mono">${it.tossAt}</span>`;

      main.appendChild(title);
      main.appendChild(sub);

      const right = document.createElement("div");
      right.className = "itemRight";

      const pill = document.createElement("div");
      pill.className = "pill " + st.key;
      pill.textContent = st.label;

      const del = document.createElement("button");
      del.type = "button";
      del.className = "delBtn";
      del.textContent = "Delete";
      del.addEventListener("click", ()=>{
        shelf = shelf.filter(x=> x.id !== it.id);
        saveShelf();
        renderShelf();
      });

      right.appendChild(pill);
      right.appendChild(del);

      wrap.appendChild(thumb);
      wrap.appendChild(main);
      wrap.appendChild(right);

      return wrap;
    }
    /* =========================
       Image utils
    ========================= */
    function fileToDataUrl(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(String(r.result||""));
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    async function makeThumbnail(dataUrl){
      // 작은 썸네일 저장 (로컬스토리지 용량 줄이기)
      // 긴 변 240px 정도로
      const img = new Image();
      img.src = dataUrl;
      await new Promise(res=> { img.onload=res; img.onerror=res; });

      const maxSide = 240;
      const w = img.naturalWidth || 1;
      const h = img.naturalHeight || 1;

      let tw = w, th = h;
      if (w >= h){
        if (w > maxSide){
          tw = maxSide;
          th = Math.round(h * (maxSide / w));
        }
      }else{
        if (h > maxSide){
          th = maxSide;
          tw = Math.round(w * (maxSide / h));
        }
      }

      const c = document.createElement("canvas");
      c.width = tw;
      c.height = th;
      const ctx = c.getContext("2d");
      ctx.drawImage(img, 0, 0, tw, th);

      return c.toDataURL("image/jpeg", 0.72);
    }

    function showPreview(dataUrl){
      currentImageDataUrl = dataUrl || "";
      previewImg.src = dataUrl || "";
      previewImg.style.display = dataUrl ? "block" : "none";
      previewEmpty.style.display = dataUrl ? "none" : "block";
    }

    function clearCurrent(){
      fileInput.value = "";
      fileNameEl.textContent = "No file selected";
      showPreview("");
      productNameEl.value = "";
      clearPAO();
      updateResult();
      hideScanUI();
      currentImageThumb = "";
    }

    /* =========================
       OCR: local (Tesseract.js)
       - 빠르게 하려면 "크게 중앙만" 보도록 간단 전처리
       - 글자 패턴은 (3|6|9|12|18|24|36)M 만
    ========================= */
    async function ensureOcrWorker(){
      if (ocrWorker && ocrReady) return;

      setScanUI("busy", "OCR 준비중…");
      ocrWorker = await Tesseract.createWorker("eng", 1, {
        logger: (m) => {
          // 너무 시끄러우면 주석 처리
          // console.log(m);
        }
      });

      // 문자셋을 강하게 제한
      await ocrWorker.setParameters({
        tessedit_char_whitelist: "0123456789Mm",
        preserve_interword_spaces: "1"
      });

      ocrReady = true;
      setScanUI("ok", "OCR 준비 완료");
      setTimeout(()=>hideScanUI(), 700);
    }

    async function ocrDetectPAO(dataUrl){
      // 반환: { pao: number|null, raw: string }
      await ensureOcrWorker();

      if (!ocrWorker) return { pao:null, raw:"" };
      if (ocrBusy) return { pao:null, raw:"" };

      ocrBusy = true;
      setScanUI("busy", "PAO 읽는중…");

      try{
        // 전처리: 캔버스로 줄이고 대비 올림 + 중앙 영역만
        const pre = await preprocessForPAO(dataUrl);

        const { data } = await ocrWorker.recognize(pre);
        const raw = String(data?.text || "").trim();

        const pao = extractPAOFromText(raw);
        if (pao){
          setScanUI("ok", `PAO ${pao}M 감지`);
          setTimeout(()=>hideScanUI(), 700);
          return { pao, raw };
        }

        setScanUI("fail", "PAO 인식 실패");
        // 실패 표시 조금 보이게
        setTimeout(()=>hideScanUI(), 1200);
        return { pao:null, raw };
      }catch(e){
        console.error(e);
        setScanUI("fail", "OCR 오류");
        setTimeout(()=>hideScanUI(), 1200);
        return { pao:null, raw:"" };
      }finally{
        ocrBusy = false;
      }
    }

    function extractPAOFromText(raw){
      // 3M/6M/9M/12M/18M/24M/36M
      // 대충 나온 결과에서도 잡히게 공백/줄바꿈 제거 후 검사
      const compact = String(raw||"")
        .toUpperCase()
        .replace(/\s+/g,"")
        .replace(/O/g,"0"); // 혹시 O가 0로 나오는 케이스

      const matches = compact.match(/(3|6|9|12|18|24|36)M/g) || [];
      if (matches.length === 0) return null;

      // 가장 먼저 나온 걸 사용
      const m = matches[0];
      const n = Number(m.replace("M",""));
      return PAO_OPTIONS.includes(n) ? n : null;
    }

    async function preprocessForPAO(dataUrl){
      // 중앙을 좀 더 크게 보는 전처리
      const img = new Image();
      img.src = dataUrl;
      await new Promise(res=> { img.onload=res; img.onerror=res; });

      const iw = img.naturalWidth || 1;
      const ih = img.naturalHeight || 1;

      // 중앙 60% 영역 크롭
      const cropW = Math.floor(iw * 0.62);
      const cropH = Math.floor(ih * 0.62);
      const sx = Math.floor((iw - cropW) / 2);
      const sy = Math.floor((ih - cropH) / 2);

      // 다운스케일 목표 너비 (너무 크면 느림)
      const targetW = 520;
      const scale = cropW > targetW ? (targetW / cropW) : 1;

      const cw = Math.max(1, Math.floor(cropW * scale));
      const ch = Math.max(1, Math.floor(cropH * scale));

      const c = document.createElement("canvas");
      c.width = cw;
      c.height = ch;
      const ctx = c.getContext("2d");

      // draw + 대비/그레이
      ctx.drawImage(img, sx, sy, cropW, cropH, 0, 0, cw, ch);

      // 간단한 대비 강화 + 그레이
      const imgData = ctx.getImageData(0,0,cw,ch);
      const d = imgData.data;

      for (let i=0; i<d.length; i+=4){
        const r = d[i], g = d[i+1], b = d[i+2];

        // luminance
        let v = 0.299*r + 0.587*g + 0.114*b;

        // contrast
        // v' = (v-128)*1.35 + 128
        v = (v - 128) * 1.35 + 128;

        // clamp
        v = Math.max(0, Math.min(255, v));

        d[i] = d[i+1] = d[i+2] = v;
        // alpha 유지
      }
      ctx.putImageData(imgData,0,0);

      return c.toDataURL("image/png");
    }

    /* =========================
       Events
    ========================= */
    btnPick.addEventListener("click", ()=> fileInput.click());

    fileInput.addEventListener("change", async (e)=>{
      const file = e.target.files?.[0];
      if (!file) return;

      fileNameEl.textContent = file.name || "selected";
      const dataUrl = await fileToDataUrl(file);
      showPreview(dataUrl);
      currentImageThumb = await makeThumbnail(dataUrl);

      // 파일 선택 즉시 OCR 자동 실행
      const { pao, raw } = await ocrDetectPAO(dataUrl);

      // OCR 성공하면 PAO 자동 선택
      if (pao){
        selectPAO(pao);
      }else{
        // 실패 시, 기존 선택값 유지 (원래 선택이 있었다면 유지)
        // 아무것도 없으면 그대로
      }

      // 디버그 보고 싶으면 아래 주석 해제
      // console.log("OCR RAW:", raw);

      updateResult();
    });

    openedEl.addEventListener("change", ()=>{
      updateResult();
    });

    productNameEl.addEventListener("input", ()=>{
      // 결과 계산과 무관하지만, UX 상 바로 반영되게 둠
    });

    btnClearCurrent.addEventListener("click", ()=>{
      clearCurrent();
    });

    btnAdd.addEventListener("click", ()=>{
      const opened = openedEl.value;
      if (!currentImageDataUrl){
        setResultUI("warn", "먼저 사진을 선택하세요", "");
        return;
      }
      if (!opened || !selectedPAO){
        setResultUI("warn", "PAO와 날짜를 선택하세요", "");
        return;
      }

      const tossDate = addMonths(opened, selectedPAO);
      const st = getStatus(tossDate);

      const item = normalizeItem({
        id: "it_" + Math.random().toString(36).slice(2) + "_" + Date.now(),
        name: String(productNameEl.value||"").trim(),
        openedAt: opened,
        paoMonths: selectedPAO,
        tossAt: toISO(tossDate),
        image: currentImageDataUrl,
        thumb: currentImageThumb,
        createdAt: Date.now()
      });

      shelf.unshift(item);
      saveShelf();
      renderShelf();

      // 추가 후 UX: 다음 등록을 위해 이름만 유지할지/초기화할지
      // 여기서는 사진/PAO는 유지(연속 등록 편하게), 이름은 비움
      productNameEl.value = "";

      setResultUI(st.key, st.label, `${selectedPAO}M · Toss at ${toISO(tossDate)}`);
      setScanUI("ok", "화장대에 추가됨");
      setTimeout(()=>hideScanUI(), 700);
    });

    btnClearShelf.addEventListener("click", ()=>{
      shelf = [];
      saveShelf();
      renderShelf();
    });

    btnResetAll.addEventListener("click", ()=>{
      localStorage.removeItem(LS_KEY);
      shelf = [];
      saveShelf();
      renderShelf();
      clearCurrent();
      openedEl.value = todayISO();
      updateResult();
    });

    /* =========================
       Init
    ========================= */
    function init(){
      renderPaoButtons();

      // 날짜 기본값: 오늘
      openedEl.value = todayISO();

      // 선반 로드/렌더
      shelf = loadShelf().map(normalizeItem);
      saveShelf();
      renderShelf();

      // 기본 결과 상태
      updateResult();

      // 초기 뱃지 숨김
      hideScanUI();
    }

    init();
  </script>
</body>
</html>
