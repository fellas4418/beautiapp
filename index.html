<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KEESS</title>

<style>
/* ========== GLOBAL COLOR SYSTEM (LOCKED) ========== */
:root {
  --bg-primary: #ffffff;
  --bg-secondary: #fff7f7;
  --bg-card: #ffffff;
  --accent-primary: #ff6b6b;
  --accent-secondary: #ffb8b8;
  --accent-tertiary: #ffd4d4;
  --text-primary: #1a1a1a;
  --text-secondary: #6b6b6b;
  --text-tertiary: #b0b0b0;
  --border-light: #f0e6e6;
  --border-accent: #ffd4d4;
  
  /* Status colors (exceptions) */
  --status-keep: #22c55e;
  --status-use-soon: #f59e0b;
  --status-toss: #ef4444;
}

/* ========== DESIGN RULE ========== */
/* Do not change the color theme unless explicitly instructed by the user. */

* { box-sizing: border-box; }

body { 
  margin: 0; 
  background: var(--bg-primary);
  color: var(--text-primary);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  overflow-x: hidden;
}

/* ========== SCREEN SYSTEM (CRITICAL) ========== */
.screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  overflow-y: auto;
  display: none;
}

.screen.active {
  display: block;
}

/* ========== HOME SCREEN ========== */
#homeScreen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: var(--bg-primary);
  padding: 32px;
}

.logo {
  font-size: 64px;
  font-weight: 900;
  color: var(--accent-primary);
  margin-bottom: 80px;
  letter-spacing: -2px;
}

.check-button {
  width: 240px;
  height: 240px;
  border-radius: 50%;
  background: var(--accent-primary);
  color: var(--bg-card);
  border: none;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 8px 24px rgba(255, 107, 107, 0.3);
  transition: all 0.3s;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
}

.check-button:hover {
  transform: scale(1.05);
  box-shadow: 0 12px 32px rgba(255, 107, 107, 0.4);
}

.check-button:active {
  transform: scale(0.98);
}

.check-icon {
  font-size: 48px;
}

/* ========== ADD PRODUCT SCREEN ========== */
.wrap { 
  max-width: 420px; 
  margin: 0 auto; 
  padding: 16px; 
  background: var(--bg-secondary);
  min-height: 100vh;
}

.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.header-title {
  flex: 1;
}

.back-button {
  background: var(--bg-card);
  color: var(--accent-primary);
  border: 2px solid var(--accent-tertiary);
  padding: 8px 16px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

.back-button:hover {
  background: var(--bg-secondary);
  border-color: var(--accent-secondary);
}

.card { 
  background: var(--bg-card);
  border-radius: 16px; 
  padding: 20px; 
  margin-bottom: 8px;
  border: 2px solid var(--border-light);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

h2 { 
  margin: 0 0 8px 0; 
  font-size: 28px;
  color: var(--text-primary);
  font-weight: 800;
}

.subtitle { 
  font-size: 14px; 
  color: var(--accent-primary);
  margin-bottom: 6px;
  font-weight: 600;
}

.tagline { 
  font-size: 13px; 
  color: var(--text-secondary);
  margin-bottom: 10px;
  line-height: 1.4;
}

img { 
  width: 100%; 
  border-radius: 12px; 
  margin-top: 10px; 
  display: block; 
  max-height: 400px; 
  object-fit: contain;
  border: 2px solid var(--border-light);
}

.pao { 
  display: grid; 
  grid-template-columns: repeat(4, 1fr); 
  gap: 10px; 
  margin-top: 8px; 
}

button { 
  padding: 12px; 
  border-radius: 10px; 
  border: 2px solid var(--accent-tertiary);
  background: var(--bg-card);
  color: var(--accent-primary);
  font-weight: 700; 
  font-size: 15px; 
  cursor: pointer; 
  transition: all 0.2s;
}

button:hover { 
  background: var(--bg-secondary);
  border-color: var(--accent-secondary);
  transform: translateY(-2px);
}

button.active { 
  background: var(--accent-primary);
  color: var(--bg-card);
  border-color: var(--accent-primary);
  box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
}

.result { 
  margin-top: 14px; 
  font-weight: 700;
  font-size: 16px; 
  text-align: center; 
  padding: 14px; 
  background: var(--bg-secondary);
  border-radius: 10px;
  color: var(--text-primary);
  border: 2px solid var(--border-light);
}

.result-estimated-note {
  margin-top: 8px;
  font-size: 13px;
  color: var(--status-use-soon);
  font-weight: 600;
}

.status-label { 
  margin-top: 8px; 
  font-weight: 800; 
  font-size: 15px; 
  text-align: center; 
  padding: 10px; 
  border-radius: 8px;
  color: var(--bg-card);
}

input[type="text"] { 
  width: 100%; 
  margin-top: 4px;
  padding: 10px; 
  border-radius: 8px; 
  border: 2px solid var(--border-light);
  background: var(--bg-card);
  color: var(--text-primary);
  font-size: 14px;
  transition: all 0.2s;
  margin-left: 4px;
}

input[type="text"]:focus {
  outline: none;
  border-color: var(--accent-secondary);
  box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
}

.file-upload-wrapper { 
  position: relative; 
  margin-top: 10px; 
}

.file-upload-wrapper input[type="file"] { 
  position: absolute; 
  opacity: 0; 
  width: 100%; 
  height: 100%; 
  cursor: pointer; 
  z-index: 2;
}

.file-upload-label {
  display: block;
  width: 100%;
  padding: 12px;
  background: var(--accent-primary);
  color: var(--bg-card);
  text-align: center;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid var(--accent-primary);
}

.file-upload-label:hover { 
  background: #ff5555;
  border-color: #ff5555;
  transform: translateY(-2px);
}

.file-name { 
  margin-top: 8px; 
  font-size: 13px; 
  color: var(--text-secondary);
  text-align: center; 
}

.status { 
  margin-top: 10px; 
  padding: 12px; 
  border-radius: 8px; 
  text-align: center; 
  font-weight: 600; 
  font-size: 14px;
  border: 2px solid var(--border-light);
}

label { 
  display: block; 
  margin-top: 0; 
  margin-bottom: 4px;
  font-size: 13px; 
  color: var(--text-secondary);
  font-weight: 700;
}

.photo-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 0;
  margin-bottom: 12px;
}

.photo-buttons button {
  padding: 20px 12px;
  background: var(--accent-primary);
  color: var(--bg-card);
  border: 2px solid var(--accent-primary);
  border-radius: 12px;
  font-weight: 700;
  font-size: 16px;
  box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);
}

.photo-buttons button:hover {
  background: #ff5555;
  border-color: #ff5555;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(255, 107, 107, 0.3);
}

.photo-section-label {
  font-size: 13px;
  color: #4a4a4a;
  margin-bottom: 6px;
  text-align: center;
  font-weight: 700;
}

@keyframes statusFadeUp {
  from {
    opacity: 0;
    transform: translateY(8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.status-label.animate {
  animation: statusFadeUp 250ms ease-out;
}

.shelf-section { 
  margin-top: 24px; 
}

.shelf-item { 
  background: var(--bg-card);
  border-radius: 12px; 
  padding: 12px; 
  margin-bottom: 10px; 
  position: relative; 
  display: flex;
  align-items: center;
  gap: 12px;
  border: 2px solid var(--border-light);
  transition: all 0.2s;
}

.shelf-item:hover {
  border-color: var(--border-accent);
  box-shadow: 0 2px 8px rgba(255, 107, 107, 0.1);
}

.shelf-item.selection-mode {
  padding-left: 48px;
}

.shelf-item-checkbox {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 24px;
  height: 24px;
  cursor: pointer;
  accent-color: var(--accent-primary);
  display: none;
}

.shelf-item.selection-mode .shelf-item-checkbox {
  display: block;
}

.shelf-item-content {
  flex: 1;
  min-width: 0;
}

.shelf-item-name {
  font-size: 16px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 4px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.shelf-item-meta {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 2px;
}

.shelf-item-dates {
  font-size: 11px;
  color: var(--text-tertiary);
}

.shelf-item-estimated-badge {
  display: inline-block;
  padding: 2px 6px;
  background: #fff7ed;
  color: var(--status-use-soon);
  border-radius: 4px;
  font-size: 10px;
  font-weight: 700;
  margin-left: 4px;
  text-transform: uppercase;
  border: 1px solid #fed7aa;
}

.shelf-item-status { 
  padding: 6px 12px; 
  border-radius: 6px; 
  font-size: 12px; 
  font-weight: 700;
  white-space: nowrap;
  flex-shrink: 0;
  color: var(--bg-card);
}

.delete-btn { 
  position: absolute; 
  top: 8px; 
  right: 8px; 
  background: var(--bg-card);
  color: var(--accent-primary);
  width: 28px; 
  height: 28px; 
  border-radius: 50%; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  font-size: 16px; 
  cursor: pointer; 
  transition: all 0.2s; 
  padding: 0; 
  z-index: 10;
  border: 2px solid var(--border-accent);
}

.delete-btn:hover { 
  background: #fee;
  color: var(--status-toss);
  border-color: var(--status-toss);
  transform: scale(1.1);
}

.shelf-item.selection-mode .delete-btn {
  display: none;
}

.shelf-summary {
  background: var(--bg-card);
  padding: 14px;
  border-radius: 10px;
  margin-bottom: 12px;
  border: 2px solid var(--border-light);
  line-height: 1.8;
}

.shelf-summary-line {
  font-size: 15px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.shelf-summary-line:last-child {
  margin-bottom: 0;
}

.date-mode-toggle {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 6px;
}

.date-mode-toggle button {
  padding: 10px;
  background: var(--bg-card);
  color: var(--accent-primary);
  border: 2px solid var(--accent-tertiary);
  border-radius: 8px;
  font-weight: 600;
  font-size: 13px;
}

.date-mode-toggle button:hover {
  background: var(--bg-secondary);
  border-color: var(--accent-secondary);
}

.date-mode-toggle button.active {
  background: var(--accent-primary);
  color: var(--bg-card);
  border-color: var(--accent-primary);
}

.date-selectors-wrapper {
  position: relative;
  margin-top: 8px;
  padding: 8px 0;
}

.date-selectors {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
  position: relative;
  z-index: 2;
}

.date-selectors.two-col {
  grid-template-columns: 1fr 1fr;
}

.date-selectors select {
  padding: 16px 10px;
  border-radius: 12px;
  border: 2px solid var(--border-light);
  background: var(--bg-card);
  color: var(--text-primary);
  font-size: 18px;
  font-weight: 700;
  text-align: center;
  height: 64px;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  cursor: pointer;
  transition: all 0.2s;
  margin-left: 4px;
}

.date-selectors select:focus {
  outline: none;
  border-color: var(--accent-secondary);
  box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
}

.date-selectors.estimated select {
  border-style: dashed;
  border-color: #fed7aa;
  background: #fff7ed;
}

.date-selectors.estimated select:focus {
  border-color: var(--status-use-soon);
  box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
}

.estimated-badge {
  display: inline-block;
  margin-top: 12px;
  padding: 8px 16px;
  background: #fff7ed;
  color: var(--status-use-soon);
  border-radius: 20px;
  font-size: 13px;
  font-weight: 700;
  text-align: center;
  border: 2px dashed var(--status-use-soon);
}

.helper-text {
  margin-top: 8px;
  font-size: 12px;
  color: var(--text-secondary);
  font-style: italic;
}

.info-block {
  background: var(--bg-secondary);
  padding: 14px;
  border-radius: 10px;
  font-size: 14px;
  line-height: 1.6;
  color: var(--text-secondary);
  margin-bottom: 7px;
  border: 2px solid var(--border-light);
}

.info-block strong {
  color: var(--accent-primary);
  font-weight: 700;
}

#saveBtn {
  width: 100%;
  margin-top: 14px;
  background: var(--accent-primary);
  color: var(--bg-card);
  border: 2px solid var(--accent-primary);
  padding: 14px;
  font-size: 16px;
  font-weight: 700;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);
}

#saveBtn:hover {
  background: #ff5555;
  border-color: #ff5555;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(255, 107, 107, 0.3);
}

.pao-section-label {
  font-size: 13px;
  color: #4a4a4a;
  margin-bottom: 8px;
  margin-top: 0;
  font-weight: 700;
  text-align: left;
}

.form-section {
  margin-bottom: 7px;
  padding: 6px;
  background: rgba(255, 247, 247, 0.3);
  border-radius: 10px;
}

.form-section:last-of-type {
  margin-bottom: 0;
}

.form-section-label {
  font-size: 13px;
  color: #4a4a4a;
  margin-bottom: 8px;
  margin-top: 0;
  font-weight: 700;
  text-align: left;
}

.save-confirmation {
  margin-top: 14px;
  padding: 14px;
  background: #f0fdf4;
  border: 2px solid #22c55e;
  border-radius: 10px;
  text-align: center;
  font-weight: 700;
  font-size: 15px;
  color: #22c55e;
  display: none;
}

.save-confirmation.show {
  display: block;
  animation: fadeInUp 0.3s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.view-shelf-button {
  width: 100%;
  margin-top: 12px;
  background: var(--accent-primary);
  color: var(--bg-card);
  border: 2px solid var(--accent-primary);
  padding: 14px;
  font-size: 16px;
  font-weight: 700;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);
  display: none;
}

.view-shelf-button.show {
  display: block;
}

.view-shelf-button:hover {
  background: #ff5555;
  border-color: #ff5555;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(255, 107, 107, 0.3);
}

#photoToOCRSection {
  margin-bottom: 7px;
}

#paoSection {
  margin-bottom: 7px;
}

#openingDateSection {
  margin-bottom: 7px;
}

#productNameSection {
  margin-bottom: 7px;
}

.card + .card {
  margin-top: 8px;
}

.result:empty {
  display: none !important;
  margin: 0 !important;
  padding: 0 !important;
}

.status-label:empty {
  display: none !important;
  margin: 0 !important;
  padding: 0 !important;
}

.status:empty {
  display: none !important;
  margin: 0 !important;
  padding: 0 !important;
}

.helper-text:empty {
  display: none !important;
  margin: 0 !important;
  padding: 0 !important;
}

.estimated-badge:empty {
  display: none !important;
  margin: 0 !important;
  padding: 0 !important;
}

.file-name:empty {
  display: none !important;
  margin: 0 !important;
  padding: 0 !important;
}

.save-confirmation:not(.show) {
  display: none !important;
  margin: 0 !important;
  padding: 0 !important;
}

.view-shelf-button:not(.show) {
  display: none !important;
  margin: 0 !important;
  padding: 0 !important;
}

#preview[style*="display: none"],
#preview[style*="display:none"] {
  margin: 0 !important;
  padding: 0 !important;
}

.delete-selected-btn {
  width: 100%;
  margin-top: 12px;
  background: var(--status-toss);
  color: var(--bg-card);
  border: 2px solid var(--status-toss);
  padding: 14px;
  font-size: 16px;
  font-weight: 700;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
  display: none;
}

.delete-selected-btn.show {
  display: block;
}

.delete-selected-btn:hover {
  background: #dc2626;
  border-color: #dc2626;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(239, 68, 68, 0.3);
}

.cancel-selection-btn {
  width: 100%;
  margin-top: 8px;
  background: var(--bg-card);
  color: var(--text-secondary);
  border: 2px solid var(--border-light);
  padding: 12px;
  font-size: 15px;
  font-weight: 600;
  border-radius: 10px;
  display: none;
}

.cancel-selection-btn.show {
  display: block;
}

.cancel-selection-btn:hover {
  background: var(--bg-secondary);
  border-color: var(--border-accent);
}
</style>
</head>

<body>

<!-- ========== HOME SCREEN ========== -->
<div id="homeScreen" class="screen active">
  <div class="logo">KEESS</div>
  <button class="check-button" onclick="showScreen('add')">
    <div class="check-icon">üì∏</div>
    <div>Add cosmetic</div>
  </button>
</div>

<!-- ========== ADD PRODUCT SCREEN ========== -->
<div id="addScreen" class="screen">
<div class="wrap">
<div class="header">
  <div class="header-title">
    <h2>KEESS</h2>
    <div class="subtitle">Keep or Toss</div>
    <div class="tagline">Know when to keep it. Know when to toss it.</div>
  </div>
</div>

<div class="card">
<div id="photoToOCRSection" class="form-section">
  <div class="photo-section-label">Upload a photo to auto-detect PAO</div>
  <div class="photo-buttons">
    <button onclick="document.getElementById('cameraInput').click()">üì∏ Take a photo</button>
    <button onclick="document.getElementById('galleryInput').click()">üñº Select from gallery</button>
  </div>
  <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">
  <input type="file" id="galleryInput" accept="image/*" style="display:none;">
  <div class="file-name" id="fileName"></div>

  <img id="preview" style="display:none">
  <div id="status" class="status" style="display:none"></div>
</div>

<div id="paoSection" class="form-section">
  <label>Select a PAO period</label>
  <div class="pao" id="paoBtns"></div>
</div>

<div id="openingDateSection" class="form-section">
  <label>Opening Date</label>
  <div class="date-mode-toggle">
    <button id="exactBtn" class="active" onclick="setDateMode('exact')">I remember the exact date</button>
    <button id="estimatedBtn" onclick="setDateMode('estimated')">I'm not sure</button>
  </div>

  <div class="date-selectors-wrapper">
    <div id="exactDateSelectors" class="date-selectors">
      <select id="yearSelect"></select>
      <select id="monthSelect"></select>
      <select id="daySelect"></select>
    </div>

    <div id="estimatedDateSelectors" class="date-selectors two-col estimated" style="display:none;">
      <select id="yearSelectEst"></select>
      <select id="monthSelectEst"></select>
    </div>
  </div>

  <div id="estimatedBadge" class="estimated-badge" style="display:none;">
    ESTIMATED
  </div>

  <div id="helperText" class="helper-text" style="display:none;">
    Opening date is estimated
  </div>
</div>

<div id="productNameSection" class="form-section">
  <label>Product Name (optional)</label>
  <input type="text" id="productName" placeholder="e.g. Est√©e Lauder Night Repair">
</div>

<div id="result" class="result" style="display:none"></div>
<div id="statusLabel" class="status-label" style="display:none"></div>

<button id="saveBtn" style="display:none">Save to My Shelf</button>

<div id="saveConfirmation" class="save-confirmation">
  ‚úì Saved to My Shelf
</div>

<button id="viewShelfBtn" class="view-shelf-button" onclick="showScreen('shelf')">
  <span id="viewShelfBtnText">üì¶ View My Shelf</span>
</button>
</div>

<div class="card">
<h3 style="margin:0 0 12px 0">‚ÑπÔ∏è What is PAO?</h3>
<div class="info-block">
<strong>Period After Opening (PAO)</strong> indicates the time a cosmetic product can be safely used after opening.<br><br>
Check the jar icon on your product for the number (e.g., 12M = 12 months).
</div>
</div>

</div>
</div>

<!-- ========== SHELF SCREEN ========== -->
<div id="shelfScreen" class="screen">
<div class="wrap">
<div class="header">
  <h2>üì¶ My Shelf</h2>
  <button class="back-button" onclick="showScreen('add')">‚Üê Home</button>
</div>
<div id="shelfSummary"></div>
<div id="shelfItems"></div>
<button id="deleteSelectedBtn" class="delete-selected-btn" onclick="deleteSelected()">Delete selected</button>
<button id="cancelSelectionBtn" class="cancel-selection-btn" onclick="exitSelectionMode()">Cancel</button>
</div>
</div>

<script>
const SUPPORTED_PAOS = [3, 6, 12, 24];
const PAOS = [3, 6, 9, 12, 18, 24, 36];
const SHELF_STORAGE_KEY = "myShelf";
const PACIFIC_TZ = "America/Los_Angeles";

let selectedPAO = null;
let currentImageDataURL = null;
let lastStatus = null;
let ocrProcessed = false;
let dateMode = 'exact';
let currentScreen = 'home';
let selectionMode = false;

const productName = document.getElementById("productName");
const paoBox = document.getElementById("paoBtns");
const result = document.getElementById("result");
const statusLabel = document.getElementById("statusLabel");
const preview = document.getElementById("preview");
const status = document.getElementById("status");
const fileName = document.getElementById("fileName");
const saveBtn = document.getElementById("saveBtn");
const shelfSummary = document.getElementById("shelfSummary");
const shelfItems = document.getElementById("shelfItems");
const saveConfirmation = document.getElementById("saveConfirmation");
const viewShelfBtn = document.getElementById("viewShelfBtn");
const viewShelfBtnText = document.getElementById("viewShelfBtnText");
const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
const cancelSelectionBtn = document.getElementById("cancelSelectionBtn");

const exactBtn = document.getElementById("exactBtn");
const estimatedBtn = document.getElementById("estimatedBtn");
const exactDateSelectors = document.getElementById("exactDateSelectors");
const estimatedDateSelectors = document.getElementById("estimatedDateSelectors");
const helperText = document.getElementById("helperText");
const estimatedBadge = document.getElementById("estimatedBadge");

const yearSelect = document.getElementById("yearSelect");
const monthSelect = document.getElementById("monthSelect");
const daySelect = document.getElementById("daySelect");
const yearSelectEst = document.getElementById("yearSelectEst");
const monthSelectEst = document.getElementById("monthSelectEst");

function showScreen(screen) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  
  if (screen === 'home') {
    document.getElementById('homeScreen').classList.add('active');
    currentScreen = 'home';
  } else if (screen === 'add') {
    document.getElementById('addScreen').classList.add('active');
    currentScreen = 'add';
    updateViewShelfButtonText();
  } else if (screen === 'shelf') {
    document.getElementById('shelfScreen').classList.add('active');
    currentScreen = 'shelf';
    exitSelectionMode();
    renderShelf();
  }
}

function updateViewShelfButtonText() {
  const shelf = loadShelfFromStorage();
  const totalCount = shelf.length;
  
  if (totalCount === 0) {
    viewShelfBtnText.textContent = "üì¶ View My Shelf";
  } else {
    viewShelfBtnText.textContent = `üì¶ View My Shelf (${totalCount})`;
  }
}

function getPacificMidnight(dateStr) {
  const dateObj = new Date(dateStr + "T00:00:00");
  const pacificDateStr = dateObj.toLocaleString("en-US", { timeZone: PACIFIC_TZ });
  const pacificDate = new Date(pacificDateStr);
  pacificDate.setHours(0, 0, 0, 0);
  return pacificDate;
}

function getTodayPacific() {
  const now = new Date();
  const pacificNowStr = now.toLocaleString("en-US", { timeZone: PACIFIC_TZ });
  const pacificNow = new Date(pacificNowStr);
  pacificNow.setHours(0, 0, 0, 0);
  return pacificNow;
}

function initDateSelectors() {
  const todayPacific = getTodayPacific();
  const currentYear = todayPacific.getFullYear();
  const currentMonth = todayPacific.getMonth() + 1;
  const currentDay = todayPacific.getDate();
  
  for (let y = currentYear; y >= currentYear - 5; y--) {
    yearSelect.add(new Option(y, y));
    yearSelectEst.add(new Option(y, y));
  }
  
  for (let m = 1; m <= 12; m++) {
    const monthName = new Date(2000, m - 1, 1).toLocaleString('en', { month: 'long' });
    monthSelect.add(new Option(monthName, m));
    monthSelectEst.add(new Option(monthName, m));
  }
  
  yearSelect.value = currentYear;
  monthSelect.value = currentMonth;
  yearSelectEst.value = currentYear;
  monthSelectEst.value = currentMonth;
  
  updateDayOptions();
  daySelect.value = currentDay;
}

function getDaysInMonth(year, month) {
  return new Date(year, month, 0).getDate();
}

function updateDayOptions() {
  const year = parseInt(yearSelect.value);
  const month = parseInt(monthSelect.value);
  const daysInMonth = getDaysInMonth(year, month);
  const currentDay = daySelect.value || 1;
  
  daySelect.innerHTML = '';
  for (let d = 1; d <= daysInMonth; d++) {
    daySelect.add(new Option(d, d));
  }
  
  if (currentDay <= daysInMonth) {
    daySelect.value = currentDay;
  } else {
    daySelect.value = daysInMonth;
  }
}

yearSelect.onchange = () => { updateDayOptions(); updateResult(); };
monthSelect.onchange = () => { updateDayOptions(); updateResult(); };
daySelect.onchange = updateResult;
yearSelectEst.onchange = updateResult;
monthSelectEst.onchange = updateResult;

function setDateMode(mode) {
  dateMode = mode;
  
  if (mode === 'exact') {
    exactBtn.classList.add('active');
    estimatedBtn.classList.remove('active');
    exactDateSelectors.style.display = 'grid';
    estimatedDateSelectors.style.display = 'none';
    helperText.style.display = 'none';
    estimatedBadge.style.display = 'none';
  } else {
    exactBtn.classList.remove('active');
    estimatedBtn.classList.add('active');
    exactDateSelectors.style.display = 'none';
    estimatedDateSelectors.style.display = 'grid';
    helperText.style.display = 'block';
    estimatedBadge.style.display = 'inline-block';
  }
  
  updateResult();
}

function getOpeningDate() {
  if (dateMode === 'exact') {
    const year = yearSelect.value;
    const month = String(monthSelect.value).padStart(2, '0');
    const day = String(daySelect.value).padStart(2, '0');
    return `${year}-${month}-${day}`;
  } else {
    const year = yearSelectEst.value;
    const month = String(monthSelectEst.value).padStart(2, '0');
    return `${year}-${month}-01`;
  }
}

SUPPORTED_PAOS.forEach(m => {
  const b = document.createElement("button");
  b.textContent = m + "M";
  b.onclick = () => { selectPAO(m); updateResult(); };
  paoBox.appendChild(b);
});

function selectPAO(m) {
  selectedPAO = m;
  [...paoBox.children].forEach(b => {
    b.classList.toggle("active", b.textContent === m + "M");
  });
}

function addMonths(d, m) {
  const [y, mo, da] = d.split("-").map(Number);
  const dt = new Date(y, mo - 1, da);
  dt.setMonth(dt.getMonth() + m);
  dt.setHours(0, 0, 0, 0);
  
  const year = dt.getFullYear();
  const month = String(dt.getMonth() + 1).padStart(2, '0');
  const day = String(dt.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function calculateDaysLeft(expiryDateStr) {
  const todayPacific = getTodayPacific();
  const expiryPacific = getPacificMidnight(expiryDateStr);
  
  const daysLeft = Math.ceil((expiryPacific - todayPacific) / (1000 * 60 * 60 * 24));
  
  return daysLeft;
}

function updateResult() {
  if (!selectedPAO) { 
    result.innerHTML = "";
    result.style.display = "none";
    statusLabel.style.display = "none";
    saveBtn.style.display = "none";
    lastStatus = null;
    return; 
  }
  
  result.style.display = "block";
  
  const openingDate = getOpeningDate();
  const expiryDateStr = addMonths(openingDate, selectedPAO);
  
  const daysLeft = calculateDaysLeft(expiryDateStr);
  
  let statusText = "";
  let statusColor = "";
  let resultMessage = "";
  
  if (daysLeft < 0) {
    statusText = "TOSS";
    statusColor = "#ef4444";
    resultMessage = "üóëÔ∏è This product should be thrown away";
  } else if (daysLeft <= 60) {
    statusText = "USE SOON";
    statusColor = "#f59e0b";
    resultMessage = "‚ö† Expiring soon ‚Äî " + daysLeft + " days left";
  } else {
    statusText = "KEEP";
    statusColor = "#22c55e";
    resultMessage = "‚úÖ Safe (for now)";
  }
  
  if (dateMode === 'estimated') {
    result.innerHTML = resultMessage + '<div class="result-estimated-note">Opening date is estimated</div>';
  } else {
    result.innerHTML = resultMessage;
  }
  
  if (statusText !== lastStatus) {
    statusLabel.classList.remove("animate");
    void statusLabel.offsetWidth;
    statusLabel.classList.add("animate");
    lastStatus = statusText;
  }
  
  statusLabel.textContent = statusText;
  statusLabel.style.background = statusColor;
  statusLabel.style.display = "block";

  saveBtn.style.display = "block";
}

function extractPAO(text) {
  console.log("Detected text:", text);
  
  const versions = [
    text,
    text.toUpperCase(),
    text.replace(/\s+/g, ''),
    text.replace(/[^a-zA-Z0-9]/g, ' '),
  ];
  
  const patterns = [
    /(\d{1,2})\s*M\b/gi,
    /(\d{1,2})M/gi,
    /M\s*(\d{1,2})/gi,
  ];
  
  for (let ver of versions) {
    for (let pattern of patterns) {
      pattern.lastIndex = 0;
      let match;
      while ((match = pattern.exec(ver)) !== null) {
        const num = parseInt(match[1]);
        if (PAOS.includes(num)) {
          console.log("‚úì Found PAO:", num);
          return num;
        }
      }
    }
  }
  
  const numbers = text.match(/\d+/g);
  if (numbers) {
    for (let numStr of numbers) {
      const num = parseInt(numStr);
      if (PAOS.includes(num)) {
        const idx = text.indexOf(numStr);
        const context = text.substring(Math.max(0, idx - 2), Math.min(text.length, idx + numStr.length + 2));
        if (/m/i.test(context)) {
          console.log("‚úì Found PAO by context:", num);
          return num;
        }
      }
    }
  }
  
  return null;
}

async function detectWithGoogle(base64Image) {
  const apiKey = document.getElementById("apiKey");
  const key = apiKey.value.trim();
  
  if (!key) {
    throw new Error("API key not found");
  }
  
  const base64Content = base64Image.split(',')[1];
  
  const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${key}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      requests: [
        {
          image: {
            content: base64Content
          },
          features: [
            {
              type: 'TEXT_DETECTION',
              maxResults: 10
            }
          ]
        }
      ]
    })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error?.message || `API error: ${response.status}`);
  }
  
  const data = await response.json();
  
  console.log("Google Vision response:", data);
  
  const textAnnotations = data.responses[0]?.textAnnotations;
  
  if (!textAnnotations || textAnnotations.length === 0) {
    return null;
  }
  
  const fullText = textAnnotations[0].description;
  
  return extractPAO(fullText);
}

async function handleFileSelect(e) {
  const file = e.target.files[0];
  if (!file) return;

  ocrProcessed = false;

  fileName.textContent = file.name;
  
  const reader = new FileReader();
  
  reader.onload = async (event) => {
    const base64 = event.target.result;
    currentImageDataURL = base64;
    
    preview.src = base64;
    preview.style.display = "block";

    if (ocrProcessed) {
      console.log("This image was already OCR processed. Skipping...");
      return;
    }

    ocrProcessed = true;

    status.style.display = "block";
    status.style.background = "#fff7ed";
    status.style.color = "#f59e0b";
    status.textContent = "üîç Analyzing with Google Vision...";

    try {
      const pao = await detectWithGoogle(base64);
      
      if (pao && SUPPORTED_PAOS.includes(pao)) {
        selectPAO(pao);
        updateResult();
        status.style.background = "#f0fdf4";
        status.style.color = "#22c55e";
        status.textContent = `‚úì Detected: ${pao}M`;
      } else if (pao) {
        status.style.background = "#fff7ed";
        status.style.color = "#f59e0b";
        status.textContent = `‚ö† Detected ${pao}M but not supported. Select manually ‚Üì`;
      } else {
        status.style.background = "#fef2f2";
        status.style.color = "#ef4444";
        status.textContent = "‚ùå Could not detect PAO. Select manually ‚Üì";
      }
      
    } catch (err) {
      console.error(err);
      status.style.background = "#fef2f2";
      status.style.color = "#ef4444";
      status.textContent = "‚ö† Error: " + err.message;
    }
  };
  
  reader.readAsDataURL(file);
}

document.getElementById("cameraInput").onchange = handleFileSelect;
document.getElementById("galleryInput").onchange = handleFileSelect;

function loadShelfFromStorage() {
  try {
    const stored = localStorage.getItem(SHELF_STORAGE_KEY);
    if (!stored) {
      console.log("No shelf data");
      return [];
    }
    const parsed = JSON.parse(stored);
    console.log("Loaded shelf data:", parsed.length, "items");
    return Array.isArray(parsed) ? parsed : [];
  } catch (err) {
    console.error("Shelf load error:", err);
    return [];
  }
}

function saveShelfToStorage(shelf) {
  try {
    localStorage.setItem(SHELF_STORAGE_KEY, JSON.stringify(shelf));
    console.log("Saved shelf data:", shelf.length, "items");
    return true;
  } catch (err) {
    console.error("Shelf save error:", err);
    alert("‚ö† Save failed: " + err.message);
    return false;
  }
}

function computeStatusFromExpiry(expiryDate) {
  const daysLeft = calculateDaysLeft(expiryDate);
  
  if (daysLeft < 0) {
    return "TOSS";
  } else if (daysLeft <= 60) {
    return "USE SOON";
  } else {
    return "KEEP";
  }
}

function refreshAllStatuses() {
  const shelf = loadShelfFromStorage();
  let updated = false;
  
  shelf.forEach(item => {
    const newStatus = computeStatusFromExpiry(item.expiryDate);
    if (item.status !== newStatus) {
      item.status = newStatus;
      updated = true;
    }
  });
  
  if (updated) {
    saveShelfToStorage(shelf);
    console.log("‚úì Statuses refreshed and saved");
  }
  
  return shelf;
}

saveBtn.onclick = () => {
  if (!selectedPAO) {
    alert("‚ö† First select a PAO period");
    return;
  }

  const openingDate = getOpeningDate();
  const expiryDate = addMonths(openingDate, selectedPAO);
  const itemStatus = computeStatusFromExpiry(expiryDate);

  const name = productName.value.trim() || "noname";

  const item = {
    name: name,
    pao: selectedPAO + "M",
    openingDate: openingDate,
    expiryDate: expiryDate,
    status: itemStatus,
    isEstimated: dateMode === 'estimated',
    createdAt: Date.now()
  };

  const shelf = loadShelfFromStorage();
  shelf.push(item);
  
  const saveSuccess = saveShelfToStorage(shelf);
  
  if (saveSuccess) {
    saveConfirmation.classList.add('show');
    viewShelfBtn.classList.add('show');
    updateViewShelfButtonText();
    productName.value = "";
    console.log("‚úì Item saved. User can continue adding or choose to view shelf.");
  }
};

function getStatusPriority(status) {
  const priorities = {
    "TOSS": 1,
    "USE SOON": 2,
    "KEEP": 3
  };
  return priorities[status] || 999;
}

function enterSelectionMode() {
  selectionMode = true;
  document.querySelectorAll('.shelf-item').forEach(item => {
    item.classList.add('selection-mode');
  });
  deleteSelectedBtn.classList.add('show');
  cancelSelectionBtn.classList.add('show');
}

function exitSelectionMode() {
  selectionMode = false;
  document.querySelectorAll('.shelf-item').forEach(item => {
    item.classList.remove('selection-mode');
    const checkbox = item.querySelector('.shelf-item-checkbox');
    if (checkbox) {
      checkbox.checked = false;
    }
  });
  deleteSelectedBtn.classList.remove('show');
  cancelSelectionBtn.classList.remove('show');
}

function deleteSelected() {
  const checkedBoxes = document.querySelectorAll('.shelf-item-checkbox:checked');
  
  if (checkedBoxes.length === 0) {
    alert("‚ö† Please select at least one item to delete");
    return;
  }
  
  if (!confirm(`Delete ${checkedBoxes.length} item(s)?`)) {
    return;
  }
  
  const idsToDelete = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.id));
  
  const shelf = loadShelfFromStorage();
  const updatedShelf = shelf.filter(item => !idsToDelete.includes(item.createdAt));
  saveShelfToStorage(updatedShelf);
  
  exitSelectionMode();
  renderShelf();
}

function formatOpeningDate(dateStr, isEstimated) {
  if (isEstimated) {
    const [year, month] = dateStr.split('-');
    const monthName = new Date(year, parseInt(month) - 1, 1).toLocaleString('en', { month: 'short' });
    return `${monthName} ${year}`;
  } else {
    return dateStr;
  }
}

function renderShelf() {
  const shelf = refreshAllStatuses();
  
  if (shelf.length === 0) {
    shelfSummary.innerHTML = '';
    shelfItems.innerHTML = '<div style="text-align:center;color:#b0b0b0;padding:20px;">No items in your shelf yet. Add your first product!</div>';
    return;
  }
  
  const tossCount = shelf.filter(item => item.status === "TOSS").length;
  const useSoonCount = shelf.filter(item => item.status === "USE SOON").length;
  const keepCount = shelf.filter(item => item.status === "KEEP").length;
  
  let summaryHTML = '<div class="shelf-summary">';
  summaryHTML += `<div class="shelf-summary-line">Total ${shelf.length} items</div>`;
  summaryHTML += `<div class="shelf-summary-line">üóëÔ∏è ${tossCount} expired ¬∑ ‚ö†Ô∏è ${useSoonCount} use soon ¬∑ ‚úÖ ${keepCount} safe</div>`;
  summaryHTML += '</div>';
  
  shelfSummary.innerHTML = summaryHTML;
  
  const itemsWithStatus = shelf.map(item => {
    if (!item.createdAt) {
      item.createdAt = Date.now() + Math.random();
    }
    
    if (!item.name) {
      item.name = "noname";
    }
    
    return {
      ...item,
      displayStatus: item.status
    };
  });
  
  itemsWithStatus.sort((a, b) => {
    return getStatusPriority(a.displayStatus) - getStatusPriority(b.displayStatus);
  });
  
  shelfItems.innerHTML = itemsWithStatus.map(item => {
    const itemStatus = item.displayStatus;
    
    let statusColor = "";
    if (itemStatus === "TOSS") {
      statusColor = "#ef4444";
    } else if (itemStatus === "USE SOON") {
      statusColor = "#f59e0b";
    } else {
      statusColor = "#22c55e";
    }
    
    const openingDateDisplay = formatOpeningDate(item.openingDate, item.isEstimated || false);
    const estimatedBadge = (item.isEstimated || false) ? '<span class="shelf-item-estimated-badge">Estimated</span>' : '';
    
    return `
      <div class="shelf-item ${selectionMode ? 'selection-mode' : ''}">
        <input type="checkbox" class="shelf-item-checkbox" data-id="${item.createdAt}">
        <button class="delete-btn" onclick="enterSelectionMode(); setTimeout(() => { document.querySelector('[data-id=\\'${item.createdAt}\\']').checked = true; }, 10);">√ó</button>
        <div class="shelf-item-content">
          <div class="shelf-item-name">${item.name}</div>
          <div class="shelf-item-meta">${item.pao} ¬∑ Expires ${item.expiryDate}</div>
          <div class="shelf-item-dates">Opened: ${openingDateDisplay}${estimatedBadge}</div>
        </div>
        <div class="shelf-item-status" style="background: ${statusColor};">
          ${itemStatus}
        </div>
      </div>
    `;
  }).join('');
}

(function cleanupOldData() {
  try {
    const stored = localStorage.getItem(SHELF_STORAGE_KEY);
    if (stored) {
      const shelf = JSON.parse(stored);
      if (shelf.length > 0 && shelf[0].image) {
        console.warn("‚ö† Old format data detected. Cleaning up...");
        localStorage.removeItem(SHELF_STORAGE_KEY);
        console.log("‚úì Shelf data reset. Ready to use without storage issues.");
      }
    }
  } catch (err) {
    console.error("Data cleanup error:", err);
  }
})();

(async function initNotifications() {
  if (!("Notification" in window)) {
    console.log("Browser does not support notifications");
    return;
  }

  if (Notification.permission === "default") {
    try {
      await Notification.requestPermission();
    } catch (err) {
      console.error("Notification permission error:", err);
    }
  }

  if (Notification.permission !== "granted") {
    console.log("Notification permission not granted");
    return;
  }

  const shelf = refreshAllStatuses();
  
  if (shelf.length === 0) {
    return;
  }

  const tossCount = shelf.filter(item => item.status === "TOSS").length;
  const useSoonCount = shelf.filter(item => item.status === "USE SOON").length;

  if (tossCount > 0) {
    new Notification("KEESS ¬∑ Keep or Toss", {
      body: "üóëÔ∏è You have expired products. Time to toss them.",
      icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>üóëÔ∏è</text></svg>",
      silent: true
    });
    console.log("‚úì Notification sent: TOSS");
  } else if (useSoonCount > 0) {
    new Notification("KEESS ¬∑ Keep or Toss", {
      body: "‚ö†Ô∏è Some products are expiring soon.",
      icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>‚ö†Ô∏è</text></svg>",
      silent: true
    });
    console.log("‚úì Notification sent: USE SOON");
  }
})();

initDateSelectors();
</script>

<input type="text" id="apiKey" value="AIzaSyAtwhPrHK5d_yLVkBfOc8tDjfk-2_cHDrw" style="display:none;" />

</body>
</html>