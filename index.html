<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KEESS</title>

<style>
/* ========== 80:10:10 COLOR SYSTEM ========== */
:root {
  /* 70% MAIN COLOR - Fresh Teal (primary actions, key UI) */
  --main-teal: #2EC4C0;
  --main-teal-hover: #26ADA9;
  --main-teal-light: #E0F7F6;
  
  /* 10% WARNING COLOR - Red (uncertainty, danger, toss, estimated) */
  --warning-red: #FF2B5B;
  --warning-red-hover: #E61F4F;
  --warning-red-light: #FFE5EE;
  --warning-red-muted: #FFC9D6;
  --warning-red-bg: #FFF5F7;
  
  /* 20% Neutral/Structure */
  --bg-primary: #FAFAFA;
  --bg-secondary: #F2F2F2;
  --bg-card: #FFFFFF;
  
  /* Text colors */
  --text-primary: #1C1C1E;
  --text-secondary: #6B6B6B;
  --text-tertiary: #9A9A9A;
  
  /* Border */
  --border-light: #E5E5E5;
  
  /* Status colors */
  --status-use-soon: #F59E0B;
  --status-keep: #10B981;
}

* { box-sizing: border-box; }

body { 
  margin: 0; 
  background: var(--bg-primary);
  color: var(--text-primary);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

/* ========== SCREEN SYSTEM ========== */
.screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  overflow-y: auto;
  display: none;
  -webkit-overflow-scrolling: touch;
}

.screen {
  pointer-events: none;
}

.screen.active {
  pointer-events: auto;
}
.screen.active {
  display: block;
}

/* ========== HOME SCREEN ========== */
#homeScreen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: var(--bg-primary);
  padding: 32px;
  position: relative;
  min-height: 100vh;
}

.logo {
  font-size: 64px;
  font-weight: 900;
  color: var(--main-teal);
  margin-bottom: 16px;
  letter-spacing: -2px;
}

.logo-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  font-weight: 600;
  margin-bottom: 60px;
  letter-spacing: 1px;
}

.check-button {
  width: 240px;
  height: 240px;
  border-radius: 50%;
  background: var(--main-teal);
  color: white;
  border: none;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 8px 24px rgba(46, 196, 192, 0.3);
  transition: all 0.3s;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-bottom: 40px;
}

.check-icon {
  font-size: 48px;
}

/* SECONDARY BUTTON STYLE - White bg, teal border, red accent */
.home-shelf-button {
  background: var(--bg-card);
  color: var(--main-teal);
  border: 2px solid var(--main-teal);
  padding: 14px 32px;
  border-radius: 12px;
  font-weight: 700;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.home-shelf-button .shelf-count {
  color: var(--warning-red);
  font-weight: 800;
}

/* ========== ADD PRODUCT SCREEN ========== */
.wrap { 
  max-width: 420px; 
  margin: 0 auto; 
  padding: 16px; 
  padding-bottom: 32px;
  background: var(--bg-primary);
  min-height: auto;
}

.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  padding-bottom: 16px;
}

.header-title {
  flex: 1;
}

.back-button {
  background: var(--bg-card);
  color: var(--main-teal);
  border: 1px solid var(--border-light);
  padding: 8px 16px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

.back-button:hover {
  background: var(--main-teal-light);
  border-color: var(--main-teal);
}

/* ========== STICKY STATUS BAR ========== */
.status-bar {
  position: sticky;
  top: 0;
  left: 0;
  width: 100%;
  padding: 20px 26px;
  text-align: center;
  font-size: 20px;
  font-weight: 800;
  color: white;
  z-index: 100;
  cursor: pointer;
  transition: all 0.2s;
  margin-bottom: 16px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.status-bar:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
}

.status-bar.toss {
  background: var(--warning-red);
}

.status-bar.use-soon {
  background: var(--status-use-soon);
}

.status-bar.keep {
  background: var(--status-keep);
}

.status-bar:empty {
  display: none !important;
  margin: 0 !important;
  padding: 0 !important;
}

.card { 
  background: var(--bg-card);
  border-radius: 16px; 
  padding: 20px; 
  margin-bottom: 12px;
  border: 1px solid var(--border-light);
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
  position: relative;
}

h2 { 
  margin: 0 0 0 0; 
  font-size: 28px;
  color: var(--text-primary);
  font-weight: 800;
}

h3 {
  margin: 0 0 12px 0;
  font-size: 20px;
  color: var(--text-primary);
  font-weight: 800;
}

img { 
  width: 100%; 
  border-radius: 12px; 
  margin-top: 10px; 
  display: block; 
  max-height: 400px; 
  object-fit: contain;
  border: 1px solid var(--border-light);
}

.pao { 
  display: grid; 
  grid-template-columns: repeat(4, 1fr); 
  gap: 10px; 
  margin-top: 8px; 
}

button { 
  padding: 12px; 
  border-radius: 10px; 
  border: 1px solid var(--border-light);
  background: var(--bg-card);
  color: var(--main-teal);
  font-weight: 700; 
  font-size: 15px; 
  cursor: pointer; 
  transition: all 0.2s;
}

button:hover { 
  background: var(--main-teal-light);
  border-color: var(--main-teal);
  transform: translateY(-2px);
}

button.active { 
  background: var(--main-teal);
  color: white;
  border-color: var(--main-teal);
  box-shadow: 0 4px 15px rgba(46, 196, 192, 0.3);
}

.result { 
  margin-top: 14px; 
  font-weight: 700;
  font-size: 16px; 
  text-align: center; 
  padding: 14px; 
  background: var(--bg-secondary);
  border-radius: 10px;
  color: var(--text-primary);
  border: 1px solid var(--border-light);
}

.result-estimated-note {
  margin-top: 8px;
  font-size: 13px;
  color: var(--warning-red);
  font-weight: 600;
}

.status-label { 
  margin-top: 8px; 
  font-weight: 800; 
  font-size: 15px; 
  text-align: center; 
  padding: 10px; 
  border-radius: 8px;
  color: white;
}

input[type="text"] { 
  width: 100%; 
  margin-top: 4px;
  padding: 10px; 
  border-radius: 8px; 
  border: 1px solid var(--border-light);
  background: var(--bg-card);
  color: var(--text-primary);
  font-size: 14px;
  transition: all 0.2s;
  margin-left: 4px;
}

input[type="text"]:focus {
  outline: none;
  border-color: var(--main-teal);
  box-shadow: 0 0 0 3px rgba(46, 196, 192, 0.1);
}

.file-name { 
  margin-top: 8px; 
  font-size: 13px; 
  color: var(--text-secondary);
  text-align: center; 
}

.status { 
  margin-top: 10px; 
  padding: 12px; 
  border-radius: 8px; 
  text-align: center; 
  font-weight: 600; 
  font-size: 14px;
  border: 1px solid var(--border-light);
}

label { 
  display: block; 
  margin-top: 0; 
  margin-bottom: 4px;
  font-size: 13px; 
  color: var(--text-secondary);
  font-weight: 700;
}

.photo-buttons {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 24px;
  margin-bottom: 12px;
}

.photo-buttons button:first-child {
  padding: 48px 20px;
  background: var(--main-teal);
  color: white;
  border: none;
  border-radius: 16px;
  font-weight: 700;
  font-size: 18px;
  box-shadow: 0 6px 20px rgba(46, 196, 192, 0.3);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
}

.photo-buttons button:first-child .photo-icon {
  font-size: 64px;
  line-height: 1;
}

.photo-buttons button:first-child .photo-label {
  font-size: 18px;
  font-weight: 700;
  line-height: 1.3;
  text-align: center;
}

.photo-buttons button:last-child {
  padding: 18px 20px;
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 1px solid var(--border-light);
  border-radius: 12px;
  font-weight: 600;
  font-size: 16px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.photo-buttons button:last-child .photo-icon {
  font-size: 24px;
  line-height: 1;
}

.photo-buttons button:last-child .photo-label {
  font-size: 16px;
  font-weight: 600;
  line-height: 1;
  text-align: center;
}

.photo-section-label {
  font-size: 18px;
  color: var(--text-primary);
  margin-bottom: 0;
  text-align: center;
  font-weight: 600;
  line-height: 1.3;
}

.photo-section-label-main {
  font-size: 32px;
  font-weight: 800;
  display: block;
  margin-bottom: 8px;
}

.shelf-section { 
  margin-top: 24px; 
}

.shelf-item { 
  background: var(--bg-card);
  border-radius: 12px; 
  padding: 12px; 
  margin-bottom: 10px; 
  position: relative; 
  display: flex;
  align-items: center;
  gap: 12px;
  border: 1px solid var(--border-light);
  transition: all 0.2s;
}

.shelf-item:hover {
  border-color: var(--main-teal);
  box-shadow: 0 2px 8px rgba(46, 196, 192, 0.1);
}

.shelf-item.selection-mode {
  padding-left: 48px;
}

.shelf-item-checkbox {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 24px;
  height: 24px;
  cursor: pointer;
  accent-color: var(--main-teal);
  display: none;
}

.shelf-item.selection-mode .shelf-item-checkbox {
  display: block;
}

.shelf-item-content {
  flex: 1;
  min-width: 0;
}

.shelf-item-name {
  font-size: 16px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 4px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.shelf-item-name.clickable {
  cursor: pointer;
  transition: color 0.2s;
}

.shelf-item-name.clickable:hover {
  color: var(--main-teal);
}

.shelf-item-name-edit-wrapper {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 4px;
}

.shelf-item-name-edit-input {
  flex: 1;
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid var(--border-light);
  background: var(--bg-card);
  color: var(--text-primary);
  font-size: 14px;
  font-weight: 700;
  transition: all 0.2s;
  margin: 0;
}

.shelf-item-name-edit-input:focus {
  outline: none;
  border-color: var(--main-teal);
  box-shadow: 0 0 0 3px rgba(46, 196, 192, 0.1);
}

.shelf-item-name-edit-btn {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  padding: 0;
  border: none;
  flex-shrink: 0;
}

.shelf-item-name-edit-btn.confirm {
  background: var(--main-teal);
  color: white;
}

.shelf-item-name-edit-btn.confirm:hover {
  background: var(--main-teal-hover);
  transform: scale(1.05);
}

.shelf-item-name-edit-btn.cancel {
  background: var(--bg-secondary);
  color: var(--text-secondary);
}

.shelf-item-name-edit-btn.cancel:hover {
  background: var(--border-light);
  color: var(--text-primary);
}

.shelf-item-meta {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 2px;
}

.shelf-item-dates {
  font-size: 11px;
  color: var(--text-tertiary);
}

.shelf-item-time-left {
  font-size: 13px;
  font-weight: 700;
  margin-top: 4px;
  padding: 4px 0;
}

.shelf-item-time-left.keep {
  color: var(--status-keep);
}

.shelf-item-time-left.use-soon {
  color: var(--status-use-soon);
}

.shelf-item-time-left.toss {
  color: var(--warning-red);
}

.shelf-item-estimated-badge {
  display: inline-block;
  padding: 2px 6px;
  background: var(--warning-red-bg);
  color: var(--warning-red);
  border-radius: 4px;
  font-size: 10px;
  font-weight: 700;
  margin-left: 4px;
  text-transform: uppercase;
  border: 1px solid var(--warning-red-muted);
}

.shelf-item-status { 
  padding: 6px 12px; 
  border-radius: 6px; 
  font-size: 12px; 
  font-weight: 700;
  white-space: nowrap;
  flex-shrink: 0;
  color: white;
}

.delete-btn { 
  position: absolute; 
  top: 8px; 
  right: 8px; 
  background: var(--bg-card);
  color: var(--warning-red);
  width: 28px; 
  height: 28px; 
  border-radius: 50%; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  font-size: 16px; 
  cursor: pointer; 
  transition: all 0.2s; 
  padding: 0; 
  z-index: 10;
  border: 1px solid var(--border-light);
}

.delete-btn:hover { 
  background: var(--warning-red-light);
  color: var(--warning-red);
  border-color: var(--warning-red);
  transform: scale(1.1);
}

.shelf-item.selection-mode .delete-btn {
  display: none;
}

.shelf-summary {
  background: var(--bg-card);
  padding: 16px;
  border-radius: 12px;
  margin-bottom: 16px;
  border: 1px solid var(--border-light);
  line-height: 1.8;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.shelf-summary-line {
  font-size: 15px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.shelf-summary-line:last-child {
  margin-bottom: 0;
}

.date-mode-toggle {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 6px;
}

.date-mode-toggle button {
  padding: 10px;
  background: var(--bg-card);
  color: var(--main-teal);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  font-weight: 600;
  font-size: 13px;
}

.date-mode-toggle button:hover {
  background: var(--main-teal-light);
  border-color: var(--main-teal);
}

.date-mode-toggle button.active {
  background: var(--main-teal);
  color: white;
  border-color: var(--main-teal);
}

.date-selectors-wrapper {
  position: relative;
  margin-top: 8px;
  padding: 8px 0;
}

.date-selectors {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
  position: relative;
  z-index: 2;
}

.date-selectors.two-col {
  grid-template-columns: 1fr 1fr;
}

.date-selectors select {
  padding: 16px 10px;
  border-radius: 12px;
  border: 1px solid var(--border-light);
  background: var(--bg-card);
  color: var(--text-primary);
  font-size: 18px;
  font-weight: 700;
  text-align: center;
  height: 64px;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  cursor: pointer;
  transition: all 0.2s;
  margin-left: 4px;
}

.date-selectors select:focus {
  outline: none;
  border-color: var(--main-teal);
  box-shadow: 0 0 0 3px rgba(46, 196, 192, 0.1);
}

/* RED-TINTED WARNING STYLE FOR "NOT SURE" STATE */
.date-selectors.estimated {
  background: var(--warning-red-bg);
  padding: 12px;
  border-radius: 12px;
  border: 2px solid var(--warning-red-muted);
}

.date-selectors.estimated select {
  border: 2px solid var(--warning-red-muted);
  background: #FFFFFF;
  color: var(--warning-red);
}

.date-selectors.estimated select:focus {
  border-color: var(--warning-red);
  box-shadow: 0 0 0 3px rgba(255, 43, 91, 0.1);
}

/* RED ESTIMATED BADGE */
.estimated-badge {
  display: inline-block;
  margin-top: 12px;
  padding: 8px 16px;
  background: var(--warning-red-bg);
  color: var(--warning-red);
  border-radius: 20px;
  font-size: 13px;
  font-weight: 700;
  text-align: center;
  border: 2px solid var(--warning-red);
}

.helper-text {
  margin-top: 8px;
  font-size: 12px;
  color: var(--warning-red);
  font-style: italic;
  font-weight: 600;
}

/* PRIMARY ACTION BUTTON - Solid teal */
#saveBtn {
  width: 100%;
  margin-top: 14px;
  background: var(--main-teal);
  color: white;
  border: none;
  padding: 14px;
  font-size: 16px;
  font-weight: 700;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(46, 196, 192, 0.2);
}

#saveBtn:hover {
  background: var(--main-teal-hover);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(46, 196, 192, 0.3);
}

.form-section {
  margin-bottom: 16px;
  padding: 0;
}

.form-section:last-of-type {
  margin-bottom: 0;
}

/* Toast notification - lightweight, non-disruptive */
.toast {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  background: var(--main-teal);
  color: white;
  padding: 20px 40px;
  border-radius: 16px;
  font-weight: 700;
  font-size: 18px;
  box-shadow: 0 12px 40px rgba(46, 196, 192, 0.5);
  z-index: 10000;
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.toast.show {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
}

.toast.hide {
  opacity: 0;
  transform: translate(-50%, -50%) scale(0.9);
}

.toast.warning {
  background: var(--warning-red);
}

/* SECONDARY BUTTON STYLE - White bg, teal border, red accent on count */
.view-shelf-button {
  width: 100%;
  margin-top: 12px;
  background: var(--bg-card);
  color: var(--main-teal);
  border: 2px solid var(--main-teal);
  padding: 14px;
  font-size: 16px;
  font-weight: 700;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.view-shelf-button .shelf-count {
  color: var(--warning-red);
  font-weight: 800;
}

.view-shelf-button:hover {
  background: var(--main-teal-light);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(46, 196, 192, 0.3);
}

#photoToOCRSection {
  margin-bottom: 16px;
}

#paoSection {
  margin-bottom: 16px;
}

#openingDateSection {
  margin-bottom: 16px;
}

#productNameSection {
  margin-bottom: 16px;
}

.card + .card {
  margin-top: 12px;
}

.result:empty {
  display: none !important;
  margin: 0 !important;
  padding: 0 !important;
}

.status-label:empty {
  display: none !important;
  margin: 0 !important;
  padding: 0 !important;
}

.status:empty {
  display: none !important;
  margin: 0 !important;
  padding: 0 !important;
}

.helper-text:empty {
  display: none !important;
  margin: 0 !important;
  padding: 0 !important;
}

.estimated-badge:empty {
  display: none !important;
  margin: 0 !important;
  padding: 0 !important;
}

.file-name:empty {
  display: none !important;
  margin: 0 !important;
  padding: 0 !important;
}

#preview[style*="display: none"],
#preview[style*="display:none"] {
  margin: 0 !important;
  padding: 0 !important;
}

.delete-selected-btn {
  width: 100%;
  margin-top: 12px;
  background: var(--warning-red);
  color: white;
  border: none;
  padding: 14px;
  font-size: 16px;
  font-weight: 700;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(255, 43, 91, 0.2);
  display: none;
}

.delete-selected-btn.show {
  display: block;
}

.delete-selected-btn:hover {
  background: var(--warning-red-hover);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(255, 43, 91, 0.3);
}

.cancel-selection-btn {
  width: 100%;
  margin-top: 8px;
  background: var(--bg-card);
  color: var(--text-secondary);
  border: 1px solid var(--border-light);
  padding: 12px;
  font-size: 15px;
  font-weight: 600;
  border-radius: 10px;
  display: none;
}

.cancel-selection-btn.show {
  display: block;
}

.cancel-selection-btn:hover {
  background: var(--main-teal-light);
  border-color: var(--main-teal);
}

.select-all-btn {
  width: 100%;
  margin-top: 12px;
  margin-bottom: 12px;
  background: var(--bg-card);
  color: var(--main-teal);
  border: 1px solid var(--border-light);
  padding: 12px;
  font-size: 15px;
  font-weight: 600;
  border-radius: 10px;
  display: none;
}

.select-all-btn.show {
  display: block;
}

.select-all-btn:hover {
  background: var(--main-teal-light);
  border-color: var(--main-teal);
}

/* HOME My Shelf Î≤ÑÌäº Ïä§ÌÉÄÏùº Í∞ïÏ†ú Î¨¥Î†•Ìôî (ÏµúÏ¢Ö Í≥†Ï†ï) */
#homeScreen .home-shelf-button,
#homeScreen .home-shelf-button * {
  background: none !important;
  border: none !important;
  box-shadow: none !important;
}

.select-gallery-button {
  background: var(--bg-secondary);
  border: 1px solid var(--main-teal);
  color: var(--main-teal);
}

.select-gallery-button:hover {
  background: #FFE6EC;
}

.select-gallery-button {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  gap: 10px;
  color: #1C1C1E;
}

.select-gallery-button .photo-icon {
  font-size: 22px;
  line-height: 1;
}

.select-gallery-button .photo-label {
  color: #1C1C1E;
}

.info-block {
  font-size: 14px;
  line-height: 1.6;
  color: var(--text-secondary);
}

/* ========== TOSS WARNING SCREEN (NEW MULTI-SELECT) ========== */
.toss-warning-message {
  background: var(--warning-red-bg);
  border: 2px solid var(--warning-red-muted);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  text-align: center;
}

.toss-warning-icon {
  font-size: 48px;
  margin-bottom: 12px;
}

.toss-warning-title {
  font-size: 20px;
  font-weight: 800;
  color: var(--warning-red);
  margin-bottom: 8px;
}

.toss-warning-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  line-height: 1.5;
}

.toss-products-list {
  margin-bottom: 20px;
}

.toss-product-item {
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.toss-product-checkbox {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: var(--warning-red);
  flex-shrink: 0;
}

.toss-product-thumbnail {
  width: 60px;
  height: 60px;
  border-radius: 8px;
  object-fit: cover;
  border: 1px solid var(--border-light);
  flex-shrink: 0;
  background: var(--bg-secondary);
}

.toss-product-info {
  flex: 1;
  min-width: 0;
}

.toss-product-name {
  font-size: 15px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.toss-product-expired {
  font-size: 13px;
  color: var(--warning-red);
  font-weight: 600;
}

.toss-select-all-btn {
  width: 100%;
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 1px solid var(--border-light);
  padding: 12px;
  font-size: 15px;
  font-weight: 600;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
  margin-bottom: 12px;
}

.toss-select-all-btn:hover {
  background: var(--main-teal-light);
  border-color: var(--main-teal);
}

.toss-confirm-btn {
  width: 100%;
  background: var(--warning-red);
  color: white;
  border: none;
  padding: 16px;
  font-size: 16px;
  font-weight: 700;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(255, 43, 91, 0.2);
}

.toss-confirm-btn:hover {
  background: var(--warning-red-hover);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(255, 43, 91, 0.3);
}

/* ========== DISCARD CONFIRMATION SCREEN ========== */
.confirmation-icon {
  font-size: 72px;
  text-align: center;
  margin-bottom: 20px;
}

.confirmation-title {
  font-size: 24px;
  font-weight: 800;
  color: var(--text-primary);
  text-align: center;
  margin-bottom: 32px;
}

.confirmation-btn {
  width: 100%;
  background: var(--main-teal);
  color: white;
  border: none;
  padding: 16px;
  font-size: 16px;
  font-weight: 700;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(46, 196, 192, 0.2);
}

.confirmation-btn:hover {
  background: var(--main-teal-hover);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(46, 196, 192, 0.3);
}

/* ========== REMINDER SETUP SCREEN ========== */
.reminder-title {
  font-size: 22px;
  font-weight: 800;
  color: var(--text-primary);
  text-align: center;
  margin-bottom: 32px;
  line-height: 1.4;
}

.reminder-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 20px;
}

.reminder-option-btn {
  width: 100%;
  background: var(--bg-card);
  color: var(--text-primary);
  border: 2px solid var(--border-light);
  padding: 16px;
  font-size: 16px;
  font-weight: 700;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.reminder-option-btn:hover {
  border-color: var(--main-teal);
  background: var(--main-teal-light);
}

.reminder-option-btn.selected {
  background: var(--main-teal);
  color: white;
  border-color: var(--main-teal);
}

.reminder-skip-btn {
  width: 100%;
  background: transparent;
  color: var(--text-secondary);
  border: none;
  padding: 12px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.reminder-skip-btn:hover {
  color: var(--main-teal);
  transform: none;
}

.reminder-confirm-btn {
  width: 100%;
  background: var(--main-teal);
  color: white;
  border: none;
  padding: 16px;
  font-size: 16px;
  font-weight: 700;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(46, 196, 192, 0.2);
  margin-bottom: 12px;
  display: none;
}

.reminder-confirm-btn.show {
  display: block;
}

.reminder-confirm-btn:hover {
  background: var(--main-teal-hover);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(46, 196, 192, 0.3);
}

</style>
</head>

<body>

<!-- Toast Notification -->
<div id="toast" class="toast">‚úì We'll remind you later</div>

<!-- ========== HOME SCREEN ========== -->
<div id="homeScreen" class="screen active">
  <div class="logo">KEESS</div>
  <div class="logo-subtitle">Check before you use</div>
  <button class="check-button" onclick="showScreen('add')">
    <div class="check-icon">‚úì</div>
    <div>Is this still safe?</div>
  </button>
  <button class="home-shelf-button" onclick="showScreen('shelf')">
    <span>View My Shelf</span>
    <span class="shelf-count" id="homeShelfCount"> ¬∑ 0 items</span>
  </button>
</div>

<!-- ========== ADD PRODUCT SCREEN ========== -->
<div id="addScreen" class="screen">
<div class="wrap">
<div class="header">
  <div class="header-title">
    <h2>Keep or Toss</h2>
  </div>
</div>

<!-- STICKY STATUS BAR -->
<div id="statusBar" class="status-bar" onclick="handleStatusBarClick()"></div>

<div class="card">
<div id="photoToOCRSection" class="form-section">
  <div class="photo-section-label">
    <span class="photo-section-label-main">Upload a photo</span>
    to auto-detect PAO
  </div>
  <div class="photo-buttons">
    <button onclick="document.getElementById('cameraInput').click()">
      <div class="photo-icon">üì∏</div>
      <div class="photo-label">Take a photo</div>
    </button>

    <button class="select-gallery-button" onclick="document.getElementById('galleryInput').click()">
      <div class="photo-icon">üñºÔ∏è</div>
      <div class="photo-label">Select from gallery</div>
    </button>
  </div>
  <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">
  <input type="file" id="galleryInput" accept="image/*" style="display:none;">
  <div class="file-name" id="fileName"></div>

  <img id="preview" style="display:none">
  <div id="status" class="status" style="display:none"></div>
</div>

<div id="paoSection" class="form-section">
  <label>Select a PAO period (tap to toggle)</label>
  <div class="pao" id="paoBtns"></div>
</div>

<div id="productNameSection" class="form-section">
  <label>Name it (optional)</label>
  <input type="text" id="productName" placeholder="Type a name so you recognize it later">
</div>

<div id="openingDateSection" class="form-section">
  <label>Opening Date</label>
  <div class="date-mode-toggle">
    <button id="exactBtn" class="active" onclick="setDateMode('exact')">Exact date</button>
    <button id="estimatedBtn" onclick="setDateMode('estimated')">Not sure</button>
  </div>

  <div class="date-selectors-wrapper">
    <div id="exactDateSelectors" class="date-selectors">
      <select id="yearSelect"></select>
      <select id="monthSelect"></select>
      <select id="daySelect"></select>
    </div>

    <div id="estimatedDateSelectors" class="date-selectors two-col estimated" style="display:none;">
      <select id="yearSelectEst"></select>
      <select id="monthSelectEst"></select>
    </div>
  </div>

  <div id="estimatedBadge" class="estimated-badge" style="display:none;">
    ESTIMATED
  </div>

  <div id="helperText" class="helper-text" style="display:none;">
    Opening date is estimated
  </div>
</div>

<div id="result" class="result" style="display:none"></div>
<div id="statusLabel" class="status-label" style="display:none"></div>

<button id="saveBtn" style="display:none">Save so I don't forget</button>

<button id="viewShelfBtn" class="view-shelf-button" onclick="showScreen('shelf')">
  <span>My Shelf</span>
  <span class="shelf-count" id="viewShelfCount"> ¬∑ 0 items</span>
</button>
</div>

<div class="card">
  <h3>What is PAO?</h3>
  <div class="info-block">
    <strong>Period After Opening (PAO)</strong> tells you how long a cosmetic product is safe to use after you open it.<br><br>
    For example, a <strong>6M</strong> symbol means the product should be used within 6 months after opening.<br>
    A <strong>12M</strong> symbol means 12 months.<br><br>
    You can usually find the PAO symbol on the packaging as an open jar icon with a number followed by "M".
  </div>
</div>

</div>
</div>

<!-- ========== SHELF SCREEN ========== -->
<div id="shelfScreen" class="screen">
<div class="wrap">
<div class="header">
  <h2>My Shelf</h2>
  <button class="back-button" onclick="showScreen('add')">‚Üê Home</button>
</div>
<div id="shelfSummary"></div>
<button id="selectAllBtn" class="select-all-btn" onclick="toggleSelectAll()">Select all</button>
<div id="shelfItems"></div>
<button id="deleteSelectedBtn" class="delete-selected-btn" onclick="deleteSelected()">Delete selected (0)</button>
<button id="cancelSelectionBtn" class="cancel-selection-btn" onclick="exitSelectionMode()">Cancel</button>
</div>
</div>

<!-- ========== TOSS WARNING SCREEN (UPDATED WITH MULTI-SELECT) ========== -->
<div id="tossWarningScreen" class="screen">
<div class="wrap">
<div class="header">
  <h2>Expired Products</h2>
  <button class="back-button" onclick="showScreen('shelf')">‚Üê Back</button>
</div>

<div class="card">
  <div class="toss-warning-message">
    <div class="toss-warning-icon">‚ö†Ô∏è</div>
    <div class="toss-warning-title">EXPIRED PRODUCT</div>
    <div class="toss-warning-subtitle">Bacteria risk increases after opening.</div>
  </div>
  
  <button class="toss-select-all-btn" id="tossSelectAllBtn" onclick="toggleTossSelectAll()">Select All</button>
  
  <div class="toss-products-list" id="tossProductsList"></div>
  
  <button class="toss-confirm-btn" onclick="confirmTossSelection()">Confirm</button>
</div>
</div>
</div>

<!-- ========== DISCARD CONFIRMATION SCREEN ========== -->
<div id="discardConfirmScreen" class="screen">
<div class="wrap">
<div class="header">
  <h2>Discarded</h2>
</div>

<div class="card">
  <div class="confirmation-icon">‚úì</div>
  <div class="confirmation-title" id="discardConfirmMessage">The selected products have been discarded.</div>
  
  <button class="confirmation-btn" onclick="confirmDiscard()">Return to Shelf</button>
</div>
</div>
</div>

<!-- ========== REMINDER SETUP SCREEN ========== -->
<div id="reminderSetupScreen" class="screen">
<div class="wrap">
<div class="header">
  <h2>Set Reminder</h2>
  <button class="back-button" onclick="showScreen('tossWarning')">‚Üê Back</button>
</div>

<div class="card">
  <div class="reminder-title">You chose to keep this product. Would you like a reminder when it expires?</div>
  
  <div class="reminder-options">
    <button class="reminder-option-btn" data-days="0" onclick="selectReminderOption(this, 0)">On expiry day</button>
    <button class="reminder-option-btn" data-days="1" onclick="selectReminderOption(this, 1)">1 day before</button>
    <button class="reminder-option-btn" data-days="3" onclick="selectReminderOption(this, 3)">3 days before</button>
    <button class="reminder-option-btn" data-days="7" onclick="selectReminderOption(this, 7)">1 week before</button>
  </div>
  
  <button class="reminder-confirm-btn" id="reminderConfirmBtn" onclick="confirmReminder()">Set Reminder</button>
  <button class="reminder-skip-btn" onclick="skipReminder()">Skip</button>
</div>
</div>
</div>

<script>
const SUPPORTED_PAOS = [3, 6, 12, 24];
const PAOS = [3, 6, 9, 12, 18, 24, 36];
const SHELF_STORAGE_KEY = "myShelf";
const PACIFIC_TZ = "America/Los_Angeles";
const GOOGLE_VISION_API_KEY = "AIzaSyAtwhPrHK5d_yLVkBfOc8tDjfk-2_cHDrw";

let selectedPAO = null;
let currentImageDataURL = null;
let lastStatus = null;
let ocrProcessed = false;
let dateMode = 'exact';
let currentScreen = 'home';
let selectionMode = false;
let editingItemId = null;
let currentTossItemId = null;
let selectedReminderDays = null;
let selectedTossItems = new Set();

const productName = document.getElementById("productName");
const paoBox = document.getElementById("paoBtns");
const result = document.getElementById("result");
const statusLabel = document.getElementById("statusLabel");
const preview = document.getElementById("preview");
const status = document.getElementById("status");
const fileName = document.getElementById("fileName");
const saveBtn = document.getElementById("saveBtn");
const shelfSummary = document.getElementById("shelfSummary");
const shelfItems = document.getElementById("shelfItems");
const toast = document.getElementById("toast");
const viewShelfBtn = document.getElementById("viewShelfBtn");
const viewShelfCount = document.getElementById("viewShelfCount");
const homeShelfCount = document.getElementById("homeShelfCount");
const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
const cancelSelectionBtn = document.getElementById("cancelSelectionBtn");
const selectAllBtn = document.getElementById("selectAllBtn");
const statusBar = document.getElementById("statusBar");
const tossProductsList = document.getElementById("tossProductsList");
const tossSelectAllBtn = document.getElementById("tossSelectAllBtn");
const reminderConfirmBtn = document.getElementById("reminderConfirmBtn");
const discardConfirmMessage = document.getElementById("discardConfirmMessage");

const exactBtn = document.getElementById("exactBtn");
const estimatedBtn = document.getElementById("estimatedBtn");
const exactDateSelectors = document.getElementById("exactDateSelectors");
const estimatedDateSelectors = document.getElementById("estimatedDateSelectors");
const helperText = document.getElementById("helperText");
const estimatedBadge = document.getElementById("estimatedBadge");

const yearSelect = document.getElementById("yearSelect");
const monthSelect = document.getElementById("monthSelect");
const daySelect = document.getElementById("daySelect");
const yearSelectEst = document.getElementById("yearSelectEst");
const monthSelectEst = document.getElementById("monthSelectEst");

function showToast(message = "‚úì We'll remind you later", isWarning = false) {
  toast.textContent = message;
  toast.classList.remove('hide', 'warning');
  if (isWarning) {
    toast.classList.add('warning');
  }
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
    toast.classList.add('hide');
  }, 1800);
}

function updateStatusBar() {
  const shelf = loadShelfFromStorage();
  
  if (shelf.length === 0) {
    statusBar.textContent = '';
    statusBar.className = 'status-bar';
    return;
  }
  
  const tossCount = shelf.filter(item => item.status === "TOSS").length;
  const useSoonCount = shelf.filter(item => item.status === "USE SOON").length;
  
  if (tossCount > 0) {
    statusBar.textContent = `üî¥ TOSS NOW ¬∑ ${tossCount} item${tossCount === 1 ? '' : 's'}`;
    statusBar.className = 'status-bar toss';
  } else if (useSoonCount > 0) {
    statusBar.textContent = `üü† USE SOON ¬∑ ${useSoonCount} item${useSoonCount === 1 ? '' : 's'}`;
    statusBar.className = 'status-bar use-soon';
  } else {
    statusBar.textContent = 'üü¢ ALL SAFE';
    statusBar.className = 'status-bar keep';
  }
}

function handleStatusBarClick() {
  const shelf = loadShelfFromStorage();
  const tossItems = shelf.filter(item => item.status === "TOSS");
  
  if (tossItems.length > 0) {
    showScreen('tossWarning');
  } else {
    showScreen('shelf');
  }
}

function renderTossProducts() {
  const shelf = loadShelfFromStorage();
  const tossItems = shelf.filter(item => item.status === "TOSS");
  
  if (tossItems.length === 0) {
    tossProductsList.innerHTML = '<div style="text-align:center;color:#9A9A9A;padding:20px;">No expired products</div>';
    return;
  }
  
  tossProductsList.innerHTML = tossItems.map(item => {
    const daysAgo = Math.abs(calculateDaysLeft(item.expiryDate));
    const displayName = item.name === "noname" ? "Product" : item.name;
    const isChecked = selectedTossItems.has(item.createdAt);
    
    // Use stored image or placeholder
    const thumbnailSrc = item.imageDataURL || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="60" height="60"%3E%3Crect width="60" height="60" fill="%23E5E5E5"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-size="24" fill="%239A9A9A"%3Eüì¶%3C/text%3E%3C/svg%3E';
    
    return `
      <div class="toss-product-item">
        <input 
          type="checkbox" 
          class="toss-product-checkbox" 
          data-id="${item.createdAt}"
          ${isChecked ? 'checked' : ''}
          onchange="toggleTossItem(${item.createdAt})"
        />
        <img src="${thumbnailSrc}" alt="${displayName}" class="toss-product-thumbnail" />
        <div class="toss-product-info">
          <div class="toss-product-name">${displayName}</div>
          <div class="toss-product-expired">Expired ${daysAgo} day${daysAgo === 1 ? '' : 's'} ago</div>
        </div>
      </div>
    `;
  }).join('');
  
  updateTossSelectAllButton();
}

function toggleTossItem(itemId) {
  if (selectedTossItems.has(itemId)) {
    selectedTossItems.delete(itemId);
  } else {
    selectedTossItems.add(itemId);
  }
  updateTossSelectAllButton();
}

function toggleTossSelectAll() {
  const shelf = loadShelfFromStorage();
  const tossItems = shelf.filter(item => item.status === "TOSS");
  
  const allSelected = tossItems.every(item => selectedTossItems.has(item.createdAt));
  
  if (allSelected) {
    // Deselect all
    selectedTossItems.clear();
  } else {
    // Select all
    tossItems.forEach(item => {
      selectedTossItems.add(item.createdAt);
    });
  }
  
  renderTossProducts();
}

function updateTossSelectAllButton() {
  const shelf = loadShelfFromStorage();
  const tossItems = shelf.filter(item => item.status === "TOSS");
  
  if (tossItems.length === 0) return;
  
  const allSelected = tossItems.every(item => selectedTossItems.has(item.createdAt));
  
  if (allSelected) {
    tossSelectAllBtn.textContent = "Deselect All";
  } else {
    tossSelectAllBtn.textContent = "Select All";
  }
}

function confirmTossSelection() {
  if (selectedTossItems.size === 0) {
    // If nothing selected, just go back to shelf
    showScreen('shelf');
    return;
  }
  
  // Show confirmation message
  const count = selectedTossItems.size;
  if (count === 1) {
    discardConfirmMessage.textContent = "The selected product has been discarded.";
  } else {
    discardConfirmMessage.textContent = `${count} products have been discarded.`;
  }
  
  showScreen('discardConfirm');
}

function showScreen(screen) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  
  if (screen === 'home') {
    document.getElementById('homeScreen').classList.add('active');
    currentScreen = 'home';
    updateViewShelfButtonText();
  } else if (screen === 'add') {
    document.getElementById('addScreen').classList.add('active');
    currentScreen = 'add';
    updateViewShelfButtonText();
    updateStatusBar();
  } else if (screen === 'shelf') {
    document.getElementById('shelfScreen').classList.add('active');
    currentScreen = 'shelf';
    exitSelectionMode();
    editingItemId = null;
    renderShelf();
  } else if (screen === 'tossWarning') {
    document.getElementById('tossWarningScreen').classList.add('active');
    currentScreen = 'tossWarning';
    selectedTossItems.clear();
    renderTossProducts();
  } else if (screen === 'discardConfirm') {
    document.getElementById('discardConfirmScreen').classList.add('active');
    currentScreen = 'discardConfirm';
  } else if (screen === 'reminderSetup') {
    document.getElementById('reminderSetupScreen').classList.add('active');
    currentScreen = 'reminderSetup';
    selectedReminderDays = null;
    reminderConfirmBtn.classList.remove('show');
    document.querySelectorAll('.reminder-option-btn').forEach(btn => {
      btn.classList.remove('selected');
    });
  }
}

function showTossWarning(itemId) {
  showScreen('tossWarning');
}

function showDiscardConfirmation() {
  showScreen('discardConfirm');
}

function confirmDiscard() {
  // Delete selected items
  const shelf = loadShelfFromStorage();
  const updatedShelf = shelf.filter(item => !selectedTossItems.has(item.createdAt));
  saveShelfToStorage(updatedShelf);
  
  selectedTossItems.clear();
  showScreen('shelf');
  updateViewShelfButtonText();
  updateStatusBar();
}

function showReminderSetup() {
  showScreen('reminderSetup');
}

function selectReminderOption(button, days) {
  selectedReminderDays = days;
  
  document.querySelectorAll('.reminder-option-btn').forEach(btn => {
    btn.classList.remove('selected');
  });
  
  button.classList.add('selected');
  reminderConfirmBtn.classList.add('show');
}

function confirmReminder() {
  if (selectedReminderDays === null) {
    alert('Please select a reminder option');
    return;
  }
  
  showToast('‚úì Reminder set! You\'ll be notified before expiration.');
  
  setTimeout(() => {
    currentTossItemId = null;
    showScreen('shelf');
  }, 1800);
}

function skipReminder() {
  showToast('‚úì Product added to your shelf.');
  
  setTimeout(() => {
    currentTossItemId = null;
    showScreen('shelf');
  }, 1800);
}

function updateViewShelfButtonText() {
  const shelf = loadShelfFromStorage();
  const totalCount = shelf.length;
  
  viewShelfCount.textContent = ` ¬∑ ${totalCount} item${totalCount === 1 ? '' : 's'}`;
  homeShelfCount.textContent = ` ¬∑ ${totalCount} item${totalCount === 1 ? '' : 's'}`;
}

function getPacificMidnight(dateStr) {
  const dateObj = new Date(dateStr + "T00:00:00");
  const pacificDateStr = dateObj.toLocaleString("en-US", { timeZone: PACIFIC_TZ });
  const pacificDate = new Date(pacificDateStr);
  pacificDate.setHours(0, 0, 0, 0);
  return pacificDate;
}

function getTodayPacific() {
  const now = new Date();
  const pacificNowStr = now.toLocaleString("en-US", { timeZone: PACIFIC_TZ });
  const pacificNow = new Date(pacificNowStr);
  pacificNow.setHours(0, 0, 0, 0);
  return pacificNow;
}

function initDateSelectors() {
  const todayPacific = getTodayPacific();
  const currentYear = todayPacific.getFullYear();
  const currentMonth = todayPacific.getMonth() + 1;
  const currentDay = todayPacific.getDate();
  
  for (let y = currentYear; y >= currentYear - 5; y--) {
    yearSelect.add(new Option(y, y));
    yearSelectEst.add(new Option(y, y));
  }
  
  for (let m = 1; m <= 12; m++) {
    const monthName = new Date(2000, m - 1, 1).toLocaleString('en', { month: 'long' });
    monthSelect.add(new Option(monthName, m));
    monthSelectEst.add(new Option(monthName, m));
  }
  
  yearSelect.value = currentYear;
  monthSelect.value = currentMonth;
  yearSelectEst.value = currentYear;
  monthSelectEst.value = currentMonth;
  
  updateDayOptions();
  daySelect.value = currentDay;
}

function getDaysInMonth(year, month) {
  return new Date(year, month, 0).getDate();
}

function updateDayOptions() {
  const year = parseInt(yearSelect.value);
  const month = parseInt(monthSelect.value);
  const daysInMonth = getDaysInMonth(year, month);
  const currentDay = daySelect.value || 1;
  
  daySelect.innerHTML = '';
  for (let d = 1; d <= daysInMonth; d++) {
    daySelect.add(new Option(d, d));
  }
  
  if (currentDay <= daysInMonth) {
    daySelect.value = currentDay;
  } else {
    daySelect.value = daysInMonth;
  }
}

yearSelect.onchange = () => { updateDayOptions(); updateResult(); };
monthSelect.onchange = () => { updateDayOptions(); updateResult(); };
daySelect.onchange = updateResult;
yearSelectEst.onchange = updateResult;
monthSelectEst.onchange = updateResult;

function setDateMode(mode) {
  dateMode = mode;
  
  if (mode === 'exact') {
    exactBtn.classList.add('active');
    estimatedBtn.classList.remove('active');
    exactDateSelectors.style.display = 'grid';
    estimatedDateSelectors.style.display = 'none';
    helperText.style.display = 'none';
    estimatedBadge.style.display = 'none';
  } else {
    exactBtn.classList.remove('active');
    estimatedBtn.classList.add('active');
    exactDateSelectors.style.display = 'none';
    estimatedDateSelectors.style.display = 'grid';
    helperText.style.display = 'block';
    estimatedBadge.style.display = 'inline-block';
  }
  
  updateResult();
}

function getOpeningDate() {
  if (dateMode === 'exact') {
    const year = yearSelect.value;
    const month = String(monthSelect.value).padStart(2, '0');
    const day = String(daySelect.value).padStart(2, '0');
    return `${year}-${month}-${day}`;
  } else {
    const year = yearSelectEst.value;
    const month = String(monthSelectEst.value).padStart(2, '0');
    return `${year}-${month}-01`;
  }
}

// PAO BUTTON TOGGLE BEHAVIOR
SUPPORTED_PAOS.forEach(m => {
  const b = document.createElement("button");
  b.textContent = m + "M";
  b.onclick = () => { 
    togglePAO(m); 
    updateResult(); 
  };
  paoBox.appendChild(b);
});

function togglePAO(m) {
  if (selectedPAO === m) {
    selectedPAO = null;
    [...paoBox.children].forEach(b => b.classList.remove("active"));
  } else {
    selectedPAO = m;
    [...paoBox.children].forEach(b => {
      b.classList.toggle("active", b.textContent === m + "M");
    });
  }
}

function selectPAO(m) {
  selectedPAO = m;
  [...paoBox.children].forEach(b => {
    b.classList.toggle("active", b.textContent === m + "M");
  });
}

function addMonths(d, m) {
  const [y, mo, da] = d.split("-").map(Number);
  const dt = new Date(y, mo - 1, da);
  dt.setMonth(dt.getMonth() + m);
  dt.setHours(0, 0, 0, 0);
  
  const year = dt.getFullYear();
  const month = String(dt.getMonth() + 1).padStart(2, '0');
  const day = String(dt.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function calculateDaysLeft(expiryDateStr) {
  const todayPacific = getTodayPacific();
  const expiryPacific = getPacificMidnight(expiryDateStr);
  
  const daysLeft = Math.ceil((expiryPacific - todayPacific) / (1000 * 60 * 60 * 24));
  
  return daysLeft;
}

function formatTimeLeft(daysLeft, status) {
  if (status === 'TOSS') {
    const daysAgo = Math.abs(daysLeft);
    return `Expired ${daysAgo} day${daysAgo === 1 ? '' : 's'} ago`;
  } else if (status === 'USE SOON') {
    return `Expires in ${daysLeft} day${daysLeft === 1 ? '' : 's'}`;
  } else {
    if (daysLeft >= 90) {
      const months = Math.floor(daysLeft / 30);
      return `Safe for ${months} month${months === 1 ? '' : 's'}`;
    } else {
      return `Safe for ${daysLeft} day${daysLeft === 1 ? '' : 's'}`;
    }
  }
}

function updateResult() {
  if (!selectedPAO) { 
    result.innerHTML = "";
    result.style.display = "none";
    statusLabel.style.display = "none";
    saveBtn.style.display = "none";
    lastStatus = null;
    return; 
  }
  
  result.style.display = "block";
  
  const openingDate = getOpeningDate();
  const expiryDateStr = addMonths(openingDate, selectedPAO);
  
  const daysLeft = calculateDaysLeft(expiryDateStr);
  
  let statusText = "";
  let statusColor = "";
  let resultMessage = "";
  
  if (daysLeft < 0) {
    statusText = "TOSS";
    statusColor = "#FF2B5B";
    resultMessage = '<span style="color: #FF2B5B;">üóëÔ∏è</span> This product should be thrown away';
  } else if (daysLeft <= 60) {
    statusText = "USE SOON";
    statusColor = "#F59E0B";
    resultMessage = '<span style="color: #F59E0B;">‚ö†Ô∏è</span> Expiring soon ‚Äî ' + daysLeft + ' days left';
  } else {
    statusText = "KEEP";
    statusColor = "#10B981";
    resultMessage = '<span style="color: #10B981;">‚úÖ</span> Safe (for now)';
  }
  
  if (dateMode === 'estimated') {
    result.innerHTML = resultMessage + '<div class="result-estimated-note">Opening date is estimated</div>';
  } else {
    result.innerHTML = resultMessage;
  }
  
  if (statusText !== lastStatus) {
    lastStatus = statusText;
  }
  
  statusLabel.textContent = statusText;
  statusLabel.style.background = statusColor;
  statusLabel.style.display = "block";

  saveBtn.style.display = "block";
}

function extractPAO(text) {
  console.log("Detected text:", text);
  
  const versions = [
    text,
    text.toUpperCase(),
    text.replace(/\s+/g, ''),
    text.replace(/[^a-zA-Z0-9]/g, ' '),
  ];
  
  const patterns = [
    /(\d{1,2})\s*M\b/gi,
    /(\d{1,2})M/gi,
    /M\s*(\d{1,2})/gi,
  ];
  
  for (let ver of versions) {
    for (let pattern of patterns) {
      pattern.lastIndex = 0;
      let match;
      while ((match = pattern.exec(ver)) !== null) {
        const num = parseInt(match[1]);
        if (PAOS.includes(num)) {
          console.log("‚úì Found PAO:", num);
          return num;
        }
      }
    }
  }
  
  const numbers = text.match(/\d+/g);
  if (numbers) {
    for (let numStr of numbers) {
      const num = parseInt(numStr);
      if (PAOS.includes(num)) {
        const idx = text.indexOf(numStr);
        const context = text.substring(Math.max(0, idx - 2), Math.min(text.length, idx + numStr.length + 2));
        if (/m/i.test(context)) {
          console.log("‚úì Found PAO by context:", num);
          return num;
        }
      }
    }
  }
  
  return null;
}

async function detectWithGoogle(base64Image) {
  const base64Content = base64Image.split(',')[1];
  
  const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      requests: [
        {
          image: {
            content: base64Content
          },
          features: [
            {
              type: 'TEXT_DETECTION',
              maxResults: 10
            }
          ]
        }
      ]
    })
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error?.message || `API error: ${response.status}`);
  }
  
  const data = await response.json();
  
  console.log("Google Vision response:", data);
  
  const textAnnotations = data.responses[0]?.textAnnotations;
  
  if (!textAnnotations || textAnnotations.length === 0) {
    return null;
  }
  
  const fullText = textAnnotations[0].description;
  
  return extractPAO(fullText);
}

async function handleFileSelect(e) {
  const file = e.target.files[0];
  if (!file) return;

  ocrProcessed = false;

  fileName.textContent = file.name;
  
  const reader = new FileReader();
  
  reader.onload = async (event) => {
    const base64 = event.target.result;
    currentImageDataURL = base64;
    
    preview.src = base64;
    preview.style.display = "block";

    if (ocrProcessed) {
      console.log("This image was already OCR processed. Skipping...");
      return;
    }

    ocrProcessed = true;

    preview.onload = async () => {
      status.style.display = "block";
      status.style.background = "#FEF3C7";
      status.style.color = "#F59E0B";
      status.textContent = "üîç Analyzing with Google Vision...";

      try {
        const pao = await detectWithGoogle(base64);
        
        if (pao && SUPPORTED_PAOS.includes(pao)) {
          selectPAO(pao);
          updateResult();
          status.style.background = "#D1FAE5";
          status.style.color = "#10B981";
          status.textContent = `‚úì Detected: ${pao}M (tap to deselect)`;
        } else if (pao) {
          status.style.background = "#FEF3C7";
          status.style.color = "#F59E0B";
          status.textContent = `‚ö†Ô∏è Detected ${pao}M but not supported. Select manually ‚Üì`;
        } else {
          status.style.background = "#FFE8EE";
          status.style.color = "#FF2B5B";
          status.textContent = "‚ùå Could not detect PAO. Select manually ‚Üì";
        }
        
      } catch (err) {
        console.error(err);
        status.style.background = "#FFE8EE";
        status.style.color = "#FF2B5B";
        status.textContent = "‚ö†Ô∏è Error: " + err.message;
      }
    };
  };
  
  reader.readAsDataURL(file);
}

document.getElementById("cameraInput").onchange = handleFileSelect;
document.getElementById("galleryInput").onchange = handleFileSelect;

function loadShelfFromStorage() {
  try {
    const stored = localStorage.getItem(SHELF_STORAGE_KEY);
    if (!stored) {
      console.log("No shelf data - initializing empty shelf");
      return [];
    }
    const parsed = JSON.parse(stored);
    console.log("Loaded shelf data:", parsed.length, "items");
    return Array.isArray(parsed) ? parsed : [];
  } catch (err) {
    console.error("Shelf load error:", err);
    return [];
  }
}

function saveShelfToStorage(shelf) {
  try {
    localStorage.setItem(SHELF_STORAGE_KEY, JSON.stringify(shelf));
    console.log("Saved shelf data:", shelf.length, "items");
    return true;
  } catch (err) {
    console.error("Shelf save error:", err);
    alert("‚ö†Ô∏è Save failed: " + err.message);
    return false;
  }
}

function computeStatusFromExpiry(expiryDate) {
  const daysLeft = calculateDaysLeft(expiryDate);
  
  if (daysLeft < 0) {
    return "TOSS";
  } else if (daysLeft <= 60) {
    return "USE SOON";
  } else {
    return "KEEP";
  }
}

function refreshAllStatuses() {
  const shelf = loadShelfFromStorage();
  let updated = false;
  
  shelf.forEach(item => {
    const newStatus = computeStatusFromExpiry(item.expiryDate);
    if (item.status !== newStatus) {
      item.status = newStatus;
      updated = true;
    }
  });
  
  if (updated) {
    saveShelfToStorage(shelf);
    console.log("‚úì Statuses refreshed and saved");
  }
  
  return shelf;
}

saveBtn.onclick = () => {
  if (!selectedPAO) {
    alert("‚ö†Ô∏è First select a PAO period");
    return;
  }

  const openingDate = getOpeningDate();
  const expiryDate = addMonths(openingDate, selectedPAO);
  const itemStatus = computeStatusFromExpiry(expiryDate);

  const name = productName.value.trim() || "noname";

  const item = {
    name: name,
    pao: selectedPAO + "M",
    openingDate: openingDate,
    expiryDate: expiryDate,
    status: itemStatus,
    isEstimated: dateMode === 'estimated',
    imageDataURL: currentImageDataURL,
    createdAt: Date.now()
  };

  const shelf = loadShelfFromStorage();
  shelf.push(item);
  
  const saveSuccess = saveShelfToStorage(shelf);
  
  if (saveSuccess) {
    showToast();
    updateViewShelfButtonText();
    updateStatusBar();
    productName.value = "";
    console.log("‚úì Item saved. User remains on add screen.");
  }
};

function getStatusPriority(status) {
  const priorities = {
    "TOSS": 1,
    "USE SOON": 2,
    "KEEP": 3
  };
  return priorities[status] || 999;
}

function updateDeleteButtonText() {
  const checkedBoxes = document.querySelectorAll('.shelf-item-checkbox:checked');
  const count = checkedBoxes.length;
  deleteSelectedBtn.textContent = `Delete selected (${count})`;
  
  const totalCheckboxes = document.querySelectorAll('.shelf-item-checkbox');
  if (count === totalCheckboxes.length && totalCheckboxes.length > 0) {
    selectAllBtn.textContent = "Deselect all";
  } else {
    selectAllBtn.textContent = "Select all";
  }
}

function toggleSelectAll() {
  const allCheckboxes = document.querySelectorAll('.shelf-item-checkbox');
  const checkedBoxes = document.querySelectorAll('.shelf-item-checkbox:checked');
  
  const shouldSelectAll = checkedBoxes.length < allCheckboxes.length;
  
  allCheckboxes.forEach(checkbox => {
    checkbox.checked = shouldSelectAll;
  });
  
  updateDeleteButtonText();
}

function enterSelectionMode() {
  selectionMode = true;
  document.querySelectorAll('.shelf-item').forEach(item => {
    item.classList.add('selection-mode');
  });
  deleteSelectedBtn.classList.add('show');
  cancelSelectionBtn.classList.add('show');
  selectAllBtn.classList.add('show');
  updateDeleteButtonText();
}

function exitSelectionMode() {
  selectionMode = false;
  document.querySelectorAll('.shelf-item').forEach(item => {
    item.classList.remove('selection-mode');
    const checkbox = item.querySelector('.shelf-item-checkbox');
    if (checkbox) {
      checkbox.checked = false;
    }
  });
  deleteSelectedBtn.classList.remove('show');
  cancelSelectionBtn.classList.remove('show');
  selectAllBtn.classList.remove('show');
}

function deleteSelected() {
  const checkedBoxes = document.querySelectorAll('.shelf-item-checkbox:checked');
  
  if (checkedBoxes.length === 0) {
    alert("‚ö†Ô∏è Please select at least one item to delete");
    return;
  }
  
  if (!confirm(`Delete ${checkedBoxes.length} item(s)?`)) {
    return;
  }
  
  const idsToDelete = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.id));
  
  const shelf = loadShelfFromStorage();
  const updatedShelf = shelf.filter(item => !idsToDelete.includes(item.createdAt));
  saveShelfToStorage(updatedShelf);
  
  exitSelectionMode();
  renderShelf();
  updateViewShelfButtonText();
  updateStatusBar();
}

function formatOpeningDate(dateStr, isEstimated) {
  if (isEstimated) {
    const [year, month] = dateStr.split('-');
    const monthName = new Date(year, parseInt(month) - 1, 1).toLocaleString('en', { month: 'short' });
    return `${monthName} ${year}`;
  } else {
    return dateStr;
  }
}

function startEditingName(itemId) {
  editingItemId = itemId;
  renderShelf();
  
  setTimeout(() => {
    const input = document.querySelector(`#edit-input-${itemId}`);
    if (input) {
      input.focus();
      input.select();
    }
  }, 10);
}

function confirmEditName(itemId) {
  const input = document.querySelector(`#edit-input-${itemId}`);
  if (!input) return;
  
  const newName = input.value.trim() || "noname";
  
  const shelf = loadShelfFromStorage();
  const item = shelf.find(item => item.createdAt === itemId);
  if (item) {
    item.name = newName;
    saveShelfToStorage(shelf);
  }
  
  editingItemId = null;
  renderShelf();
}

function cancelEditName() {
  editingItemId = null;
  renderShelf();
}

function renderShelf() {
  const shelf = refreshAllStatuses();
  
  if (shelf.length === 0) {
    shelfSummary.innerHTML = '';
    shelfItems.innerHTML = '<div style="text-align:center;color:#9A9A9A;padding:20px;">No items in your shelf yet. Add your first product!</div>';
    return;
  }
  
  const tossCount = shelf.filter(item => item.status === "TOSS").length;
  const useSoonCount = shelf.filter(item => item.status === "USE SOON").length;
  const keepCount = shelf.filter(item => item.status === "KEEP").length;
  
  let summaryHTML = '<div class="shelf-summary">';
  summaryHTML += `<div class="shelf-summary-line">Total ${shelf.length} items</div>`;
  summaryHTML += `<div class="shelf-summary-line"><span style="color:#FF2B5B">üóëÔ∏è ${tossCount} toss</span> ¬∑ <span style="color:#F59E0B">‚ö†Ô∏è ${useSoonCount} use soon</span> ¬∑ <span style="color:#10B981">‚úÖ ${keepCount} safe</span></div>`;
  summaryHTML += '</div>';
  
  shelfSummary.innerHTML = summaryHTML;
  
  const itemsWithStatus = shelf.map(item => {
    if (!item.createdAt) {
      item.createdAt = Date.now() + Math.random();
    }
    
    if (!item.name) {
      item.name = "noname";
    }
    
    return {
      ...item,
      displayStatus: item.status
    };
  });
  
  itemsWithStatus.sort((a, b) => {
    return getStatusPriority(a.displayStatus) - getStatusPriority(b.displayStatus);
  });
  
  shelfItems.innerHTML = itemsWithStatus.map(item => {
    const itemStatus = item.displayStatus;
    const daysLeft = calculateDaysLeft(item.expiryDate);
    const timeLeftText = formatTimeLeft(daysLeft, itemStatus);
    
    let statusColor = "";
    let timeLeftClass = "";
    let statusClickHandler = "";
    
    if (itemStatus === "TOSS") {
      statusColor = "#FF2B5B";
      timeLeftClass = "toss";
      statusClickHandler = `onclick="showTossWarning(${item.createdAt})" style="cursor:pointer;"`;
    } else if (itemStatus === "USE SOON") {
      statusColor = "#F59E0B";
      timeLeftClass = "use-soon";
    } else {
      statusColor = "#10B981";
      timeLeftClass = "keep";
    }
    
    const openingDateDisplay = formatOpeningDate(item.openingDate, item.isEstimated || false);
    const estimatedBadge = (item.isEstimated || false) ? '<span class="shelf-item-estimated-badge">Estimated</span>' : '';
    
    const isEditing = editingItemId === item.createdAt;
    const displayName = item.name === "noname" ? "" : item.name;
    
    let nameHTML;
    if (isEditing) {
      nameHTML = `
        <div class="shelf-item-name-edit-wrapper">
          <input 
            type="text" 
            id="edit-input-${item.createdAt}" 
            class="shelf-item-name-edit-input" 
            value="${displayName}"
            placeholder="Product name"
          />
          <button class="shelf-item-name-edit-btn confirm" onclick="confirmEditName(${item.createdAt})">‚úì</button>
          <button class="shelf-item-name-edit-btn cancel" onclick="cancelEditName()">‚úï</button>
        </div>
      `;
    } else {
      nameHTML = `<div class="shelf-item-name clickable" onclick="startEditingName(${item.createdAt})">${item.name}</div>`;
    }
    
    return `
      <div class="shelf-item ${selectionMode ? 'selection-mode' : ''}">
        <input type="checkbox" class="shelf-item-checkbox" data-id="${item.createdAt}" onchange="updateDeleteButtonText()">
        <button class="delete-btn" onclick="enterSelectionMode(); setTimeout(() => { document.querySelector('[data-id=\\'${item.createdAt}\\']').checked = true; updateDeleteButtonText(); }, 10);">√ó</button>
        <div class="shelf-item-content">
          ${nameHTML}
          <div class="shelf-item-meta">${item.pao} ¬∑ Expires ${item.expiryDate}</div>
          <div class="shelf-item-dates">Opened: ${openingDateDisplay}${estimatedBadge}</div>
          <div class="shelf-item-time-left ${timeLeftClass}">${timeLeftText}</div>
        </div>
        <div class="shelf-item-status" style="background: ${statusColor};" ${statusClickHandler}>
          ${itemStatus}
        </div>
      </div>
    `;
  }).join('');
}

initDateSelectors();
updateViewShelfButtonText();
updateStatusBar();
</script>

</body>
</html>