<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Keep or Toss</title>

  <style>
    body{margin:0;background:#0b0c10;color:#e8e8ea;font-family:system-ui}
    .wrap{max-width:420px;margin:0 auto;padding:16px}
    .card{background:#111318;border-radius:16px;padding:14px}
    img{width:100%;border-radius:12px;margin-top:10px}
    .pao{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
    button{padding:10px;border-radius:10px;border:none;background:#1f2430;color:#fff;font-weight:700}
    button.active{outline:2px solid #20c997}
    .result{margin-top:12px;font-weight:800}
    .ok{color:#20c997}.warn{color:#ffcc00}.err{color:#ff4d4f}
    input[type="date"]{width:100%;margin-top:10px;padding:8px;border-radius:8px;border:none}
  </style>
</head>

<body>
<div class="wrap">
  <h2>Keep or Toss</h2>

  <div class="card">
    <input type="file" id="fileInput" accept="image/*">
    <img id="preview" style="display:none">

    <input type="date" id="opened">
    <div class="pao" id="paoBtns"></div>
    <div id="result" class="result"></div>
  </div>
</div>

<script>
/* ===== 설정 ===== */
const PAOS = [3,6,9,12,18,24,36];
const OCR_ENDPOINT = "https://pao-ocr-worker.ohryee.workers.dev/ocr-meta";

/* ===== 상태 ===== */
let selectedPAO = null;

/* ===== DOM ===== */
const openedInput = document.getElementById("opened");
const paoBox = document.getElementById("paoBtns");
const result = document.getElementById("result");
const preview = document.getElementById("preview");

/* ===== 초기값 ===== */
openedInput.value = new Date().toISOString().slice(0,10);

/* ===== PAO 버튼 ===== */
PAOS.forEach(m=>{
  const b=document.createElement("button");
  b.textContent=m+"M";
  b.onclick=()=>{ selectPAO(m); updateResult(); };
  paoBox.appendChild(b);
});

function selectPAO(m){
  selectedPAO = m;
  [...paoBox.children].forEach(b=>{
    b.classList.toggle("active", b.textContent === m+"M");
  });
}

/* ===== 계산 ===== */
function addMonths(dateStr,months){
  const [y,m,d]=dateStr.split("-").map(Number);
  const dt=new Date(y,m-1,d);
  dt.setMonth(dt.getMonth()+months);
  return dt;
}

function updateResult(){
  if(!openedInput.value || !selectedPAO){
    result.textContent = "";
    return;
  }

  const tossDate = addMonths(openedInput.value, selectedPAO);
  const daysLeft = Math.floor((tossDate - new Date()) / 86400000);

  let cls="ok", txt="SAFE TO USE";
  if(daysLeft < 0){ cls="err"; txt="TOSS IT"; }
  else if(daysLeft <= 30){ cls="warn"; txt="USE SOON"; }

  result.className = "result " + cls;
  result.textContent =
    `${txt} · ${selectedPAO}M · Toss at ${tossDate.toISOString().slice(0,10)}`;
}

openedInput.onchange = updateResult;

/* ===== OCR (핵심) ===== */
document.getElementById("fileInput").onchange = async e => {
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = async () => {
    preview.src = reader.result;
    preview.style.display = "block";

    const base64 = reader.result.split(",")[1];

    const res = await fetch(OCR_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ imageBase64: base64 })
    });

    const json = await res.json();

    // ✅ 여기 중요
    if (json.ok && json.paoCandidates && json.paoCandidates.length > 0) {
      selectPAO(json.paoCandidates[0]);
      updateResult();
    }
  };
  reader.readAsDataURL(file);
};
</script>
</body>
</html>
