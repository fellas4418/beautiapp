<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Keep or Toss</title>
  <meta name="theme-color" content="#0b0c10" />
  <style>
    :root{
      --bg:#0b0c10;
      --card:#111318;
      --text:#e8e8ea;
      --muted:#a8abb4;
      --border:rgba(255,255,255,.10);
      --btn:#2b6cff;
      --btn2:#1f2430;
      --danger:#ff4d4f;
      --ok:#20c997;
      --warn:#ffcc00;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    .wrap{ max-width: 860px; margin: 0 auto; padding: 16px; padding-bottom: 60px; }
    .header{ padding: 10px 2px 6px; }
    .title{ margin:0; font-size: 26px; line-height: 1.2; letter-spacing: -0.2px; }
    .sub{ margin: 8px 0 0; color: var(--muted); font-size: 14px; line-height: 1.5; }

    .card{
      margin-top: 14px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      position: relative;
    }

    .fileInput{
      position: fixed;
      left: 0;
      top: 0;
      width: 1px;
      height: 1px;
      opacity: 0;
      pointer-events: none;
    }

    .row{ display:flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }

    .btn{
      border-radius: 12px;
      padding: 14px 14px;
      font-size: 15px;
      font-weight: 900;
      min-height: 48px;
      background: var(--btn2);
      color: var(--text);
      border: 1px solid var(--border);
      flex: 1 1 160px;
      text-align:center;
      user-select:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .dateRow{ display:flex; gap:10px; flex-wrap: wrap; margin-top: 12px; }
    .sel{
      flex: 1 1 100%;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 12px;
      color: var(--text);
      font-size: 14px;
    }
    .sel label{ display:block; color: var(--muted); font-size: 12px; margin-bottom: 6px; }
    .dateInput{
      width:100%;
      background: transparent;
      color: var(--text);
      border: 0;
      outline: none;
      font-size: 15px;
      font-weight: 900;
    }
    .dowLine{
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
    }

    .panel{
      margin-top: 14px;
      padding: 12px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      position: relative;
    }
    #imgWrap{ display:none; }
    #imgPreview{ max-width:100%; border-radius:12px; display:block; }
    .footer{ margin-top: 8px; color: var(--muted); font-size: 12px; line-height: 1.5; text-align:center; }

    .overlay{
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(0,0,0,.45);
      border-radius: 12px;
      pointer-events: none;
    }
    .overlay.show{ display:flex; }
    .spinner{
      width: 32px; height: 32px;
      border: 4px solid rgba(255,255,255,.18);
      border-top-color: rgba(255,204,0,.95);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    .statusLine{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(17,19,24,.95);
      border: 1px solid var(--border);
      font-size: 14px;
      line-height: 1.45;
      color: var(--muted);
      display:none;
      white-space: pre-wrap;
    }
    .statusLine.show{ display:block; }
    .statusLine.ok{ color: var(--ok); border-color: rgba(32,201,151,.55); background: rgba(32,201,151,.10); }
    .statusLine.warn{ color: var(--warn); border-color: rgba(255,204,0,.55); background: rgba(255,204,0,.10); }
    .statusLine.err{ color: var(--danger); border-color: rgba(255,77,79,.55); background: rgba(255,77,79,.10); }

    .paoTitle{ margin-top: 14px; color: rgba(232,232,234,.72); font-size: 13px; }
    .paoGrid{ margin-top: 10px; display:grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .paoBtn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius: 12px;
      padding: 14px 0;
      font-size: 14px;
      font-weight: 1000;
      cursor:pointer;
      touch-action: manipulation;
    }
    .paoBtn.active{
      border-color: rgba(32,201,151,.9);
      box-shadow: 0 0 0 2px rgba(32,201,151,.18) inset;
    }

    .resultMain{
      margin-top: 14px;
      border-radius: 14px;
      padding: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      display:none;
    }
    .resultMain.show{ display:block; }

    .bigStatus{
      font-size: 24px;
      font-weight: 1100;
      letter-spacing: .6px;
      padding: 14px;
      border-radius: 12px;
      text-align:center;
      border: 1px solid var(--border);
      background: rgba(17,19,24,.75);
    }
    .bigStatus.ok{ color: var(--ok); border-color: rgba(32,201,151,.55); background: rgba(32,201,151,.10); }
    .bigStatus.err{ color: var(--danger); border-color: rgba(255,77,79,.55); background: rgba(255,77,79,.10); }
    .bigStatus.warn{ color: var(--warn); border-color: rgba(255,204,0,.55); background: rgba(255,204,0,.10); }

    .metaGrid{ display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px; }
    .metaBox{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 12px;
      padding: 12px;
      text-align:center;
    }
    .metaLabel{ color: var(--muted); font-size: 12px; margin-bottom: 6px; }
    .metaVal{ font-size: 26px; font-weight: 1100; letter-spacing: .3px; }

    .shelfCard{
      margin-top: 14px;
      background: rgba(255,255,255,.02);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
    }
    .shelfTop{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }
    .shelfTitle{
      font-size: 18px;
      font-weight: 1000;
      margin: 0;
    }
    .countPill{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      padding: 8px 10px;
      color: var(--muted);
      font-size: 13px;
    }
    .shelfControls{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
      align-items: center;
    }
    .input{
      flex: 1 1 260px;
      min-width: 220px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      padding: 14px 12px;
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    .item{
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.02);
      padding: 12px;
      display:flex;
      gap: 10px;
      align-items: flex-start;
      justify-content: space-between;
    }
    .itemLeft{ flex: 1 1 auto; min-width: 0; }
    .itemName{
      font-weight: 1000;
      margin: 0;
      font-size: 15px;
    }
    .badgeRow{
      margin-top: 8px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 1000;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }
    .badge.ok{ color: var(--ok); border-color: rgba(32,201,151,.55); background: rgba(32,201,151,.08); }
    .badge.warn{ color: var(--warn); border-color: rgba(255,204,0,.55); background: rgba(255,204,0,.08); }
    .badge.err{ color: var(--danger); border-color: rgba(255,77,79,.55); background: rgba(255,77,79,.08); }

    .itemMeta{
      margin-top: 8px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }
    .miniBtn{
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 1000;
      background: var(--btn2);
      color: var(--text);
      border: 1px solid var(--border);
      cursor:pointer;
      white-space: nowrap;
      touch-action: manipulation;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(17,19,24,.95);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 14px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
      max-width: 92vw;
      text-align: center;
    }
    .toast.show{ opacity: 1; }

    @media (max-width: 520px){
      .title{ font-size: 22px; }
      .metaGrid{ grid-template-columns: 1fr; }
      .paoGrid{ grid-template-columns: repeat(3, 1fr); }
      .metaVal{ font-size: 26px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <h1 class="title">Keep or Toss</h1>
      <p class="sub">Take a photo if you want auto-detect. Or tap a PAO button to calculate right away.</p>
    </div>

    <div class="card">
      <input id="imageCamera" class="fileInput" type="file" accept="image/*" capture="environment" />
      <input id="imageGallery" class="fileInput" type="file" accept="image/*" />

      <div class="row">
        <label class="btn" for="imageCamera">Take Photo</label>
        <label class="btn" for="imageGallery">Upload Photo</label>
      </div>

      <div class="dateRow">
        <div class="sel">
          <label>Opened date</label>
          <input id="openedDate" class="dateInput" type="date" />
          <div id="openedDow" class="dowLine"></div>
        </div>
      </div>

      <div id="imgWrap" class="panel">
        <div id="overlay" class="overlay">
          <div>
            <div class="spinner"></div>
            <div style="color:rgba(232,232,234,.75); font-size:13px;">Scanning photo...</div>
          </div>
        </div>
        <img id="imgPreview" alt="preview" />
        <div class="footer">Selected photo</div>
      </div>

      <div id="statusLine" class="statusLine"></div>

      <div class="paoTitle">Choose PAO (months after opening)</div>
      <div id="paoGrid" class="paoGrid"></div>

      <div id="resultMain" class="resultMain">
        <div id="bigStatus" class="bigStatus">Tap a PAO button</div>
        <div class="metaGrid">
          <div class="metaBox">
            <div class="metaLabel">PAO</div>
            <div id="metaPao" class="metaVal">-</div>
          </div>
          <div class="metaBox">
            <div class="metaLabel">Days left</div>
            <div id="metaDays" class="metaVal">-</div>
          </div>
          <div class="metaBox">
            <div class="metaLabel">Toss at</div>
            <div id="metaToss" class="metaVal">-</div>
          </div>
        </div>
      </div>

      <div class="shelfCard">
        <div class="shelfTop">
          <h2 class="shelfTitle">My Shelf</h2>
          <div id="countPill" class="countPill">Total: 0</div>
        </div>

        <div class="shelfControls">
          <input id="productName" class="input" placeholder="Product name (auto-filled from photo if possible)" />
          <button id="btnAddShelf" class="miniBtn" type="button">Add to My Shelf</button>
          <button id="btnClearShelf" class="miniBtn" type="button">Clear</button>
        </div>

        <div id="shelfList"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>

const API_BASE = "https://skinguard.ohryee.workers.dev";
    const OCR_META_ENDPOINT = API_BASE + "/ocr-meta";

    const PAO_OPTIONS = [3, 6, 9, 12, 18, 24, 36];
    const STORAGE_KEY = "skinguard_shelf_v2";
    const LAST_NAME_KEY = "skinguard_last_name_v2";

    const $imageCamera = document.getElementById("imageCamera");
    const $imageGallery = document.getElementById("imageGallery");

    const $imgWrap = document.getElementById("imgWrap");
    const $imgPreview = document.getElementById("imgPreview");
    const $overlay = document.getElementById("overlay");
    const $statusLine = document.getElementById("statusLine");

    const $openedDate = document.getElementById("openedDate");
    const $openedDow = document.getElementById("openedDow");

    const $paoGrid = document.getElementById("paoGrid");

    const $resultMain = document.getElementById("resultMain");
    const $bigStatus = document.getElementById("bigStatus");
    const $metaPao = document.getElementById("metaPao");
    const $metaDays = document.getElementById("metaDays");
    const $metaToss = document.getElementById("metaToss");

    const $toast = document.getElementById("toast");

    const $productName = document.getElementById("productName");
    const $btnAddShelf = document.getElementById("btnAddShelf");
    const $btnClearShelf = document.getElementById("btnClearShelf");
    const $shelfList = document.getElementById("shelfList");
    const $countPill = document.getElementById("countPill");

    let selectedFile = null;
    let previewUrl = null;
    let selectedPao = null;
    let ocrBusy = false;

    function toast(msg){
      $toast.textContent = msg;
      $toast.classList.add("show");
      setTimeout(() => $toast.classList.remove("show"), 1400);
    }

    function setStatus(msg, type){
      $statusLine.className = "statusLine show" + (type ? (" " + type) : "");
      $statusLine.textContent = msg;
    }
    function hideStatus(){
      $statusLine.className = "statusLine";
      $statusLine.textContent = "";
    }

    function showOverlay(on){
      $overlay.classList.toggle("show", !!on);
    }

    function pad2(n){ return String(n).padStart(2,"0"); }

    function fmtDate(d){
      const yyyy = d.getFullYear();
      const mm = pad2(d.getMonth()+1);
      const dd = pad2(d.getDate());
      return `${yyyy}-${mm}-${dd}`;
    }

    function getOpenedDate(){
      const v = String($openedDate.value || "").trim();
      if (!v) return new Date();
      const d = new Date(v + "T12:00:00");
      return Number.isNaN(d.getTime()) ? new Date() : d;
    }

    function updateOpenedDow(){
      const d = getOpenedDate();
      const fmt = new Intl.DateTimeFormat("en-US", {
        weekday: "long",
        year: "numeric",
        month: "short",
        day: "numeric",
      });
      $openedDow.textContent = fmt.format(d);
    }

    function addMonths(date, months){
      const d = new Date(date.getTime());
      const y = d.getFullYear();
      const m = d.getMonth();
      const day = d.getDate();

      const target = new Date(y, m + months, 1, 12, 0, 0);
      const lastDay = new Date(target.getFullYear(), target.getMonth()+1, 0).getDate();
      target.setDate(Math.min(day, lastDay));
      return target;
    }

    function diffDays(a, b){
      const ms = b.getTime() - a.getTime();
      return Math.floor(ms / (1000*60*60*24));
    }

    function computeStatus(daysLeft){
      if (daysLeft < 0) return "TOSS";
      if (daysLeft <= 30) return "WARN";
      return "OK";
    }

    function computeFreshness(){
      if (!selectedPao) return;

      const opened = getOpenedDate();
      const tossAt = addMonths(opened, selectedPao);
      const today = new Date();
      const daysLeft = diffDays(today, tossAt);
      const status = computeStatus(daysLeft);

      $resultMain.classList.add("show");

      if (status === "TOSS"){
        $bigStatus.className = "bigStatus err";
        $bigStatus.textContent = "TOSS IT";
      } else if (status === "WARN"){
        $bigStatus.className = "bigStatus warn";
        $bigStatus.textContent = "USE SOON";
      } else {
        $bigStatus.className = "bigStatus ok";
        $bigStatus.textContent = "SAFE TO USE";
      }

      $metaPao.textContent = selectedPao + "M";
      $metaDays.textContent = String(daysLeft);
      $metaToss.textContent = fmtDate(tossAt);
    }

    function renderPaoButtons(){
      $paoGrid.innerHTML = "";
      PAO_OPTIONS.forEach(m => {
        const btn = document.createElement("button");
        btn.className = "paoBtn" + (selectedPao === m ? " active" : "");
        btn.type = "button";
        btn.textContent = m + "M";
        btn.addEventListener("click", () => {
          selectedPao = m;
          renderPaoButtons();
          hideStatus();
          computeFreshness();
        });
        $paoGrid.appendChild(btn);
      });
    }

    function fileToPayload(file, maxW = 1600, quality = 0.85) {
      return new Promise((resolve, reject) => {
        if (!file) return reject(new Error("no file"));

        const fr = new FileReader();
        fr.onerror = () => reject(new Error("FileReader error"));
        fr.onload = () => {
          const dataUrl = String(fr.result || "");
          const img = new Image();
          img.onerror = () => reject(new Error("image decode error"));
          img.onload = () => {
            const w = img.naturalWidth || img.width || 1;
            const h = img.naturalHeight || img.height || 1;
            const scale = Math.min(1, maxW / w);
            const tw = Math.max(1, Math.round(w * scale));
            const th = Math.max(1, Math.round(h * scale));

            const canvas = document.createElement("canvas");
            canvas.width = tw;
            canvas.height = th;

            const ctx = canvas.getContext("2d");
            if (!ctx) return reject(new Error("canvas ctx error"));
            ctx.drawImage(img, 0, 0, tw, th);

            const outMime = "image/jpeg";
            const outDataUrl = canvas.toDataURL(outMime, quality);
            const base64 = outDataUrl.split(",")[1] || "";

            resolve({ imageBase64: base64, mimeType: outMime, width: tw, height: th });
          };
          img.src = dataUrl;
        };
        fr.readAsDataURL(file);
      });
    }

    async function fetchWithTimeout(url, options, ms = 15000){
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), ms);
      try{
        const res = await fetch(url, { ...options, signal: controller.signal });
        return res;
      } finally{
        clearTimeout(id);
      }
    }

    async function readJsonSafe(res){
      const txt = await res.text().catch(() => "");
      if (!txt) return { text: "", json: null };
      try{ return { text: txt, json: JSON.parse(txt) }; }
      catch{ return { text: txt, json: null }; }
    }

    function humanizeScanError(httpStatus, payload){
      const e = (payload && typeof payload === "object") ? payload : {};
      const code = String(e.error || e.code || "").trim();
      const upstreamStatus = Number(e.status || httpStatus || 0);
      const model = String(e.model || "").trim();
      const msg = String(e.message || "").trim();

      const m = model ? (" model=" + model) : "";
      const tail = msg ? ("\n" + msg.slice(0, 240)) : "";

      if (code === "NO_API_KEY") return "Scanner is not configured (missing API key).";
      if (code === "IMAGE_TOO_LARGE" || upstreamStatus === 413) return "Photo is too large. Try again.";

      if (upstreamStatus === 401) return "Scanner auth failed (401). Check GEMINI_API_KEY.";
      if (upstreamStatus === 403) {
        return "Scanner blocked (403)." + m + tail + "\nThis usually means billing/permission/policy for generateContent.";
      }
      if (upstreamStatus === 429) return "Scanner is busy (429). Try again in a moment.";
      if (upstreamStatus === 408) return "Scanner timed out. Try again.";
      if (upstreamStatus >= 500 && upstreamStatus <= 599) return "Scanner is temporarily unavailable. Try again.";

      if (code) return "Scan failed (" + code + ")." + tail;
      if (msg) return "Scan failed." + tail;

      return "PAO not detected. Please tap a PAO button below.";
    }

    function maybeFillProductName(name){
      const clean = String(name || "").trim();
      if (!clean) return;

      const current = String($productName.value || "").trim();
      if (!current || current === localStorage.getItem(LAST_NAME_KEY)) {
        $productName.value = clean;
      }

      localStorage.setItem(LAST_NAME_KEY, clean);
      toast("Product name filled");
    }

    async function runScan(){
      if (ocrBusy) return;
      if (!selectedFile){
        setStatus("Please select a photo first.", "warn");
        return;
      }

      ocrBusy = true;
      showOverlay(true);
      setStatus("Scanning photo to detect PAO and product name...", "");

      try{
        const payload = await fileToPayload(selectedFile, 1600, 0.85);

        const res = await fetchWithTimeout(OCR_META_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        }, 20000);

        const parsed = await readJsonSafe(res);
        const data = parsed.json;

        if (!res.ok){
          setStatus(humanizeScanError(res.status, data), "warn");
          return;
        }

        if (!data || data.ok !== true){
          setStatus(humanizeScanError(res.status, data), "warn");
          return;
        }

        const candidates = Array.isArray(data?.paoCandidates) ? data.paoCandidates : [];
        const productName = String(data?.productName || "").trim();

        if (productName) maybeFillProductName(productName);

        if (candidates.length >= 1){
          const m = Number(candidates[0]);
          if (PAO_OPTIONS.includes(m)){
            selectedPao = m;
            renderPaoButtons();
            setStatus("Detected " + m + "M. Checking freshness…", "ok");
            computeFreshness();
            toast("Detected " + m + "M");
            return;
          }
        }

        setStatus("PAO not found. Tap a PAO button below.", "warn");
      } catch(e){
        setStatus("Photo scan failed. Tap a PAO button below.\n" + String(e?.message || e), "warn");
      } finally{
        showOverlay(false);
        ocrBusy = false;
      }
    }

    function handleImagePicked(file){
      if (!file) return;
      selectedFile = file;

      if (previewUrl) URL.revokeObjectURL(previewUrl);
      previewUrl = URL.createObjectURL(file);
      $imgPreview.src = previewUrl;
      $imgWrap.style.display = "block";

      runScan();
    }
    function loadShelf(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function saveShelf(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    function renderShelf(){
      const items = loadShelf();
      $countPill.textContent = "Total: " + items.length;
      $shelfList.innerHTML = "";

      if (items.length === 0){
        const empty = document.createElement("div");
        empty.style.color = "rgba(232,232,234,.55)";
        empty.style.fontSize = "13px";
        empty.style.marginTop = "12px";
        empty.textContent = "No items yet.";
        $shelfList.appendChild(empty);
        return;
      }

      const today = new Date();

      items.forEach(item => {
        const name = (item?.name || "").trim() || "Unnamed product";
        const openedAt = String(item?.openedAt || "");
        const paoMonths = Number(item?.paoMonths || 0);

        const openedDate = openedAt ? new Date(openedAt) : new Date();
        const tossAt = addMonths(openedDate, paoMonths);
        const daysLeft = diffDays(today, tossAt);
        const st = computeStatus(daysLeft);

        const row = document.createElement("div");
        row.className = "item";

        const left = document.createElement("div");
        left.className = "itemLeft";

        const title = document.createElement("p");
        title.className = "itemName";
        title.textContent = name;

        const badges = document.createElement("div");
        badges.className = "badgeRow";

        const badge = document.createElement("span");
        badge.className = "badge " + (st === "TOSS" ? "err" : st === "WARN" ? "warn" : "ok");
        badge.textContent = (st === "TOSS" ? "TOSS" : st === "WARN" ? "SOON" : "SAFE");
        badges.appendChild(badge);

        const meta = document.createElement("div");
        meta.className = "itemMeta";
        meta.textContent =
          `Opened: ${fmtDate(openedDate)} · PAO: ${paoMonths}M · Toss: ${fmtDate(tossAt)} · Days left: ${daysLeft}`;

        left.appendChild(title);
        left.appendChild(badges);
        left.appendChild(meta);

        const right = document.createElement("div");
        const del = document.createElement("button");
        del.className = "miniBtn";
        del.type = "button";
        del.textContent = "Delete";
        del.addEventListener("click", () => {
          const next = loadShelf().filter(x => x.id !== item.id);
          saveShelf(next);
          renderShelf();
        });
        right.appendChild(del);

        row.appendChild(left);
        row.appendChild(right);

        $shelfList.appendChild(row);
      });
    }

    function addCurrentToShelf() {
  if (!selectedPao) {
    toast("Choose PAO first");
    return;
  }

  const item = createShelfItem({
    photoSrc: currentImageSrc || "",
    paoMonths: selectedPao,
    openedAt: $openedDate.value
  });

  const shelf = loadShelf();
  shelf.unshift(item); // 최신이 위로
  saveShelf(shelf);

  renderShelf();
  toast("Added to My Shelf");
}


    window.addEventListener("DOMContentLoaded", () => {
      // opened date default = today
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,"0");
      const dd = String(now.getDate()).padStart(2,"0");
      $openedDate.value = `${yyyy}-${mm}-${dd}`;
      updateOpenedDow();

      $openedDate.addEventListener("change", () => {
        updateOpenedDow();
        if (selectedPao) computeFreshness();
      });
 
      // product name default = last used
      const lastName = localStorage.getItem(LAST_NAME_KEY) || "";
      if (lastName) $productName.value = lastName;

      renderPaoButtons();
      renderShelf();
      hideStatus();

      $imageCamera.addEventListener("change", (e) => handleImagePicked(e.target.files?.[0]));
      $imageGallery.addEventListener("change", (e) => handleImagePicked(e.target.files?.[0]));
      //$btnAnalyze.addEventListener("click", () => runOcr());

      $btnAddShelf.addEventListener("click", () => addCurrentToShelf());
      $btnClearShelf.addEventListener("click", () => {
        saveShelf([]);
        renderShelf();
        toast("Cleared");
      });
    });
    
    // ===== 2단계: Shelf Storage (DOMContentLoaded 바깥) =====
const SHELF_KEY = "keep_or_toss_shelf";

function loadShelf() {
  try {
    const raw = localStorage.getItem(SHELF_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch {
    return [];
  }
}

function saveShelf(items) {
  localStorage.setItem(SHELF_KEY, JSON.stringify(items));
}

// ===== 2단계: Add current item to shelf =====
function addCurrentToShelf() {
  if (!selectedPao) {
    toast("Choose PAO first");
    return;
  }

  const item = createShelfItem({
    photoSrc: currentImageSrc || "",
    paoMonths: selectedPao,
    openedAt: $openedDate.value
  });

  const shelf = loadShelf();
  shelf.unshift(item);
  saveShelf(shelf);

  renderShelf();
  toast("Added to My Shelf");
}


    function createId() {
  return `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
}

function calculateDiscardAt(openedAt, paoMonths) {
  const d = new Date(openedAt);
  d.setMonth(d.getMonth() + paoMonths);
  return d.toISOString().slice(0, 10);
}

function calculateStatus(discardAt) {
  const today = new Date().toISOString().slice(0, 10);
  if (today > discardAt) return "toss";

  const diff =
    (new Date(discardAt) - new Date(today)) / (1000 * 60 * 60 * 24);

  if (diff <= 30) return "warning";
  return "safe";
}

function createShelfItem({ photoSrc, paoMonths, openedAt }) {
  const opened = openedAt || new Date().toISOString().slice(0, 10);
  const discardAt = calculateDiscardAt(opened, paoMonths);

  return {
    id: createId(),
    photo: { src: photoSrc || "", takenAt: opened },
    productName: null,
    openedAt: opened,
    paoMonths,
    discardAt,
    status: calculateStatus(discardAt),
    createdAt: new Date().toISOString()
  };
}

console.log(
  createShelfItem({
    photoSrc: "test-image",
    paoMonths: 6
  })
);

  </script>
</body>
</html>
