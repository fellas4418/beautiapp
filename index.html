<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Check Cosmetic Freshness</title>
  <style>
    :root{
      --bg:#0b0c10;
      --card:#111318;
      --text:#e8e8ea;
      --muted:#a8abb4;
      --border:rgba(255,255,255,.10);
      --btn2:#1f2430;
      --danger:#ff4d4f;
      --ok:#20c997;
      --warn:#ffcc00;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    .wrap{
      max-width: 760px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 40px;
    }
    .header{ padding: 12px 4px 6px; }
    .title{ margin:0; font-size: 26px; line-height: 1.2; letter-spacing: -0.2px; }
    .sub{ margin: 8px 0 0; color: var(--muted); font-size: 14px; line-height: 1.5; }
    .card{
      margin-top: 14px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .row{
      display:flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    button{
      border: 0;
      border-radius: 12px;
      padding: 14px 14px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      min-height: 48px;
    }
    .btn-secondary{
      background: var(--btn2);
      color: var(--text);
      border: 1px solid var(--border);
      flex: 1 1 160px;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .panel{
      margin-top: 14px;
      padding: 12px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    .field{
      margin-top: 10px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      border-radius: 12px;
    }
    .field label{
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
    }
    .field input[type="date"]{
      flex: 1;
      min-width: 140px;
      background: transparent;
      border: 0;
      color: var(--text);
      font-size: 14px;
      outline: none;
    }

    .hero{
      display:none;
      margin-top: 12px;
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
    }
    .hero .k{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .hero .v{
      font-size: 44px;
      font-weight: 800;
      letter-spacing: -1px;
      line-height: 1;
    }

    .status{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(17,19,24,.95);
      border: 1px solid var(--border);
      font-size: 14px;
      display:none;
      line-height: 1.45;
      word-break: break-word;
    }
    .status.show{ display:block; }
    .status.ok{ color: var(--ok); border-color: rgba(32,201,151,.55); background: rgba(32,201,151,.10); }
    .status.err{ color: var(--danger); border-color: rgba(255,77,79,.55); background: rgba(255,77,79,.10); }
    .status.warn{ color: var(--warn); border-color: rgba(255,204,0,.55); background: rgba(255,204,0,.10); }

    .metaRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 13px;
    }
    .pill b{ font-weight:700; color: var(--text); }

    #imgWrap{ display:none; }
    #imgPreview{ max-width:100%; border-radius:12px; display:block; }
    .footer{
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
      text-align:center;
    }

    #paoButtons{ display:none; }

    @media (max-width: 420px){
      .title{ font-size: 22px; }
      .btn-secondary{ flex: 1 1 100%; }
      .hero .v{ font-size: 40px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1 class="title">Check Your Cosmetic Freshness</h1>
      <p class="sub">Take a photo and check freshness after opening.</p>
    </div>

    <div class="card">
      <input id="imageCamera" type="file" accept="image/*" capture="environment" style="display:none" />
      <input id="imageGallery" type="file" accept="image/*" style="display:none" />

      <div class="row">
        <button id="btnCamera" class="btn-secondary" type="button">Take Photo</button>
        <button id="btnGallery" class="btn-secondary" type="button">Upload Photo</button>
        <button id="btnOcr" class="btn-secondary" type="button" disabled>Detect PAO</button>
      </div>

      <div id="imgWrap" class="panel">
        <img id="imgPreview" alt="preview" />
        <div class="footer">Selected Image</div>

        <div class="field">
          <label for="openedDate">Opened date</label>
          <input id="openedDate" type="date" />
        </div>

        <div id="heroPao" class="hero">
          <div class="k">Detected PAO</div>
          <div id="heroPaoValue" class="v">-</div>
        </div>
      </div>

      <div id="metaRow" class="metaRow" style="display:none;">
        <div id="pDays" class="pill" style="display:none;">
          Days left: <b id="daysLeftText">-</b>
        </div>
        <div id="pToss" class="pill" style="display:none;">
          Toss at: <b id="tossAtText">-</b>
        </div>
      </div>

      <div id="status" class="status"></div>

      <div id="paoButtons" class="row" style="margin-top: 12px;"></div>
    </div>
  </div>

  <script>
    const API_BASE = "https://skinguard.ohryee.workers.dev";
    const OCR_ENDPOINT = API_BASE + "/ocr-pao";
    const FRESHNESS_ENDPOINT = API_BASE + "/freshness";

    const $imageCamera = document.getElementById("imageCamera");
    const $imageGallery = document.getElementById("imageGallery");
    const $btnCamera = document.getElementById("btnCamera");
    const $btnGallery = document.getElementById("btnGallery");
    const $btnOcr = document.getElementById("btnOcr");
    const $imgWrap = document.getElementById("imgWrap");
    const $imgPreview = document.getElementById("imgPreview");
    const $status = document.getElementById("status");
    const $paoButtons = document.getElementById("paoButtons");

    const $openedDate = document.getElementById("openedDate");

    const $heroPao = document.getElementById("heroPao");
    const $heroPaoValue = document.getElementById("heroPaoValue");

    const $metaRow = document.getElementById("metaRow");
    const $pDays = document.getElementById("pDays");
    const $daysLeftText = document.getElementById("daysLeftText");
    const $pToss = document.getElementById("pToss");
    const $tossAtText = document.getElementById("tossAtText");

    let selectedFile = null;
    let previewUrl = null;
    let ocrBusy = false;

    function todayLocalYYYYMMDD(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function setStatus(msg, type){
      $status.className = "status show" + (type ? (" " + type) : "");
      $status.textContent = msg;
    }
    function hideStatus(){
      $status.className = "status";
      $status.textContent = "";
    }

    function resetUiForNewScan(){
      hideStatus();
      $paoButtons.style.display = "none";
      $paoButtons.innerHTML = "";

      $metaRow.style.display = "none";
      $pDays.style.display = "none";
      $pToss.style.display = "none";
      $daysLeftText.textContent = "-";
      $tossAtText.textContent = "-";

      $heroPao.style.display = "none";
      $heroPaoValue.textContent = "-";
    }

    function showDetected(months){
      $heroPao.style.display = "block";
      $heroPaoValue.textContent = months + "M";
    }

    function showFreshnessMeta(daysLeft, tossAt){
      $metaRow.style.display = "flex";

      if (Number.isFinite(daysLeft)){
        $pDays.style.display = "inline-flex";
        $daysLeftText.textContent = String(daysLeft);
      }

      if (tossAt){
        $pToss.style.display = "inline-flex";
        $tossAtText.textContent = String(tossAt);
      }
    }

    function fileToPayload(file, maxW = 1400, quality = 0.85) {
      return new Promise((resolve, reject) => {
        if (!file) return reject(new Error("no file"));

        const fr = new FileReader();
        fr.onerror = () => reject(new Error("FileReader error"));
        fr.onload = () => {
          const dataUrl = String(fr.result || "");
          const img = new Image();
          img.onerror = () => reject(new Error("image decode error"));
          img.onload = () => {
            const w = img.naturalWidth || img.width || 1;
            const h = img.naturalHeight || img.height || 1;
            const scale = Math.min(1, maxW / w);
            const tw = Math.max(1, Math.round(w * scale));
            const th = Math.max(1, Math.round(h * scale));

            const canvas = document.createElement("canvas");
            canvas.width = tw;
            canvas.height = th;

            const ctx = canvas.getContext("2d");
            if (!ctx) return reject(new Error("canvas ctx error"));
            ctx.drawImage(img, 0, 0, tw, th);

            const outMime = "image/jpeg";
            const outDataUrl = canvas.toDataURL(outMime, quality);
            const base64 = outDataUrl.split(",")[1] || "";

            resolve({ imageBase64: base64, mimeType: outMime, width: tw, height: th });
          };
          img.src = dataUrl;
        };
        fr.readAsDataURL(file);
      });
    }

    function humanScanErrorMessage(status){
      if (status === 429) return "Too many requests right now. Please try again, or choose PAO manually.";
      if (status >= 500) return "Service is temporarily unavailable. Please try again, or choose PAO manually.";
      if (status === 413) return "Photo is too large. Please retake closer, or choose PAO manually.";
      if (status === 400) return "Couldn’t read this photo. Please retake (closer, brighter) or choose PAO manually.";
      return "Couldn’t analyze this photo. Please try again, or choose PAO manually.";
    }

    async function fetchWithTimeout(url, options, timeoutMs = 20000){
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeoutMs);
      try{
        return await fetch(url, { ...options, signal: controller.signal, cache: "no-store" });
      } finally {
        clearTimeout(id);
      }
    }

    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    $btnCamera.addEventListener("click", () => {
      if (isMobile) {
        $imageCamera.value = "";
        $imageCamera.click();
      } else {
        $imageGallery.value = "";
        $imageGallery.click();
      }
    });

    $btnGallery.addEventListener("click", () => {
      $imageGallery.value = "";
      $imageGallery.click();
    });

    $imageCamera.addEventListener("change", (e) => handleImagePicked(e.target.files?.[0]));
    $imageGallery.addEventListener("change", (e) => handleImagePicked(e.target.files?.[0]));

    $btnOcr.addEventListener("click", () => {
      runOcrAuto({ manual: true });
    });

    function handleImagePicked(file){
      if (!file) return;
      selectedFile = file;

      resetUiForNewScan();

      if (previewUrl) URL.revokeObjectURL(previewUrl);
      previewUrl = URL.createObjectURL(selectedFile);
      $imgPreview.src = previewUrl;
      $imgWrap.style.display = "block";

      if (!$openedDate.value) $openedDate.value = todayLocalYYYYMMDD();

      $btnOcr.disabled = false;

      runOcrAuto({ manual: false });
    }

    async function runOcrAuto({ manual } = { manual: false }){
      if (ocrBusy) return;
      if (!selectedFile){
        setStatus("Please upload a photo first.", "err");
        return;
      }

      ocrBusy = true;
      $btnOcr.disabled = true;

      setStatus(manual ? "Rechecking PAO mark..." : "Checking PAO mark...", "");

      try{
        const payload = await fileToPayload(selectedFile, 1400, 0.85);

        const res = await fetchWithTimeout(OCR_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        }, 25000);

        if (!res.ok){
          let detail = {};
          try { detail = await res.json(); } catch(e) {}

          const extra =
            (detail?.error ? ` [${detail.error}]` : "") +
            (detail?.upstreamStatus ? ` (upstream ${detail.upstreamStatus})` : "") +
            (detail?.usingModel ? ` (model ${detail.usingModel})` : "");

          setStatus(humanScanErrorMessage(res.status) + extra, "warn");
          renderPaoButtons([3, 6, 12, 24]);
          return;
        }

        const data = await res.json().catch(() => ({}));
        const pao = Array.isArray(data?.paoCandidates) ? data.paoCandidates : [];

        if (pao.length === 1){
          showDetected(pao[0]);
          setStatus(`Detected ${pao[0]}M. Checking freshness...`, "ok");
          await runFreshness(pao[0]);
          return;
        }

        if (pao.length > 1){
          setStatus("Multiple PAO marks found. Please select one:", "");
          renderPaoButtons(pao);
          return;
        }

        setStatus("Couldn’t find a PAO mark. Please choose one:", "warn");
        renderPaoButtons([3, 6, 12, 24]);
      } catch(e){
        setStatus("Couldn’t analyze this photo. Please try again, or choose PAO manually.", "warn");
        renderPaoButtons([3, 6, 12, 24]);
      } finally{
        ocrBusy = false;
        $btnOcr.disabled = false;
      }
    }

    function renderPaoButtons(months){
      $paoButtons.innerHTML = "";
      $paoButtons.style.display = "flex";

      months.forEach(m => {
        const btn = document.createElement("button");
        btn.className = "btn-secondary";
        btn.style.flex = "1 1 80px";
        btn.textContent = m + "M";
        btn.onclick = async () => {
          showDetected(m);
          setStatus(`Selected ${m}M. Checking freshness...`, "");
          await runFreshness(m);
        };
        $paoButtons.appendChild(btn);
      });
    }

    async function runFreshness(paoMonths){
      const openedDate = ($openedDate.value || "").trim() || todayLocalYYYYMMDD();

      try{
        const res = await fetchWithTimeout(FRESHNESS_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paoMonths, openedDate }),
        }, 15000);

        if (!res.ok){
          setStatus("Couldn’t check freshness right now. Please try again.", "warn");
          return;
        }

        const data = await res.json().catch(() => ({}));

        const daysLeft = Number.isFinite(Number(data?.daysLeft)) ? Number(data.daysLeft) : null;
        const tossAt = typeof data?.tossAt === "string" ? data.tossAt : "";
        showFreshnessMeta(daysLeft, tossAt);

        if (data?.status === "TOSS"){
          setStatus("Toss it. This product is past the recommended period after opening.", "err");
        } else if (data?.status === "WARN"){
          setStatus("Almost time to toss. Use soon or replace.", "warn");
        } else {
          setStatus("Safe to use. Product is within the recommended period.", "ok");
        }
      } catch(e){
        setStatus("Freshness check failed. Please try again.", "warn");
      }
    }
  </script>
</body>
</html>
