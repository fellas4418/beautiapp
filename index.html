<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>PAO Scanner</title>
  <style>
    :root { --bg:#0b0b0b; --card:#151515; --gold:#ffcc00; --text:#eee; --btn:#222; --muted:#666; }
    *{ box-sizing:border-box; }
    body{ background:var(--bg); color:var(--text); font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif; margin:0; padding:20px; text-align:center; }
    .container{ max-width:420px; margin:auto; }
    h2{ font-size:1.2rem; margin:10px 0; text-align:left; letter-spacing:-0.5px; }
    .desc{ font-size:0.8rem; color:var(--muted); margin-bottom:18px; text-align:left; line-height:1.4; }

    .nav-btns{ display:flex; gap:10px; margin-bottom:14px; }
    .btn-ui{ flex:1; padding:16px; background:var(--btn); color:white; border:1px solid #333; border-radius:12px; font-size:0.85rem; font-weight:600; cursor:pointer; display:block; }

    .viewer{ width:100%; aspect-ratio:1; background:var(--card); border-radius:20px; border:1px solid #222; overflow:hidden; position:relative; display:flex; align-items:center; justify-content:center; }
    #preview{ width:100%; height:100%; object-fit:contain; display:none; }
    #placeholder{ color:#333; padding:20px; }

    #loader{ position:absolute; inset:0; background:rgba(0,0,0,0.85); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:10; }
    .spinner{ width:35px; height:35px; border:4px solid #333; border-top-color:var(--gold); border-radius:50%; animation:spin 1s linear infinite; margin-bottom:12px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    #result-area{ display:none; margin-top:16px; animation:slideUp 0.35s ease; }
    .res-card{ background:#1a1a1a; padding:22px; border-radius:18px; border:1px solid #333; margin-bottom:14px; }
    .res-val{ font-size:3rem; font-weight:800; color:var(--gold); margin:6px 0 0; }

    #manual-area{ display:none; text-align:left; }
    .hint{ font-size:0.8rem; color:#555; }
    .pao-grid{ display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; margin-top:10px; }
    .pao-btn{ padding:14px 0; background:#111; border:1px solid #333; color:#777; border-radius:10px; font-size:0.85rem; font-weight:bold; cursor:pointer; }
    .pao-btn.active{ border-color:var(--gold); color:var(--gold); background:#221f00; }

    .small{ margin-top:10px; font-size:0.75rem; color:#666; text-align:left; line-height:1.4; }

    @keyframes slideUp { from { opacity:0; transform:translateY(18px); } to { opacity:1; transform:translateY(0); } }
  </style>
</head>
<body>
  <div class="container">
    <h2>Scan PAO Mark</h2>
    <p class="desc">Instantly detect the shelf life after opening. If it’s unclear, select manually.</p>

    <div class="nav-btns">
      <label for="camInput" class="btn-ui">Camera</label>
      <label for="fileInput" class="btn-ui">Gallery</label>
    </div>

    <input type="file" id="camInput" accept="image/*" capture="environment" style="display:none" />
    <input type="file" id="fileInput" accept="image/*" style="display:none" />

    <div class="viewer">
      <div id="loader">
        <div class="spinner"></div>
        <div style="font-size:0.9rem;">Analyzing...</div>
      </div>
      <img id="preview" alt="preview" />
      <div id="placeholder">Point at 6M, 12M, etc.</div>
    </div>

    <div id="result-area">
      <div class="res-card">
        <div style="font-size:0.75rem; color:#888; text-transform:uppercase;">Result</div>
        <div id="pao-display" class="res-val">-</div>
      </div>
    </div>

    <div id="manual-area">
      <span class="hint">Not accurate? Select manually:</span>
      <div class="pao-grid">
        <button class="pao-btn" data-val="3">3M</button>
        <button class="pao-btn" data-val="6">6M</button>
        <button class="pao-btn" data-val="12">12M</button>
        <button class="pao-btn" data-val="24">24M</button>
      </div>
      <div class="small" id="debugLine" style="display:none;"></div>
    </div>

    <canvas id="procCanvas" style="display:none;"></canvas>
  </div>

  <script>
    // 중요: 이 index.html과 같은 폴더에 pao-worker.js 파일이 있어야 함
    const ocrWorker = new Worker("./pao-worker.js");

    const preview = document.getElementById("preview");
    const loader = document.getElementById("loader");
    const resultArea = document.getElementById("result-area");
    const manualArea = document.getElementById("manual-area");
    const paoDisplay = document.getElementById("pao-display");
    const procCanvas = document.getElementById("procCanvas");
    const ctx = procCanvas.getContext("2d");
    const placeholder = document.getElementById("placeholder");
    const debugLine = document.getElementById("debugLine");

    const camInput = document.getElementById("camInput");
    const fileInput = document.getElementById("fileInput");

    const PAO_STANDARDS = ["3","6","12","24"];

    function resetUI() {
      loader.style.display = "none";
      resultArea.style.display = "none";
      manualArea.style.display = "none";
      paoDisplay.textContent = "-";
      document.querySelectorAll(".pao-btn").forEach(b => b.classList.remove("active"));
      debugLine.style.display = "none";
      debugLine.textContent = "";
    }

    function setActiveButton(val) {
      document.querySelectorAll(".pao-btn").forEach(btn => {
        btn.classList.toggle("active", btn.getAttribute("data-val") === String(val));
      });
    }

    function showResult(val, source) {
      paoDisplay.textContent = val ? (String(val) + "M") : "?";
      resultArea.style.display = "block";
      manualArea.style.display = "block";
      if (val) setActiveButton(val);

      // 필요하면 디버그 보여줄 수 있음 (기본은 숨김)
      // debugLine.style.display = "block";
      // debugLine.textContent = source || "";
    }

    function toThresholdDataURL(img, scale = 3, thr = 165, jpegQ = 0.7) {
      // 업스케일 + 흑백 이진화(threshold)로 엠보싱 대비 살림
      procCanvas.width = Math.max(1, Math.round(img.width * scale));
      procCanvas.height = Math.max(1, Math.round(img.height * scale));

      ctx.setTransform(scale, 0, 0, scale, 0, 0);
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = "high";
      ctx.drawImage(img, 0, 0);

      const w = procCanvas.width;
      const h = procCanvas.height;
      const imageData = ctx.getImageData(0, 0, w, h);
      const d = imageData.data;

      for (let i = 0; i < d.length; i += 4) {
        const r = d[i], g = d[i+1], b = d[i+2];
        const y = 0.2126*r + 0.7152*g + 0.0722*b;
        const v = y > thr ? 255 : 0;
        d[i] = d[i+1] = d[i+2] = v;
      }
      ctx.putImageData(imageData, 0, 0);

      return procCanvas.toDataURL("image/jpeg", jpegQ);
    }

    async function handleFile(file) {
      if (!file) return;
      resetUI();

      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          preview.src = ev.target.result;
          preview.style.display = "block";
          placeholder.style.display = "none";

          loader.style.display = "flex";
          resultArea.style.display = "none";
          manualArea.style.display = "none";
          paoDisplay.textContent = "…";

          // 전처리 1차
          const img1 = toThresholdDataURL(img, 3, 165, 0.7);

          // 실패하면 파라미터만 바꿔 2차/3차도 자동 시도(성공률 올라감)
          ocrWorker.postMessage({ image: img1, tries: 1 });
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    }

    camInput.addEventListener("change", (e) => handleFile(e.target.files?.[0]));
    fileInput.addEventListener("change", (e) => handleFile(e.target.files?.[0]));

    // 수동 선택 버튼
    document.querySelectorAll(".pao-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const val = btn.getAttribute("data-val");
        setActiveButton(val);
        showResult(val, "manual");
      });
    });

    // 워커 결과 처리
    ocrWorker.onmessage = (e) => {
      loader.style.display = "none";

      const success = !!e.data?.success;
      const candidates = Array.isArray(e.data?.candidates) ? e.data.candidates : [];
      const raw = String(e.data?.raw || "");

      // 1개 확정이면 바로 표시
      if (success && candidates.length === 1 && PAO_STANDARDS.includes(String(candidates[0]))) {
        showResult(candidates[0], raw);
        return;
      }

      // 여러 개면 사용자 선택
      if (success && candidates.length > 1) {
        showResult(null, raw);
        // 후보가 여러개라면 그 후보 버튼만 강조하고 싶으면 여기서 처리 가능
        return;
      }

      // 실패면 수동 영역 열기
      showResult(null, raw);
    };

    // 워커 에러 핸들
    ocrWorker.onerror = () => {
      loader.style.display = "none";
      showResult(null, "worker error");
    };
  </script>
</body>
</html>
