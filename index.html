<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Keep or Toss</title>
  <meta name="theme-color" content="#0b0c10" />
  <style>
    :root{
      --bg:#0b0c10;
      --card:#111318;
      --card2:#0f1116;
      --text:#e8e8ea;
      --muted:#a8abb4;
      --border:rgba(255,255,255,.10);
      --btn:#2b6cff;
      --btn2:#1f2430;
      --danger:#ff4d4f;
      --warn:#ffcc00;
      --ok:#20c997;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background: radial-gradient(900px 500px at 20% 0%, rgba(43,108,255,.16), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(32,201,151,.14), transparent 55%),
                  var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    a{ color:inherit; }

    .wrap{
      max-width: 860px;
      margin: 0 auto;
      padding: 18px 14px 120px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin: 6px 0 16px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 0;
    }
    .logo{
      width:34px;
      height:34px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(43,108,255,.95), rgba(32,201,151,.9));
      box-shadow: 0 10px 25px rgba(43,108,255,.15);
      flex: 0 0 auto;
    }
    .brandText{ min-width:0; }
    .brandTitle{
      font-weight: 800;
      font-size: 18px;
      line-height:1.1;
      letter-spacing:.2px;
    }
    .brandSub{
      color: var(--muted);
      font-size: 12.5px;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chip{
      border:1px solid var(--border);
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 12.5px;
      display:flex;
      align-items:center;
      gap:8px;
      flex: 0 0 auto;
    }
    .chip strong{
      color: var(--text);
      font-weight: 700;
      letter-spacing:.2px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
    }
    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
    }

    .btnRow{ display:flex; gap:10px; flex-wrap: wrap; }
    .btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 14px;
      font-weight: 700;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-height: 46px;
      transition: transform .06s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
    }
    .btn:active{ transform: scale(.99); }
    .btnPrimary{
      background: rgba(43,108,255,.90);
      border-color: rgba(43,108,255,.55);
    }
    .btnPrimary:hover{ background: rgba(43,108,255,.98); }
    .btnDanger{
      background: rgba(255,77,79,.14);
      border-color: rgba(255,77,79,.35);
      color: rgba(255,255,255,.92);
    }
    .btnGhost{ background: rgba(255,255,255,.02); }
    .btnSmall{
      padding: 9px 10px;
      border-radius: 12px;
      min-height: 40px;
      font-size: 13.5px;
    }
    .btnWide{ width: 100%; }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    .muted{ color: var(--muted); }
    .hr{ height:1px; background: rgba(255,255,255,.08); margin: 14px 0; }

    .screen{ display:none; }
    .screen.active{ display:block; }

    .hero{
      padding: 18px;
      border-radius: 22px;
      background: radial-gradient(650px 280px at 20% 0%, rgba(43,108,255,.25), transparent 55%),
                  radial-gradient(650px 280px at 90% 15%, rgba(32,201,151,.20), transparent 55%),
                  rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 14px 45px rgba(0,0,0,.35);
    }
    .heroTitle{
      font-size: 44px;
      font-weight: 900;
      letter-spacing: -1px;
      margin: 6px 0 6px;
    }
    @media (max-width: 480px){
      .heroTitle{ font-size: 36px; }
    }
    .heroDesc{
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
      margin: 0 0 14px;
      max-width: 52ch;
    }

    .cameraBox{
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      overflow: hidden;
      position: relative;
      min-height: 320px;
    }
    .cameraBox video,
    .cameraBox img{
      width: 100%;
      height: 100%;
      display:block;
      object-fit: cover;
      background: rgba(0,0,0,.35);
    }
    .cameraHint{
      position:absolute;
      left: 12px;
      top: 12px;
      right: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.38);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.88);
      font-size: 13px;
      line-height:1.35;
      backdrop-filter: blur(10px);
      pointer-events: none;
    }

    .fieldGrid{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:center;
    }
    .field{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px 12px;
      background: rgba(255,255,255,.03);
    }
    .fieldLabel{
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 6px;
    }
    .fieldValue{
      font-size: 18px;
      font-weight: 800;
      letter-spacing: .3px;
    }
    .fieldValueSmall{
      font-size: 14px;
      font-weight: 700;
      color: rgba(232,232,234,.92);
    }

    .resultBig{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 10px;
      padding: 14px 14px;
      border-radius: 16px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
    }
    .resultBigLeft .k{
      color: var(--muted);
      font-size: 12px;
    }
    .resultBigLeft .v{
      font-size: 44px;
      font-weight: 900;
      letter-spacing: -1px;
      line-height: 1;
      margin-top: 4px;
    }

    .tag{
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.9);
      font-size: 12.5px;
      font-weight: 800;
      letter-spacing:.2px;
      white-space: nowrap;
    }
    .tagOk{ border-color: rgba(32,201,151,.35); background: rgba(32,201,151,.12); }
    .tagWarn{ border-color: rgba(255,204,0,.35); background: rgba(255,204,0,.10); color: rgba(255,255,255,.92); }
    .tagToss{ border-color: rgba(255,77,79,.35); background: rgba(255,77,79,.12); }

    .shelfHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .shelfTotal{
      display:flex;
      flex-direction:column;
      gap: 4px;
    }
    .shelfTotal .title{
      font-size: 20px;
      font-weight: 900;
      letter-spacing: -.2px;
      margin-top: 2px;
    }
    .shelfTotal .big{
      font-size: 56px;
      font-weight: 950;
      letter-spacing: -1.5px;
      line-height: 1;
      margin-top: 6px;
    }
    .shelfTotal .sub{
      color: var(--muted);
      font-size: 13px;
      margin-top: 2px;
    }

    .gaugeRow{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap: 12px;
      align-items:center;
      margin-top: 10px;
    }
    @media (max-width: 420px){
      .gaugeRow{ grid-template-columns: 140px 1fr; }
    }
    .gauge{
      width: 160px;
      height: 160px;
      position: relative;
    }
    .gauge svg{ width:100%; height:100%; display:block; }
    .gaugeCenter{
      position:absolute;
      inset: 0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      gap: 2px;
    }
    .gaugeCenter .pct{
      font-size: 34px;
      font-weight: 950;
      letter-spacing: -1px;
    }
    .gaugeCenter .lbl{
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
      letter-spacing:.2px;
    }

    .itemsHeader{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
      margin-top: 6px;
    }
    .itemsHeader .h{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: -.2px;
    }
    .itemsHeader .hint{
      color: var(--muted);
      font-size: 12.5px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      padding: 8px 10px;
      border-radius: 999px;
      text-align:right;
      white-space: nowrap;
    }

    .item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 14px;
      display:flex;
      gap: 12px;
      align-items:flex-start;
      justify-content:space-between;
      margin-top: 10px;
    }
    .item .left{ min-width:0; }
    .item .name{
      font-size: 15px;
      font-weight: 900;
      margin-bottom: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .item .meta{
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.45;
    }
    .item .right{
      display:flex;
      flex-direction:column;
      gap: 8px;
      align-items:flex-end;
      flex: 0 0 auto;
    }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 20px;
      z-index: 9999;
      background: rgba(20,22,28,.92);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: 0 12px 40px rgba(0,0,0,.45);
      max-width: calc(100% - 24px);
      text-align:center;
      display:none;
    }

    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.62);
      z-index: 9300;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
    }
    .overlay.show{ display:flex; }

    .modal{
      width: min(520px, 100%);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 20px 70px rgba(0,0,0,.55);
      padding: 16px;
      position: relative;
    }
    .modalTitle{
      font-size: 18px;
      font-weight: 950;
      letter-spacing: -.2px;
      margin: 2px 0 6px;
    }
    .modalDesc{
      color: var(--muted);
      font-size: 13.5px;
      line-height: 1.5;
      margin: 0 0 12px;
    }
    .modalClose{
      position:absolute;
      right: 12px;
      top: 12px;
      width: 38px;
      height: 38px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      font-size: 18px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .modalActions{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .calendarWrap{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      overflow:hidden;
      background: rgba(0,0,0,.22);
    }
    .calHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      gap: 10px;
    }
    .calHead .navBtn{
      width: 42px;
      height: 42px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      color: rgba(255,255,255,.92);
      font-size: 18px;
    }
    .calHead .label{
      font-size: 15px;
      font-weight: 950;
      letter-spacing: -.2px;
      display:flex;
      align-items:center;
      gap: 10px;
      user-select:none;
      cursor:pointer;
    }
    .calHead select{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.92);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 800;
      font-size: 13px;
      display:none;
    }
    .calHead select.show{ display:inline-flex; }

    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      padding: 12px;
    }
    .dow{
      color: rgba(255,255,255,.65);
      font-size: 12px;
      font-weight: 800;
      text-align:center;
      padding: 6px 0;
    }
    .day{
      border-radius: 14px;
      border: 1px solid transparent;
      background: rgba(255,255,255,.02);
      color: rgba(255,255,255,.88);
      padding: 10px 0;
      text-align:center;
      cursor:pointer;
      font-weight: 800;
      user-select:none;
    }
    .day.off{ opacity: .35; }
    .day.sel{
      background: rgba(43,108,255,.25);
      border-color: rgba(43,108,255,.45);
    }
    .day:hover{ border-color: rgba(255,255,255,.12); }

    .popup{
      position: fixed;
      left: 50%;
      top: 14px;
      transform: translateX(-50%);
      z-index: 9200;
      width: min(680px, calc(100% - 18px));
      display:none;
    }
    .popup.show{ display:block; }
    .popupCard{
      background: rgba(14,16,22,.92);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      box-shadow: 0 16px 60px rgba(0,0,0,.55);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .popupTop{
      padding: 14px 14px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .popupTop .title{
      font-size: 16px;
      font-weight: 950;
      letter-spacing: -.2px;
    }
    .popupTop .sub{
      color: rgba(255,255,255,.72);
      font-size: 13px;
      margin-top: 3px;
      line-height: 1.35;
    }
    .popupBody{ padding: 0 14px 14px; }
    .tips{
      margin-top: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
      padding-top: 10px;
      color: rgba(255,255,255,.76);
      font-size: 12.8px;
      line-height: 1.5;
    }
    .tips span{
      display:block;
      margin-top: 6px;
      color: rgba(255,255,255,.70);
    }

    .hiddenInput{ display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="brandText">
          <div class="brandTitle">Keep or Toss</div>
          <div class="brandSub">Check your makeup before you use it</div>
        </div>
      </div>
      <div class="chip" id="chipSaved">
        <strong id="savedCount">0</strong> saved
      </div>
    </div>

    <div id="screenHome" class="screen active">
      <div class="hero">
        <div class="heroTitle">keep or toss?</div>
        <div class="heroDesc">
          Take a photo of the PAO icon (like 6M, 12M) to check freshness.
          Save it to My Shelf to build your item box.
        </div>
        <div class="btnRow">
          <button class="btn btnPrimary btnWide" id="btnTakePhoto">Take a photo</button>
          <button class="btn btnGhost btnWide" id="btnUploadPhoto">Upload a photo</button>
          <input id="fileInputHome" class="hiddenInput" type="file" accept="image/*" />
        </div>
        <div class="hr"></div>
        <div class="btnRow">
          <button class="btn btnSmall btnWide" id="btnGoShelf">Go to My Shelf</button>
        </div>
      </div>
    </div>

    <div id="screenScan" class="screen">
      <div class="grid">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div>
              <div style="font-weight:950;font-size:18px;letter-spacing:-.2px;">Photo</div>
              <div class="muted" style="font-size:13px;margin-top:4px;">Focus on the PAO icon (3M / 6M / 12M).</div>
            </div>
            <button class="btn btnSmall btnGhost" id="btnBackFromScan">Home</button>
          </div>

          <div style="height:12px;"></div>

          <div class="cameraBox" id="cameraBox">
            <div class="cameraHint" id="cameraHint">
              Tip: Fill the frame with the PAO icon. Avoid reflections.
            </div>
            <video id="video" playsinline autoplay muted style="display:none;"></video>
            <img id="previewImg" alt="preview" style="display:none;" />
          </div>

          <div style="height:12px;"></div>

          <div class="btnRow">
            <button class="btn btnWide" id="btnCapture">Capture</button>
            <button class="btn btnWide" id="btnChooseImage">Choose image</button>
            <input id="fileInput" class="hiddenInput" type="file" accept="image/*" />
          </div>

          <div style="height:12px;"></div>

          <div class="fieldGrid">
            <div class="field">
              <div class="fieldLabel">Opened date</div>
              <div class="fieldValue" id="openedDateText">-</div>
            </div>
            <button class="btn btnSmall" id="btnPickDate">Pick</button>
          </div>

          <div style="height:10px;"></div>

          <div class="fieldGrid">
            <div class="field">
              <div class="fieldLabel">Product name (optional)</div>
              <div class="fieldValueSmall" id="productNameText">Not set</div>
            </div>
            <button class="btn btnSmall" id="btnEditName">Edit</button>
          </div>

          <div style="height:10px;"></div>

          <button class="btn btnPrimary btnWide" id="btnAnalyze">Analyze</button>
          <div class="muted" id="analyzeHint" style="font-size:12.5px;margin-top:8px;line-height:1.45;"></div>
        </div>

        <div class="card">
          <div style="font-weight:950;font-size:18px;letter-spacing:-.2px;">Result</div>
          <div class="muted" style="font-size:13px;margin-top:6px;line-height:1.45;">
            After analysis, you’ll get a Safe/Toss pop-up.
            Then you can save it to My Shelf.
          </div>

          <div style="height:12px;"></div>

          <div class="resultBig">
            <div class="resultBigLeft">
              <div class="k">Detected PAO</div>
              <div class="v" id="detectedPaoBig">-</div>
            </div>
            <div class="tag" id="statusTag">Waiting</div>
          </div>

          <div style="height:12px;"></div>

          <div class="field">
            <div class="fieldLabel">Expires</div>
            <div class="fieldValue" id="expiresText">-</div>
          </div>

          <div style="height:10px;"></div>

          <div class="field">
            <div class="fieldLabel">Days left</div>
            <div class="fieldValue" id="daysLeftText">-</div>
          </div>

          <div style="height:12px;"></div>

          <button class="btn btnWide" id="btnSave" disabled>Save to My Shelf</button>

          <div class="muted" style="font-size:12.5px;margin-top:10px;line-height:1.45;">
            If PAO looks wrong, re-shoot closer, or upload a clearer photo.
          </div>
        </div>
      </div>
    </div>

    <div id="screenShelf" class="screen">
      <div class="card">
        <div class="shelfHeader">
          <div class="shelfTotal">
            <div class="title">My Shelf</div>
            <div class="big" id="totalBig">0</div>
            <div class="sub">items inside</div>
          </div>
          <div class="btnRow" style="justify-content:flex-end;">
            <button class="btn btnSmall" id="btnAddFromShelf">Add</button>
            <button class="btn btnSmall btnDanger" id="btnClearAll">Clear all</button>
            <button class="btn btnSmall btnGhost" id="btnHomeFromShelf">Home</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="gaugeRow">
          <div class="gauge">
            <svg viewBox="0 0 120 120" aria-hidden="true">
              <circle cx="60" cy="60" r="46" fill="none" stroke="rgba(255,255,255,.10)" stroke-width="12" />
              <circle id="gaugeArc" cx="60" cy="60" r="46" fill="none" stroke="rgba(32,201,151,.90)" stroke-width="12"
                stroke-linecap="round" transform="rotate(-90 60 60)" stroke-dasharray="0 999" />
            </svg>
            <div class="gaugeCenter">
              <div class="pct" id="gaugePct">0%</div>
              <div class="lbl">safe ratio</div>
            </div>
          </div>
          <div>
            <div style="font-weight:950;font-size:18px;letter-spacing:-.2px;" id="gaugeTitle">-</div>
            <div class="muted" style="font-size:13px;line-height:1.45;margin-top:6px;" id="gaugeCopy">-</div>
            <div style="height:10px;"></div>
            <div class="muted" style="font-size:13px;line-height:1.45;" id="gaugeNumbers">Safe 0 / 0</div>
            <div style="height:10px;"></div>
            <button class="btn btnSmall" id="btnNotif">Notifications</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="itemsHeader">
          <div class="h">Items</div>
          <div class="hint">Delete = one item · Clear all = everything</div>
        </div>
        <div id="itemsList"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="popup" id="resultPopup">
    <div class="popupCard">
      <div class="popupTop">
        <div>
          <div class="title" id="popupTitle">-</div>
          <div class="sub" id="popupSub">-</div>
        </div>
        <button class="modalClose" id="popupClose" aria-label="close">×</button>
      </div>
      <div class="popupBody">
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <div class="tag" id="popupTag">-</div>
          <div class="tag" id="popupPao">-</div>
          <div class="tag" id="popupExpire">-</div>
        </div>
        <div class="tips" id="popupTips">
          Quick tips
          <span id="tip1">-</span>
          <span id="tip2">-</span>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlayConfirm">
    <div class="modal">
      <div class="modalTitle" id="confirmTitle">Confirm</div>
      <div class="modalDesc" id="confirmDesc">Are you sure?</div>
      <button class="modalClose" id="confirmClose">×</button>
      <div class="modalActions">
        <button class="btn" id="confirmCancel">Cancel</button>
        <button class="btn" id="confirmOk">OK</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlayDate">
    <div class="modal">
      <div class="modalTitle">Pick Opened Date</div>
      <button class="modalClose" id="dateClose">×</button>
      <div class="calendarWrap">
        <div class="calHead">
          <button class="navBtn" id="calPrev">‹</button>
          <div class="label" id="calLabel">
            <span id="calLabelText">2024-05</span>
            <select id="yearSelect"></select>
          </div>
          <button class="navBtn" id="calNext">›</button>
        </div>
        <div class="calGrid" id="calGrid"></div>
      </div>
      <div class="modalActions">
        <button class="btn btnPrimary btnWide" id="dateOk">Confirm</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlayText">
    <div class="modal">
      <div class="modalTitle">Product Name</div>
      <button class="modalClose" id="textClose">×</button>
      <div style="height:10px;"></div>
      <input type="text" id="textInput" placeholder="e.g. Cleansing Oil" style="
        width:100%;
        border-radius: 16px;
        border:1px solid rgba(255,255,255,.12);
        padding: 14px 14px;
        background: rgba(255,255,255,.04);
        color: rgba(255,255,255,.92);
        font-size: 15px;
        font-weight: 700;
        outline:none;
      " />
      <div class="modalActions">
        <button class="btn" id="textCancel">Cancel</button>
        <button class="btn btnPrimary" id="textOk">Save</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://skinguard.ohryee.workers.dev";
    const ENDPOINT_META = API_BASE + "/ocr-meta";
    const ENDPOINT_FRESHNESS = API_BASE + "/freshness";

    const AUTO_ANALYZE_DELAY_MS = 200;

    const Screen = { HOME: "HOME", SCAN: "SCAN", SHELF: "SHELF" };

    const state = {
      screen: Screen.HOME,
      stream: null,
      imageDataUrl: "",
      openedAt: isoToday(),
      productName: "",
      detectedPao: null,
      paoCandidates: [],
      rawText: "",
      freshness: null,
      busy: false,
      items: loadItems(),
      notifEnabled: false,
      remind7: false,
      remindDay: true,
    };

    const el = (id) => document.getElementById(id);

    function isoToday(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function toast(msg, ms=2200){
      const t = el("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.style.display="none", ms);
    }

    function setScreen(s){
      state.screen = s;
      el("screenHome").classList.toggle("active", s===Screen.HOME);
      el("screenScan").classList.toggle("active", s===Screen.SCAN);
      el("screenShelf").classList.toggle("active", s===Screen.SHELF);

      if(s !== Screen.SCAN){ stopCamera(); }
      renderTopChip();
      if(s === Screen.SHELF) renderShelf();
      if(s === Screen.SCAN) renderScan();
    }

    function renderTopChip(){
      const c = state.items.length;
      el("savedCount").textContent = String(c);
      el("chipSaved").style.opacity = c ? "1" : ".75";
    }

    function loadItems(){
      try{
        const raw = localStorage.getItem("kot_items");
        const arr = JSON.parse(raw || "[]");
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }

    function saveItems(){
      localStorage.setItem("kot_items", JSON.stringify(state.items));
      renderTopChip();
    }

    function stopCamera(){
      if(state.stream){
        try{ state.stream.getTracks().forEach(t => t.stop()); }catch{}
      }
      state.stream = null;
      const v = el("video");
      v.srcObject = null;
      v.style.display = "none";
    }

    async function startCameraIfPossible(){
      const v = el("video");
      const img = el("previewImg");
      img.style.display = "none";
      v.style.display = "block";

      if(state.stream) stopCamera();

      try{
        if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
          throw new Error("mediaDevices not supported");
        }
        const s = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: "environment" } },
          audio: false
        });
        state.stream = s;
        v.srcObject = s;

        // 중요: 메타데이터 로드 + 재생 보장 (캡처 버튼이 안 먹는 케이스 방지)
        await new Promise((resolve)=> {
          if(v.readyState >= 1) return resolve();
          v.onloadedmetadata = ()=> resolve();
        });
        await v.play().catch(()=>{});
      }catch(e){
        console.error(e);
        toast("Camera blocked. Use Upload instead.", 2600);
        v.style.display = "none";
      }
    }

    function capturePhoto(){
      const video = el("video");
      if(!video.videoWidth || !video.videoHeight){
        toast("Camera not ready. Try again.", 2000);
        return "";
      }
      const canvas = document.createElement("canvas");
      const w = video.videoWidth || 1280;
      const h = video.videoHeight || 720;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, w, h);
      return canvas.toDataURL("image/jpeg", 0.9);
    }

    function showOverlay(id, show){
      el(id).classList.toggle("show", !!show);
    }

    function normalizeProductName(s){
      return String(s||"").replace(/\s+/g," ").trim().slice(0,80);
    }

    function renderScan(){
      el("openedDateText").textContent = state.openedAt || "-";
      el("productNameText").textContent = state.productName ? state.productName : "Not set";

      el("detectedPaoBig").textContent = state.detectedPao ? (state.detectedPao + "M") : "-";
      el("expiresText").textContent = state.freshness?.tossAt || "-";
      el("daysLeftText").textContent = (state.freshness && Number.isFinite(state.freshness.daysLeft)) ? String(state.freshness.daysLeft) : "-";

      const kind = computeStatus(state.freshness?.daysLeft);
      setStatusTag(kind);

      el("btnSave").disabled = !(state.detectedPao && state.freshness);

      const img = el("previewImg");
      const v = el("video");
      if(state.imageDataUrl){
        img.src = state.imageDataUrl;
        img.style.display = "block";
        v.style.display = "none";
      }else{
        img.style.display = "none";
      }
    }

    function setStatusTag(kind){
      const tag = el("statusTag");
      tag.className = "tag";
      if(kind === "OK"){
        tag.classList.add("tagOk");
        tag.textContent = "Safe";
      }else if(kind === "WARN"){
        tag.classList.add("tagWarn");
        tag.textContent = "Close";
      }else if(kind === "TOSS"){
        tag.classList.add("tagToss");
        tag.textContent = "Toss";
      }else{
        tag.textContent = "Waiting";
      }
    }

    function computeStatus(daysLeft){
      if(!Number.isFinite(daysLeft)) return "WAIT";
      if(daysLeft < 0) return "TOSS";
      if(daysLeft <= 30) return "WARN";
      return "OK";
    }

    function openResultPopup(status, pao, tossAt, daysLeft){
      const p = el("resultPopup");
      const title = el("popupTitle");
      const sub = el("popupSub");
      const tag = el("popupTag");
      const paoTag = el("popupPao");
      const expTag = el("popupExpire");

      tag.className = "tag";
      paoTag.className = "tag";
      expTag.className = "tag";

      if(status === "OK"){
        title.textContent = "Safe";
        sub.textContent = "Looks fresh. You’re good to go.";
        tag.classList.add("tagOk");
        tag.textContent = "SAFE";
      }else if(status === "WARN"){
        title.textContent = "Close to toss";
        sub.textContent = "Almost done. Use it soon, or plan to toss.";
        tag.classList.add("tagWarn");
        tag.textContent = "CLOSE";
      }else{
        title.textContent = "Toss it";
        sub.textContent = "Expired after opening. It’s time to let it go.";
        tag.classList.add("tagToss");
        tag.textContent = "TOSS IT";
      }

      paoTag.textContent = pao + "M PAO";
      expTag.textContent = "Until " + tossAt;

      const tips = getTips(status);
      el("tip1").textContent = tips[0];
      el("tip2").textContent = tips[1];

      p.style.display = "block";
      p.classList.add("show");

      // 자동 닫힘(2.6초): 확인 누르면 즉시 닫히고, 안 누르면 자동으로 사라짐
      clearTimeout(openResultPopup._t);
      openResultPopup._t = setTimeout(()=> closeResultPopup(), 2600);
    }

    function closeResultPopup(){
      const p = el("resultPopup");
      if(!p) return;
      p.classList.remove("show");
      p.style.display = "none";
    }

    function getTips(status){
      if(status === "OK") return [
        "Keep it in a cool, dry place away from sunlight.",
        "Close the lid tightly to prevent drying or bacteria."
      ];
      if(status === "WARN") return [
        "Use it daily to finish before the expiry date.",
        "Check for changes in smell or texture."
      ];
      return [
        "Old makeup can harbor bacteria and cause breakouts.",
        "If you had irritation before, don’t risk it. Skin > product."
      ];
    }

    function openConfirm({ title, desc, okText="OK", danger=false }){
      return new Promise((resolve)=>{
        el("confirmTitle").textContent = title;
        el("confirmDesc").textContent = desc;
        el("confirmOk").textContent = okText;
        el("confirmOk").className = danger ? "btn btnDanger" : "btn btnPrimary";

        const close = (v)=>{
          showOverlay("overlayConfirm", false);
          cleanup();
          resolve(v);
        };
        const cleanup = ()=>{
          el("confirmClose").onclick = null;
          el("confirmCancel").onclick = null;
          el("confirmOk").onclick = null;
        };

        el("confirmClose").onclick = ()=> close(false);
        el("confirmCancel").onclick = ()=> close(false);
        el("confirmOk").onclick = ()=> close(true);
        showOverlay("overlayConfirm", true);
      });
    }

    function openTextInput(initial){
      return new Promise((resolve)=>{
        el("textInput").value = initial || "";
        const close = (v)=>{
          showOverlay("overlayText", false);
          cleanup();
          resolve(v);
        };
        const cleanup = ()=>{
          el("textClose").onclick = null;
          el("textCancel").onclick = null;
          el("textOk").onclick = null;
        };
        el("textClose").onclick = ()=> close(null);
        el("textCancel").onclick = ()=> close(null);
        el("textOk").onclick = ()=> close(normalizeProductName(el("textInput").value));
        showOverlay("overlayText", true);
        setTimeout(()=> el("textInput").focus(), 50);
      });
    }

    // Calendar
    const cal = { y: new Date().getFullYear(), m: new Date().getMonth(), sel: null, showYearSelect: false };

    function buildYearSelect(){
      const ys = el("yearSelect");
      ys.innerHTML = "";
      const nowY = new Date().getFullYear();
      const minY = nowY - 10;
      const maxY = nowY + 10;
      for(let y=minY;y<=maxY;y++){
        const opt = document.createElement("option");
        opt.value = String(y);
        opt.textContent = String(y);
        ys.appendChild(opt);
      }
      ys.value = String(cal.y);
      ys.onchange = ()=>{
        cal.y = Number(ys.value);
        renderCalendar();
      };
    }

    function openDatePicker(){
      const d = new Date(state.openedAt);
      if(!Number.isNaN(d.getTime())){
        cal.y = d.getFullYear();
        cal.m = d.getMonth();
        cal.sel = new Date(d.getTime());
      }else{
        cal.y = new Date().getFullYear();
        cal.m = new Date().getMonth();
        cal.sel = new Date();
      }
      cal.showYearSelect = false;
      buildYearSelect();
      renderCalendar();
      showOverlay("overlayDate", true);
    }

    function closeDatePicker(){
      showOverlay("overlayDate", false);
      el("yearSelect").classList.remove("show");
      cal.showYearSelect = false;
    }

    function renderCalendar(){
      const label = el("calLabelText");
      label.textContent = `${cal.y}-${String(cal.m+1).padStart(2,"0")}`;
      const ys = el("yearSelect");
      ys.value = String(cal.y);

      const grid = el("calGrid");
      grid.innerHTML = "";
      const dows = ["S","M","T","W","T","F","S"];
      dows.forEach(d => {
        const div = document.createElement("div");
        div.className = "dow";
        div.textContent = d;
        grid.appendChild(div);
      });

      const first = new Date(cal.y, cal.m, 1);
      const last = new Date(cal.y, cal.m + 1, 0);
      const startDow = first.getDay();
      const prevLast = new Date(cal.y, cal.m, 0).getDate();

      for(let i=0; i<startDow; i++){
        const div = document.createElement("div");
        div.className = "day off";
        div.textContent = String(prevLast - startDow + i + 1);
        grid.appendChild(div);
      }

      for(let d=1; d<=last.getDate(); d++){
        const div = document.createElement("div");
        div.className = "day";
        if(cal.sel && cal.sel.getFullYear()===cal.y && cal.sel.getMonth()===cal.m && cal.sel.getDate()===d){
          div.classList.add("sel");
        }
        div.textContent = String(d);
        div.onclick = ()=>{
          const newSel = new Date(cal.y, cal.m, d);
          state.openedAt = `${newSel.getFullYear()}-${String(newSel.getMonth()+1).padStart(2,"0")}-${String(newSel.getDate()).padStart(2,"0")}`;
          cal.sel = newSel;
          renderCalendar();
        };
        grid.appendChild(div);
      }
    }

    // Analyze helpers
    async function compressToDataUrl(fileOrDataUrl){
      if(typeof fileOrDataUrl === "string" && fileOrDataUrl.startsWith("data:image")){
        return fileOrDataUrl;
      }
      const file = fileOrDataUrl;
      const img = new Image();
      const dataUrl = await new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = ()=> resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
      await new Promise((resolve,reject)=>{
        img.onload = resolve;
        img.onerror = reject;
        img.src = dataUrl;
      });
      const maxW = 1400;
      const maxH = 1400;
      let w = img.width;
      let h = img.height;
      const scale = Math.min(1, maxW / w, maxH / h);
      w = Math.round(w * scale);
      h = Math.round(h * scale);
      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, w, h);
      return canvas.toDataURL("image/jpeg", 0.86);
    }

    function getMimeFromDataUrl(dataUrl){
      const m = String(dataUrl||"").match(/^data:(image\/[a-zA-Z0-9.+-]+);base64,/);
      return m ? m[1] : "image/jpeg";
    }

    function parsePaoFromAnyText(s){
      const text = String(s||"").toUpperCase().replace(/\s/g,"");
      const m = text.match(/(3|6|9|12|18|24|36)M/g) || [];
      const nums = [...new Set(m.map(x => Number(x.replace("M",""))))].filter(n => [3,6,9,12,18,24,36].includes(n));
      return nums;
    }

    // 후보 선택 개선:
    // - API 후보 + rawText 후보를 합침
    // - rawText에 후보가 있고 API가 단일(특히 12만 던지는) 케이스면 rawText 우선
    function pickBestPao(merged, candidatesFromApi, candidatesFromRaw){
      const a = [...new Set(candidatesFromApi)].sort((x,y)=>x-y);
      const b = [...new Set(candidatesFromRaw)].sort((x,y)=>x-y);
      const all = [...new Set(merged)].sort((x,y)=>x-y);

      if(all.length === 0) return null;

      // rawText가 의미있게 잡힌 경우 우선
      if(b.length && (!a.length || (a.length === 1 && b[0] !== a[0]))){
        return b[0];
      }

      // 기본: 가장 작은 값(보수적으로)
      return all[0];
    }

    async function analyzeNow(auto=false){
      if(state.busy) return;
      if(!state.imageDataUrl){
        if(!auto) toast("Add a photo first.", 2200);
        return;
      }

      state.busy = true;
      el("btnAnalyze").disabled = true;
      el("btnAnalyze").textContent = "Analyzing...";
      el("analyzeHint").textContent = "Reading PAO icon…";

      // 초기화
      state.detectedPao = null;
      state.paoCandidates = [];
      state.rawText = "";
      state.freshness = null;
      renderScan();

      try{
        const mimeType = getMimeFromDataUrl(state.imageDataUrl) || "image/jpeg";

        const r = await fetch(ENDPOINT_META, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            imageBase64: state.imageDataUrl,
            mimeType
          })
        });

        const j = await r.json().catch(()=>null);

        // OCR 실패면 여기서 무조건 끝 (freshness 절대 호출 금지)
        if(!r.ok || !j || !j.ok){
        el("analyzeHint").textContent =
           "Couldn’t read PAO. Try a closer shot, reduce glare, or upload a clearer image.";
      if(!auto){
        toast("Couldn’t read PAO. Try again.", 2400);
        }
        renderScan();
      return;
      }

        const candidatesFromApi = (Array.isArray(j.paoCandidates) ? j.paoCandidates : [])
          .map(n => Number(n))
          .filter(n => [3,6,9,12,18,24,36].includes(n));

        const candidatesFromRaw = parsePaoFromAnyText(j.rawText || "");
        const merged = [...new Set([...candidatesFromApi, ...candidatesFromRaw])].sort((a,b)=>a-b);

        state.paoCandidates = merged;
        state.rawText = (j.rawText || "").toString().slice(0,220);

        const pn = normalizeProductName(j.productName || "");
        if(pn && !state.productName) state.productName = pn;

        const picked = pickBestPao(merged, candidatesFromApi, candidatesFromRaw);
        state.detectedPao = picked;

        if(!picked){
  el("analyzeHint").textContent =
    "PAO not detected. Fill the frame with the PAO icon (e.g., 6M) and avoid reflections.";
  if(!auto){
    toast("PAO not detected. Try again.", 2400);
  }
  renderScan();
  return;
}


        // freshness 계산
        el("analyzeHint").textContent = `Detected ${picked}M. Checking freshness…`;

        const fr = await fetch(ENDPOINT_FRESHNESS, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paoMonths: picked, openedAt: state.openedAt })
        });

        const fj = await fr.json().catch(()=>null);
        if(!fr.ok || !fj || !fj.ok){
          el("analyzeHint").textContent =
            "Could not calculate freshness. Please try again.";
          toast("Freshness calc failed.", 2600);
          renderScan();
          return;
        }

        state.freshness = fj;

        const status = computeStatus(fj.daysLeft);
        setStatusTag(status);
        renderScan();

        // 팝업 표시
        openResultPopup(status, picked, fj.tossAt, fj.daysLeft);

        // 저장 버튼 활성화
        el("btnSave").disabled = false;

        // Calculating 잔상 제거: 최종 결과로 덮어쓰기
        el("analyzeHint").textContent =
          `Detected ${picked}M · Expires ${fj.tossAt} · Days left ${fj.daysLeft}`;

      }catch(e){
        console.error(e);
        el("analyzeHint").textContent =
          "Couldn’t analyze due to a network error. Please try again.";
        toast("Network error. Try again.", 2800);
        return;
      }finally{
        state.busy = false;
        el("btnAnalyze").disabled = false;
        el("btnAnalyze").textContent = "Analyze";
      }
    }

    function addCurrentToShelf(){
      if(!(state.detectedPao && state.freshness)) return;

      const item = {
        id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2)),
        name: state.productName || "Untitled item",
        openedAt: state.openedAt || isoToday(),
        pao: state.detectedPao,
        expiresAt: state.freshness.tossAt,
        daysLeft: state.freshness.daysLeft,
        status: computeStatus(state.freshness.daysLeft),
        createdAt: Date.now()
      };

      state.items.unshift(item);
      saveItems();
      toast("Saved to My Shelf.", 1700);
      setScreen(Screen.SHELF);
      runOnOpenReminders();
    }

    function renderShelf(){
      const total = state.items.length;
      el("totalBig").textContent = String(total);

      const safeCount = state.items.filter(it => it.status === "OK").length;
      const ratio = total ? Math.round((safeCount / total) * 100) : 0;

      const circ = 2 * Math.PI * 46;
      const dash = (circ * ratio) / 100;
      const arc = el("gaugeArc");
      arc.setAttribute("stroke-dasharray", `${dash} ${circ - dash}`);

      if(ratio >= 80){ arc.setAttribute("stroke", "rgba(32,201,151,.92)"); }
      else if(ratio >= 60){ arc.setAttribute("stroke", "rgba(255,204,0,.92)"); }
      else { arc.setAttribute("stroke", "rgba(255,77,79,.92)"); }

      el("gaugePct").textContent = `${ratio}%`;

      let title = "Good";
      let copy = "Mostly clean. You’re managing well.";
      if(total === 0){
        title = "Empty shelf";
        copy = "Add your first item. Your “item box” starts now.";
      }else if(ratio >= 80){
        title = "Good";
        copy = "Mostly clean. You’re managing well.";
      }else if(ratio >= 60){
        title = "Decent";
        copy = "A few items need attention soon.";
      }else{
        title = "Alert";
        copy = "Many items expired. Toss them for skin safety.";
      }
      el("gaugeTitle").textContent = title;
      el("gaugeCopy").textContent = copy;
      el("gaugeNumbers").textContent = `Safe ${safeCount} / ${total}`;

      const list = el("itemsList");
      list.innerHTML = "";

      if(total === 0){
        list.innerHTML = `<div class="muted" style="text-align:center;padding:40px 0;">No items saved yet.</div>`;
        return;
      }

      for(const it of state.items){
        const row = document.createElement("div");
        row.className = "item";

        const left = document.createElement("div");
        left.className = "left";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = it.name || "Untitled item";

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML =
          `Opened: ${it.openedAt}<br>` +
          `PAO: ${it.pao}M<br>` +
          `Expires: ${it.expiresAt}`;

        left.appendChild(name);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.className = "right";

        const st = document.createElement("div");
        st.className = "tag";
        if(it.status === "OK"){ st.classList.add("tagOk"); st.textContent = "Safe"; }
        else if(it.status === "WARN"){ st.classList.add("tagWarn"); st.textContent = "Close"; }
        else { st.classList.add("tagToss"); st.textContent = "Toss"; }

        const del = document.createElement("button");
        del.className = "btn btnSmall btnDanger";
        del.textContent = "Delete";
        del.onclick = async ()=>{
          const ok = await openConfirm({
            title: "Delete this item?",
            desc: "This will permanently remove it from your shelf.",
            okText: "Delete",
            danger: true
          });
          if(!ok) return;
          state.items = state.items.filter(x => x.id !== it.id);
          saveItems();
          renderShelf();
        };

        right.appendChild(st);
        right.appendChild(del);

        row.appendChild(left);
        row.appendChild(right);
        list.appendChild(row);
      }
    }

    // Reminders
    async function requestNotif(){
      if(!("Notification" in window)) return;
      const res = await Notification.requestPermission();
      if(res === "granted"){
        state.notifEnabled = true;
        toast("Notifications enabled!", 1800);
      }
    }

    function runOnOpenReminders(){
      if(!state.notifEnabled || Notification.permission !== "granted") return;

      const items = state.items;
      const today = new Date();
      const todayIso = today.toISOString().split("T")[0];
      const in7 = new Date(); in7.setDate(in7.getDate()+7);
      const in7Iso = in7.toISOString().split("T")[0];

      if(state.remind7){
        const hits = items.filter(it => it.expiresAt === in7Iso);
        if(hits.length) new Notification("Keep or Toss", { body: `${hits.length} item(s) expire in 7 days.` });
      }
      if(state.remindDay){
        const hits = items.filter(it => it.expiresAt === todayIso);
        if(hits.length) new Notification("Keep or Toss", { body: `${hits.length} item(s) expire today.` });
      }
    }

    function scheduleAutoAnalyze(){
      clearTimeout(scheduleAutoAnalyze._t);
      scheduleAutoAnalyze._t = setTimeout(()=>{
        analyzeNow(true);
      }, AUTO_ANALYZE_DELAY_MS);
    }

    // Events
    el("btnTakePhoto").onclick = async ()=>{
      setScreen(Screen.SCAN);
      state.imageDataUrl = "";
      state.detectedPao = null;
      state.paoCandidates = [];
      state.rawText = "";
      state.freshness = null;
      el("analyzeHint").textContent = "";
      renderScan();
      await startCameraIfPossible();
    };

    el("btnUploadPhoto").onclick = ()=> el("fileInputHome").click();

    el("fileInputHome").onchange = async (e)=>{
      const f = e.target.files && e.target.files[0];
      e.target.value = "";
      if(!f) return;

      setScreen(Screen.SCAN);
      state.imageDataUrl = await compressToDataUrl(f);
      state.detectedPao = null;
      state.paoCandidates = [];
      state.rawText = "";
      state.freshness = null;
      el("analyzeHint").textContent = "";
      renderScan();

      scheduleAutoAnalyze();
    };

    el("btnBackFromScan").onclick = ()=> setScreen(Screen.HOME);

    el("btnGoShelf").onclick = ()=> setScreen(Screen.SHELF);

    el("btnHomeFromShelf").onclick = ()=> setScreen(Screen.HOME);

    el("btnAddFromShelf").onclick = async ()=>{
      setScreen(Screen.SCAN);
      state.imageDataUrl = "";
      state.detectedPao = null;
      state.paoCandidates = [];
      state.rawText = "";
      state.freshness = null;
      el("analyzeHint").textContent = "";
      renderScan();
      await startCameraIfPossible();
    };

    el("btnCapture").onclick = async ()=>{
      if(!state.stream) await startCameraIfPossible();
      if(!state.stream) return;
      const shot = capturePhoto();
      if(!shot) return;
      state.imageDataUrl = shot;
      el("analyzeHint").textContent = "";
      renderScan();
      scheduleAutoAnalyze();
    };

    el("btnChooseImage").onclick = ()=> el("fileInput").click();

    el("fileInput").onchange = async (e)=>{
      const f = e.target.files && e.target.files[0];
      e.target.value = "";
      if(!f) return;

      state.imageDataUrl = await compressToDataUrl(f);
      state.detectedPao = null;
      state.paoCandidates = [];
      state.rawText = "";
      state.freshness = null;
      el("analyzeHint").textContent = "";
      renderScan();

      scheduleAutoAnalyze();
    };

    el("btnPickDate").onclick = ()=> openDatePicker();
    el("calPrev").onclick = ()=>{ cal.m--; if(cal.m<0){ cal.m=11; cal.y--; } renderCalendar(); };
    el("calNext").onclick = ()=>{ cal.m++; if(cal.m>11){ cal.m=0; cal.y++; } renderCalendar(); };

    // 연도 선택: 라벨(연/월)을 누르면 yearSelect 토글
    el("calLabel").onclick = ()=>{
      cal.showYearSelect = !cal.showYearSelect;
      el("yearSelect").classList.toggle("show", cal.showYearSelect);
    };

    el("dateClose").onclick = ()=> closeDatePicker();
    el("dateOk").onclick = ()=> { renderScan(); closeDatePicker(); };

    el("btnEditName").onclick = async ()=>{
      const res = await openTextInput(state.productName);
      if(res !== null){
        state.productName = res;
        renderScan();
      }
    };

    el("btnAnalyze").onclick = ()=> analyzeNow(false);

    el("popupClose").onclick = ()=> closeResultPopup();

    el("btnSave").onclick = ()=> addCurrentToShelf();

    el("btnClearAll").onclick = async ()=>{
      const ok = await openConfirm({
        title: "Clear everything?",
        desc: "This will remove all items from your shelf.",
        okText: "Clear All",
        danger: true
      });
      if(!ok) return;
      state.items = [];
      saveItems();
      renderShelf();
    };

    el("btnNotif").onclick = ()=> requestNotif();

    // Init
    renderTopChip();
    setScreen(Screen.HOME);
  </script>
</body>
</html>

