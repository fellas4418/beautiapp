<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cosmetic Expiry Calculator</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
* { box-sizing: border-box; }
body { margin: 0; background: #0b0c10; color: #e8e8ea; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
.wrap { max-width: 420px; margin: 0 auto; padding: 16px; }
.card { background: #111318; border-radius: 16px; padding: 16px; margin-bottom: 16px; }
h2 { margin: 0 0 20px 0; font-size: 28px; }
img { width: 100%; border-radius: 12px; margin-top: 10px; display: block; max-height: 300px; object-fit: contain; }
.pao { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 12px; }
button { padding: 12px; border-radius: 10px; border: none; background: #1f2430; color: #fff; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.2s; }
button:hover { background: #2a3142; transform: translateY(-2px); }
button.active { background: linear-gradient(135deg, #667eea, #764ba2); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5); }
.result { margin-top: 14px; font-weight: 800; font-size: 17px; text-align: center; padding: 14px; background: #1a1d2e; border-radius: 10px; }
input[type="date"] { width: 100%; margin-top: 10px; padding: 10px; border-radius: 8px; border: none; font-size: 14px; }
input[type="file"] { width: 100%; padding: 10px; background: #1a1d2e; border: 2px dashed #333; border-radius: 8px; color: #e8e8ea; cursor: pointer; margin-top: 10px; }
input[type="file"]::-webkit-file-upload-button { background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; }
.status { margin-top: 10px; padding: 12px; border-radius: 8px; text-align: center; font-weight: 600; font-size: 14px; }
label { display: block; margin-top: 12px; margin-bottom: 4px; font-size: 14px; color: #aaa; }
.debug { margin-top: 10px; padding: 10px; background: #1a1d2e; border-radius: 8px; font-size: 11px; color: #888; max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; font-family: monospace; }
.info-box { background: #1a1d2e; padding: 14px; border-radius: 10px; margin-top: 16px; font-size: 14px; line-height: 1.6; color: #aaa; }
.info-box strong { color: #667eea; }
.test-btn { background: #dc3545; margin-top: 10px; width: 100%; }
</style>
</head>

<body>
<div class="wrap">
<h2>üíÑ PAO Calculator</h2>

<div class="card">
<label>Opening Date</label>
<input type="date" id="opened">

<label>Period After Opening (PAO)</label>
<div class="pao" id="paoBtns"></div>

<label>Upload Product Photo (Optional)</label>
<input type="file" id="fileInput" accept="image/*">
<img id="preview" style="display:none">

<button class="test-btn" onclick="testOCR()">üß™ Test OCR System</button>

<div id="result" class="result">Select a PAO period</div>
<div id="status" class="status" style="display:none"></div>
<div id="debug" class="debug" style="display:none"></div>
</div>

<div class="card">
<h3 style="margin:0 0 12px 0">‚ÑπÔ∏è About PAO</h3>
<div class="info-box">
<strong>Period After Opening (PAO)</strong> indicates how long a cosmetic product is safe to use after opening.<br><br>
Look for the open jar symbol on your product with a number (e.g., 12M = 12 months).<br><br>
You can upload a photo of the PAO symbol and our OCR will try to detect it automatically.
</div>
</div>
</div>

<script>
const PAOS = [3, 6, 9, 12, 18, 24, 36];
let selectedPAO = null;

const opened = document.getElementById("opened");
const paoBox = document.getElementById("paoBtns");
const result = document.getElementById("result");
const preview = document.getElementById("preview");
const status = document.getElementById("status");
const debug = document.getElementById("debug");

opened.value = new Date().toISOString().slice(0, 10);

PAOS.forEach(m => {
  const b = document.createElement("button");
  b.textContent = m + "M";
  b.onclick = () => { selectPAO(m); updateResult(); };
  paoBox.appendChild(b);
});

function selectPAO(m) {
  selectedPAO = m;
  [...paoBox.children].forEach(b => {
    b.classList.toggle("active", b.textContent === m + "M");
  });
}

function addMonths(d, m) {
  const [y, mo, da] = d.split("-").map(Number);
  const dt = new Date(y, mo - 1, da);
  dt.setMonth(dt.getMonth() + m);
  return dt;
}

function updateResult() {
  if (!selectedPAO) { 
    result.textContent = "Select a PAO period"; 
    return; 
  }
  const toss = addMonths(opened.value, selectedPAO);
  const daysLeft = Math.ceil((toss - new Date()) / (1000 * 60 * 60 * 24));
  
  let emoji = "‚úÖ";
  if (daysLeft < 0) emoji = "‚ùå";
  else if (daysLeft <= 30) emoji = "‚ö†Ô∏è";
  
  result.textContent = `${emoji} ${selectedPAO}M ¬∑ Expires on ${toss.toISOString().slice(0, 10)}`;
  
  if (daysLeft < 0) {
    result.textContent += ` (Expired ${Math.abs(daysLeft)} days ago)`;
  } else {
    result.textContent += ` (${daysLeft} days left)`;
  }
}

function logDebug(msg) {
  debug.style.display = "block";
  debug.textContent += msg + "\n";
  console.log(msg);
}

// üîç Enhanced PAO extraction function
function extractPAO(text) {
  logDebug("=== Starting PAO Extraction ===");
  logDebug("Original text: " + text);
  
  // Step 1: Preprocessing
  let clean = text.replace(/\s+/g, '').toUpperCase();
  logDebug("Cleaned text: " + clean);
  
  // Step 2: Pattern matching
  const patterns = [
    { name: "Standard M", regex: /(\d+)M\b/i },
    { name: "Spaced M", regex: /(\d+)\s*M\b/i },
    { name: "MO format", regex: /(\d+)MO/i },
    { name: "MONTH format", regex: /(\d+)MONTH/i },
    { name: "PAO prefix", regex: /PAO[:\s]*(\d+)M/i },
    { name: "PERIOD prefix", regex: /PERIOD[:\s]*(\d+)M/i },
    { name: "Surrounded", regex: /[^\d](\d+)M[^\d]/i },
  ];
  
  for (let { name, regex } of patterns) {
    const match = clean.match(regex);
    if (match) {
      const num = parseInt(match[1]);
      logDebug(`Pattern "${name}" matched: ${match[0]} -> ${num}`);
      if (PAOS.includes(num)) {
        logDebug(`‚úì Valid PAO found: ${num}M`);
        return num;
      } else {
        logDebug(`‚úó Number ${num} not in valid PAO list`);
      }
    }
  }
  
  // Step 3: Extract all numbers
  const numbers = clean.match(/\d+/g);
  logDebug("All numbers found: " + (numbers ? numbers.join(", ") : "none"));
  
  if (numbers) {
    for (let numStr of numbers) {
      const num = parseInt(numStr);
      if (PAOS.includes(num)) {
        const idx = clean.indexOf(numStr);
        const nearby = clean.substring(Math.max(0, idx - 2), Math.min(clean.length, idx + numStr.length + 2));
        logDebug(`Checking number ${num}, nearby context: "${nearby}"`);
        if (nearby.includes('M')) {
          logDebug(`‚úì Found valid PAO by proximity: ${num}M`);
          return num;
        }
      }
    }
  }
  
  logDebug("‚úó No valid PAO found");
  return null;
}

async function testOCR() {
  status.style.display = "block";
  status.style.background = "#4d4d1b";
  status.style.color = "#f0ad4e";
  status.textContent = "üß™ Testing Tesseract.js...";
  
  debug.style.display = "block";
  debug.textContent = "=== OCR System Test ===\n";
  
  try {
    logDebug("Checking Tesseract availability...");
    
    if (typeof Tesseract === 'undefined') {
      throw new Error("Tesseract.js library not loaded!");
    }
    
    logDebug("‚úì Tesseract.js is loaded");
    logDebug("Version: " + (Tesseract.version || "unknown"));
    
    // Create a simple test image with text
    const canvas = document.createElement('canvas');
    canvas.width = 200;
    canvas.height = 100;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, 200, 100);
    ctx.fillStyle = 'black';
    ctx.font = '40px Arial';
    ctx.fillText('12M', 50, 60);
    
    canvas.toBlob(async (blob) => {
      logDebug("Testing with generated image '12M'...");
      
      const { data: { text } } = await Tesseract.recognize(blob, 'eng', {
        logger: m => {
          if (m.status === 'recognizing text') {
            const pct = Math.round(m.progress * 100);
            status.textContent = `üß™ Test running... ${pct}%`;
          }
        }
      });
      
      logDebug("Test OCR result: " + text);
      
      const pao = extractPAO(text);
      
      if (pao === 12) {
        status.style.background = "#1b4d3e";
        status.style.color = "#20c997";
        status.textContent = "‚úì OCR system working correctly!";
      } else {
        status.style.background = "#4d1b1b";
        status.style.color = "#ff6b6b";
        status.textContent = "‚ö† OCR system loaded but detection may be inaccurate";
      }
    });
    
  } catch (err) {
    logDebug("ERROR: " + err.message);
    status.style.background = "#4d1b1b";
    status.style.color = "#ff6b6b";
    status.textContent = "‚ùå OCR system failed: " + err.message;
  }
}

document.getElementById("fileInput").onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  preview.src = URL.createObjectURL(file);
  preview.style.display = "block";

  status.style.display = "block";
  status.style.background = "#4d4d1b";
  status.style.color = "#f0ad4e";
  status.textContent = "üîç Detecting PAO...";

  debug.style.display = "block";
  debug.textContent = "=== OCR Analysis Started ===\n";

  try {
    logDebug("File name: " + file.name);
    logDebug("File size: " + (file.size / 1024).toFixed(2) + " KB");
    logDebug("File type: " + file.type);
    
    logDebug("Starting Tesseract recognition...");
    
    const { data: { text, confidence } } = await Tesseract.recognize(file, 'eng', {
      logger: m => {
        if (m.status === 'recognizing text') {
          const pct = Math.round(m.progress * 100);
          status.textContent = `üîç Analyzing... ${pct}%`;
        }
      }
    });

    logDebug("OCR completed");
    logDebug("Confidence: " + confidence);
    logDebug("Raw text output:\n" + text);
    
    const pao = extractPAO(text);
    
    if (pao) {
      selectPAO(pao);
      updateResult();
      status.style.background = "#1b4d3e";
      status.style.color = "#20c997";
      status.textContent = `‚úì Detected ${pao}M successfully!`;
    } else {
      status.style.background = "#4d1b1b";
      status.style.color = "#ff6b6b";
      status.textContent = "‚ùå Detection failed. Please select manually ‚Üì";
    }
  } catch (err) {
    logDebug("CRITICAL ERROR: " + err.message);
    logDebug("Stack trace: " + err.stack);
    status.style.background = "#4d1b1b";
    status.style.color = "#ff6b6b";
    status.textContent = "‚ö† Error: " + err.message;
  }
};

opened.onchange = updateResult;

// Check Tesseract on page load
window.addEventListener('load', () => {
  setTimeout(() => {
    if (typeof Tesseract === 'undefined') {
      status.style.display = "block";
      status.style.background = "#4d1b1b";
      status.style.color = "#ff6b6b";
      status.textContent = "‚ö† Tesseract.js failed to load. Check your internet connection.";
    }
  }, 3000);
});
</script>
</body>
</html>