<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Keep or Toss</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body{margin:0;background:#0b0c10;color:#e8e8ea;font-family:system-ui}
.wrap{max-width:420px;margin:0 auto;padding:16px}
.card{background:#111318;border-radius:16px;padding:14px}
img{width:100%;border-radius:12px;margin-top:10px}
.pao{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
button{padding:10px;border-radius:10px;border:none;background:#1f2430;color:#fff;font-weight:700}
button.active{outline:2px solid #20c997}
.result{margin-top:12px;font-weight:800}
input[type="date"]{width:100%;margin-top:10px;padding:8px;border-radius:8px;border:none}
</style>
</head>

<body>
<div class="wrap">
<h2>Keep or Toss</h2>

<div class="card">
<input type="file" id="fileInput" accept="image/*">
<img id="preview" style="display:none">

<input type="date" id="opened">
<div class="pao" id="paoBtns"></div>
<div id="result" class="result"></div>
<div id="pao-detection" style="display:none; margin-top:10px; padding:10px; background:#1b4d3e; border-radius:8px; text-align:center; font-weight:bold; color:#20c997;"></div>
</div>
</div>

<script>
const PAOS=[3,6,9,12,18,24,36];
let selectedPAO=null;

const opened=document.getElementById("opened");
const paoBox=document.getElementById("paoBtns");
const result=document.getElementById("result");
const preview=document.getElementById("preview");

opened.value=new Date().toISOString().slice(0,10);

PAOS.forEach(m=>{
  const b=document.createElement("button");
  b.textContent=m+"M";
  b.onclick=()=>{selectPAO(m);updateResult();};
  paoBox.appendChild(b);
});

function selectPAO(m){
  selectedPAO=m;
  [...paoBox.children].forEach(b=>{
    b.classList.toggle("active",b.textContent===m+"M");
  });
}

function addMonths(d,m){
  const [y,mo,da]=d.split("-").map(Number);
  const dt=new Date(y,mo-1,da);
  dt.setMonth(dt.getMonth()+m);
  return dt;
}

function updateResult(){
  if(!selectedPAO){result.textContent="PAO 선택";return;}
  const toss=addMonths(opened.value,selectedPAO);
  result.textContent=`${selectedPAO}M · Toss ${toss.toISOString().slice(0,10)}`;
}

/* ===== 핵심: 확실한 자동 인식 ===== */
document.getElementById("fileInput").onchange=e=>{
  const file=e.target.files[0];
  if(!file)return;

  preview.src=URL.createObjectURL(file);
  preview.style.display="block";

  // 1️⃣ 파일명에서 먼저 잡음 (6m.jpg, IMG_6M.png 등)
  const nameMatch=file.name.match(/(3|6|9|12|18|24|36)\s*m/i);
  if(nameMatch){
    const detected=Number(nameMatch[1]);
    selectPAO(detected);
    updateResult();
    const paoDetection=document.getElementById("pao-detection");
    paoDetection.textContent=`Detected ${detected}M`;
    paoDetection.style.display="block";
    return;
  }

  // 2️⃣ 파일명 실패 시 OCR 실행
  const paoDetection=document.getElementById("pao-detection");
  paoDetection.textContent="Scanning...";
  paoDetection.style.display="block";

  const img = new Image();
  img.src = URL.createObjectURL(file);
  // 이미지 전처리 (명암 대비 강화)
  const img = new Image();
  img.onload = () => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.filter = 'contrast(2) brightness(1.2)';
    ctx.drawImage(img, 0, 0);
    
    Tesseract.recognize(canvas, 'eng', {
      tessedit_char_whitelist: '0123456789M '
    })
    .then(({data:{text}})=>{
      console.log("OCR 결과:", text);
      const ocrMatch=text.match(/\b(3|6|9|12|18|24|36)\s*M\b/i);
      if(ocrMatch){
        const detected=Number(ocrMatch[1]);
        selectPAO(detected);
        updateResult();
        paoDetection.textContent=`Detected ${detected}M`;
      }else{
        paoDetection.textContent="Couldn't read the symbol. Retake the photo.";
      }
    })
    .catch(()=>{
      paoDetection.textContent="Scan failed. Try again.";
    });
};
</script>
</body>
</html>
